/*BassoonTracker v0.4.3 by Steffest - build 2024-07-12 - Full source on https://github.com/steffest/BassoonTracker */
var BassoonTracker=function(){function audioBufferToWav(e,t){var n=e.numberOfChannels,a=e.sampleRate,r=(t=t||{}).float32?3:1,i=3==r?32:16;return encodeWAV(2===n?function(e,t){for(var n=e.length+t.length,a=new Float32Array(n),r=0,i=0;r<n;)a[r++]=e[i],a[r++]=t[i],i++;return a}(e.getChannelData(0),e.getChannelData(1)):e.getChannelData(0),r,a,n,i)}function encodeWAV(e,t,n,a,r){function i(e,t,n){for(var a=0;a<n.length;a++)e.setUint8(t+a,n.charCodeAt(a))}var o=r/8,s=a*o,l=new ArrayBuffer(44+e.length*o),c=new DataView(l);i(c,0,"RIFF"),c.setUint32(4,36+e.length*o,!0),i(c,8,"WAVE"),i(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,t,!0),c.setUint16(22,a,!0),c.setUint32(24,n,!0),c.setUint32(28,n*s,!0),c.setUint16(32,s,!0),c.setUint16(34,r,!0),i(c,36,"data"),c.setUint32(40,e.length*o,!0);var u,d=44;if(1===t)for(u=0;u<e.length;u++,d+=2){var h=Math.max(-1,Math.min(1,e[u]));c.setInt16(d,h<0?32768*h:32767*h,!0)}else for(u=0;u<e.length;u++,d+=4)c.setFloat32(d,e[u],!0);return l}function getUrlParameter(e){if(window.location.getParameter)return window.location.getParameter(e);if(location.search)for(var t=location.search.substring(1).split("&"),n=0;n<t.length;n++){var a=t[n].split("=");if(a[0]&&a[0]==e)return a[1]||!0}}function formatFileSize(e){var t="k";return isNaN(e)&&(e=0),1e3<(e=Math.round(e/1e3))&&(e=Math.round(e/100)/10,t="MB"),e+t}function createSlug(e){var t={"Á":"A","Ă":"A","Ắ":"A","Ặ":"A","Ằ":"A","Ẳ":"A","Ẵ":"A","Ǎ":"A","Â":"A","Ấ":"A","Ậ":"A","Ầ":"A","Ẩ":"A","Ẫ":"A","Ä":"A","Ǟ":"A","Ȧ":"A","Ǡ":"A","Ạ":"A","Ȁ":"A","À":"A","Ả":"A","Ȃ":"A","Ā":"A","Ą":"A","Å":"A","Ǻ":"A","Ḁ":"A","Ⱥ":"A","Ã":"A","Ꜳ":"AA","Æ":"AE","Ǽ":"AE","Ǣ":"AE","Ꜵ":"AO","Ꜷ":"AU","Ꜹ":"AV","Ꜻ":"AV","Ꜽ":"AY","Ḃ":"B","Ḅ":"B","Ɓ":"B","Ḇ":"B","Ƀ":"B","Ƃ":"B","Ć":"C","Č":"C","Ç":"C","Ḉ":"C","Ĉ":"C","Ċ":"C","Ƈ":"C","Ȼ":"C","Ď":"D","Ḑ":"D","Ḓ":"D","Ḋ":"D","Ḍ":"D","Ɗ":"D","Ḏ":"D","ǲ":"D","ǅ":"D","Đ":"D","Ƌ":"D","Ǳ":"DZ","Ǆ":"DZ","É":"E","Ĕ":"E","Ě":"E","Ȩ":"E","Ḝ":"E","Ê":"E","Ế":"E","Ệ":"E","Ề":"E","Ể":"E","Ễ":"E","Ḙ":"E","Ë":"E","Ė":"E","Ẹ":"E","Ȅ":"E","È":"E","Ẻ":"E","Ȇ":"E","Ē":"E","Ḗ":"E","Ḕ":"E","Ę":"E","Ɇ":"E","Ẽ":"E","Ḛ":"E","Ꝫ":"ET","Ḟ":"F","Ƒ":"F","Ǵ":"G","Ğ":"G","Ǧ":"G","Ģ":"G","Ĝ":"G","Ġ":"G","Ɠ":"G","Ḡ":"G","Ǥ":"G","Ḫ":"H","Ȟ":"H","Ḩ":"H","Ĥ":"H","Ⱨ":"H","Ḧ":"H","Ḣ":"H","Ḥ":"H","Ħ":"H","Í":"I","Ĭ":"I","Ǐ":"I","Î":"I","Ï":"I","Ḯ":"I","İ":"I","Ị":"I","Ȉ":"I","Ì":"I","Ỉ":"I","Ȋ":"I","Ī":"I","Į":"I","Ɨ":"I","Ĩ":"I","Ḭ":"I","Ꝺ":"D","Ꝼ":"F","Ᵹ":"G","Ꞃ":"R","Ꞅ":"S","Ꞇ":"T","Ꝭ":"IS","Ĵ":"J","Ɉ":"J","Ḱ":"K","Ǩ":"K","Ķ":"K","Ⱪ":"K","Ꝃ":"K","Ḳ":"K","Ƙ":"K","Ḵ":"K","Ꝁ":"K","Ꝅ":"K","Ĺ":"L","Ƚ":"L","Ľ":"L","Ļ":"L","Ḽ":"L","Ḷ":"L","Ḹ":"L","Ⱡ":"L","Ꝉ":"L","Ḻ":"L","Ŀ":"L","Ɫ":"L","ǈ":"L","Ł":"L","Ǉ":"LJ","Ḿ":"M","Ṁ":"M","Ṃ":"M","Ɱ":"M","Ń":"N","Ň":"N","Ņ":"N","Ṋ":"N","Ṅ":"N","Ṇ":"N","Ǹ":"N","Ɲ":"N","Ṉ":"N","Ƞ":"N","ǋ":"N","Ñ":"N","Ǌ":"NJ","Ó":"O","Ŏ":"O","Ǒ":"O","Ô":"O","Ố":"O","Ộ":"O","Ồ":"O","Ổ":"O","Ỗ":"O","Ö":"O","Ȫ":"O","Ȯ":"O","Ȱ":"O","Ọ":"O","Ő":"O","Ȍ":"O","Ò":"O","Ỏ":"O","Ơ":"O","Ớ":"O","Ợ":"O","Ờ":"O","Ở":"O","Ỡ":"O","Ȏ":"O","Ꝋ":"O","Ꝍ":"O","Ō":"O","Ṓ":"O","Ṑ":"O","Ɵ":"O","Ǫ":"O","Ǭ":"O","Ø":"O","Ǿ":"O","Õ":"O","Ṍ":"O","Ṏ":"O","Ȭ":"O","Ƣ":"OI","Ꝏ":"OO","Ɛ":"E","Ɔ":"O","Ȣ":"OU","Ṕ":"P","Ṗ":"P","Ꝓ":"P","Ƥ":"P","Ꝕ":"P","Ᵽ":"P","Ꝑ":"P","Ꝙ":"Q","Ꝗ":"Q","Ŕ":"R","Ř":"R","Ŗ":"R","Ṙ":"R","Ṛ":"R","Ṝ":"R","Ȑ":"R","Ȓ":"R","Ṟ":"R","Ɍ":"R","Ɽ":"R","Ꜿ":"C","Ǝ":"E","Ś":"S","Ṥ":"S","Š":"S","Ṧ":"S","Ş":"S","Ŝ":"S","Ș":"S","Ṡ":"S","Ṣ":"S","Ṩ":"S","Ť":"T","Ţ":"T","Ṱ":"T","Ț":"T","Ⱦ":"T","Ṫ":"T","Ṭ":"T","Ƭ":"T","Ṯ":"T","Ʈ":"T","Ŧ":"T","Ɐ":"A","Ꞁ":"L","Ɯ":"M","Ʌ":"V","Ꜩ":"TZ","Ú":"U","Ŭ":"U","Ǔ":"U","Û":"U","Ṷ":"U","Ü":"U","Ǘ":"U","Ǚ":"U","Ǜ":"U","Ǖ":"U","Ṳ":"U","Ụ":"U","Ű":"U","Ȕ":"U","Ù":"U","Ủ":"U","Ư":"U","Ứ":"U","Ự":"U","Ừ":"U","Ử":"U","Ữ":"U","Ȗ":"U","Ū":"U","Ṻ":"U","Ų":"U","Ů":"U","Ũ":"U","Ṹ":"U","Ṵ":"U","Ꝟ":"V","Ṿ":"V","Ʋ":"V","Ṽ":"V","Ꝡ":"VY","Ẃ":"W","Ŵ":"W","Ẅ":"W","Ẇ":"W","Ẉ":"W","Ẁ":"W","Ⱳ":"W","Ẍ":"X","Ẋ":"X","Ý":"Y","Ŷ":"Y","Ÿ":"Y","Ẏ":"Y","Ỵ":"Y","Ỳ":"Y","Ƴ":"Y","Ỷ":"Y","Ỿ":"Y","Ȳ":"Y","Ɏ":"Y","Ỹ":"Y","Ź":"Z","Ž":"Z","Ẑ":"Z","Ⱬ":"Z","Ż":"Z","Ẓ":"Z","Ȥ":"Z","Ẕ":"Z","Ƶ":"Z","Ĳ":"IJ","Œ":"OE","ᴀ":"A","ᴁ":"AE","ʙ":"B","ᴃ":"B","ᴄ":"C","ᴅ":"D","ᴇ":"E","ꜰ":"F","ɢ":"G","ʛ":"G","ʜ":"H","ɪ":"I","ʁ":"R","ᴊ":"J","ᴋ":"K","ʟ":"L","ᴌ":"L","ᴍ":"M","ɴ":"N","ᴏ":"O","ɶ":"OE","ᴐ":"O","ᴕ":"OU","ᴘ":"P","ʀ":"R","ᴎ":"N","ᴙ":"R","ꜱ":"S","ᴛ":"T","ⱻ":"E","ᴚ":"R","ᴜ":"U","ᴠ":"V","ᴡ":"W","ʏ":"Y","ᴢ":"Z","á":"a","ă":"a","ắ":"a","ặ":"a","ằ":"a","ẳ":"a","ẵ":"a","ǎ":"a","â":"a","ấ":"a","ậ":"a","ầ":"a","ẩ":"a","ẫ":"a","ä":"a","ǟ":"a","ȧ":"a","ǡ":"a","ạ":"a","ȁ":"a","à":"a","ả":"a","ȃ":"a","ā":"a","ą":"a","ᶏ":"a","ẚ":"a","å":"a","ǻ":"a","ḁ":"a","ⱥ":"a","ã":"a","ꜳ":"aa","æ":"ae","ǽ":"ae","ǣ":"ae","ꜵ":"ao","ꜷ":"au","ꜹ":"av","ꜻ":"av","ꜽ":"ay","ḃ":"b","ḅ":"b","ɓ":"b","ḇ":"b","ᵬ":"b","ᶀ":"b","ƀ":"b","ƃ":"b","ɵ":"o","ć":"c","č":"c","ç":"c","ḉ":"c","ĉ":"c","ɕ":"c","ċ":"c","ƈ":"c","ȼ":"c","ď":"d","ḑ":"d","ḓ":"d","ȡ":"d","ḋ":"d","ḍ":"d","ɗ":"d","ᶑ":"d","ḏ":"d","ᵭ":"d","ᶁ":"d","đ":"d","ɖ":"d","ƌ":"d","ı":"i","ȷ":"j","ɟ":"j","ʄ":"j","ǳ":"dz","ǆ":"dz","é":"e","ĕ":"e","ě":"e","ȩ":"e","ḝ":"e","ê":"e","ế":"e","ệ":"e","ề":"e","ể":"e","ễ":"e","ḙ":"e","ë":"e","ė":"e","ẹ":"e","ȅ":"e","è":"e","ẻ":"e","ȇ":"e","ē":"e","ḗ":"e","ḕ":"e","ⱸ":"e","ę":"e","ᶒ":"e","ɇ":"e","ẽ":"e","ḛ":"e","ꝫ":"et","ḟ":"f","ƒ":"f","ᵮ":"f","ᶂ":"f","ǵ":"g","ğ":"g","ǧ":"g","ģ":"g","ĝ":"g","ġ":"g","ɠ":"g","ḡ":"g","ᶃ":"g","ǥ":"g","ḫ":"h","ȟ":"h","ḩ":"h","ĥ":"h","ⱨ":"h","ḧ":"h","ḣ":"h","ḥ":"h","ɦ":"h","ẖ":"h","ħ":"h","ƕ":"hv","í":"i","ĭ":"i","ǐ":"i","î":"i","ï":"i","ḯ":"i","ị":"i","ȉ":"i","ì":"i","ỉ":"i","ȋ":"i","ī":"i","į":"i","ᶖ":"i","ɨ":"i","ĩ":"i","ḭ":"i","ꝺ":"d","ꝼ":"f","ᵹ":"g","ꞃ":"r","ꞅ":"s","ꞇ":"t","ꝭ":"is","ǰ":"j","ĵ":"j","ʝ":"j","ɉ":"j","ḱ":"k","ǩ":"k","ķ":"k","ⱪ":"k","ꝃ":"k","ḳ":"k","ƙ":"k","ḵ":"k","ᶄ":"k","ꝁ":"k","ꝅ":"k","ĺ":"l","ƚ":"l","ɬ":"l","ľ":"l","ļ":"l","ḽ":"l","ȴ":"l","ḷ":"l","ḹ":"l","ⱡ":"l","ꝉ":"l","ḻ":"l","ŀ":"l","ɫ":"l","ᶅ":"l","ɭ":"l","ł":"l","ǉ":"lj","ſ":"s","ẜ":"s","ẛ":"s","ẝ":"s","ḿ":"m","ṁ":"m","ṃ":"m","ɱ":"m","ᵯ":"m","ᶆ":"m","ń":"n","ň":"n","ņ":"n","ṋ":"n","ȵ":"n","ṅ":"n","ṇ":"n","ǹ":"n","ɲ":"n","ṉ":"n","ƞ":"n","ᵰ":"n","ᶇ":"n","ɳ":"n","ñ":"n","ǌ":"nj","ó":"o","ŏ":"o","ǒ":"o","ô":"o","ố":"o","ộ":"o","ồ":"o","ổ":"o","ỗ":"o","ö":"o","ȫ":"o","ȯ":"o","ȱ":"o","ọ":"o","ő":"o","ȍ":"o","ò":"o","ỏ":"o","ơ":"o","ớ":"o","ợ":"o","ờ":"o","ở":"o","ỡ":"o","ȏ":"o","ꝋ":"o","ꝍ":"o","ⱺ":"o","ō":"o","ṓ":"o","ṑ":"o","ǫ":"o","ǭ":"o","ø":"o","ǿ":"o","õ":"o","ṍ":"o","ṏ":"o","ȭ":"o","ƣ":"oi","ꝏ":"oo","ɛ":"e","ᶓ":"e","ɔ":"o","ᶗ":"o","ȣ":"ou","ṕ":"p","ṗ":"p","ꝓ":"p","ƥ":"p","ᵱ":"p","ᶈ":"p","ꝕ":"p","ᵽ":"p","ꝑ":"p","ꝙ":"q","ʠ":"q","ɋ":"q","ꝗ":"q","ŕ":"r","ř":"r","ŗ":"r","ṙ":"r","ṛ":"r","ṝ":"r","ȑ":"r","ɾ":"r","ᵳ":"r","ȓ":"r","ṟ":"r","ɼ":"r","ᵲ":"r","ᶉ":"r","ɍ":"r","ɽ":"r","ↄ":"c","ꜿ":"c","ɘ":"e","ɿ":"r","ś":"s","ṥ":"s","š":"s","ṧ":"s","ş":"s","ŝ":"s","ș":"s","ṡ":"s","ṣ":"s","ṩ":"s","ʂ":"s","ᵴ":"s","ᶊ":"s","ȿ":"s","ɡ":"g","ᴑ":"o","ᴓ":"o","ᴝ":"u","ť":"t","ţ":"t","ṱ":"t","ț":"t","ȶ":"t","ẗ":"t","ⱦ":"t","ṫ":"t","ṭ":"t","ƭ":"t","ṯ":"t","ᵵ":"t","ƫ":"t","ʈ":"t","ŧ":"t","ᵺ":"th","ɐ":"a","ᴂ":"ae","ǝ":"e","ᵷ":"g","ɥ":"h","ʮ":"h","ʯ":"h","ᴉ":"i","ʞ":"k","ꞁ":"l","ɯ":"m","ɰ":"m","ᴔ":"oe","ɹ":"r","ɻ":"r","ɺ":"r","ⱹ":"r","ʇ":"t","ʌ":"v","ʍ":"w","ʎ":"y","ꜩ":"tz","ú":"u","ŭ":"u","ǔ":"u","û":"u","ṷ":"u","ü":"u","ǘ":"u","ǚ":"u","ǜ":"u","ǖ":"u","ṳ":"u","ụ":"u","ű":"u","ȕ":"u","ù":"u","ủ":"u","ư":"u","ứ":"u","ự":"u","ừ":"u","ử":"u","ữ":"u","ȗ":"u","ū":"u","ṻ":"u","ų":"u","ᶙ":"u","ů":"u","ũ":"u","ṹ":"u","ṵ":"u","ᵫ":"ue","ꝸ":"um","ⱴ":"v","ꝟ":"v","ṿ":"v","ʋ":"v","ᶌ":"v","ⱱ":"v","ṽ":"v","ꝡ":"vy","ẃ":"w","ŵ":"w","ẅ":"w","ẇ":"w","ẉ":"w","ẁ":"w","ⱳ":"w","ẘ":"w","ẍ":"x","ẋ":"x","ᶍ":"x","ý":"y","ŷ":"y","ÿ":"y","ẏ":"y","ỵ":"y","ỳ":"y","ƴ":"y","ỷ":"y","ỿ":"y","ȳ":"y","ẙ":"y","ɏ":"y","ỹ":"y","ź":"z","ž":"z","ẑ":"z","ʑ":"z","ⱬ":"z","ż":"z","ẓ":"z","ȥ":"z","ẕ":"z","ᵶ":"z","ᶎ":"z","ʐ":"z","ƶ":"z","ɀ":"z","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ĳ":"ij","œ":"oe","ﬆ":"st","ₐ":"a","ₑ":"e","ᵢ":"i","ⱼ":"j","ₒ":"o","ᵣ":"r","ᵤ":"u","ᵥ":"v","ₓ":"x"};return e=(e=(e=(e=e.split(" ").join("-")).replace(/[^A-Za-z0-9\[\] ]/g,function(e){return t[e]||e})).toLowerCase()).replace(/[^a-z0-9\-]+/g,"")}function loadFile(e,n){var a=new XMLHttpRequest;a.open("GET",e,!0),a.responseType="arraybuffer",a.onload=function(e){var t=a.response;t&&200===a.status?n&&n(t):void 0!==Editor&&n&&n(!1)},a.send(null)}function saveFile(e,t){var n=document.createElement("a");document.body.appendChild(n),n.style="display: none",url=window.URL.createObjectURL(e),n.href=url,n.download=t,n.click(),window.URL.revokeObjectURL(url)}function BinaryStream(e,t){function o(e){(e=0===e?e:e||i.index)<0&&(e=0),i.length<=e&&(e=i.length-1),i.index=e}var i={index:0,litteEndian:!t,goto:function(e){o(e)},jump:function(e){this.goto(this.index+e)},readByte:function(e){o(e);var t=this.dataView.getInt8(this.index);return this.index++,t},writeByte:function(e,t){o(t),this.dataView.setInt8(this.index,e),this.index++},readUbyte:function(e){o(e);var t=this.dataView.getUint8(this.index);return this.index++,t},writeUByte:function(e,t){o(t),this.dataView.setUint8(this.index,e),this.index++},readUint:function(e){o(e);var t=this.dataView.getUint32(this.index,this.litteEndian);return this.index+=4,t},writeUint:function(e,t){o(t),this.dataView.setUint32(this.index,e,this.litteEndian),this.index+=4},readBytes:function(e,t){o(t);var n=new Uint8Array(e),a=this.index;(e+=a)>this.length&&(e=this.length);for(var r=0;a<e;++a)n.setUint8(r++,this.dataView.getUint8(a));return this.index=e,n},readString:function(e,t){o(t);var n=this.index,a=this.dataView,r="";for((e+=n)>this.length&&(e=this.length);n<e;++n){var i=a.getUint8(n);if(0==i)break;r+=String.fromCharCode(i)}return this.index=e,r},writeString:function(e,t){o(t);for(var n=this.dataView,a=e.length,r=0;r<a;r++)n.setUint8(this.index+r,e.charCodeAt(r));this.index+=a},writeStringSection:function(e,t,n,a){o(a),n=n||0;var r=(e=e||"").length;(t=t||1)<r&&(e=e.substr(0,t)),i.writeString(e),i.fill(n,t-r)},readWord:function(e){o(e);var t=this.dataView.getUint16(this.index,this.litteEndian);return this.index+=2,t},writeWord:function(e,t){o(t),this.dataView.setUint16(this.index,e,this.litteEndian),this.index+=2}};return i.readLong=i.readDWord=i.readUint,i.writeLong=i.writeDWord=i.writeUint,i.readShort=function(e,t){o(t);var n=this.dataView.getInt16(this.index,this.litteEndian);return this.index+=2,n},i.clear=function(e){i.fill(0,e)},i.fill=function(e,t){e=e||0,t=t||0;for(var n=0;n<t;n++)i.writeByte(e)},i.isEOF=function(e){return this.length-(e=e||0)<=this.index},e&&(i.buffer=e,i.dataView=new DataView(e),i.length=e.byteLength),i}function read8SVXsample(t,e){function n(){var e={};return e.name=t.readString(4),e.size=t.readDWord(),e}t.litteEndian=!1,t.goto(12);for(var a=n();"BODY"!=a.name&&!t.isEOF(10);)"NAME"==a.name?e.name=t.readString(a.size):t.jump(a.size),a=n();if("BODY"==a.name)for(var r=0;r<a.size;r++){var i=t.readByte();e.data.push(i/127)}}function detectSampleType(e,t,n){var a=SAMPLETYPE.RAW_8BIT,r=readRAWsample,i="";switch(t&&t.name&&(i=t.name.split(".").pop().toLowerCase()),t.info=getSamplerate(e,i),t.info.type){case"WAVE_PCM":case"RIFF":case"MP3":case"FLAC":case"OGG":case"OPUS":a=SAMPLETYPE[t.info.type],r=decodeFileWithAudioContext;break;case"FORM":e.goto(8),"8SVX"==e.readString(4)&&(a=SAMPLETYPE.IFF_8SVX,r=read8SVXsample)}if(t&&r)r(e,t,n);else{if(!n)return a;n(a)}}function decodeFileWithAudioContext(e,t,n){Audio.converter=new AudioContext({sampleRate:t.info.sampleRate}),Audio.converter.decodeAudioData(e.buffer,function(e){e?(t.data=e.getChannelData(0),t.data&&!t.data.concat&&(t.data=Array.from(t.data)),t.length=e.length,n&&n()):alert("error decoding file data: "+url)},function(e){n&&n()})}function getSamplerate(e,t){function n(e){for(var t=[],n=Math.min(e.length,1048576),a=0;a<n;a++)t.push(String.fromCharCode(e[a]));return t.join("")}function a(e){for(var t=500;t<e.length-1;t++)if(255===e[t]&&224==(224&e[t+1])){var n=[4,0,2,1],a=[44100,48e3,32e3],r=(24&e[t+1])>>3,i=(6&e[t+1])>>1,o=(12&e[t+2])>>2,s=(192&e[t+3])>>6;return{ID:r,Layer:i,srate:o,type:"MP3",info:["MPEG Version 2.5","reserved","MPEG Version 2","MPEG Version 1"][r]+" "+["reserved","Layer III","Layer II","Layer I"][i],sampleRate:isNaN(a[o]/n[r])?Audio.context.sampleRate:a[o]/n[r],numberOfChannels:[2,2,2,1][s]}}return!1}var r={},i=new Uint8Array(e.buffer);if(r.type=String.fromCharCode(i[0])+String.fromCharCode(i[1])+String.fromCharCode(i[2])+String.fromCharCode(i[3]),"RIFF"===r.type){r.type="WAVE_PCM",r.chunkSize=i[4]+(i[5]<<8)+(i[6]<<16)+(i[7]<<24);var o=n(i).indexOf("fmt ");r.audioFormat=i[o+8]+(i[o+9]<<8),r.numberOfChannels=i[o+10]+(i[o+11]<<8),r.sampleRate=i[o+12]+(i[o+13]<<8)+(i[o+14]<<16)+(i[o+15]<<24),r.bits=i[o+22]+(i[o+23]<<8)}else if("fLaC"===r.type)r.type="FLAC",r.sampleRate=(i[18]<<12)+(i[19]<<4)+((240&i[20])>>4),r.numberOfChannels=1+((14&i[20])>>1),r.bits=((1&i[20])<<4)+((240&i[21])>>4)+1;else if("OggS"===r.type){var s=n(i).indexOf("OpusHead");-1!=s?(s+=8,r.type="OPUS",r.version=i[s],r.numberOfChannels=i[s+1],r.preSkip=i[s+2]+(i[s+3]<<8),r.sampleRate=i[s+4]+(i[s+5]<<8)+(i[s+6]<<16)+(i[s+7]<<24)):(r.type="OGG",r.numberOfChannels=i[39],r.sampleRate=i[40]+(i[41]<<8)+(i[42]<<16)+(i[43]<<24)+(i[44]<<32)+(i[45]<<40)+(i[46]<<48)+(i[47]<<56),r.bits=i[48]+(i[49]<<8)+(i[50]<<16)+(i[51]<<24))}else if(String.fromCharCode(i[4])+String.fromCharCode(i[5])+String.fromCharCode(i[6])+String.fromCharCode(i[7])==="ftyp"){r.type="MP4";var l=n(i).indexOf("mdhd");r.sampleRate=1===i[l+4]?(i[l+16+8]<<24)+(i[l+17+8]<<16)+(i[l+18+8]<<8)+i[l+19+8]:(i[l+16]<<24)+(i[l+17]<<16)+(i[l+18]<<8)+i[l+19]}else("ID3"===r.type.substring(0,3)||"mp3"===t)&&(r=a(i));return r}function readRAWsample(e,t){e.goto(0);for(var n=0;n<t.length;n++){var a=e.readByte();t.data.push(a/127)}}function encodeRIFFsample(e,t){var n=e.length,a=8e3;16===t&&(n=2*e.length,a=16e3);var r=n;r%2==1&&r++;var i=new BinaryStream(new ArrayBuffer(46+r),!1);if(i.goto(0),i.writeString("RIFF"),i.writeDWord(38+r),i.writeString("WAVE"),i.writeString("fmt "),i.writeDWord(18),i.writeWord(1),i.writeWord(1),i.writeDWord(8e3),i.writeDWord(a),i.writeWord(Math.floor(t/8)),i.writeWord(t),i.writeWord(0),i.writeString("data"),i.writeDWord(n),16===t)for(var o=0;o<e.length;o++)i.writeWord(32767*e[o]);else for(o=0;o<e.length;o++)i.writeUByte(Math.round(127*e[o])+127);return n<r&&i.writeUByte(0),i}var cachedAssets={images:{},audio:{},json:{},arrayBuffer:{}},sprites={},UI=void 0,PRELOADTYPE={image:1,audio:2,json:3,binary:4},EVENT={instrumentChange:1,patternChange:2,patternPosChange:3,patternTableChange:4,recordingChange:5,cursorPositionChange:6,trackStateChange:7,playingChange:8,playTypeChange:9,songPositionChange:10,songSpeedChange:11,songBPMChange:12,samplePlay:13,screenRefresh:14,screenRender:15,songPropertyChange:16,instrumentNameChange:17,command:18,pianoNoteOn:19,pianoNoteOff:20,statusChange:21,diskOperationTargetChange:22,diskOperationActionChange:23,trackCountChange:24,patternHorizontalScrollChange:25,songLoaded:26,songLoading:27,trackerModeChanged:28,instrumentListChange:29,showView:30,toggleView:31,visibleTracksCountChange:32,filterChainCountChange:33,fxPanelToggle:34,samplePropertyChange:35,sampleIndexChange:36,second:37,minute:38,dropboxConnect:39,dropboxConnectCancel:40,trackScopeClick:41,octaveChanged:42,skipFrameChanged:43,showContextMenu:44,hideContextMenu:45,clockEventExpired:46,commandUndo:50,commandRedo:51,commandSelectAll:52,songEnd:53,patternEnd:54,songSpeedChangeIgnored:55,songBPMChangeIgnored:56,commandProcessSample:57,pluginRenderHook:58,menuLayoutChanged:59,midiIn:60},COMMAND={newFile:1,openFile:2,saveFile:3,clearTrack:4,clearPattern:5,clearSong:6,clearInstruments:7,showMain:8,showOptions:9,showFileOperations:10,showSampleEditor:11,showAbout:12,showHelp:13,togglePiano:14,showTopMain:15,showBottomMain:16,randomSong:17,randomSongXM:18,showGithub:19,showStats:20,cut:21,copy:22,paste:23,pattern2Sample:24,toggleAppSideBar:25,undo:26,redo:27,nibbles:28,generator:29},PLAYTYPE={song:1,pattern:2},FILETYPE={module:1,sample:2,pattern:3,track:4},MODULETYPE={mod:1,xm:2},SAMPLETYPE={RAW_8BIT:1,WAVE_PCM:2,IFF_8SVX:3,MP3:4,RIFF_8BIT:5,RIFF_16BIT:6,FLAC:5,OGG:9,OPUS:10},STEREOSEPARATION={FULL:1,BALANCED:2,NONE:3},FREQUENCYTABLE={AMIGA:1,LINEAR:2},LOOPTYPE={NONE:0,FORWARD:1,PINGPONG:2},SELECTION={RESET:1,CLEAR:2,CUT:3,COPY:4,PASTE:5,POSITION:6,DELETE:7,REPLACE:8},EDITACTION={PATTERN:1,TRACK:2,NOTE:3,RANGE:4,VALUE:5,DATA:6,SAMPLE:7},AMIGA_PALFREQUENCY=7093790,PC_FREQUENCY=7158728,AMIGA_PALFREQUENCY_HALF=AMIGA_PALFREQUENCY/2,PC_FREQUENCY_HALF=PC_FREQUENCY/2,LAYOUTS={column4:4,column5:5,column5Full:6,column6:7},NOTEPERIOD={C1:{period:856,name:"C-1",tune:[907,900,894,887,881,875,868,862,856,850,844,838,832,826,820,814]},Cs1:{period:808,name:"C#1",tune:[856,850,844,838,832,826,820,814,808,802,796,791,785,779,774,768]},D1:{period:762,name:"D-1",tune:[808,802,796,791,785,779,774,768,762,757,752,746,741,736,730,725]},Ds1:{period:720,name:"D#1",tune:[762,757,752,746,741,736,730,725,720,715,709,704,699,694,689,684]},E1:{period:678,name:"E-1",tune:[720,715,709,704,699,694,689,684,678,674,670,665,660,655,651,646]},F1:{period:640,name:"F-1",tune:[678,675,670,665,660,655,651,646,640,637,632,628,623,619,614,610]},Fs1:{period:604,name:"F#1",tune:[640,636,632,628,623,619,614,610,604,601,597,592,588,584,580,575]},G1:{period:570,name:"G-1",tune:[604,601,597,592,588,584,580,575,570,567,563,559,555,551,547,543]},Gs1:{period:538,name:"G#1",tune:[570,567,563,559,555,551,547,543,538,535,532,528,524,520,516,513]},A1:{period:508,name:"A-1",tune:[538,535,532,528,524,520,516,513,508,505,502,498,495,491,487,484]},As1:{period:480,name:"A#1",tune:[508,505,502,498,494,491,487,484,480,477,474,470,467,463,460,457]},B1:{period:453,name:"B-1",tune:[480,477,474,470,467,463,460,457,453,450,447,444,441,437,434,431]},C2:{period:428,name:"C-2",tune:[453,450,447,444,441,437,434,431,428,425,422,419,416,413,410,407]},Cs2:{period:404,name:"C#2",tune:[428,425,422,419,416,413,410,407,404,401,398,395,392,390,387,384]},D2:{period:381,name:"D-2",tune:[404,401,398,395,392,390,387,384,381,379,376,373,370,368,365,363]},Ds2:{period:360,name:"D#2",tune:[381,379,376,373,370,368,365,363,360,357,355,352,350,347,345,342]},E2:{period:339,name:"E-2",tune:[360,357,355,352,350,347,345,342,339,337,335,332,330,328,325,323]},F2:{period:320,name:"F-2",tune:[339,337,335,332,330,328,325,323,320,318,316,314,312,309,307,305]},Fs2:{period:302,name:"F#2",tune:[320,318,316,314,312,309,307,305,302,300,298,296,294,292,290,288]},G2:{period:285,name:"G-2",tune:[302,300,298,296,294,292,290,288,285,284,282,280,278,276,274,272]},Gs2:{period:269,name:"G#2",tune:[285,284,282,280,278,276,274,272,269,268,266,264,262,260,258,256]},A2:{period:254,name:"A-2",tune:[269,268,266,264,262,260,258,256,254,253,251,249,247,245,244,242]},As2:{period:240,name:"A#2",tune:[254,253,251,249,247,245,244,242,240,239,237,235,233,232,230,228]},B2:{period:226,name:"B-2",tune:[240,238,237,235,233,232,230,228,226,225,224,222,220,219,217,216]},C3:{period:214,name:"C-3",tune:[226,225,223,222,220,219,217,216,214,213,211,209,208,206,205,204]},Cs3:{period:202,name:"C#3",tune:[214,212,211,209,208,206,205,203,202,201,199,198,196,195,193,192]},D3:{period:190,name:"D-3",tune:[202,200,199,198,196,195,193,192,190,189,188,187,185,184,183,181]},Ds3:{period:180,name:"D#3",tune:[190,189,188,187,185,184,183,181,180,179,177,176,175,174,172,171]},E3:{period:170,name:"E-3",tune:[180,179,177,176,175,174,172,171,170,169,167,166,165,164,163,161]},F3:{period:160,name:"F-3",tune:[170,169,167,166,165,164,163,161,160,159,158,157,156,155,154,152]},Fs3:{period:151,name:"F#3",tune:[160,159,158,157,156,155,154,152,151,150,149,148,147,146,145,144]},G3:{period:143,name:"G-3",tune:[151,150,149,148,147,146,145,144,143,142,141,140,139,138,137,136]},Gs3:{period:135,name:"G#3",tune:[143,142,141,140,139,138,137,136,135,134,133,132,131,130,129,128]},A3:{period:127,name:"A-3",tune:[135,134,133,132,131,130,129,128,127,126,125,125,124,123,122,121]},As3:{period:120,name:"A#3",tune:[127,126,125,125,123,123,122,121,120,119,118,118,117,116,115,114]},B3:{period:113,name:"B-3",tune:[120,119,118,118,117,116,115,114,113,113,112,111,110,109,109,108]}},FTNOTEPERIOD={None:{name:"---"},C0:{name:"C-0",period:6848},Cs0:{name:"C#0",period:6464},D0:{name:"D-0",period:6096},Ds0:{name:"D#0",period:5760},E0:{name:"E-0",period:5424},F0:{name:"F-0",period:5120},Fs0:{name:"F#0",period:4832},G0:{name:"G-0",period:4560},Gs0:{name:"G#0",period:4304},A0:{name:"A-0",period:4064},As0:{name:"A#0",period:3840},B0:{name:"B-0",period:3624},C1:{name:"C-1",period:3424},Cs1:{name:"C#1",period:3232},D1:{name:"D-1",period:3048},Ds1:{name:"D#1",period:2880},E1:{name:"E-1",period:2712},F1:{name:"F-1",period:2560},Fs1:{name:"F#1",period:2416},G1:{name:"G-1",period:2280},Gs1:{name:"G#1",period:2152},A1:{name:"A-1",period:2032},As1:{name:"A#1",period:1920},B1:{name:"B-1",period:1812},C2:{name:"C-2",period:1712},Cs2:{name:"C#2",period:1616},D2:{name:"D-2",period:1524},Ds2:{name:"D#2",period:1440},E2:{name:"E-2",period:1356},F2:{name:"F-2",period:1280},Fs2:{name:"F#2",period:1208},G2:{name:"G-2",period:1140},Gs2:{name:"G#2",period:1076},A2:{name:"A-2",period:1016},As2:{name:"A#2",period:960},B2:{name:"B-2",period:906},C3:{name:"C-3",period:856},Cs3:{name:"C#3",period:808},D3:{name:"D-3",period:762},Ds3:{name:"D#3",period:720},E3:{name:"E-3",period:678},F3:{name:"F-3",period:640},Fs3:{name:"F#3",period:604},G3:{name:"G-3",period:570},Gs3:{name:"G#3",period:538},A3:{name:"A-3",period:508},As3:{name:"A#3",period:480},B3:{name:"B-3",period:453},C4:{name:"C-4",period:428},Cs4:{name:"C#4",period:404},D4:{name:"D-4",period:381},Ds4:{name:"D#4",period:360},E4:{name:"E-4",period:339},F4:{name:"F-4",period:320},Fs4:{name:"F#4",period:302},G4:{name:"G-4",period:285},Gs4:{name:"G#4",period:269},A4:{name:"A-4",period:254},As4:{name:"A#4",period:240},B4:{name:"B-4",period:226.5,modPeriod:226},C5:{name:"C-5",period:214},Cs5:{name:"C#5",period:202},D5:{name:"D-5",period:190.5,modPeriod:190},Ds5:{name:"D#5",period:180},E5:{name:"E-5",period:169.5,modPeriod:170},F5:{name:"F-5",period:160},Fs5:{name:"F#5",period:151},G5:{name:"G-5",period:142.5,modPeriod:143},Gs5:{name:"G#5",period:134.5,modPeriod:135},A5:{name:"A-5",period:127},As5:{name:"A#5",period:120},B5:{name:"B-5",period:113.25,modPeriod:113},C6:{name:"C-6",period:107},Cs6:{name:"C#6",period:101},D6:{name:"D-6",period:95.25,modPeriod:95},Ds6:{name:"D#6",period:90},E6:{name:"E-6",period:84.75,modPeriod:85},F6:{name:"F-6",period:80},Fs6:{name:"F#6",period:75.5,modPeriod:75},G6:{name:"G-6",period:71.25,modPeriod:71},Gs6:{name:"G#6",period:67.25,modPeriod:67},A6:{name:"A-6",period:63.5,modPeriod:63},As6:{name:"A#6",period:60},B6:{name:"B-6",period:56.625,modPeriod:56},C7:{name:"C-7",period:53.5,modPeriod:53},Cs7:{name:"C#7",period:50.5,modPeriod:50},D7:{name:"D-7",period:47.625,modPeriod:47},Ds7:{name:"D#7",period:45},E7:{name:"E-7",period:42.375,modPeriod:42},F7:{name:"F-7",period:40},Fs7:{name:"F#7",period:37.75,modPeriod:37},G7:{name:"G-7",period:35.625,modPeriod:35},Gs7:{name:"G#7",period:33.625,modPeriod:33},A7:{name:"A-7",period:31.75,modPeriod:31},As7:{name:"A#7",period:30},B7:{name:"B-7",period:28.3125,modPeriod:28},C8:{name:"C-8",period:26.75},Cs8:{name:"C#8",period:25.25},D8:{name:"D-8",period:23.8125},Ds8:{name:"D#8",period:22.5},E8:{name:"E-8",period:21.1875},F8:{name:"F-8",period:20},Fs8:{name:"F#8",period:18.875},G8:{name:"G-8",period:17.8125},Gs8:{name:"G#8",period:16.8125},A8:{name:"A-8",period:15.875},As8:{name:"A#8",period:15},B8:{name:"B-8",period:14.15625},C9:{name:"C-9",period:13.375},Cs9:{name:"C#9",period:12.625},D9:{name:"D-9",period:11.90625},Ds9:{name:"D#9",period:11.25},E9:{name:"E-9",period:10.59375},F9:{name:"F-9",period:10},Fs9:{name:"F#9",period:9.4375},G9:{name:"G-9",period:8.90625},Gs9:{name:"G#9",period:8.40625},A9:{name:"A-9",period:7.9375},As9:{name:"A#9",period:7.5},B9:{name:"B-9",period:7.078125},C10:{name:"C-10",period:6.6875},Cs10:{name:"C#10",period:6.3125},D10:{name:"D-10",period:5.953125},Ds10:{name:"D#10",period:5.625},E10:{name:"E-10",period:5.296875},F10:{name:"F-10",period:5},Fs10:{name:"F#10",period:4.71875},G10:{name:"G-10",period:4.453125},Gs10:{name:"G#10",period:4.203125},A10:{name:"A-10",period:3.96875},As10:{name:"A#10",period:3.75},B10:{name:"B-10",period:3.5390625},C11:{name:"C-11",period:3.34375},Cs11:{name:"C#11",period:3.15625},D11:{name:"D-11",period:2.9765625},Ds11:{name:"D#11",period:2.8125},E11:{name:"E-11",period:2.6484375},F11:{name:"F-11",period:2.5},Fs11:{name:"F#11",period:2.359375},G11:{name:"G-11",period:2.2265625},Gs11:{name:"G#11",period:2.1015625},A11:{name:"A-11",period:1.984375},As11:{name:"A#11",period:1.875},B11:{name:"B-11",period:1.76953125},OFF:{name:"OFF",period:0}},NOTEOFF=145,KEYBOARDKEYS={OFF:0,C:1,Csharp:2,D:3,Dsharp:4,E:5,F:6,Fsharp:7,G:8,Gsharp:9,A:10,Asharp:11,B:12,COctaveUp:13,CsharpOctaveUp:14,DOctaveUp:15,DsharpOctaveUp:16,EOctaveUp:17,FOctaveUp:18,FsharpOctaveUp:19,GOctaveUp:20,GsharpOctaveUp:21,AOctaveUp:22,AsharpOctaveUp:23,BOctaveUp:24,COctaveUp2:25,CsharpOctaveUp2:26,DOctaveUp2:27},OCTAVENOTES={0:{name:"OFF"},1:{name:"C"},2:{name:"Cs"},3:{name:"D"},4:{name:"Ds"},5:{name:"E"},6:{name:"F"},7:{name:"Fs"},8:{name:"G"},9:{name:"Gs"},10:{name:"A"},11:{name:"As"},12:{name:"B"}},KEYBOARDTABLE={azerty:{a:KEYBOARDKEYS.COctaveUp,z:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,y:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,i:KEYBOARDKEYS.COctaveUp2,o:KEYBOARDKEYS.DOctaveUp2,"é":KEYBOARDKEYS.CsharpOctaveUp,'"':KEYBOARDKEYS.DsharpOctaveUp,"(":KEYBOARDKEYS.FsharpOctaveUp,"§":KEYBOARDKEYS.GsharpOctaveUp,"è":KEYBOARDKEYS.AsharpOctaveUp,"ç":KEYBOARDKEYS.CsharpOctaveUp2,w:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,n:KEYBOARDKEYS.A,",":KEYBOARDKEYS.B,";":KEYBOARDKEYS.COctaveUp,":":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"<":KEYBOARDKEYS.OFF},dvorak:{"'":KEYBOARDKEYS.COctaveUp,",":KEYBOARDKEYS.DOctaveUp,".":KEYBOARDKEYS.EOctaveUp,p:KEYBOARDKEYS.FOctaveUp,y:KEYBOARDKEYS.GOctaveUp,f:KEYBOARDKEYS.AOctaveUp,g:KEYBOARDKEYS.BOctaveUp,c:KEYBOARDKEYS.COctaveUp2,r:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,";":KEYBOARDKEYS.C,q:KEYBOARDKEYS.D,j:KEYBOARDKEYS.E,k:KEYBOARDKEYS.F,x:KEYBOARDKEYS.G,b:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,w:KEYBOARDKEYS.COctaveUp,v:KEYBOARDKEYS.DOctaveUp,o:KEYBOARDKEYS.Csharp,e:KEYBOARDKEYS.Dsharp,i:KEYBOARDKEYS.Fsharp,d:KEYBOARDKEYS.Gsharp,h:KEYBOARDKEYS.Asharp,n:KEYBOARDKEYS.CsharpOctaveUp,"\\":KEYBOARDKEYS.OFF},qwerty:{q:KEYBOARDKEYS.COctaveUp,w:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,y:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,i:KEYBOARDKEYS.COctaveUp2,o:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,z:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,n:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,",":KEYBOARDKEYS.COctaveUp,".":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"\\":KEYBOARDKEYS.OFF},qwertz:{q:KEYBOARDKEYS.COctaveUp,w:KEYBOARDKEYS.DOctaveUp,e:KEYBOARDKEYS.EOctaveUp,r:KEYBOARDKEYS.FOctaveUp,t:KEYBOARDKEYS.GOctaveUp,z:KEYBOARDKEYS.AOctaveUp,u:KEYBOARDKEYS.BOctaveUp,i:KEYBOARDKEYS.COctaveUp2,o:KEYBOARDKEYS.DOctaveUp2,2:KEYBOARDKEYS.CsharpOctaveUp,3:KEYBOARDKEYS.DsharpOctaveUp,5:KEYBOARDKEYS.FsharpOctaveUp,6:KEYBOARDKEYS.GsharpOctaveUp,7:KEYBOARDKEYS.AsharpOctaveUp,9:KEYBOARDKEYS.CsharpOctaveUp2,y:KEYBOARDKEYS.C,x:KEYBOARDKEYS.D,c:KEYBOARDKEYS.E,v:KEYBOARDKEYS.F,b:KEYBOARDKEYS.G,n:KEYBOARDKEYS.A,m:KEYBOARDKEYS.B,",":KEYBOARDKEYS.COctaveUp,".":KEYBOARDKEYS.DOctaveUp,s:KEYBOARDKEYS.Csharp,d:KEYBOARDKEYS.Dsharp,g:KEYBOARDKEYS.Fsharp,h:KEYBOARDKEYS.Gsharp,j:KEYBOARDKEYS.Asharp,"\\":KEYBOARDKEYS.OFF}},TRACKERMODE={PROTRACKER:1,FASTTRACKER:2},SETTINGS={unrollLoops:!1,unrollShortLoops:!1,sustainKeyboardNotes:!1,useHover:!0,keyboardTable:"qwerty",vubars:!0,stereoSeparation:STEREOSEPARATION.BALANCED,emulateProtracker1OffsetBug:!0,loadInitialFile:!0},EventBus=(a={},b={on:function(e,t){var n=a[e];return n||(a[e]=n=[]),n.push(t),n.length},off:function(e,t){var n=a[e];n&&(n[t-1]=void 0)},trigger:function(e,t){var n=a[e];if(n){var r,i=n.length;for(r=0;r<i;r++)n[r]&&n[r](t,e)}}},b),a,b,Audio=function(){function r(e,t){(n=e.createGain()).gain.setValueAtTime(1,0);n.connect(t||e.destination),(i=e.createGain()).connect(n),A.setMasterVolume(1),(o=e.createBiquadFilter()).type="lowpass",o.frequency.setValueAtTime(2e4,0),o.connect(i),A.masterVolume=i,A.cutOffVolume=n,A.lowPassfilter=o}var x,i,n,o,P,A={};window.AudioContext=window.AudioContext||window.webkitAudioContext,window.OfflineAudioContext=window.OfflineAudioContext||window.webkitOfflineAudioContext;var t,a,U,s,M,_,L=[],l=[],c=STEREOSEPARATION.BALANCED,u=0,D=[[],[],[]],O=0,N=4143.569,d={volume:!0,panning:!0,high:!0,mid:!0,low:!0,lowPass:!0,reverb:!0,distortion:!1,delay:!1},B=!1;return AudioContext&&(x=new AudioContext),A.init=function(e,t){function n(){var e=FilterChain(d);e.output().connect(o),L.push(e)}if(A.context=x=e=e||x,e){M=!!Audio.context.createStereoPanner,_=void 0!==Editor,r(e,t);var a=Tracker.getTrackCount();for(L=[],P=0;P<a;P++)n();A.filterChains=L,A.usePanning=M,B||(EventBus.on(EVENT.trackStateChange,function(e){void 0!==e.track&&L[e.track]&&L[e.track].volumeValue(e.mute?0:70)}),EventBus.on(EVENT.trackCountChange,function(e){for(P=L.length;P<e;P++)n();EventBus.trigger(EVENT.filterChainCountChange,e),A.setStereoSeparation(c)}),EventBus.on(EVENT.trackerModeChanged,function(e){A.setStereoSeparation()}))}},A.enable=function(){n.gain.setValueAtTime(1,0),A.cutOff=!1},A.disable=function(){n.gain.setValueAtTime(0,0),A.cutOff=!0;D.forEach(function(e,t){e.forEach(function(e){e.gain.cancelScheduledValues(0),e.gain.setValueAtTime(0,0)}),D[t]=[]})},A.checkState=function(){x&&"suspended"===x.state&&x.resume&&x.resume()},A.playSample=function(e,t,n,a,r,i,o){var s;B?s=U:(s=x,A.enable()),t=t||428,void 0===a&&(a=_?Editor.getCurrentTrack():0),i=i||x.currentTime,o===NOTEOFF&&(n=0);var l,c,u,d=Tracker.getInstrument(e),h=t,f=0;if(d){var g,p,m=0,v=0;n=void 0===n?100*d.sample.volume/64:n,f=(d.sample.panning||0)/128,Tracker.inFTMode()?Tracker.useLinearFrequency?t-=d.getFineTune()/2:d.getFineTune()&&(t=A.getFineTuneForNote(o,d.getFineTune())):d.getFineTune()&&(t=A.getFineTuneForPeriod(t,d.getFineTune())),p=A.getSampleRateForPeriod(t);var b=1;d.sample.data.length?(v=d.sample.data.length,r&&r.offset&&(v<=r.offset.value&&(r.offset.value=v-1),m=r.offset.value/s.sampleRate),g=s.createBuffer(1,v,s.sampleRate),b=p/s.sampleRate):(g=s.createBuffer(1,1,s.sampleRate),m=0);var E=g.getChannelData(0);for(P=0;P<v;P++)E[P]=d.sample.data[P];N=p;var w=s.createBufferSource();w.buffer=g;var T=s.createGain();if(T.gain.value=n/100,T.gain.setValueAtTime(n/100,i),d.sample.loop.enabled&&2<d.sample.loop.length&&(SETTINGS.unrollLoops||(w.loop=!0,w.loopStart=d.sample.loop.start/s.sampleRate,w.loopEnd=(d.sample.loop.start+d.sample.loop.length)/s.sampleRate)),d.volumeEnvelope.enabled||d.panningEnvelope.enabled||d.hasVibrato()){var I=d.noteOn(i),k=w;I.volume&&(w.connect(l=I.volume),k=l),I.panning&&(k.connect(c=I.panning),k=c),u=I.scheduled,k.connect(T)}else w.connect(T);var S=Audio.context.createGain();if(S.gain.setValueAtTime(0,i),S.gain.linearRampToValueAtTime(1,i+.01),T.connect(S),M){var C=Audio.context.createStereoPanner();C.pan.setValueAtTime(f,i),S.connect(C),C.connect(L[a].input())}else S.connect(L[a].input());w.playbackRate.value=b;w.start(i+0,m);var y={source:w,volume:T,panning:C,volumeEnvelope:l,panningEnvelope:c,volumeFadeOut:S,startVolume:n,currentVolume:n,startPeriod:t,basePeriod:h,noteIndex:o,startPlaybackRate:b,sampleRate:p,instrumentIndex:e,effects:r,track:a,time:i,scheduled:u};return D[O].push(T),B||EventBus.trigger(EVENT.samplePlay,y),y}return{}},A.playSilence=function(){if(x){var e=x.createBufferSource();e.connect(i);try{e.start()}catch(e){}}},A.playRaw=function(e,t){if(x&&e&&e.length){var n;n=x.createBuffer(1,e.length,x.sampleRate);var a=t/audioContext.sampleRate,r=x.createBufferSource();r.buffer=n,r.loop=!0,r.playbackRate.value=a,r.connect(i),r.start()}},A.isRecording=function(){return t},A.startRecording=function(){if(!t&&x&&x.createMediaStreamDestination){var e=x.createMediaStreamDestination();(a=new MediaRecorder(e.stream)).ondataavailable=function(e){l.push(e.data)},a.onstop=function(e){var t=new Blob(l,{type:"audio/ogg; codecs=opus"});saveAs(t,"recording.opus")},i.connect(e),a.start(),t=!0}},A.stopRecording=function(){t&&(t=!1,a.stop())},A.startRendering=function(e){B=!0,U=new OfflineAudioContext(2,44100*e,44100),s=x,A.context=U,A.init(U)},A.stopRendering=function(t){B=!1,U.startRendering().then(function(e){t&&t(e)}).catch(function(e){}),r(A.context=s),A.init(s)},A.setStereoSeparation=function(e){var t,n=Tracker.getTrackCount();if(Tracker.inFTMode())t=0;else switch(c=e=e||c){case STEREOSEPARATION.NONE:t=0,SETTINGS.stereoSeparation=STEREOSEPARATION.NONE;break;case STEREOSEPARATION.FULL:t=1,SETTINGS.stereoSeparation=STEREOSEPARATION.FULL;break;default:t=.5,SETTINGS.stereoSeparation=STEREOSEPARATION.BALANCED}for(P=0;P<n;P++){var a=L[P];a&&a.panningValue(P%4==0||P%4==3?-t:t)}},A.getPrevSampleRate=function(){return N},A.context=x,A.getSemiToneFrom=function(e,t,n){var a=e;if(n&&(e=(e=A.getFineTuneBasePeriod(e,n))||a),t){var r=periodNoteTable[e];if(r){var i=noteNames.indexOf(r.name),o=noteNames[i+t];if(o){var s=nameNoteTable[o];s&&(a=s.period,n&&(a=A.getFineTuneForPeriod(a,n)))}}}return a},A.getNearestSemiTone=function(n,e){var t,a,r,i=n,o=1e5,s=Tracker.getInstrument(e);if(Tracker.inFTMode()){var l=0;FTNotes.forEach(function(e,t){(a=e.period)&&(r=Math.abs(a-n))<o&&(o=r,i=a,l=t)}),l&&s&&s.getFineTune()&&(Tracker.useLinearFrequency?i-=s.getFineTune()/2:i=A.getFineTuneForNote(l,s.getFineTune()))}else{var c=8;for(t in e&&s&&s.sample.finetune&&(c+=s.sample.finetune),NOTEPERIOD)NOTEPERIOD.hasOwnProperty(t)&&(a=NOTEPERIOD[t].tune[c],(r=Math.abs(a-n))<o&&(o=r,i=a))}return i},A.getFineTuneForPeriod=function(e,t){var n=e,a=periodNoteTable[e];if(a&&a.tune){var r=8+t;0<=r&&r<a.tune.length&&(n=a.tune[r])}return n},A.getFineTuneForNote=function(e,t){if(e===NOTEOFF)return 1;var n=FTNotes[e],a=0<t?FTNotes[e+1]:FTNotes[e-1];if(n&&a){var r=Math.abs(a.period-n.period)/127;return n.period-r*t}return n?n.period:1e5},A.getFineTuneBasePeriod=function(e,t){var n=e,a=periodFinetuneTable[t];return a&&(n=a[e]),n},A.getSampleRateForPeriod=function(e){return Tracker.inFTMode()?Tracker.useLinearFrequency?8363*Math.pow(2,(4608-e)/768):PC_FREQUENCY_HALF/e:AMIGA_PALFREQUENCY_HALF/e},A.limitAmigaPeriod=function(e){return e=Math.max(e,113),e=Math.min(e,856)},A.setAmigaLowPassFilter=function(e,t){o.frequency.setValueAtTime(e?2e3:2e4,t)},A.setMasterVolume=function(e,t){e*=.7,i.gain.setValueAtTime(u,t=t||x.currentTime),i.gain.linearRampToValueAtTime(e,t+.02),u=e},A.slideMasterVolume=function(e,t){i.gain.linearRampToValueAtTime(e*=.7,t=t||x.currentTime),u=e},A.getLastMasterVolume=function(){return u/.7},A.clearScheduledNotesCache=function(){2<++O&&(O=0),D[O]=[]},A.waveFormFunction={sine:function(e,t,n,a){return e+Math.sin(t*n*.8)*a*1.7},saw:function(e,t,n,a){var r=1-Math.abs(t*n/7%1);return e+(r=(r=2*r-1)*a*-2)},square:function(e,t,n,a){var r=Math.sin(t*n)<=0?-1:1;return e+(r=r*a*2)},sawInverse:function(e,t,n,a){var r=Math.abs(t*n/7%1);return e+(r=(r=2*r-1)*a*-2)}},A}();!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t():e[e.__dropbox_export||"dropboxService"]=t()}(this,function(){"use strict";function f(e){return"[object Function]"==g.call(e)}function e(n,e){var t=[].slice.call(arguments),a=v[n]||{},r=a.baseUri||"https://api.dropboxapi.com/2/",i=a.format||"rpc",o=a.contentType||null===a.contentType?null:b[i],s=t[t.length-1],l=2<t.length&&("[object Object]"==g.call(s)||f(s))?s:{};f(l)&&(l={onComplete:l});var c,u={};Promise&&(c=new Promise(function(e,t){u.resolve=e,u.reject=t}));var d=new XMLHttpRequest;d.open("POST",r+n,!0),d.setRequestHeader("Authorization","Bearer "+(p("__dbat")||"000000000000000000000000_00000-000000000000000000000000000000000")),"content-download"==i&&(d.responseType="blob"),e&&e.responseType&&(d.responseType=e.responseType,delete e.responseType),o&&d.setRequestHeader("Content-Type",o),!e||"content-upload"!=i&&"content-download"!=i||d.setRequestHeader("Dropbox-API-Arg",JSON.stringify(e)),l.onDownloadProgress&&d.addEventListener("progress",l.onDownloadProgress),l.onUploadProgress&&d.upload&&d.upload.addEventListener("progress",l.onUploadProgress),(l.onError||m)&&d.addEventListener("error",function(e){var t=l.onError&&l.onError(e.target);c&&u.reject&&u.reject(e.target),m&&m(e.target,t)}),d.onreadystatechange=function(){if(4==d.readyState)if(200==d.status){var e=JSON.parse(d.getResponseHeader("dropbox-api-result")||d.responseText);"auth/token/revoke"==n&&p("__dbat",""),l.onComplete&&l.onComplete(e,d.response,d),c&&u.resolve&&u.resolve(e,d.response,d)}else{var t=l.onError&&l.onError(d);c&&u.reject&&u.reject(d),m&&m(d,t)}};var h=2<t.length&&"content-upload"==i?t[2]:void 0;return(h=h||(e&&"rpc"==i?JSON.stringify(e):null))?d.send(h):d.send(),c}var g={}.toString,t="https://content.dropboxapi.com/2/",p=function(e,t){return 1<arguments.length?localStorage[e]=t:localStorage[e]},m=void 0,v={"auth/token/revoke":{contentType:null},"users/get_current_account":{contentType:"application/json"},"files/upload":{baseUri:t,format:"content-upload"},"files/get_thumbnail":{baseUri:t,format:"content-download"},"files/download":{baseUri:t,format:"content-download"},"files/get_preview":{baseUri:t,format:"content-download"},"files/upload_session/append":{baseUri:t,format:"content-upload"},"files/upload_session/append_v2":{baseUri:t,format:"content-upload"},"files/upload_session/finish":{baseUri:t,format:"content-upload"},"files/upload_session/start":{baseUri:t,format:"content-upload"},"files/get_shared_link_file":{baseUri:t,format:"content-download"}},b={rpc:"application/json","content-upload":"application/octet-stream"};return e.setGlobalErrorHandler=function(e){m=e},e.setTokenStore=function(e){p=e},e.authenticate=function(e,t){f(t=t||{})&&(t={onComplete:t}),"[object String]"==g.call(e=e||{})&&(e={client_id:e}),e.redirect_uri=e.redirect_uri||window.location.href;var n,a={};if(Promise&&(n=new Promise(function(e,t){a.resolve=e,a.reject=t})),p("__dbat"))return t.onComplete(),n&&n.resolve&&n.resolve(),n;var r=window.location.hash.replace(/^#/,"").split("&").reduce(function(e,t){return""==t||(t=t.split("="),e[decodeURIComponent(t[0])]=decodeURIComponent(t[1])),e},{}),i=p("__dbcsrf");if(r.state&&i&&r.state==i)if(r.access_token)p("__dbat",r.access_token),p("__dbcsrf",""),window.location.replace(window.location.href.replace(/#.*/,""));else{var o=t.onError&&t.onError(r);n&&n.reject&&n.reject(r),m&&m(r,o)}else i=""+Math.floor(1e5*Math.random()),p("__dbcsrf",i),window.location="https://www.dropbox.com/1/oauth2/authorize?response_type=token&client_id="+encodeURIComponent(e.client_id)+"&redirect_uri="+encodeURIComponent(e.redirect_uri)+"&state="+encodeURIComponent(i);return n},e.getAccessToken=function(){return p("__dbat")},e.clearAccessToken=function(){return p("__dbat","")},e});var saveAs=saveAs||function(s){"use strict";if(!(void 0===s||"undefined"!=typeof navigator&&/MSIE [1-9]\./.test(navigator.userAgent))){var l=function(){return s.URL||s.webkitURL||s},c=s.document.createElementNS("http://www.w3.org/1999/xhtml","a"),u="download"in c,d=/constructor/i.test(s.HTMLElement)||s.safari,h=/CriOS\/[\d]+/.test(navigator.userAgent),f=function(e){(s.setImmediate||s.setTimeout)(function(){throw e},0)},g=function(e){setTimeout(function(){"string"==typeof e?l().revokeObjectURL(e):e.remove()},4e4)},p=function(e){return/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob([String.fromCharCode(65279),e],{type:e.type}):e},a=function(e,n,t){t||(e=p(e));function a(){!function(e,t,n){for(var a=(t=[].concat(t)).length;a--;){var r=e["on"+t[a]];if("function"==typeof r)try{r.call(e,n||e)}catch(e){f(e)}}}(i,"writestart progress write writeend".split(" "))}var r,i=this,o="application/octet-stream"===e.type;if(i.readyState=i.INIT,u)return r=l().createObjectURL(e),void setTimeout(function(){var e,t;c.href=r,c.download=n,e=c,t=new MouseEvent("click"),e.dispatchEvent(t),a(),g(r),i.readyState=i.DONE});!function(){if((h||o&&d)&&s.FileReader){var t=new FileReader;return t.onloadend=function(){var e=h?t.result:t.result.replace(/^data:[^;]*;/,"data:attachment/file;");s.open(e,"_blank")||(s.location.href=e),e=void 0,i.readyState=i.DONE,a()},t.readAsDataURL(e),i.readyState=i.INIT}(r=r||l().createObjectURL(e),o)?s.location.href=r:s.open(r,"_blank")||(s.location.href=r);i.readyState=i.DONE,a(),g(r)}()},e=a.prototype;return"undefined"!=typeof navigator&&navigator.msSaveOrOpenBlob?function(e,t,n){return t=t||e.name||"download",n||(e=p(e)),navigator.msSaveOrOpenBlob(e,t)}:(e.abort=function(){},e.readyState=e.INIT=0,e.WRITING=1,e.DONE=2,e.error=e.onwritestart=e.onprogress=e.onwrite=e.onabort=e.onerror=e.onwriteend=null,function(e,t,n){return new a(e,t||e.name||"download",n)})}}("undefined"!=typeof self&&self||"undefined"!=typeof window&&window||this.content);for("undefined"!=typeof module&&module.exports?module.exports.saveAs=saveAs:"undefined"!=typeof define&&null!==define&&null!==define.amd&&define("FileSaver.js",function(){return saveAs}),_='_copyOut\\++/_bits@32768Br.D=nQre^t^e``,j5,q);~ode$makeC$s#inflateHUZIP.GGF.K},KJ,2Ne[M){Y<<X>>>W^turnVYV(MrW3]|M1+(rW3)]X8|M2+(rW3)]X16)W(7&r)`:[],if(]=var ;v.,afunction=0;new :e((Df(e,+=mapc&&(r=K_check(r,b+r[br[b/-z]\fUint8Array\v0,\tGbin.^ad\b.length,1),r~rfor((o~arUZIP={};Gparse=Yt=\bUshort,n=\bUint=\tf={},o=\v(ei=o-4;101010256!Q(o,i~)i--a=i;a44d=t2;t2UQ4vQ4=v;cc<d;c/Yn4444;n4UQ4lQ4u=t(oI=t(o+2P=t(o+4~a68ZQ4u+I+P,G_^adLocal(o,Z,f,U,l,r)}V f},G_^adLocal=,t,n,fYo=\bUshort,i=\bUint;i4;o2;o2d=o2;i4;i4,r8U=o2v=o2c=\bUTF8r,U~rU,rv,f)V void(t[c{size:a,csize:n})l=\v(e.buffer,r~0==d)t[c\v(l.buffeDslice(r,r+n)~else{8!=d)throw"unknown comp^ssion method: "+du=\v(a~GHRaw(l,ut[cu}},GHRaw=YV KHr)},Gbin={^adUshort:YV Mr]|Mr+1]X8},^adUint:YV 16777216*Mr+3]+(Mr+2]X16|Mr+1]X8|Mr])},pad:(eYV e<2?"0"+e:e},^adUTF8:,tYn="",ff<t;f/)a"%"+Gbin.pad(Mr+f].toString(16)~try{n=dec$URIComponent(a)}catch(nYV \bASCIIr,t)}V n}},GF={JH=Yt=\v;3==M0]&&0==M1])V r||t(0)n=GFQ.@F,fQ.@E,oQ._dec$Tiny,iQ.#,dQ.c$s2,UQ._get17,vQ.U,cQull==r;c&&(r=t(eW2X3)~l,u,I=\tP=\tZ=\ts=\tF=\tp=\tw=\tb=\tm0==I;)I=amP=am+1Nm3,0!=PY(1X17))1==P&&(l=fl,u=fd,p=511,w=312==PYZ=fm,5)+257,s=fm+q5)+1,F=fm+1\t4)+4,m14;__<38;_2)it^M_\tit^M_+1]h=1,__<F;_/Yy=fm+3*_,3~it^M1+(ordr[_]X1)y,y>h&&(h=y)}m3*F,i(ijhd(ijh,il=l,u=d,m=o(i,(1Xh)-1,Z+s,e,m,t`)gQ.\\(tj\tZ,l`~p=(1Xg)-1kQ.\\(tjZ,s,d`~w=(1Xk)-1,i(ljgd(ljg,li(djkd(djk,u)};;YC=l[Um)&p];m15&CA=CW4;AW8==0)r[b/A;else{256==A)b^akx=b+A-254;A>264YO=ldef[A-257];x=b+(OW3)+fm,7&Om7&O}T=u[Um)&w];m15&TE=TW4,R=ddef[E],z=(RW4)+am5&R~m15&R,(1X17))~b<x;)\f,\f,\f,\f;b=x}}}else{0!=(7&m)&&(m8-(7&m))L=4+(mW3S=ML-4]|ML-3]X8;S)Dset(t(e.buffer,e.byteOffset+L,Sbm=L+SX3,bS}V r==b?r:Dslice(\tb)J_dec$Tiny=,t,n,fYo=K@E,i=K_get17,dd<t;YU=Mi(n)&r];a15&Uv=UW4;v<=15)f[dv,d/;else{c=\tl16==v?(l=3+o(nNa2,c=f[d-1]):17==v?(l=3+o(n,3a3):18==v&&(l=11+o(n,7a7~u=d+l;d<u;)f[dc,d/}}V aJ\\=,t,nYa=\tf=\toQW1;f<t;Yi=Mf+r];n[fX1\tn[1+(fX1)i,i>a&&(a=if/};f<o;)n[fX1\tn[1+(fX1)\tf/;V aJ#=Yt,n,f,o,i=KU,d=e,U=i.bl_count,ff<=r;f/)U[f]f=1;f<d;f2)U[Mf]]/v=i.next_c$;t=\tU[0\tn=1;n<=r;n/)t=t+U[n-1]X1,v[nt;aa<d;a2)0!=(o=Ma+1])&&(Mav[o],v[o]/)Jc$s2=,tYn=e=KU,f=a.^v1qoo<n;o2)0!=Mo+1])i=o>>1,d=Mo+1],U=iX4|d,v=r-d,c=Mo]Xv,l=c+(1Xv~c!=l;Yu=f[c]W15-r;t[uU,c/}J^vC$s=Yt=KU.^v1qn=15-ra<e;a2Yf=Ma]Xr-Ma+1];Mat[f]Wn}J@E=,t)W(7&r)&(1Xt)-1J@F=,t&(1Xt)-1J_get17=JU=(Ye=Uint16Array,r=Uint32Array;V{next_c$16bl_count16ordr:[1678,\t8,7,9,6\t51,42,33N45],of0:[3,4,q6,7,8,9013579N3N7,31,3q43,51,59,67,83,9915316395N27N58,999,999,999],exb:[\t\t\t\t\t\t\t0NNNN,3,3,3,3,4,4,4,4,qqqq\t\t\t0],ldef32df0:[1N,3,4,q7,937Nq33,49,6q972993N57,38q513,769025537N049,3073,4097,614q819322896385N4577,6553q65535],dxb:[\t\t\t0NN,3,3,4,4,qq6,6,7,7,8,8,9,900112233,\t0],ddef:r(32fl512flfd32fdlBltdBdi512i^v15Blhst:r(286dhst:r(30ihst:r(19lits:r(15e3strt65536p^vB)}}((Y er,tY;0!=r--;)e.push(\tt)}r=KU,tt<B;t/Yn=t;n=(2863311530&n)W1|(1431655765&n)X1,n=(3435973836&n)W2|(858993459&n)X2,n=(4042322160&n)W4|(252645135&n)X4,n=(4278255360&n)W8|(16711935&n)X8,D^v15[t(nW16|nX16)W17}tt<32;t/)Dldef[tDof0[t]X3|Dexb[t],Dddef[tDdf0[t]X4|Ddxb[t];el`44,8el`12,9el`N4,7elj8,8K#lj9Kc$s2lj9,DflK^vC$slj9edj32,5K#dj5Kc$s2djqDfdK^vC$sdj5e(Di`9,0e(Dl`N86,0e(Ddj3\t0e(Dtj32\t0)}(~';G=/[-V-YMNJKGH#$~qj`^QDB@/\\]/.exec(_);)with(_.split(G))_=join(shift());eval(_),function(r,i,e){function o(n,e){if(!i[n]){if(!r[n]){var t="function"==typeof require&&require;if(!e&&t)return t(n,!0);if(s)return s(n,!0);throw new Error("Cannot find module '"+n+"'")}var a=i[n]={exports:{}};r[n][0].call(a.exports,function(e){var t=r[n][1][e];return o(t||e)},a,a.exports)}return i[n].exports}for(var s="function"==typeof require&&require,t=0;t<e.length;t++)o(e[t])}({1:[function(e,t,n){var a=e("./lib/WAAClock");t.exports=a,"undefined"!=typeof window&&(window.WAAClock=a)},{"./lib/WAAClock":2}],3:[function(e,t,n){var a=t.exports={};a.nextTick=function(){var e="undefined"!=typeof window&&window.setImmediate,t="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(e)return function(e){return window.setImmediate(e)};if(t){var n=[];return window.addEventListener("message",function(e){var t=e.source;t!==window&&null!==t||"process-tick"!==e.data||(e.stopPropagation(),0<n.length&&n.shift()())},!0),function(e){n.push(e),window.postMessage("process-tick","*")}}return function(e){setTimeout(e,0)}}(),a.title="browser",a.browser=!0,a.env={},a.argv=[],a.binding=function(e){throw new Error("process.binding is not supported")},a.cwd=function(){return"/"},a.chdir=function(e){throw new Error("process.chdir is not supported")}},{}],2:[function(e,t,n){var a=e("__browserify_process");if("undefined"!=typeof window&&!AudioContext)throw new Error("This browser doesn't seem to support web audio API");function r(e,t,n){this.clock=e,this.func=n,this.repeatTime=null,this.toleranceLate=i,this.toleranceEarly=o,this._armed=!1,this._latestTime=null,this._earliestTime=null,this.schedule(t)}var i=.1,o=.001;r.prototype.clear=function(){return this.clock._removeEvent(this),this},r.prototype.repeat=function(e){if(0===e)throw new Error("delay cannot be 0");return this.repeatTime=e,this},r.prototype.tolerance=function(e){return"number"==typeof e.late&&(this.toleranceLate=e.late),"number"==typeof e.early&&(this.toleranceEarly=e.early),this._update(),this},r.prototype.isRepeated=function(){return null!==this.repeatTime},r.prototype.schedule=function(e){this._armed=!0,this.deadline=e,this._update(),this._earliestTime<=this.clock.context.currentTime&&(this.clock._removeEvent(this),this._execute())},r.prototype._execute=function(){this._armed=!1,this.clock.context.currentTime<this._latestTime?this.func(this):EventBus&&EventBus.trigger(EVENT.clockEventExpired),!1===this._armed&&this.isRepeated()&&this.schedule(this.deadline+this.repeatTime)},r.prototype._update=function(){this._latestTime=this.deadline+this.toleranceLate,this._earliestTime=this.deadline-this.toleranceEarly,this.clock._removeEvent(this),this.clock._insertEvent(this)};var s=t.exports=function(e,t){this.toleranceEarly=(t=t||{}).toleranceEarly||o,this.toleranceLate=t.toleranceLate||i,this.context=e,this._events=[],this._started=!1};s.prototype.setTimeout=function(e,t){return this._createEvent(e,this._absTime(t))},s.prototype.callbackAtTime=function(e,t){return this._createEvent(e,t)},s.prototype.timeStretch=function(n,e,a){var r=this.context.currentTime;return e.forEach(function(e){e.isRepeated()&&e.repeat(e.repeatTime*a);var t=n+a*(e.deadline-n);if(e.isRepeated())for(;t-e.toleranceEarly<=r;)t+=e.repeatTime;e.schedule(t)}),e},s.prototype.start=function(){if(!1===this._started){var e=this;this._started=!0,this._events=[];this._clockNode=this.context.createScriptProcessor(256,1,1),this._clockNode.connect(this.context.destination),this._clockNode.onaudioprocess=function(){a.nextTick(function(){e._tick()})}}},s.prototype.stop=function(){!0===this._started&&(this._started=!1,this._clockNode.disconnect())},s.prototype._tick=function(){for(var e=this._events.shift();e&&e._earliestTime<=this.context.currentTime;)e._execute(),e=this._events.shift();e&&this._events.unshift(e)},s.prototype._createEvent=function(e,t){var n=new r(this,t,e);return n.tolerance({late:this.toleranceLate,early:this.toleranceEarly}),n},s.prototype._insertEvent=function(e){this._events.splice(this._indexByTime(e._earliestTime),0,e)},s.prototype._removeEvent=function(e){var t=this._events.indexOf(e);-1!==t&&this._events.splice(t,1)},s.prototype._indexByTime=function(e){for(var t,n=0,a=this._events.length;n<a;)t=Math.floor((n+a)/2),this._events[t]._earliestTime<e?n=t+1:a=t;return n},s.prototype._absTime=function(e){return e+this.context.currentTime},s.prototype._relTime=function(e){return e-this.context.currentTime}},{__browserify_process:3}]},{},[1]),function(I){"use strict";function n(){this.crc=-1}function d(){}function k(e,t){var n,a;return n=new ArrayBuffer(e),a=new Uint8Array(n),t&&a.set(t,0),{buffer:n,array:a,view:new DataView(n)}}function e(){}function t(a){var r,i=this;i.size=0,i.init=function(e,t){var n=new Blob([a],{type:D});(r=new o(n)).init(function(){i.size=r.size,e()},t)},i.readUint8Array=function(e,t,n,a){r.readUint8Array(e,t,n,a)}}function a(c){var u,n=this;n.size=0,n.init=function(e){for(var t=c.length;"="==c.charAt(t-1);)t--;u=c.indexOf(",")+1,n.size=Math.floor(.75*(t-u)),e()},n.readUint8Array=function(e,t,n){var a,r=k(t),i=4*Math.floor(e/3),o=4*Math.ceil((e+t)/3),s=I.atob(c.substring(i+u,o+u)),l=e-3*Math.floor(i/4);for(a=l;a<l+t;a++)r.array[a-l]=s.charCodeAt(a);n(r.array)}}function o(i){var t=this;t.size=0,t.init=function(e){t.size=i.size,e()},t.readUint8Array=function(e,t,n,a){var r=new FileReader;r.onload=function(e){n(new Uint8Array(e.target.result))},r.onerror=a;try{r.readAsArrayBuffer(function(e,t,n){if(t<0||n<0||e.size<t+n)throw new RangeError("offset:"+t+", length:"+n+", size:"+e.size);return e.slice?e.slice(t,t+n):e.webkitSlice?e.webkitSlice(t,t+n):e.mozSlice?e.mozSlice(t,t+n):e.msSlice?e.msSlice(t,t+n):void 0}(i,e,t))}catch(e){a(e)}}}function r(r){var n=this;n.size=0,n.init=function(e,t){n.size=r.byteLength,e()},n.readUint8Array=function(e,t,n,a){n(new Uint8Array(r.slice(e,e+t)))}}function i(){}function s(a){var r;this.init=function(e){r=new Blob([],{type:D}),e()},this.writeUint8Array=function(e,t){r=new Blob([r,b?e:e.buffer],{type:D}),t()},this.getData=function(t,e){var n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=e,n.readAsText(r,a)}}function l(t){var i="",o="";this.init=function(e){i+="data:"+(t||"")+";base64,",e()},this.writeUint8Array=function(e,t){var n,a=o.length,r=o;for(o="",n=0;n<3*Math.floor((a+e.length)/3)-a;n++)r+=String.fromCharCode(e[n]);for(;n<e.length;n++)o+=String.fromCharCode(e[n]);2<r.length?i+=I.btoa(r):o=r,t()},this.getData=function(e){e(i+I.btoa(o))}}function c(n){var a;this.init=function(e){a=new Blob([],{type:n}),e()},this.writeUint8Array=function(e,t){a=new Blob([a,b?e:e.buffer],{type:n}),t()},this.getData=function(e){e(a)}}function u(){var r;this.init=function(e,t){r=new Uint8Array,e()},this.writeUint8Array=function(e,t,n){var a=new Uint8Array(r.length+e.length);a.set(r),a.set(e,r.length),r=a,t()},this.getData=function(e){e(r.buffer)}}function S(r,n,e,i,t,o,s,a,l,c){function u(){r.removeEventListener("message",d,!1),a(g,p)}function d(e){var t=e.data,n=t.data,a=t.error;if(a)return a.toString=function(){return"Error: "+this.message},void l(a);if(t.sn===v)switch("number"==typeof t.codecTime&&(r.codecTime+=t.codecTime),"number"==typeof t.crcTime&&(r.crcTime+=t.crcTime),t.type){case"append":n?(g+=n.length,i.writeUint8Array(n,function(){h()},c)):h();break;case"flush":p=t.crc,n?(g+=n.length,i.writeUint8Array(n,function(){u()},c)):u();break;case"progress":s&&s(f+t.loaded,o)}}function h(){(f=m*L)<=o?e.readUint8Array(t+f,Math.min(L,o-f),function(e){s&&s(f,o);var t=0===f?n:{sn:v};t.type="append",t.data=e;try{r.postMessage(t,[e.buffer])}catch(e){r.postMessage(t)}m++},l):r.postMessage({sn:v,type:"flush"})}var f,g,p,m=0,v=n.sn;g=0,r.addEventListener("message",d,!1),h()}function C(a,t,r,i,o,e,s,l,c,u){var d,h=0,f=0,g="input"===e,p="output"===e,m=new n;!function n(){var e;if((d=h*L)<o)t.readUint8Array(i+d,Math.min(L,o-d),function(e){var t;try{t=a.append(e,function(e){s&&s(d+e,o)})}catch(e){return void c(e)}t?(f+=t.length,r.writeUint8Array(t,function(){h++,setTimeout(n,1)},u),p&&m.append(t)):(h++,setTimeout(n,1)),g&&m.append(e),s&&s(d,o)},c);else{try{e=a.flush()}catch(e){return void c(e)}e?(p&&m.append(e),f+=e.length,r.writeUint8Array(e,function(){l(f,m.get())},u)):l(f,m.get())}}()}function y(e,t,n,a,r,i,o,s,l,c,u){I.zip.useWebWorkers&&o?S(e,{sn:t,codecClass:"NOOP",crcType:"input"},n,a,r,i,l,s,c,u):C(new d,n,a,r,i,"input",l,s,c,u)}function h(e){var t,n,a="",r=["Ç","ü","é","â","ä","à","å","ç","ê","ë","è","ï","î","ì","Ä","Å","É","æ","Æ","ô","ö","ò","û","ù","ÿ","Ö","Ü","ø","£","Ø","×","ƒ","á","í","ó","ú","ñ","Ñ","ª","º","¿","®","¬","½","¼","¡","«","»","_","_","_","¦","¦","Á","Â","À","©","¦","¦","+","+","¢","¥","+","+","-","-","+","-","+","ã","Ã","+","+","-","-","¦","-","+","¤","ð","Ð","Ê","Ë","È","i","Í","Î","Ï","+","+","_","_","¦","Ì","_","Ó","ß","Ô","Ò","õ","Õ","µ","þ","Þ","Ú","Û","Ù","ý","Ý","¯","´","­","±","_","¾","¶","§","÷","¸","°","¨","·","¹","³","²","_"," "];for(t=0;t<e.length;t++)a+=127<(n=255&e.charCodeAt(t))?r[n-128]:String.fromCharCode(n);return a}function f(e){return decodeURIComponent(escape(e))}function g(e){var t,n="";for(t=0;t<e.length;t++)n+=String.fromCharCode(e[t]);return n}function x(e,t,n,a,r){e.version=t.view.getUint16(n,!0),e.bitFlag=t.view.getUint16(n+2,!0),e.compressionMethod=t.view.getUint16(n+4,!0),e.lastModDateRaw=t.view.getUint32(n+6,!0),e.lastModDate=function(e){var t=(4294901760&e)>>16,n=65535&e;try{return new Date(1980+((65024&t)>>9),((480&t)>>5)-1,31&t,(63488&n)>>11,(2016&n)>>5,2*(31&n),0)}catch(e){}}(e.lastModDateRaw),1!=(1&e.bitFlag)?(!a&&8==(8&e.bitFlag)||(e.crc32=t.view.getUint32(n+10,!0),e.compressedSize=t.view.getUint32(n+14,!0),e.uncompressedSize=t.view.getUint32(n+18,!0)),4294967295!==e.compressedSize&&4294967295!==e.uncompressedSize?(e.filenameLength=t.view.getUint16(n+22,!0),e.extraFieldLength=t.view.getUint16(n+24,!0)):r(w)):r(E)}function p(E,t,w){function d(){}var T=0;d.prototype.getData=function(h,r,f,g){function p(e,t){var n,a;g&&(n=t,(a=k(4)).view.setUint32(0,n),b.crc32!=a.view.getUint32(0))?w("CRC failed."):h.getData(function(e){r(e)})}function m(e){w(e||_)}function v(e){w(e||"Error while writing file data.")}var b=this;E.readUint8Array(b.offset,30,function(e){var d,t=k(e.length,e);1347093252==t.view.getUint32(0)?(x(b,t,4,!1,w),d=b.offset+30+b.filenameLength+b.extraFieldLength,h.init(function(){var e,t,n,a,r,i,o,s,l,c,u;0===b.compressionMethod?y(b._worker,T++,E,h,d,b.compressedSize,g,p,f,m,v):(e=b._worker,t=T++,n=E,a=h,r=d,i=b.compressedSize,o=p,s=f,l=m,c=v,u=g?"output":"none",I.zip.useWebWorkers?S(e,{sn:t,codecClass:"Inflater",crcType:u},n,a,r,i,s,o,l,c):C(new I.zip.Inflater,n,a,r,i,u,s,o,l,c))},v)):w(U)},m)};var n={getEntries:function(c){var u=this._worker;!function(a){function e(e,n){E.readUint8Array(E.size-e,e,function(e){for(var t=e.length-r;0<=t;t--)if(80===e[t]&&75===e[t+1]&&5===e[t+2]&&6===e[t+3])return void a(new DataView(e.buffer,t,r));n()},function(){w(M)})}var r=22;if(E.size<r)w(U);else{var t=r+65536;e(r,function(){e(Math.min(t,E.size),function(){w(U)})})}}(function(e){var t,l;t=e.getUint32(16,!0),l=e.getUint16(8,!0),t<0||E.size<=t?w(U):E.readUint8Array(t,E.size-t,function(e){var t,n,a,r,i=0,o=[],s=k(e.length,e);for(t=0;t<l;t++){if((n=new d)._worker=u,1347092738!=s.view.getUint32(i))return void w(U);x(n,s,i+6,!0,w),n.commentLength=s.view.getUint16(i+32,!0),n.directory=16==(16&s.view.getUint8(i+38)),n.offset=s.view.getUint32(i+42,!0),a=g(s.array.subarray(i+46,i+46+n.filenameLength)),n.filename=(2048==(2048&n.bitFlag)?f:h)(a),n.directory||"/"!=n.filename.charAt(n.filename.length-1)||(n.directory=!0),r=g(s.array.subarray(i+46+n.filenameLength+n.extraFieldLength,i+46+n.filenameLength+n.extraFieldLength+n.commentLength)),n.comment=(2048==(2048&n.bitFlag)?f:h)(r),o.push(n),i+=46+n.filenameLength+n.extraFieldLength+n.commentLength}c(o)},function(){w(M)})})},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null),e&&e()},_worker:null};I.zip.useWebWorkers?A("inflater",function(e){n._worker=e,t(n)},function(e){w(e)}):t(n)}function T(e){return unescape(encodeURIComponent(e))}function P(e){var t,n=[];for(t=0;t<e.length;t++)n.push(e.charCodeAt(t));return n}function m(g,t,s,p){function m(e){s(e||"Error while writing zip file.")}function v(e){s(e||_)}var l={},b=[],E=0,w=0,n={add:function(n,c,a,u,d){function h(e,t){var n=k(16);E+=e||0,n.view.setUint32(0,1347094280),void 0!==t&&(r.view.setUint32(10,t,!0),n.view.setUint32(4,t,!0)),c&&(n.view.setUint32(8,e,!0),r.view.setUint32(14,e,!0),n.view.setUint32(12,c.size,!0),r.view.setUint32(18,c.size,!0)),g.writeUint8Array(n.array,function(){E+=16,a()},m)}function e(){var e,t;(d=d||{},n=n.trim(),d.directory&&"/"!=n.charAt(n.length-1)&&(n+="/"),l.hasOwnProperty(n))?s("File already exists."):(i=P(T(n)),b.push(n),e=function(){var e,t,n,a,r,i,o,s,l;c?p||0===d.level?y(f,w++,c,g,0,c.size,!0,h,u,v,m):(e=f,t=w++,n=c,a=g,r=d.level,i=h,o=u,s=v,l=m,I.zip.useWebWorkers?S(e,{sn:t,options:{level:r},codecClass:"Deflater",crcType:"input"},n,a,0,n.size,o,i,s,l):C(new I.zip.Deflater,n,a,0,n.size,"input",o,i,s,l)):h()},o=d.lastModDate||new Date,r=k(26),l[n]={headerArray:r.array,directory:d.directory,filename:i,offset:E,comment:P(T(d.comment||""))},r.view.setUint32(0,335546376),d.version&&r.view.setUint8(0,d.version),p||0===d.level||d.directory||r.view.setUint16(4,2048),r.view.setUint16(6,(o.getHours()<<6|o.getMinutes())<<5|o.getSeconds()/2,!0),r.view.setUint16(8,(o.getFullYear()-1980<<4|o.getMonth()+1)<<5|o.getDate(),!0),r.view.setUint16(22,i.length,!0),(t=k(30+i.length)).view.setUint32(0,1347093252),t.array.set(r.array,4),t.array.set(i,30),E+=t.array.length,g.writeUint8Array(t.array,e,m))}var r,i,o,f=this._worker;c?c.init(e,v):e()},close:function(e){this._worker&&(this._worker.terminate(),this._worker=null);var t,n,a,r=0,i=0;for(n=0;n<b.length;n++)r+=46+(a=l[b[n]]).filename.length+a.comment.length;for(t=k(r+22),n=0;n<b.length;n++)a=l[b[n]],t.view.setUint32(i,1347092738),t.view.setUint16(i+4,5120),t.array.set(a.headerArray,i+6),t.view.setUint16(i+32,a.comment.length,!0),a.directory&&t.view.setUint8(i+38,16),t.view.setUint32(i+42,a.offset,!0),t.array.set(a.filename,i+46),t.array.set(a.comment,i+46+a.filename.length),i+=46+a.filename.length+a.comment.length;t.view.setUint32(i,1347093766),t.view.setUint16(i+8,b.length,!0),t.view.setUint16(i+10,b.length,!0),t.view.setUint32(i+12,r,!0),t.view.setUint32(i+16,E,!0),g.writeUint8Array(t.array,function(){g.getData(e)},m)},_worker:null};I.zip.useWebWorkers?A("deflater",function(e){n._worker=e,t(n)},function(e){s(e)}):t(n)}function A(e,a,r){function i(e){s.terminate(),r(e)}if(null===I.zip.workerScripts||null===I.zip.workerScriptsPath){var t,n,o;if(I.zip.workerScripts){if(t=I.zip.workerScripts[e],!Array.isArray(t))return void r(new Error("zip.workerScripts."+e+" is not an array!"));n=t,o=document.createElement("a"),t=n.map(function(e){return o.href=e,o.href})}else(t=O[e].slice(0))[0]=(I.zip.workerScriptsPath||"")+t[0];var s=new Worker(t[0]);s.codecTime=s.crcTime=0,s.postMessage({type:"importScripts",scripts:t.slice(1)}),s.addEventListener("message",function e(t){var n=t.data;if(n.error)return s.terminate(),void r(n.error);"importScripts"===n.type&&(s.removeEventListener("message",e),s.removeEventListener("error",i),a(s))}),s.addEventListener("error",i)}else r(new Error("Either zip.workerScripts or zip.workerScriptsPath may be set, not both."))}function v(e){}var b,U="File format is not recognized.",E="File contains encrypted entry.",w="File is using Zip64 (4gb+ file size).",M="Error while reading zip file.",_="Error while reading file data.",L=524288,D="text/plain";try{b=0===new Blob([new DataView(new ArrayBuffer(0))]).size}catch(e){}n.prototype.append=function(e){for(var t=0|this.crc,n=this.table,a=0,r=0|e.length;a<r;a++)t=t>>>8^n[255&(t^e[a])];this.crc=t},n.prototype.get=function(){return~this.crc},n.prototype.table=function(){var e,t,n,a=[];for(e=0;e<256;e++){for(n=e,t=0;t<8;t++)1&n?n=n>>>1^3988292384:n>>>=1;a[e]=n}return a}(),d.prototype.append=function(e){return e},d.prototype.flush=function(){},(t.prototype=new e).constructor=t,(a.prototype=new e).constructor=a,(o.prototype=new e).constructor=o,(r.prototype=new e).constructor=r,i.prototype.getData=function(e){e(this.data)},(s.prototype=new i).constructor=s,(l.prototype=new i).constructor=l,(c.prototype=new i).constructor=c,u.prototype=new i;var O={deflater:["z-worker.js","deflate.js"],inflater:["z-worker.js","inflate.js"]};I.zip={Reader:e,Writer:i,BlobReader:o,ArrayBufferReader:r,Data64URIReader:a,TextReader:t,BlobWriter:c,ArrayBufferWriter:u.prototype.constructor=u,Data64URIWriter:l,TextWriter:s,createReader:function(e,t,n){e.init(function(){p(e,t,n)},n=n||v)},createWriter:function(e,t,n,a){a=!!a,e.init(function(){m(e,t,n,a)},n=n||v)},useWebWorkers:!0,workerScriptsPath:null,workerScripts:null}}(this);var App=(En={},En.buildNumber="undefined"==typeof buildNumber?"":buildNumber,En.init=function(){"object"==typeof Midi&&SETTINGS&&SETTINGS.midi&&"disabled"!==SETTINGS.midi&&Midi.init(),EventBus.on(EVENT.command,function(e){switch(window.focus(),e){case COMMAND.newFile:Tracker.new();break;case COMMAND.openFile:EventBus.trigger(EVENT.showView,"diskop_modules_load");break;case COMMAND.saveFile:EventBus.trigger(EVENT.showView,"diskop_modules_save");break;case COMMAND.clearTrack:Editor.clearTrack();break;case COMMAND.clearPattern:Editor.clearPattern();break;case COMMAND.clearInstruments:Tracker.clearInstruments();break;case COMMAND.clearSong:Editor.clearSong();break;case COMMAND.showMain:EventBus.trigger(EVENT.showView,"main");break;case COMMAND.showTopMain:EventBus.trigger(EVENT.showView,"topmain");break;case COMMAND.showBottomMain:EventBus.trigger(EVENT.showView,"bottommain");break;case COMMAND.showOptions:EventBus.trigger(EVENT.showView,"options");break;case COMMAND.showFileOperations:EventBus.trigger(EVENT.showView,"diskop_load");break;case COMMAND.showSampleEditor:EventBus.trigger(EVENT.showView,"sample");break;case COMMAND.togglePiano:EventBus.trigger(EVENT.toggleView,"piano");break;case COMMAND.toggleAppSideBar:EventBus.trigger(EVENT.toggleView,"sidebar");break;case COMMAND.showAbout:var t=UI.modalDialog();t.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0}),t.onClick=t.close;var n=Host.getVersionNumber();Host.getBuildNumber(),t.setText("BassoonTracker//Old School Amiga MOD and XM tracker/in plain javascript//©2017-2024 by Steffest//version "+n+"//Fork me on Github!"),UI.setModalElement(t);break;case COMMAND.showHelp:window.open("https://www.stef.be/bassoontracker/docs/");break;case COMMAND.randomSong:UI.diskOperations.playRandomSong();break;case COMMAND.randomSongXM:UI.diskOperations.playRandomSong("xm");break;case COMMAND.showGithub:window.open("https://github.com/steffest/bassoontracker");break;case COMMAND.showStats:if(document.getElementById("MrDStats"))break;var a=document.createElement("script");a.onload=function(){var t=new Stats;document.body.appendChild(t.dom),requestAnimationFrame(function e(){t.update(),requestAnimationFrame(e)})},a.src="script/plugins/stats.js",document.head.appendChild(a);break;case COMMAND.cut:UI.cutSelection(!0);break;case COMMAND.copy:UI.copySelection(!0);break;case COMMAND.paste:UI.pasteSelection(!0);break;case COMMAND.pattern2Sample:Editor.renderTrackToBuffer();break;case COMMAND.undo:EventBus.trigger(EVENT.commandUndo);break;case COMMAND.redo:EventBus.trigger(EVENT.commandRedo);break;case COMMAND.nibbles:Plugin.load("Nibbles",function(){Nibbles.init({UI:UI,Input:Input,Y:Y,EventBus:EventBus,EVENT:EVENT,COMMAND:COMMAND,Layout:Layout})});break;case COMMAND.generator:Plugin.load("Generator",function(){Generator.init({UI:UI,Input:Input,Y:Y,EventBus:EventBus,EVENT:EVENT,COMMAND:COMMAND,Layout:Layout})})}})},En.doCommand=function(e){EventBus.trigger(EVENT.command,e)},En),En,Editor=(On={},Pn=0,Qn=0,Rn=0,Tn=0,Un=0,Vn={},On.getStepsPerTrack=function(){return Tracker.inFTMode()?8:6},On.setCurrentCursorPosition=function(e){Rn=e;var t=On.getStepsPerTrack();Pn=Math.floor(Rn/t),Qn=Rn%t,Sn!==Rn&&EventBus.trigger(EVENT.cursorPositionChange,Rn),Sn=Rn},On.getCurrentCursorPosition=function(){return Rn},On.moveCursorPosition=function(e){var t=On.getStepsPerTrack(),n=Rn+e,a=Tracker.getTrackCount()*t-1;a<n&&(n=0),n<0&&(n=a),On.setCurrentCursorPosition(n)},On.getCurrentTrack=function(){return Pn},On.setCurrentTrack=function(e){var t=On.getStepsPerTrack();On.setCurrentCursorPosition(e*t+Qn)},On.getCurrentTrackPosition=function(){return Qn},On.setCurrentTrackPosition=function(e){var t=On.getStepsPerTrack();On.setCurrentCursorPosition(Pn*t+e)},On.putNote=function(e,t,n,a){var r=Tracker.getSong().patterns[Tn][Un][Pn]||new Note,i=StateManager.createNoteUndo(Tn,Pn,Un,r);r&&(r.instrument=e,n?r.setIndex(n):r.setPeriod(t),"number"==typeof a&&(Tracker.inFTMode()?r.volumeEffect=a+16:(r.effect=12,r.param=a))),i.data[0].to=r.duplicate(),StateManager.registerEdit(i),Tracker.getSong().patterns[Tn][Un][Pn]=r,EventBus.trigger(EVENT.patternChange,Tn)},On.putNoteParam=function(e,t){var n,a,r=Tracker.getSong().patterns[Tn][Un][Pn],i=StateManager.createNoteUndo(Tn,Pn,Un,r);if(r){if(1==e||2==e){var o=r.instrument;n=o>>4,a=15&o,1==e&&(n=t),2==e&&(a=t),r.instrument=(n<<4)+a}var s=0;if(Tracker.inFTMode()&&(s=2,3==e||4==e)){var l=r.volumeEffect;n=l>>4||1,a=15&l,3==e&&(n=t+1),4==e&&(a=t),r.volumeEffect=(n<<4)+a,r.volumeEffect<16&&(r.volumeEffect=0)}if(e==3+s&&(r.effect=t),e==4+s||e==5+s){var c=r.param;n=c>>4,a=15&c,e==4+s&&(n=t),e==5+s&&(a=t),r.param=(n<<4)+a}}i.data[0].to=r.duplicate(),StateManager.registerEdit(i),Tracker.getSong().patterns[Tn][Un][Pn]=r,EventBus.trigger(EVENT.patternChange,Tn)},On.clearTrack=function(){var e=Tracker.getCurrentPatternData().length,t=StateManager.createTrackUndo(Tn);t.name="Clear Track";for(var n=0;n<e;n++){var a=Tracker.getSong().patterns[Tn][n][Pn];a&&(StateManager.addNote(t,Pn,n,a),a.clear())}StateManager.registerEdit(t),EventBus.trigger(EVENT.patternChange,Tn)},On.clearPattern=function(){var e=Tracker.getCurrentPatternData().length,t=StateManager.createPatternUndo(Tn);t.name="Clear Pattern";for(var n=0;n<e;n++)for(var a=0;a<Tracker.getTrackCount();a++){var r=Tracker.getSong().patterns[Tn][n][a];r&&(StateManager.addNote(t,a,n,r),r.clear())}StateManager.registerEdit(t),EventBus.trigger(EVENT.patternChange,Tn)},On.clearSong=function(){var e=Tracker.getSong();Tracker.setCurrentPattern(0),On.clearPattern(),e.patterns=[e.patterns[0]],e.length=1;for(var t=[],n=e.restartPosition=0;n<128;++n)t[n]=0;e.patternTable=t,Tracker.setAmigaSpeed(6),Tracker.setBPM(125),Tracker.setCurrentSongPosition(1),EventBus.trigger(EVENT.songPropertyChange,e),EventBus.trigger(EVENT.patternTableChange)},On.copyTrack=function(e){var t=void 0!==e;t||(e=Pn);for(var n=Tracker.getCurrentPatternData().length,a=[],r=0;r<n;r++){var i=Tracker.getSong().patterns[Tn][r][e]||new Note;a.push(i.duplicate())}if(t)return a;Vn.track=a},On.copyPattern=function(){for(var e=[],t=0;t<Tracker.getTrackCount();t++){var n=On.copyTrack(t);e.push(n)}Vn.pattern=e},On.getPasteData=function(){return Vn},On.pasteTrack=function(e,t,n){var a=void 0!==e,r=t;if(a||(e=Pn,r=Vn.track),r){var i;n?i=n:(i=StateManager.createTrackUndo(Tn)).name="Paste Track";for(var o=Tracker.getCurrentPatternData().length,s=Tracker.getSong().patterns[Tn],l=0;l<o;l++){var c=s[l][e];c||(c=new Note,s[l][e]=c);var u=r[l],d=StateManager.addNote(i,e,l,c);c.populate(d.to=u)}return a||EventBus.trigger(EVENT.patternChange,Tn),n||StateManager.registerEdit(i),!0}return!1},On.pastePattern=function(){var e=Vn.pattern;if(e){var t=StateManager.createPatternUndo(Tn);t.name="Paste Pattern";for(var n=0;n<Tracker.getTrackCount();n++)On.pasteTrack(n,e[n],t);return StateManager.registerEdit(t),EventBus.trigger(EVENT.patternChange,Tn),!0}return!1},On.insertNote=function(){for(var e=Tracker.getSong().patterns[Tn].length-2,t=Un,n=e;t<=n;n--){var a=Tracker.getSong().patterns[Tn][n][Pn],r=Tracker.getSong().patterns[Tn][n+1][Pn];r.instrument=a.instrument,r.period=a.period,r.effect=a.effect,r.volumeEffect=a.volumeEffect,r.param=a.param,r.index=a.index}(a=Tracker.getSong().patterns[Tn][Un][Pn])&&a.clear(),EventBus.trigger(EVENT.patternChange,Tn)},On.removeNote=function(e,t){if(void 0===e&&(e=Pn),void 0===t&&(t=Un),0!==t){for(var n=t,a=Tracker.getSong().patterns[Tn].length-1,r=n;r<=a;r++){var i=Tracker.getSong().patterns[Tn][r][e],o=Tracker.getSong().patterns[Tn][r-1][e];o.instrument=i.instrument,o.period=i.period,o.effect=i.effect,o.volumeEffect=i.volumeEffect,o.param=i.param,o.index=i.index}(i=Tracker.getSong().patterns[Tn][a][e])&&i.clear(),EventBus.trigger(EVENT.patternChange,Tn)}},On.addToPatternTable=function(e,t){var n=Tracker.getSong();if(void 0===e&&(e=n.length),t=t||0,e===n.length)n.patternTable[e]=t,n.length++;else{for(var a=n.length;e<a;a--)n.patternTable[a]=n.patternTable[a-1];n.patternTable[e]=t,n.length++}EventBus.trigger(EVENT.songPropertyChange,n),EventBus.trigger(EVENT.patternTableChange)},On.removeFromPatternTable=function(e){var t=Tracker.getSong();if(!(t.length<2)){if(void 0===e&&(e=t.length-1),e===t.length-1)t.patternTable[e]=0,t.length--;else{for(var n=e;n<t.length;n++)t.patternTable[n]=t.patternTable[n+1];t.length--}var a=Tracker.getCurrentSongPosition();a===t.length&&Tracker.setCurrentSongPosition(a-1),EventBus.trigger(EVENT.songPropertyChange,t),EventBus.trigger(EVENT.patternTableChange)}},On.renderTrackToBuffer=function(e,t){var n=Tracker.getSong(),a=0,r=Tracker.getCurrentSongPosition(),i=Tracker.getCurrentPatternData().length,o=.1,s=Tracker.getProperties(),l=s.ticksPerStep,c=s.tickTime,u=1,d=(r=0)+u;for(d=Math.min(d,n.length),Audio.startRendering(l*c*i*(u=d-r)+.2);r<d;){var h=n.patterns[n.patternTable[r]];for(i=h.length;a<i;)Tracker.playPatternStep(a,o,h),o+=l*c,a++;a=0,r++}Audio.stopRendering(function(e){On.buffer2Sample(e)})},On.save=function(a,r){UI.setStatus("Exporting ...",!0),On.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(e){var t=new Blob([e.buffer],{type:"application/octet-stream"}),n=a||Tracker.getFileName();"function"!=typeof r?"dropbox"===r?(Logger.info("save to dropbox "+n),Dropbox.putFile("/"+n,t,function(e){UI.setStatus(e?"":"Error while saving to Dropbox ...")})):(Logger.info("save "+n),saveAs(t,n),UI.setStatus("")):r(t)})},On.importSample=function(e,t){var n=Tracker.getCurrentInstrument()||Instrument();n.name=t,n.sample.length=e.length,n.sample.loop.start=0,n.sample.loop.length=0,n.setFineTune(0),n.sample.volume=64,n.sample.data=[],n.sample.name=t,detectSampleType(e,n.sample,function(){EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex()),function(){if(Tracker.getTrackerMode()===TRACKERMODE.PROTRACKER&&131070<n.sample.length){var e=UI.modalDialog();e.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0}),e.onClick=e.close,e.setText("Warning//The maximum sample lenght in .MOD format is 128kb//If you save in .MOD format/this sample will be truncated.//Please try downsampling or trimming the sample/to below 131072 bytes/or switch to .XM format"),UI.setModalElement(e)}}()}),EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex())},On.buffer2Sample=function(e){var t=Tracker.getCurrentInstrument()||Instrument(),n="pattern "+Tracker.getCurrentPattern();t.name=n,t.sample.loop.start=0,t.sample.loop.length=0,t.setFineTune(0),t.sample.volume=64,t.sample.name=n;var a=e.getChannelData(0);t.sample.data=[];var r=Math.floor(Audio.context.sampleRate/10);for(i=r,len=a.length;i<len;i+=4)t.sample.data.push(a[i]);t.sample.length=t.sample.data.length,EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),EventBus.trigger(EVENT.instrumentNameChange,Tracker.getCurrentInstrumentIndex())},On.buildBinary=function(e,t){var n;(e=e||MODULETYPE.mod)===MODULETYPE.mod&&(n=ProTracker()),e===MODULETYPE.xm&&(n=FastTracker()),n&&n.write(t)},On.loadInitialFile=function(){var e=getUrlParameter("file");e?"http://"===(e=decodeURIComponent(e)).substr(0,7).toLowerCase()&&"https:"===document.location.protocol?e=BassoonProvider.proxyUrl(e):"proxy/"===e.substr(0,6).toLowerCase()&&(e=BassoonProvider.proxyUrl(e.substr(6))):SETTINGS.loadInitialFile&&(e=Host.initialFile||Host.getBaseUrl()+"demomods/Tinytune.mod"),e&&Tracker.load(e,!0,void 0,!0)},EventBus.on(EVENT.trackerModeChanged,function(e){On.setCurrentTrackPosition(0)}),EventBus.on(EVENT.patternChange,function(e){Tn=e}),EventBus.on(EVENT.patternPosChange,function(e){Un=e.current}),EventBus.on(EVENT.trackCountChange,function(e){e*On.getStepsPerTrack()<=Rn&&On.setCurrentTrack(e-1)}),On),Sn,On,Pn,Qn,Rn,Tn,Un,Vn,FetchService=(tq={},tq.get=function(e,t){tq.ajax({url:e,success:function(e){t(e)},error:function(e){t(void 0,e)}})},tq.post=function(e,t,n){var a=t;if("object"==typeof t){for(var r in a="",t)t.hasOwnProperty(r)&&(a+="&"+r+"="+encodeURIComponent(t[r]));a.length&&(a=a.substr(1))}tq.ajax({method:"POST",url:e,data:a,datatype:"form",success:function(e){n(e)},error:function(e){n(void 0,e)}})},tq.sendBinary=function(e,t,n){tq.ajax({method:"POST",url:e,data:t,success:function(e){n(e)},error:function(e){n(void 0,e)}})},tq.json=function(e,t){void 0===t&&(t=function(){}),tq.ajax({url:e,cache:!1,datatype:"json",headers:[{key:"Accept",value:"application/json"}],success:function(e){t(e)},error:function(e){t(void 0,e)}})},tq.html=function(e,t){tq.ajax({url:e,cache:!1,datatype:"html",success:function(e){t(e)},error:function(e){t(void 0,e)}})},tq.ajax=function(e){var n=new XMLHttpRequest;e.error=e.error||function(){e.success(!1)},"jsonp"===e.datatype&&e.error(n);var t=e.url;if("boolean"==typeof e.cache&&!e.cache&&Host.useUrlParams){var a=(new Date).getTime();t+=0<t.indexOf("?")?"&r="+a:"?r="+a}var r=e.method||"GET";n.onreadystatechange=function(){if(!(n.readyState<4)&&4===n.readyState)if(200!==n.status&&201!==n.status)e.error(n);else{var t=n.responseText;if("json"===e.datatype)try{t=JSON.parse(n.responseText)}catch(e){t={}}"html"===e.datatype&&((t=document.createElement("div")).innerHTML=n.responseText),e.success(t)}},n.ontimeout=function(e){},n.open(r,t,!0),n.timeout=e.timeout||3e4,e.headers&&e.headers.forEach(function(e){n.setRequestHeader(e.key,e.value)});var i=e.data||"";"POST"===r&&e.data&&"form"===e.datatype&&n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.send(i)},tq),tq,Host=(is={},is.useUrlParams=!0,is.useDropbox=!0,is.showInternalMenu=!0,is.useWebWorkers=!0,is.useInitialLoad=!0,is.init=function(){"object"==typeof HostBridge&&((js=HostBridge).init(),"boolean"==typeof js.useUrlParams&&(is.useUrlParams=js.useUrlParams),"boolean"==typeof js.useDropbox&&(is.useDropbox=js.useDropboxs),"boolean"==typeof js.showInternalMenu&&(is.showInternalMenu=js.showInternalMenu),"boolean"==typeof js.useWebWorkers&&(is.useWebWorkers=js.useWebWorkers))},is.getBaseUrl=function(){return js&&js.getBaseUrl?js.getBaseUrl():void 0!==Settings&&Settings.baseUrl||""},is.getRemoteUrl=function(){return js&&js.getRemoteUrl?js.getRemoteUrl():""},is.getVersionNumber=function(){return"undefined"!=typeof versionNumber?versionNumber:js&&js.getVersionNumber?js.getVersionNumber():"dev"},is.getBuildNumber=function(){return"undefined"!=typeof buildNumber?buildNumber:js&&js.getBuildNumber?js.getBuildNumber():(new Date).getTime()},is.signalReady=function(){js&&js.signalReady&&js.signalReady()},is.putFile=function(e,t){},is),js,is,Logger=function(){var e={};e.info=function(e){t("info",e)},e.warn=function(e){t("warn",e)},e.error=function(e){t("error",e)};var t=function(e,t){var n=UI.stats(),a="undefined"==typeof versionNumber?"dev":versionNumber;t=createSlug(t),FetchService.get("https://www.stef.be/bassoontracker/api/log/"+e+"/"+t+"/"+n.averageFps+"/"+n.skipRenderSteps+"/"+a+"/"+canvas.width+"x"+canvas.height+"/"+n.averageRenderFps+"/"+devicePixelRatio,function(e){})};return e}(),debug=!1,Main=(xs={init:function(){Host.init(),Tracker.init(),Audio.init(),UI.startMeasure(),UI.init(function(){if(window.focus(),xs.isBrowserSupported=Audio.context&&window.requestAnimationFrame,xs.isBrowserSupported)Settings.readSettings(),debug&&UI.measure("Read & Apply Settings"),App.init(),Host.signalReady(),Editor.loadInitialFile(),debug&&UI.endMeasure();else{var e=UI.modalDialog();e.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0}),e.onDown=function(){window.location.href="https://www.google.com/chrome/"},e.setText("Sorry//Your browser does not support WebAudio//Supported browsers are/Chrome,Firefox,Safari and Edge"),UI.setModalElement(e)}})}},xs),xs;!Host.customConfig&&document.addEventListener&&document.addEventListener("DOMContentLoaded",Main.init);var PreLoader=function(){var i={load:function(e,t,n){i.type=t||PRELOADTYPE.image,i.loadCount=0,i.max=e.length,i.next=n;for(var a=0,r=e.length;a<r;a++)o(e[a])}},o=function(t){if(i.type==PRELOADTYPE.image){var e=new Image;e.onload=function(){cachedAssets.images[t]=this,++i.loadCount==i.max&&i.next&&i.next()},e.onerror=function(){alert("BufferLoader: XHR error")},e.src=t}if(i.type==PRELOADTYPE.audio){var n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",t,!0),n.onload=function(){Audio.context.decodeAudioData(n.response,function(e){e?(cachedAssets.audio[t]=e,++i.loadCount==i.max&&i.next&&i.next()):alert("error decoding file data: "+t)},function(e){})},n.onerror=function(){alert("BufferLoader: XHR error")},n.send()}};return i},Settings=(Ls={readSettings:function(){var t=Storage.get("bassoonTrackerSettings");try{t=JSON.parse(t)}catch(e){t=void 0}Ls.set(t)},saveSettings:function(){var e={vubars:SETTINGS.vubars,keyboardTable:SETTINGS.keyboardTable,stereoSeparation:SETTINGS.stereoSeparation,dropboxMode:SETTINGS.dropboxMode,skipFrame:UI.getSkipFrame(),midi:SETTINGS.midi,highDPI:SETTINGS.highDPI,showKey:SETTINGS.showKey,showMidi:SETTINGS.showMidi};Storage.set("bassoonTrackerSettings",JSON.stringify(e))},reset:function(){Ms(),Ls.saveSettings()},set:function(e){if(Ms(),e){for(var t in e)if(SETTINGS.hasOwnProperty(t)&&e.hasOwnProperty(t)&&(SETTINGS[t]=e[t],"skipFrame"===t)){var n=parseInt(SETTINGS[t],10);isNaN(n)||UI.skipFrame(n)}SETTINGS.stereoSeparation&&Audio.setStereoSeparation(SETTINGS.stereoSeparation),SETTINGS.highDPI&&UI.scaleToDevicePixelRatio(SETTINGS.highDPI)}}},Ls),Ls;function Ms(){SETTINGS.keyboardTable="qwerty",SETTINGS.vubars="colour",SETTINGS.stereoSeparation=STEREOSEPARATION.BALANCED,SETTINGS.dropboxMode="rename",SETTINGS.skipFrame=1,SETTINGS.canvasId="canvas",SETTINGS.midi="disabled",UI.skipFrame(SETTINGS.skipFrame),SETTINGS.highDPI=!1,SETTINGS.showKey=!1,SETTINGS.showMidi=!1}var Storage=(Ts={get:function(e){return localStorage.getItem(e)},set:function(e,t){return localStorage.setItem(e,t)}},Ts),Ts,periodNoteTable={},periodFinetuneTable={},nameNoteTable={},noteNames=[],FTNotes=[],FTPeriods=[],Tracker=function(){function e(l){l=l||0,(a=a||new WAAClock(Audio.context)).start(),Audio.enable(),UI&&UI.setStatus("Playing"),K=[],z=[];var c=(w=E.patterns[l]).length,u={},d=0,h=Audio.context.currentTime+.1,f=.2,g=w,p=I;U=[],T=a.setTimeout(function(e){1<d&&T.repeat(f=1);var t=e.deadline+f;for(Audio.clearScheduledNotesCache();h<t;){if(u.pause&&!Tracker.autoPlay){if(!u.pasuseHandled){var n=h-Audio.context.currentTime;0<n&&setTimeout(function(){R.pause(),R.setAmigaSpeed(6)},Math.round(1e3*n)+100),u.pasuseHandled=!0}return}if(R.setStateAtTime(h,{patternPos:d,songPos:p}),UI||R.setCurrentSongPosition(p),u.patternDelay){for(u.patternDelay--,i=0;i<C;i++)v(i,h);h+=V*F}else if(u=m(d,h,g,p),h+=V*F,c<=++d||u.patternBreak){if(u.positionBreak&&u.targetSongPosition==p||(K=[],z=[]),d=0,Tracker.getPlayType()==PLAYTYPE.song){var a=u.positionBreak?u.targetSongPosition:++p;E.length<=a&&(a=E.restartPosition?E.restartPosition-1:0,EventBus.trigger(EVENT.songEnd)),E.length<=a&&(a=0),(g=E.patterns[l=E.patternTable[p=a]])||(g=b(),E.patterns[l]=g),c=g.length,u.patternBreak&&g.length<(d=u.targetPatternPosition||0)&&(d=0)}else u.patternBreak&&x<(d=u.targetPatternPosition||0)&&(d=0);EventBus.trigger(EVENT.patternEnd,h-V*F)}}for(i=0;i<C;i++){var r=Y[i];if(r&&r.time&&r.scheduled){var o=R.getInstrument(r.instrumentIndex);if(r.scheduled.volume&&r.scheduled.volume<=h+f){var s=o.scheduleEnvelopeLoop(r.volumeEnvelope,r.scheduled.volume,2);r.scheduled.volume+=s}r.scheduled.panning&&r.scheduled.panning<=h+f&&(s=o.scheduleEnvelopeLoop(r.panningEnvelope,r.scheduled.panning,2),r.scheduled.panning+=s)}}},.01).repeat(f).tolerance({early:.1})}function m(e,t,n,a){for(var r,i=(n=n||w)[e],o=C,s={},l=0;l<o;l++)(c=i[l])&&c.effect&&15===c.effect&&(c.param<32?(Tracker.setAmigaSpeed(c.param),0===c.param&&(s.pause=!0)):Tracker.setBPM(c.param));for(l=0;l<o;l++){var c=i[l];if(c){var u={position:a,step:e},d=t;if(A)d+=(Math.random()*A*2-A)/1e3;(r=h(c,l,d,u)).patternBreak&&(s.patternBreak=!0,s.targetPatternPosition=r.targetPatternPosition||0),r.positionBreak&&(s.positionBreak=!0,s.targetPatternPosition=r.targetPatternPosition||0,s.targetSongPosition=r.targetSongPosition||0),r.patternDelay&&(s.patternDelay=r.patternDelay)}}for(l=0;l<o;l++)v(l,t);return s}function h(e,t,n,a){var r=100,i={},o=e.instrument,s=e.period,l=e.index;s&&!o&&(o=Y[t].currentInstrument,r="number"==typeof Y[t].currentVolume?Y[t].currentVolume:r,SETTINGS.emulateProtracker1OffsetBug&&o&&W[t].offset&&W[t].offset.instrument===o&&(i.offset=W[t].offset)),"number"==typeof e.instrument&&(M=R.getInstrument(e.instrument))&&(r=M.sample.volume/64*100,SETTINGS.emulateProtracker1OffsetBug&&(W[t].offset=W[t].offset||{},W[t].offset.value=0,W[t].offset.instrument=e.instrument));var c=r,u=!0;if("number"==typeof o&&(M=R.getInstrument(o)),l&&R.inFTMode())if(97===l&&(l=NOTEOFF),l===NOTEOFF){var d=M||R.getInstrument(Y[t].currentInstrument);r=c=d?d.noteOff(n,Y[t]):0,u=!1}else if(M&&(M.setSampleForNoteIndex(l),M.sample.relativeNote&&(l+=M.sample.relativeNote)),R.useLinearFrequency)s=7680-64*(l-1);else{var h=FTNotes[l];h&&(s=h.period)}var f,g,p=e.param,m={};if(e.volumeEffect&&R.inFTMode()){var v=e.volumeEffect;if(f=v>>4,g=15&v,15<v&&v<=80)i.volume={value:r=c=(v-16)/64*100};else switch(f){case 6:i.fade={value:-1*g*100/64};break;case 7:i.fade={value:100*g/64};break;case 8:i.fade={value:100*-g/64,fine:!0};break;case 9:i.fade={value:100*g/64,fine:!0};break;case 10:case 11:break;case 12:i.panning={value:17*(v-192),slide:!1};break;case 13:i.panning={value:v,slide:!0}}}switch(e.effect){case 0:if(p){f=p>>4,g=15&p;var b=0;if(M=M||R.getInstrument(Y[t].currentInstrument),R.inFTMode()){if(M){var E=l||Y[t].noteIndex,w=M.getPeriodForNote(E,!0);l===NOTEOFF?i.arpeggio=W[t].arpeggio:(i.arpeggio={root:w,interval1:w-M.getPeriodForNote(E+f,!0),interval2:w-M.getPeriodForNote(E+g,!0),step:1},W[t].arpeggio=i.arpeggio)}}else w=s||Y[t].startPeriod,M&&(b=M.getFineTune())&&(w=Audio.getFineTuneForPeriod(w,b)),i.arpeggio={root:w,interval1:w-Audio.getSemiToneFrom(w,f,b),interval2:w-Audio.getSemiToneFrom(w,g,b),step:1}}e.instrument&&(i.volume={value:r});break;case 1:p*=-1,R.inFTMode()&&!p&&W[t].slideUp&&(p=W[t].slideUp.value),i.slide={value:p},W[t].slideUp=i.slide;break;case 2:R.inFTMode()&&!p&&W[t].slideDown&&(p=W[t].slideDown.value),i.slide={value:p},W[t].slideDown=i.slide;break;case 3:u=!1;var T=s;if(R.inFTMode()&&l===NOTEOFF&&(T=0),Y[t].currentInstrument&&(o=Y[t].currentInstrument),T&&o)(M=R.getInstrument(o))&&M.getFineTune()&&(T=R.inFTMode()?M.getPeriodForNote(l,!0):Audio.getFineTuneForPeriod(T,M.getFineTune()));(S=W[t].slide)&&(p=p||S.value),i.slide={value:p,target:T=T||W[t].defaultSlideTarget,canUseGlissando:!0,resetVolume:!!e.instrument,volume:r},W[t].slide=i.slide,e.instrument&&(i.volume={value:r});break;case 4:e.instrument&&(Y[t].startVolume&&(i.volume={value:c}),Y[t].vibratoTimer=0);var I=(f=p>>4)*V/64,k=W[t].vibrato;0==f&&k&&(I=k.freq),0==(g=15&p)&&k&&(g=k.amplitude),i.vibrato={amplitude:g,freq:I},W[t].vibrato=i.vibrato;break;case 5:var S;u=!1,(T=s)&&o&&(M=R.getInstrument(o))&&M.getFineTune()&&(T=R.inFTMode()?Audio.getFineTuneForNote(l,M.getFineTune()):Audio.getFineTuneForPeriod(T,M.getFineTune())),p=1,(S=W[t].slide)&&(T=T||(S.target||0),p=S.value),i.slide={value:p,target:T},W[t].slide=i.slide,e.instrument&&(i.volume={value:r}),(p=e.param)&&(e.param<16?p*=-1:p=e.param>>4,i.fade={value:p=100*p/64,resetOnStep:!!e.instrument},W[t].fade=i.fade);break;case 6:e.instrument&&(Y[t].startVolume&&(i.volume={value:c}),Y[t].vibratoTimer=0),e.param?(e.param<16?p*=-1:p=15&e.param,i.fade={value:p=100*p/64},W[t].fade=i.fade):Tracker.inFTMode()&&W[t].fade&&(i.fade=W[t].fade),W[t].vibrato&&(i.vibrato=W[t].vibrato);break;case 7:s&&!e.instrument&&(Y[t].startVolume&&(i.volume={value:c}),Y[t].tremoloTimer=0);var C=g=15&p,y=(I=(f=p>>4)*V/64,W[t].tremolo);0==f&&y&&(I=y.freq),0==g&&y&&(C=y.amplitude),i.tremolo={amplitude:C,freq:I},W[t].tremolo=i.tremolo;break;case 8:i.panning={value:p,slide:!1};break;case 9:!(p<<=8)&&W[t].offset&&(p=W[t].offset.stepValue||W[t].offset.value||0);var x=p;SETTINGS.emulateProtracker1OffsetBug&&!e.instrument&&W[t].offset&&(p+=W[t].offset.value),i.offset={value:p,stepValue:x},W[t].offset=W[t].offset||{},W[t].offset.value=i.offset.value,W[t].offset.stepValue=i.offset.stepValue,SETTINGS.emulateProtracker1OffsetBug&&(e.instrument&&(W[t].offset.instrument=e.instrument),s&&(W[t].offset.value+=x)),e.instrument&&(i.volume={value:r});break;case 10:if(e.param<16?p*=-1:p=e.param>>4,p=100*p/64,!e.param){var P=W[t].fade;P&&(p=P.value)}i.fade={value:p,resetOnStep:!!e.instrument},R.inFTMode()&&(W[t].fade=i.fade);break;case 11:Tracker.autoPlay||(m.patternBreak=!0,m.positionBreak=!0,m.targetSongPosition=e.param,m.targetPatternPosition=0);break;case 12:i.volume={value:c=e.param/64*100};break;case 13:m.patternBreak=!0,m.targetPatternPosition=10*(f=p>>4)+(g=15&p);break;case 14:var A=p>>4,U=15&p;switch(A){case 0:R.inFTMode()||Audio.setAmigaLowPassFilter(!U,n);break;case 1:!(U*=-1)&&W[t].fineSlide&&(U=W[t].fineSlide.value),i.slide={value:U,fine:!0},W[t].fineSlide=i.slide;break;case 2:!U&&W[t].fineSlide&&(U=W[t].fineSlide.value),i.slide={value:U,fine:!0},W[t].fineSlide=i.slide;break;case 3:W[t].glissando=!!U;break;case 4:switch(U){case 1:N=Audio.waveFormFunction.saw;break;case 2:N=Audio.waveFormFunction.square;break;case 3:case 4:N=Audio.waveFormFunction.sine;break;case 5:N=Audio.waveFormFunction.saw;break;case 6:N=Audio.waveFormFunction.square;break;case 7:default:N=Audio.waveFormFunction.sine}break;case 5:if(o){var M=R.getInstrument(o);i.fineTune={original:M.getFineTune(),instrument:M},M.setFineTune(U)}break;case 6:U?(z[t]=z[t]||0,z[t]<U?(z[t]++,m.patternBreak=!0,m.positionBreak=!0,m.targetSongPosition=a.position,m.targetPatternPosition=K[t]||0):z[t]=0):K[t]=a.step;break;case 7:switch(U){case 1:B=Audio.waveFormFunction.saw;break;case 2:B=Audio.waveFormFunction.square;break;case 3:case 4:B=Audio.waveFormFunction.sine;break;case 5:B=Audio.waveFormFunction.saw;break;case 6:B=Audio.waveFormFunction.square;break;case 7:default:B=Audio.waveFormFunction.sine}break;case 8:break;case 9:U&&(i.reTrigger={value:U});break;case 10:i.fade={value:U=100*U/64,fine:!0};break;case 11:i.fade={value:-(U=100*U/64),fine:!0};break;case 12:U?U<V&&(i.cutNote={value:U}):u=!1;break;case 13:U&&(U<V?n+=F*U:u=!1);break;case 14:m.patternDelay=U}break;case 15:break;case 16:p=Math.min(p,64),R.isPlugin||Audio.setMasterVolume(p/64,n);break;case 17:f=p>>4,g=15&p;var _=64*Audio.getLastMasterVolume(),L=0;if(f){var D=n+f*F;L=f*(V-1)}else g&&(D=n+g*F,L=-g*(V-1));L&&(p=(_+L)/64,p=Math.max(0,p),p=Math.min(1,p),Audio.slideMasterVolume(p,D));break;case 20:R.inFTMode()&&(d=M||R.getInstrument(Y[t].currentInstrument),e.param&&V<=e.param||(u=!1,d?e.param?(i.noteOff={value:e.param},u=!0):r=c=d.noteOff(n,Y[t]):r=0));break;case 21:case 25:break;case 27:i.reTrigger={value:e.param}}return u&&o&&s&&(O(t,n),Y[t]={},M&&(Y[t]=M.play(l,s,c,t,i,n)),W[t].defaultSlideTarget=Y[t].startPeriod),o&&(Y[t].currentInstrument=o,i.fineTune&&i.fineTune.instrument&&i.fineTune.instrument.setFineTune(i.fineTune.original||0)),M&&M.hasVibrato()&&(Y[t].hasAutoVibrato=!0),Y[t].effects=i,Y[t].note=e,m}function O(e,t){try{if(Y[e].source){var n=Y[e].volume.gain;n.setValueAtTime(Y[e].currentVolume/100,t-.002),n.linearRampToValueAtTime(0,t),Y[e].source.stop(t+.02)}}catch(e){}}function y(e,t){var n=R.getInstrument(e.instrumentIndex);if(n){var a=-n.vibrato.rate/40,r=n.vibrato.depth/8;if(R.useLinearFrequency&&(r*=4),e.vibratoTimer=e.vibratoTimer||0,n.vibrato.sweep&&e.vibratoTimer<n.vibrato.sweep)r*=1-(n.vibrato.sweep-e.vibratoTimer)/n.vibrato.sweep;var i=n.getAutoVibratoFunction()(t,e.vibratoTimer,a,r);return e.vibratoTimer++,i}return t}function v(e,t){var n=Y[e],a=n.effects;if(n&&a){var r,i=!1;if(n.startVibratoTimer=n.vibratoTimer||0,n.resetPeriodOnStep&&n.source)R.setPeriodAtTime(n,d=n.currentPeriod||n.startPeriod,t),n.resetPeriodOnStep=!1;if(a.volume){var o=a.volume.value;n.volume&&n.volume.gain.setValueAtTime(o/100,t),n.currentVolume=o}if(a.panning&&(255===(r=a.panning.value)&&(r=254),n.panning&&n.panning.pan.setValueAtTime((r-127)/127,t)),a.fade){var s;r=a.fade.value;var l=1;s=a.fade.resetOnStep?n.startVolume:n.currentVolume;var c=V;a.fade.fine&&(l=0,c=1);for(var u=l;u<c;u++)n.volume&&(n.volume.gain.setValueAtTime(s/100,t+u*F),s+=r,s=Math.max(s,0),s=Math.min(s,100));n.currentVolume=s}if(a.slide&&n.source){var d=p=n.currentPeriod||n.startPeriod;c=V;a.slide.fine&&(c=2);var h,f=a.slide.value;if(R.inFTMode()&&R.useLinearFrequency&&(f=4*a.slide.value),r=Math.abs(f),R.inFTMode()&&a.slide.resetVolume&&(n.volumeFadeOut||n.volumeEnvelope))(h=R.getInstrument(n.instrumentIndex))&&h.resetVolume(t,n);n.vibratoTimer=n.startVibratoTimer;for(u=1;u<c;u++){a.slide.target?(W[e].defaultSlideTarget=a.slide.target,d<a.slide.target?a.slide.target<(d+=r)&&(d=a.slide.target):(d-=r)<a.slide.target&&(d=a.slide.target)):(d+=f,W[e].defaultSlideTarget&&(W[e].defaultSlideTarget+=f)),R.inFTMode()||(d=Audio.limitAmigaPeriod(d));var g=d;a.slide.canUseGlissando&&W[e].glissando&&(g=Audio.getNearestSemiTone(d,n.instrumentIndex)),d!==n.currentPeriod&&(n.currentPeriod=d,n.hasAutoVibrato&&R.inFTMode()&&(d=y(n,g),i=!0),R.setPeriodAtTime(n,g,t+u*F))}}if(a.arpeggio&&n.source){var p=n.currentPeriod||n.startPeriod;n.resetPeriodOnStep=!0,n.vibratoTimer=n.startVibratoTimer;for(u=0;u<V;u++){var m=u%3;0==m&&(d=p),1==m&&a.arpeggio.interval1&&(d=p-a.arpeggio.interval1),2==m&&a.arpeggio.interval2&&(d=p-a.arpeggio.interval2),n.hasAutoVibrato&&R.inFTMode()&&(d=y(n,d),i=!0),R.setPeriodAtTime(n,d,t+u*F)}}if(a.vibrato||n.hasAutoVibrato&&!i){a.vibrato=a.vibrato||{freq:0,amplitude:0};var v=a.vibrato.freq,b=a.vibrato.amplitude;if(R.inFTMode()&&R.useLinearFrequency&&(b*=4),n.vibratoTimer=n.vibratoTimer||0,n.source){n.resetPeriodOnStep=!0,p=n.currentPeriod||n.startPeriod,n.vibratoTimer=n.startVibratoTimer;for(u=0;u<V;u++)d=N(p,n.vibratoTimer,v,b),n.hasAutoVibrato&&R.inFTMode()?(d=y(n,d),i=!0):n.vibratoTimer++,R.setPeriodAtTime(n,d,t+u*F)}}if(a.tremolo){v=a.tremolo.freq,b=a.tremolo.amplitude;if(n.tremoloTimer=n.tremoloTimer||0,n.volume){var E=n.startVolume;for(u=0;u<V;u++)(E=B(E,n.tremoloTimer,v,b))<0&&(E=0),100<E&&(E=100),n.volume.gain.setValueAtTime(E/100,t+u*F),n.currentVolume=E,n.tremoloTimer++}}if(a.cutNote&&(n.volume&&n.volume.gain.setValueAtTime(0,t+a.cutNote.value*F),n.currentVolume=0),a.noteOff)(h=R.getInstrument(n.instrumentIndex))&&(n.currentVolume=h.noteOff(t+a.noteOff.value*F,n));if(a.reTrigger){var w=n.instrumentIndex,T=n.startPeriod;o=n.startVolume;for(var I=n.noteIndex,k=a.reTrigger.value||1,S=k;S<V;){var C=t+S*F;O(e,C),Y[e]=Audio.playSample(w,T,o,e,a,C,I),S+=k}}}}function s(){UI&&UI.setInfo(E.title),E.channels&&R.setTrackCount(E.channels),k=n=r=t=void 0,R.setCurrentSongPosition(0),R.setCurrentPatternPos(0),R.setCurrentInstrumentIndex(1),R.clearEffectCache(),EventBus.trigger(EVENT.songLoaded,E),EventBus.trigger(EVENT.songPropertyChange,E)}function l(){EventBus.trigger(EVENT.songBPMChangeIgnored,0),EventBus.trigger(EVENT.songSpeedChangeIgnored,0),R.setAmigaSpeed(6),R.setBPM(125),B=N=Audio.waveFormFunction.sine,W=[],Y=[];for(var e=0;e<C;e++)Y.push({}),W.push({});R.useLinearFrequency=!1,R.setTrackerMode(TRACKERMODE.PROTRACKER,!0),R.isPlugin||Audio.setMasterVolume(1),Audio.setAmigaLowPassFilter(!1,0),void 0!==StateManager&&StateManager.clear()}function b(){for(var e=[],t=0;t<x;t++){var n,a=[];for(n=0;n<C;n++)a.push(Note());e.push(a)}return e}var a,E,r,n,t,w,N,B,T,R={},o=!(R.isMaster=!0),c=!1,u=[],d=1,f=0,g=0,p=PLAYTYPE.song,I=0,k=0,S=125,V=6,F=2.5/S,C=4,x=64,P=TRACKERMODE.PROTRACKER,A=0,Y=[],W=[],U=[],K=[],z=[];R.init=function(t){for(var e=0;e<C;e++)Y.push({}),W.push({});for(e=-8;e<8;e++)periodFinetuneTable[e]={};for(var n in NOTEPERIOD)if(NOTEPERIOD.hasOwnProperty(n)){var a=NOTEPERIOD[n];if(noteNames.push((nameNoteTable[(periodNoteTable[a.period]=a).name]=a).name),a.tune)for(e=-8;e<8;e++){periodFinetuneTable[e][a.tune[e+8]]=a.period}}var r=0;for(n in FTNOTEPERIOD)if(FTNOTEPERIOD.hasOwnProperty(n)){var i=FTNOTEPERIOD[n];i.period||(i.period=1),FTNotes.push(i),FTPeriods[i.period]=r,i.modPeriod&&(FTPeriods[i.modPeriod]=r),r++}t&&(Host.init(),Audio.init(t.audioContext,t.audioDestination),t.plugin&&(R.isPlugin=!0,UI.initPlugin(t),"boolean"==typeof t.isMaster&&(R.isMaster=t.isMaster),t.handler&&(EventBus.on(EVENT.songBPMChange,function(e){t.handler(EVENT.songBPMChange,e)}),EventBus.on(EVENT.songBPMChangeIgnored,function(e){t.handler(EVENT.songBPMChangeIgnored,e)}),EventBus.on(EVENT.songSpeedChange,function(e){t.handler(EVENT.songSpeedChange,e)}),EventBus.on(EVENT.songSpeedChangeIgnored,function(e){t.handler(EVENT.songSpeedChangeIgnored,e)}),EventBus.on(EVENT.patternEnd,function(e){t.handler(EVENT.patternEnd,e)}))))},R.setMaster=function(e){R.isMaster=e},R.isMaster=function(){return!!R.isMaster},R.setCurrentInstrumentIndex=function(e){if(E.instruments[e])r!=(d=e)&&EventBus.trigger(EVENT.instrumentChange,d),r=d;else if(e<=R.getMaxInstruments()){for(var t=E.instruments.length,n=e;t<=n;t++)R.setInstrument(t,Instrument());var a=[];for(t=1;t<=n;t++){a.push({label:t+" "+(E.instruments[t]||{name:""}).name,data:t}),EventBus.trigger(EVENT.instrumentListChange,a)}r!=(d=e)&&EventBus.trigger(EVENT.instrumentChange,d),r=d}},R.getCurrentInstrumentIndex=function(){return d},R.getCurrentInstrument=function(){return u[d]},R.getMaxInstruments=function(){return R.inFTMode()?128:31},R.setCurrentPattern=function(e){(w=E.patterns[f=e])||(w=b(),E.patterns[f]=w),x=w.length,n!=f&&EventBus.trigger(EVENT.patternChange,f),n=f},R.getCurrentPattern=function(){return f},R.getCurrentPatternData=function(){return w},R.updatePatternTable=function(e,t){EventBus.trigger(EVENT.patternTableChange,E.patternTable[e]=t),e==I&&(n=void 0,Tracker.setCurrentPattern(t))},R.setCurrentPatternPos=function(e){t!=(g=e)&&EventBus.trigger(EVENT.patternPosChange,{current:g,prev:t}),t=g},R.getCurrentPatternPos=function(){return g},R.moveCurrentPatternPos=function(e){var t=g+e,n=x-1;t<0&&(t=n),n<t&&(t=0),R.setCurrentPatternPos(t)},R.getCurrentSongPosition=function(){return I},R.setCurrentSongPosition=function(e,t){(I=e)!=k&&(EventBus.trigger(EVENT.songPositionChange,I),E.patternTable&&R.setCurrentPattern(E.patternTable[I]),k=I,t&&R.isPlaying()&&(R.stop(),R.togglePlay()))},R.setPlayType=function(e){EventBus.trigger(EVENT.playTypeChange,p=e)},R.getPlayType=function(){return p},R.playSong=function(){R.stop(),Audio.checkState(),R.setPlayType(PLAYTYPE.song),c=!0,e(f),EventBus.trigger(EVENT.playingChange,c)},R.playPattern=function(){R.stop(),Audio.checkState(),g=0,R.setPlayType(PLAYTYPE.pattern),c=!0,e(f),EventBus.trigger(EVENT.playingChange,c)},R.stop=function(){a&&a.stop(),Audio.disable(),R.isPlugin||Audio.setMasterVolume(1),UI&&(UI.setStatus("Ready"),Input.clearInputNotes()),R.clearEffectCache();for(var e=0;e<C;e++)if(Y[e].source)try{Y[e].source.stop()}catch(e){}EventBus.trigger(EVENT.playingChange,c=!1)},R.pause=function(){a&&a.stop(),EventBus.trigger(EVENT.playingChange,c=!1)},R.togglePlay=function(){R.isPlaying()?R.stop():p==PLAYTYPE.pattern?R.playPattern():R.playSong()},R.getProperties=function(){return{ticksPerStep:V,tickTime:F}},R.playPatternStep=m,R.cutNote=O,R.setBPM=function(e,t){var n=t&&t.isMaster;R.isMaster||n?(a&&a.timeStretch(Audio.context.currentTime,[T],S/e),n||EventBus.trigger(EVENT.songBPMChangeIgnored,S),F=2.5/(S=e),EventBus.trigger(EVENT.songBPMChange,S)):EventBus.trigger(EVENT.songBPMChangeIgnored,e)},R.getBPM=function(){return S},R.setAmigaSpeed=function(e,t){R.isMaster||t&&t.isMaster?EventBus.trigger(EVENT.songSpeedChange,V=e):EventBus.trigger(EVENT.songSpeedChangeIgnored,e)},R.getAmigaSpeed=function(){return V},R.getSwing=function(){return A},R.setSwing=function(e){A=e},R.getPatternLength=function(){return x},R.setPatternLength=function(e){var t=E.patterns[f].length;if(t!==(x=e)){if(t<x)for(var n=t;n<x;n++){var a,r=[];for(a=0;a<C;a++)r.push(Note());E.patterns[f].push(r)}else E.patterns[f]=E.patterns[f].splice(0,x),x<=g&&R.setCurrentPatternPos(x-1);EventBus.trigger(EVENT.patternChange,f)}},R.getTrackCount=function(){return C},R.setTrackCount=function(e){C=e;for(var t=Y.length;t<C;t++)Y.push({});for(t=W.length;t<C;t++)W.push({});EventBus.trigger(EVENT.trackCountChange,C)},R.toggleRecord=function(){R.stop(),EventBus.trigger(EVENT.recordingChange,o=!o)},R.isPlaying=function(){return c},R.isRecording=function(){return o},R.setStateAtTime=function(e,t){U.push({time:e,state:t})},R.getStateAtTime=function(e){for(var t=void 0,n=0,a=U.length;n<a;n++){if(!(U[0].time<e))return t;t=U.shift().state}return t},R.getTimeStates=function(){return U},R.setPeriodAtTime=function(e,t,n){if(t=Math.max(t,1),R.inFTMode()&&R.useLinearFrequency)var a=8363*Math.pow(2,(4608-t)/768)/Audio.context.sampleRate;else a=e.startPeriod/t,a*=e.startPlaybackRate;e.source.playbackRate.setValueAtTime(a,n),e.source.playbackRate.setValueAtTime(a,n+.005)},R.load=function(o,s,l,t){(o=o||"demomods/StardustMemories.mod").indexOf("://")<0&&0!==o.indexOf("/")&&(o=Host.getBaseUrl()+o),UI&&(UI.setInfo(""),UI.setLoading());function n(e){t&&!Host.useInitialLoad||R.processFile(e,c,function(e){if(UI&&UI.setStatus("Ready"),e){var t="",n="";if("string"==typeof o){if(0<o.indexOf("modarchive.org")){var a=o.split("moduleid=")[1];E.filename=a.split("#")[1]||a,n="modArchive",t="https://modarchive.org/index.php?request=view_by_moduleid&query="+(a=(a=a.split("#")[0]).split("&")[0]),EventBus.trigger(EVENT.songPropertyChange,E)}0<o.indexOf("modules.pl")&&(a=o.split("modules.pl/")[1],E.filename=a.split("#")[1]||a,n="modules.pl",t="http://www.modules.pl/?id=module&mod="+(a=(a=a.split("#")[0]).split("&")[0]),EventBus.trigger(EVENT.songPropertyChange,E)),0<o.indexOf("&path=")&&(a=(a=(a=(a=o.split("&path=")[1]).split(":")[1]||a).split("#")[0]).split("&")[0],E.filename=a,EventBus.trigger(EVENT.songPropertyChange,E))}UI&&UI.setInfo(E.title,n,t)}if(UI&&e&&!s){var r=window.location.pathname,i=r.substring(r.lastIndexOf("/")+1);window.history.pushState&&window.history.pushState({},c,i+"?file="+encodeURIComponent(o))}e&&M(s),l&&l()})}var c="";"string"==typeof o?(c=o.substr(o.lastIndexOf("/")+1),loadFile(o,function(e){n(e)})):(c=o.name||"",s=!0,n(o.buffer||o))};var M=function(e){var t=getUrlParameter("autoplay");Tracker.autoPlay&&(t="1"),!UI&&e&&(t="1"),"true"!=t&&"1"!=t||Tracker.playSong()};return R.handleUpload=function(e){if(e.length){var t=e[0],n=new FileReader;n.onload=function(){R.processFile(n.result,t.name,function(e){UI&&UI.setStatus("Ready")})},n.readAsArrayBuffer(t)}},R.processFile=function(e,a,r){var t=!1,n=new BinaryStream(e,!0),i=FileDetector.detect(n,a);if(i&&"ZIP"==i.name)if(UI&&UI.setStatus("Extracting Zip file",!0),"undefined"!=typeof UZIP){var o=UZIP.parse(e);for(var a in o){R.processFile(o[a].buffer,a,r);break}}else zip.workerScriptsPath="script/src/lib/zip/",zip.useWebWorkers=Host.useWebWorkers,zip.createReader(new zip.ArrayBufferReader(e),function(e){var t,n=0;e.getEntries(function(e){e&&e.length&&e.forEach(function(e){n<e.uncompressedSize&&(n=e.uncompressedSize,t=e)}),t?t.getData(new zip.ArrayBufferWriter,function(e){e&&e.byteLength&&R.processFile(e,a,r)}):r&&r(!1)})},function(e){r&&r(!1)});i.isMod&&i.loader&&(t=!0,R.isPlaying()&&R.stop(),l(),(E=i.loader().load(n,a)).filename=a,s()),i.isSample&&void 0!==Editor&&Editor.importSample(n,a),r&&r(t)},R.getSong=function(){return E},R.getInstruments=function(){return u},R.getInstrument=function(e){return u[e]},R.setInstrument=function(e,t){u[t.instrumentIndex=e]=t},R.clearEffectCache=function(){W=[];for(var e=0;e<C;e++)W.push({})},R.clearInstruments=function(e){if(E){var t=[],n=e||E.instruments.length-1;for(u=[],i=1;i<=n;i++)R.setInstrument(i,Instrument()),t.push({label:i+" ",data:i});E.instruments=u,EventBus.trigger(EVENT.instrumentListChange,t),EventBus.trigger(EVENT.instrumentChange,d)}},R.setTrackerMode=function(e,t){function n(){P=e,SETTINGS.emulateProtracker1OffsetBug=!R.inFTMode(),EventBus.trigger(EVENT.trackerModeChanged,e)}e===TRACKERMODE.PROTRACKER&&!t&&32<Tracker.getInstruments().length?UI.showDialog("WARNING !!!//This file has more than 31 instruments./If you save this file as .MOD, only the first 31 instruments will be included.//Are you sure you want to continue?",function(){n()},function(){}):n()},R.getTrackerMode=function(){return P},R.inFTMode=function(){return P===TRACKERMODE.FASTTRACKER},R.new=function(){l(),E={patterns:[],instruments:[]},R.clearInstruments(31),E.typeId="M.K.",E.title="new song",E.length=1,E.restartPosition=0,E.patterns.push(b());for(var e=[],t=0;t<128;++t)e[t]=0;E.patternTable=e,s()},R.clearInstrument=function(){u[d]=Instrument(),EventBus.trigger(EVENT.instrumentChange,d),EventBus.trigger(EVENT.instrumentNameChange,d)},R.getFileName=function(){return E.filename||(E.title?E.title.replace(/ /g,"-").replace(/\W/g,"")+".mod":"new.mod")},R.useLinearFrequency=!0,R}(),Yascal=(Fx={sprites:{},getImage:function(e){return Fx.sprites[e]?Fx.sprites[e].canvas:void 0},loadImage:function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.onload=function(){t&&t(n)},n.onerror=function(){},n.src=e}},Fx),Fx,Y=Yascal,canvas,ctx,UI=function(){function e(e){if(!e.length)return 0;for(var t=0,n=0,a=e.length;n<a;n++)t+=e[n];return t/a}var r,i,o,s,l,c,u,d,h,t,n,f,a={},g=!1,p=[],m=1200,v=!0,b=0,E=0,w=0,T=0,I=0,k=0,S=0,C=0,y=100,x=[],P=[],A=0,U=!1,M={},_=getUrlParameter("tracks");if(8==_&&(m=1200),16==_&&(m=1600),32<=_&&(m=3200),f=window.performance&&performance.now?function(){return performance.now()}:Date.now,!window.requestAnimationFrame){var L=0;window.requestAnimationFrame=function(e,t){var n=(new Date).getTime(),a=Math.max(0,16-(n-L)),r=window.setTimeout(function(){e(n+a)},a);return L=n+a,r}}a.init=function(e){var t=Host.useUrlParams;canvas=document.getElementById("canvas"),(ctx=canvas.getContext("2d")).imageSmoothingEnabled=!1;var n=window.innerWidth,a=window.innerHeight;m<n&&(n=m),2e3<a&&(a=2e3),i=a,canvas.width=r=n,canvas.height=i,ctx.fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#78828F",ctx.font="20px sans-serif",ctx.textAlign="center",ctx.fillText("Loading ...",canvas.width/2,canvas.height/2),debug&&UI.measure("Create Main Canvas"),UI.Assets.preLoad(function(){debug&&UI.measure("UI sprites"),D(),Input.init(),debug&&UI.measure("Input Init"),O(),debug&&UI.measure("First render"),t&&"undefined"!=typeof versionNumber&&FetchService.json("package.json?ts="+(new Date).getTime(),function(e){if(e&&e.version&&e.version!==versionNumber){var t=localStorage.getItem("updatemessageshown")||0;if(t=parseInt(t,10),isNaN(t)&&(t=0),window.reload=function(){localStorage.setItem("updatemessageshown",(new Date).getTime()),window.location.reload(!0)},18e5<(new Date).getTime()-t){var n=document.createElement("div");n.className="message",n.innerHTML='A new version of BassoonTracker is available. Please <a href="#" onclick="reload()">refresh your browser</a>',document.body.appendChild(n)}}}),e&&e()})},a.initPlugin=function(e){if(e.canvas)canvas=e.canvas;else{canvas=document.getElementById("canvas");var t=window.innerWidth;m<t&&(t=m),2e3<t&&(t=2e3),canvas.width=t}(ctx=canvas.getContext("2d")).fillStyle="black",ctx.fillRect(0,0,canvas.width,canvas.height),Settings.baseUrl=e.baseUrl,App.isPlugin=!0,buildNumber=Math.random(),UI.Assets.preLoad(function(){D(),O(),Settings.readSettings(),App.init(),e.callback&&e.callback()})},a.setSize=function(e,t){m<e&&(e=m),2e3<t&&(t=2e3),t<200&&(t=200),e===canvas.width&&t===canvas.height||(ctx.clearRect(0,0,canvas.width,canvas.height),r=e,i=t,a.scaleToDevicePixelRatio(g),a.mainPanel.setSize(e,t),d&&d.setProperties({width:e,height:t}),v=!0)},a.scaleToDevicePixelRatio=function(e){g=!!e,e&&1<devicePixelRatio?(canvas.width=r*devicePixelRatio,canvas.height=i*devicePixelRatio,ctx.scale(devicePixelRatio,devicePixelRatio),ctx.imageSmoothingEnabled=!1):(canvas.width=r,canvas.height=i),canvas.style.width=r+"px",canvas.style.height=i+"px",UI.mainPanel.refresh()};var D=function(){var e=Y.getImage("font");(o=BitmapFont()).generate({image:e,startX:1,startY:1,charWidth:6,charHeight:6,spaceWidth:6,margin:0,charsPerLine:42,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890.+-_#>",onlyUpperCase:!0}),window.fontSmall=o,(s=BitmapFont()).generate({image:e,startX:1,startY:110,charWidth:8,charHeight:8,spaceWidth:8,margin:1,charsPerLine:26,lineSpacing:1,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789↑↓-#:.!©_?;()=/+<>&[]{}\\*%$'\"`°,",onlyUpperCase:!0}),s.generateColor("green","rgba(80, 140, 0,0.9)"),s.generateColor("orange","rgba(161, 82, 0,0.9)"),window.fontMed=s,(l=BitmapFont()).generate({image:e,startX:1,startY:10,charWidth:11,charHeight:11,spaceWidth:11,margin:1,charsPerLine:20,lineSpacing:3,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890.,-_",onlyUpperCase:!0}),window.fontBig=l,(c=BitmapFont()).generate({image:e,startX:1,startY:145,charHeight:12,spaceWidth:4,margin:1,charsPerLine:[26,26,40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz1234567890#©_-&\"'()!.,?+=*$/\\;:[]{}",charWidth:"888888883888998888888899987777757735739777757578987777777777778868864553348767888435555",onlyUpperCase:!1,debug:!1}),window.fontFT=c,(u=BitmapFont()).generate({image:e,startX:1,startY:184,charHeight:10,spaceWidth:5,margin:0,charsPerLine:[26,26,10],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",charWidth:"6666556625656666666666666655555455245365555454566555",onlyUpperCase:!1}),window.fontCondensed=u;var t=BitmapFont();t.generate({image:e,startX:2,startY:208,charHeight:8,charWidth:4,spaceWidth:4,margin:0,charsPerLine:[45],lineSpacing:0,chars:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_.-#+><↑↓",onlyUpperCase:!0}),t.generateColor("green","rgba(80, 140, 0,0.9)"),t.generateColor("orange","rgba(161, 82, 0,0.9)"),window.fontSuperCondensed=t;var n=BitmapFont();n.generate({image:e,startX:107,startY:68,charWidth:8,charHeight:13,spaceWidth:8,margin:0,charsPerLine:20,chars:" 0123456789-"}),window.fontLed=n;var a=BitmapFont();a.generate({image:e,startX:9,startY:82,charWidth:14,charHeight:22,spaceWidth:8,margin:0,charsPerLine:11,chars:" 0123456789"}),window.fontLedBig=a;var r=BitmapFont();r.generate({image:e,startX:1,startY:216,charHeight:9,spaceWidth:5,margin:0,charsPerLine:[40],lineSpacing:0,chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890():-",charWidth:"7777667736768777877778887746666666664434",onlyUpperCase:!0}),window.fontDark=r,debug&&UI.measure("Generate font"),UI.Assets.init(),UI.mainPanel=UI.MainPanel(),p.push(UI.mainPanel),debug&&UI.measure("Generate Main Panel")},O=function(e){var t=!0;if(Tracker.isPlaying()){var n=Tracker.getStateAtTime(Audio.context.currentTime+.01);n&&(n.patternPos!==M.patternPos&&(Tracker.setCurrentPatternPos(n.patternPos),M.patternPos=n.patternPos),n.songPos!==M.songPos&&(Tracker.setCurrentSongPosition(n.songPos),M.songPos=n.songPos))}b&&(t=b<++E);var a=Audio.context?Audio.context.currentTime:0;if(t){var r=1e3/((T=f())-I);P.push(r),20<P.length&&P.shift(),60<r&&(t=!1)}t&&(E=0,I=T,EventBus.trigger(EVENT.screenRefresh),d&&d.needsRendering&&(UI.mainPanel.refresh(),v=!0),v&&(p.forEach(function(e){e.needsRendering&&e.render()}),EventBus.trigger(EVENT.screenRender),d&&(d.render(),v=!1))),a&&(C++,(w=w||a)+1<a&&(h=C/(a-w),y=Math.min(y,h),w=a,C=0,x.push(h),20<x.length&&x.shift(),!U&&5<x.length&&(Logger.info("init "+Math.round(S)),U=!0),EventBus.trigger(EVENT.second))),window.requestAnimationFrame(O)};return a.setModalElement=function(e){Input.setFocusElement(d=e)},a.getModalElement=function(){return d},a.removeModalElement=function(){d&&Input.clearFocusElement(),d=void 0,UI.mainPanel.refresh(),v=!0},a.setSelection=function(e){n=t=e},a.getSelection=function(){return t},a.clearSelection=function(){t&&t(SELECTION.RESET)&&(t=void 0)},a.copySelection=function(e){t&&(t(SELECTION.COPY),e&&t(SELECTION.RESET)),t=void 0},a.cutSelection=function(e){t&&(t(SELECTION.CUT),e&&t(SELECTION.RESET)),t=void 0},a.deleteSelection=function(){t&&t(SELECTION.DELETE),t=void 0},a.pasteSelection=function(e){!t&&n&&(t=n)(SELECTION.POSITION),t&&(t(SELECTION.PASTE),e&&t(SELECTION.RESET)),t=void 0},a.showContextMenu=function(e){EventBus.trigger(EVENT.showContextMenu,e)},a.hideContextMenu=function(){EventBus.trigger(EVENT.hideContextMenu)},a.showDialog=function(e,n,a,r){var i=UI.modalDialog();i.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!!n,cancel:!!a,input:!!r}),i.onClick=function(e){var t;if(r&&"dialoginput"===(t=i.getElementAtPoint(e.x,e.y)).name)return void t.activate();a?(t=i.getElementAtPoint(e.x,e.y))&&t.name&&("okbutton"===t.name?"function"==typeof n&&n(i.inputValue):"function"==typeof a&&a(),i.close()):(i.close(),n&&n(i.inputValue))},i.onKeyDown=function(e){switch(e){case 13:var t=i.inputValue;return i.close(),n&&n(t),!0;case 27:return i.close(),a&&a(),!0}},i.setText(e),UI.setModalElement(i)},a.getChildren=function(){return p},a.getEventElement=function(e,t){for(var n=void 0,a=0,r=p.length;a<r;a++){var i=p[a];if(i.isVisible()&&i.containsPoint(e,t)){n=i;break}}return n&&n.children&&n.children.length&&(n=n.getElementAtPoint(e,t)),n},a.getInternalPoint=function(e,t,n){for(var a={left:0,top:0};n.parent;)a.left+=n.left,a.top+=n.top,n=n.parent;return{x:e-a.left,y:t-a.top}},a.setLoading=function(){a.setStatus("Loading",!0),EventBus.trigger(EVENT.songLoading)},a.setStatus=function(e,t){EventBus.trigger(EVENT.statusChange,{status:e,showSpinner:!!t})},a.setInfo=function(e,t,n){EventBus.trigger(EVENT.statusChange,{info:e,source:t,url:n})},a.stats=function(){return{fps:h,minFps:y,averageFps:e(x),averageRenderFps:e(P),fpsList:x,skipRenderSteps:b}},a.startMeasure=function(){Audio.context&&(k=Audio.context.currentTime)},a.measure=function(e){if(Audio.context){0}},a.endMeasure=function(){Audio.context&&(S=1e3*(Audio.context.currentTime-k))},a.children=p,a.getAverageFps=function(){return 2<x.length?e(x):60},a.resetAverageFps=function(){var e=x.pop();x=e?[e]:[]},a.skipFrame=function(e){SETTINGS.skipFrame=b=e,EventBus.trigger(EVENT.skipFrameChanged,b)},a.getSkipFrame=function(){return b},EventBus.on(EVENT.clockEventExpired,function(){var e=f();2e3<e-A&&(Logger.warn("throttling back"),b<4?a.skipFrame(b+1):Logger.warn("Browser can't keep up"),A=e)}),a}();UI.app_sidebar=function(){var f=UI.panel(0,0,200,200);return f.setProperties({name:"sideBar"}),f.init=function(){function t(e){var t=c[e];t&&(l.setSelectedIndex(e),u=e,Tracker.autoPlay=d=!0,Tracker.load(t.url))}function e(){d&&(c.length<=++u&&(u=0),Tracker.stop(),t(u))}var n=UI.scale9Panel(0,0,f.width,f.height,{img:Y.getImage("background"),left:3,top:3,right:4,bottom:4});n.ignoreEvents=!0,f.addChild(n);var a=UI.label();a.setProperties({label:"Playlist:",font:fontFT}),f.addChild(a);var r=UI.Assets.generate("buttonKey");f.addChild(r),r.onClick=function(){App.doCommand(COMMAND.toggleAppSideBar)};var i=UI.Assets.generate("buttonKey");i.setLabel("Next"),i.onClick=function(){e()};var o=UI.Assets.generate("buttonKey");o.setLabel("Toggle UI"),o.onClick=function(){};var s=UI.scale9Panel(0,0,f.width,f.height,{img:Y.getImage("background"),left:3,top:3,right:4,bottom:4});s.ignoreEvents=!0,f.addChild(s),f.addChild(i),f.addChild(o);var l=UI.listbox(2,50,100,100);l.setProperties({font:window.fontFT}),f.addChild(l);var c=[{label:"Demomusic",url:"demomods/demomusic.mod"},{label:"Stardust Memories",url:"demomods/StardustMemories.mod"},{label:"Space Debry",url:"demomods/spacedeb.mod"}],u=0,d=!1;l.onChange=function(e){},l.onClick=function(){var e=l.getItemAtPosition(l.eventX,l.eventY);e&&e.url&&t(e.index)},f.onResize=function(){n.setSize(f.width,f.height),r.setPosition(f.width-22,2),a.setSize(f.width,Layout.trackControlHeight),s.setPosition(2,32),s.setSize(f.width-4,54),i.setPosition(8,36),i.setProperties({width:f.width<50?20:100}),i.setLabel(f.width<50?">":"Next"),o.setPosition(8,56),o.setProperties({width:f.width<50?20:100}),o.setLabel(f.width<50?"-":"Toggle UI");l.setProperties({left:2,top:88,width:f.width-4,height:f.height-88-Layout.defaultMargin}),f.width<50?(a.hide(),s.hide(),l.hide(),i.setPosition(2,36)):(a.show(),s.show(),l.show())},EventBus.on(EVENT.songEnd,function(){e()}),f.onResize();var h=Host.getBaseUrl()+"demomods/Playlist/";FetchService.get(h+"list.txt",function(e){(e=e.split("\n")).forEach(function(e){e&&c.push({label:e,url:h+e})}),c.forEach(function(e,t){e.index=t}),u=0,d=!1,l.setItems(c)})},f},UI.buttonGroup=function(e,t){var o=UI.panel();o.hide();var s=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);s.ignoreEvents=!0,o.addChild(s);var n=UI.label({label:e,font:fontSmall,width:60,top:1});o.addChild(n);var l=[];return t.forEach(function(t){if("number"===t.type){var n=UI.numberDisplay({autoPadding:!0});n.setValue(t.value)}else(n=UI.Assets.generate("buttonLight")).setLabel(t.label),n.onClick=t.onClick;n.widthParam=t.width||100,o.addChild(n),l.push(n),t.onSamplePropertyChange&&EventBus.on(EVENT.samplePropertyChange,function(e){t.onSamplePropertyChange(n,e)})}),o.onResize=function(){s.setSize(o.width,18);var n=20,a=(o.height-n-2)/4,r=o.width,i=0;l.forEach(function(e,t){e.setProperties({width:Math.floor(r*e.widthParam/100),height:a,left:Math.floor(i*r/100),top:n}),95<(i+=e.widthParam)&&(i=0,n+=a)})},o},UI.pattern_sidebar=function(){var o=UI.panel();o.setProperties({name:"sideButtonPanel"});var s=UI.label();s.setProperties({label:"DEMOSONGS:",font:fontFT}),o.addChild(s);for(var l=[],c=[{label:"Demomusic",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/demomusic.mod")}},{label:"Stardust",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/StardustMemories.mod")}},{label:"Space Debris",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/spacedeb.mod")}},{label:"Tinytune",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/Tinytune.mod")}},{label:"Lotus 2",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/lotus20.mod")}},{label:"Professionaltracker",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/hoffman_and_daytripper_-_professional_tracker.mod")}},{label:"XM: Ambrozia",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/Ambrozia.xm")}},{label:"XM: Aquarium",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/aws_aqua.xm")}},{label:"8CHN: Block Shockin'",onClick:function(){Tracker.load(Host.getRemoteUrl()+"demomods/AceMan.mod")}},{label:"Random MOD",onClick:function(){App.doCommand(COMMAND.randomSong)}},{label:"Random XM",onClick:function(){App.doCommand(COMMAND.randomSongXM)}}],u=0;u<c.length;u++){var e=c[u],t=UI.button();t.info=e,t.onClick=e.onClick,o.addChild(l[u]=t)}var d=UI.button();d.setProperties({label:"",textAlign:"center",background:UI.Assets.buttonLightScale9,hoverBackground:UI.Assets.buttonLightHoverScale9,image:Y.getImage("piano"),font:window.fontMed}),d.onClick=function(){App.doCommand(COMMAND.togglePiano)},o.addChild(d);var h=UI.button();return h.setProperties({label:"",textAlign:"center",background:UI.Assets.buttonLightScale9,hoverBackground:UI.Assets.buttonLightHoverScale9,image:Y.getImage("nibbles")}),h.onClick=function(){App.doCommand(COMMAND.nibbles)},o.addChild(h),o.onResize=function(){s.setSize(o.width,Layout.trackControlHeight);d.setProperties({left:0,top:o.height-30,width:o.width,height:30}),h.setProperties({left:0,top:o.height-30-30,width:o.width,height:30});var e=c.length;for(u=0;u<e;u++){var t=l[u],n=30*u+s.height,a=0;h.top-30<n&&(a=-500);var r=UI.Assets.buttonLightScale9,i=UI.Assets.buttonLightHoverScale9;e-3<u&&(r=UI.Assets.panelDarkScale9,i=UI.Assets.panelDarkHoverScale9),t.setProperties({left:a,top:n,width:o.width,height:30,label:t.info.label,textAlign:"left",background:r,hoverBackground:i,font:window.fontFT})}},o.onResize(),o},UI.app_patternView=function(e,t,n,d){function O(e,t,n){if(Tracker.inFTMode())var a="i"+e.index+"."+K.charWidth;else a="p"+e.period+"."+K.charWidth;if(!u[a]){var r=document.createElement("canvas");r.height=Z,r.width=3*K.charWidth+2;var i=r.getContext("2d");if(Tracker.inFTMode())if(e.index){var o=FTNotes[e.index];97===e.index&&(o=FTNotes[NOTEOFF]);var s=o?o.name:"???"}else{s="---";var l=FTPeriods[e.period];l&&(o=FTNotes[l])&&(s=o.name)}else s=(l=periodNoteTable[e.period])?l.name:"---";K.write(i,s,0,0,0),u[a]=r}j.ctx.drawImage(u[a],t,n)}function N(e,t,n){t+=3*K.charWidth+4;var a="n"+e.instrument+"."+(z?e.volumeEffect:"")+"."+e.effect+"."+e.param+"."+K.charWidth;if(!f[a]){var r=document.createElement("canvas");r.height=Z,r.width=7*K.charWidth+10;var i=r.getContext("2d"),o=h(e.instrument,2,"0");"00"==o&&(o="..");var s=0;if(K.write(i,o,s,0,0,"green"),z){s+=2*K.charWidth+4;var l=e.volumeEffect||0;if(l&&(l-=16),l<80)o=h(l,2,"0");else{var c=(l>>4).toString(16).toUpperCase(),u=(15&l).toString(16).toUpperCase();o=(c={5:"-",6:"+",7:"↓",8:"↑",9:"S",A:"V",B:"P",C:"<",D:">",E:"M"}[c]||c)+u}e.volumeEffect||(o=".."),K.write(i,o,s,0,0)}s+=2*K.charWidth+4,o=(15<e.effect?function(e,t,n){if(d=e.toString(36).toUpperCase(),t&&d.length<t)for(n=n||"0";d.length<t;)d=n+d;return d}:h)(e.effect),"000"===(o+=h(e.param,2,"0"))&&(o="..."),K.write(i,o,s,0,0,"orange"),f[a]=r}j.ctx.drawImage(f[a],t,n)}function B(e,t,n,a,r){if(Tracker.isPlaying()&&e&&e.period&&p[a]!==r){var i=100;if(12===e.effect)i=100*e.param/64;else{var o=Tracker.getInstrument(e.instrument);o&&(i=100*o.sample.volume/64)}oe[a]=i,p[a]=r}if(oe[a]){G=!0;var s=oe[a]*le/100,l=100*s/le;if("colour"===SETTINGS.vubars){var c=Y.getImage("vubar");j.ctx.drawImage(c,0,100-l,26,l,t,n-s,10,s)}else"trans"===SETTINGS.vubars&&(j.ctx.fillStyle="rgba(120,190,255,0.3)",j.ctx.fillRect(t,n-s,10,s));oe[a]-=se,oe[a]<0&&(oe[a]=0)}}function R(e,t,n){var a=""+e;e<10&&(a="0"+a);var r=a+"."+K.charWidth;if(!l[r]){var i=document.createElement("canvas");i.height=Z,i.width=3*K.charWidth;var o=i.getContext("2d"),s=!1;e%4==0&&(s="orange"),K.write(o,a,0,0,0,s),l[r]=i}j.ctx.drawImage(l[r],t,n)}function h(e,t,n){if(d=e.toString(16).toUpperCase(),t&&d.length<t)for(n=n||"0";d.length<t;)d=n+d;return d}function V(){var e=Tracker.getCurrentPatternPos()||0;if(q){var t=1,n=j.height-2,a=n;r=0,1<W&&((a=Math.floor(q/W*n))<12&&(a=12),r=(n-a)/(W-1)),e&&r&&(t=Math.floor(1+r*e)),ae.setProperties({left:j.width-16,top:t,width:16,height:a})}}function F(){var e=j.width,t=Math.floor(e/Tracker.getTrackCount()*Q),n=(e-t)/(Tracker.getTrackCount()-Q),a=j.height-20;Q>=Tracker.getTrackCount()&&(a=-200),re.setProperties({top:a,width:t,left:0+Math.floor($*n)})}function c(){te={start:[ee.start[0],ee.start[1]],end:[ee.end[0],ee.end[1]]};for(var e=0;e<2;e++)ee.end[e]<ee.start[e]&&(te.start[e]=ee.end[e],te.end[e]=ee.start[e])}function a(e){ne?(ee.end=[Tracker.getCurrentPatternPos(),Editor.getCurrentTrack()],c()):(ee.start=[e.prev||0,Editor.getCurrentTrack()],ee.end=[e.current,Editor.getCurrentTrack()],ee.top=ee.left=1e5,c(),ne=!0,j.showSelectionUI()),j.refresh()}var W,K,z,G,H,X,j=UI.panel(e,t,n,d),q=0,Q=8,Z=13,J=0,r=0,$=0,u={},f={},l={},ee={},te={},g=[],ne=!1,ae=UI.scale9Panel(n-28,18,16,d-3,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});ae.onDragStart=function(){Tracker.isPlaying()||(ae.startDragIndex=Tracker.getCurrentPatternPos())},ae.onDrag=function(e){if(!Tracker.isPlaying()&&q&&r){var t=Math.floor(ae.startDragIndex+e.deltaY/r);t=Math.min(t,W-1),t=Math.max(t,0),Tracker.setCurrentPatternPos(t)}},j.addChild(ae),V();var re=UI.scale9Panel(n-28,18,16,16,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});re.onDragStart=function(){re.startDragIndex=$},re.onDrag=function(e){var t=Tracker.getTrackCount()-Q,n=Math.floor(e.deltaX/((j.width-re.width)/t));j.setHorizontalScroll(re.startDragIndex+n),j.onResize()},j.addChild(re);for(var ie=[],i=0,o=Tracker.getTrackCount();i<o;i++){var s=UI.fxPanel(i);ie.push(s),j.addChild(s)}var oe=[],p=[],se=5,le=70;return j.setHorizontalScroll=function(e){var t=Tracker.getTrackCount()-Q;e!=$&&0<=e&&e<=t&&(EventBus.trigger(EVENT.patternHorizontalScrollChange,$=e),F())},j.onResize=function(){H=Layout.firstTrackOffsetLeft,X=Layout.trackMargin;var e=j.height;(Q=Layout.visibleTracks)<Tracker.getTrackCount()&&(e-=24),cachedAssets.darkPanel=null;for(var t=0;t<Q;t++){if((s=ie[$+t])&&s.visible)s.setPosition(H+t*(Layout.trackWidth+X),0),s.setSize(Layout.trackWidth,e),s.setLayout(),s.show()}},j.render=function(){if(j.isVisible()){if(this.needsRendering){j.clearCanvas();var e=Tracker.getCurrentPattern()||0,t=Tracker.getCurrentPatternPos()||0,n=Tracker.getSong();if(!n)return;K=Layout.trackFont,W=Tracker.getPatternLength();var a=Q<Tracker.getTrackCount(),r=j.height-30,i=(z=Tracker.inFTMode())?92:72,o=9,s=28;Layout.useCondensedTrackFont&&(i=z?46:36,o=5,s=15);var l=10,c=Math.floor((Layout.trackWidth-i)/2)+l,u=!1;H&&(u=!(c=l=0)),a&&(r-=24),(q=Math.ceil(r/Z))%2==0&&q--;var d=Math.floor(q/2),h=t-d,f=h+q,g=Z+2,p=(J=Math.floor((r+g)/2))-d*Z+4,m=J,v=J+g,b=cachedAssets.darkPanel;if(!b&&Y.getImage("panel_dark")){var E=UI.scale9Panel(0,0,Layout.trackWidth,m,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});cachedAssets.darkPanel=E.render(!0),b=cachedAssets.darkPanel}var w=[];G=!1,se=5,m<(le=70)&&(se=(le=m)/10);for(var T=0;T<Q;T++){var I=$+T;if(w[I]=!(ie[I]&&ie[I].visible),w[I]&&b.height&&b.width){var k=H+T*(Layout.trackWidth+X);j.ctx.drawImage(b,k,0,Layout.trackWidth,m),j.ctx.drawImage(b,k,v,Layout.trackWidth,m),ie[I]&&(ie[I].left=k)}}var S=n.patterns[e];if(S){Tracker.isRecording()?j.ctx.fillStyle="#A50B0F":j.ctx.fillStyle="#202E58",j.ctx.fillRect(0,J,+j.width,g);var C,y=Editor.getCurrentTrackPosition(),x=o;C=u?(k=H+(Editor.getCurrentTrack()-$)*(Layout.trackWidth+X))+Math.floor((Layout.trackWidth-i)/2)+y*x-1:H+c+(Editor.getCurrentTrack()-$)*Layout.trackWidth+y*x-1,0<y?(C+=2*x+1,2<y&&(C+=2),4<y&&z&&(C+=2)):x=s,j.ctx.fillStyle="rgba(220,220,220,.3)",j.ctx.fillRect(C,J,x,Z+2),j.ctx.fillStyle="rgba(200,150,70,.3)";var P=8*K.charWidth+14;z&&(P+=2*K.charWidth+2);for(T=h;T<f;T++)if(0<=T&&T<Tracker.getPatternLength()){var A=S[T],U=p+(T-h)*Z,M=!0;U<J&&(U-=3,M=!1),J+Z<U&&(U+=3,M=!1),R(T,l,U),M&&(R(T,l,U),R(T,l,U));for(var _=0;_<Q;_++)if(w[I=_+$]&&I<Tracker.getTrackCount()){var L,D=A[I]||Note();L=u?(k=H+_*(Layout.trackWidth+X))+(Layout.trackWidth-i>>1):H+c+_*Layout.trackWidth,ne&&te.start[0]<=T&&T<=te.end[0]&&te.start[1]<=I&&I<=te.end[1]&&(ee.top=Math.min(ee.top,U-2),ee.left=Math.min(ee.left,L-2),j.ctx.fillRect(L-2,U-2,P,Z)),M&&(O(D,L,U),O(D,L,U),(Tracker.isPlaying()||oe[_]&&"none"!==SETTINGS.vubars)&&B(D,L-12,J,_,e+"."+t)),O(D,L,U),N(D,L,U)}G&&setTimeout(function(){j.refresh()},20)}}for(_=0;_<Q;_++)w[I=_+$]||ie[I].render();for(V(),ae.render(),a&&(F(),re.render()),_=0;_<Q;_++)w[I=_+$]&&K.write(j.ctx,""+(I+1),k=H+_*(Layout.trackWidth+X)+2,2,0,void 0)}this.needsRendering=!1,j.parentCtx.drawImage(j.canvas,j.left,j.top,j.width,j.height)}},j.onMouseWheel=function(e){if(!Tracker.isPlaying()){var t=Tracker.getCurrentPatternPos();0<e.mouseWheels[0]?t&&Tracker.moveCurrentPatternPos(-1):t<W-1&&Tracker.moveCurrentPatternPos(1)}},j.onDragStart=function(e){if(re.startDragIndex=$,!Tracker.isPlaying()&&(j.startDragPos=Tracker.getCurrentPatternPos(),e.isMeta||Tracker.isRecording())){var t=Math.floor((e.x-Layout.firstTrackOffsetLeft)/(Layout.trackWidth+Layout.trackMargin)),n=Editor.getStepsPerTrack();Editor.setCurrentCursorPosition(($+t)*n),UI.clearSelection(),j.startDragTrackX=t*(Layout.trackWidth+Layout.trackMargin)+Layout.firstTrackOffsetLeft;var a=Math.floor((e.y-J)/Z);ee.start=[Tracker.getCurrentPatternPos()+a,Editor.getCurrentTrack()],ee.end=ee.start,ee.top=ee.left=1e5,j.refresh()}},j.onDrag=function(e){if(Q<Tracker.getTrackCount()&&!e.isMeta&&!Tracker.isRecording()){var t=Tracker.getTrackCount()-Q,n=e.deltaX,a=Math.floor(n/((j.width-re.width)/t));j.setHorizontalScroll(re.startDragIndex-a)}if(!Tracker.isPlaying()){n=Math.round(e.deltaY/Z);var r=j.startDragPos-n;if(r=Math.max(r,0),r=Math.min(r,W-1),e.isMeta||Tracker.isRecording()){ne=!0,n=Math.floor(e.deltaY/Z);var i=Math.floor(e.deltaX/Layout.trackWidth);ee.end=[ee.start[0]+n,Editor.getCurrentTrack()+i],c(),j.refresh()}else Tracker.setCurrentPatternPos(r)}},j.onTouchUp=function(){ne&&j.showSelectionUI()},j.onClick=function(e){var t=Math.floor((e.x-Layout.firstTrackOffsetLeft)/(Layout.trackWidth+Layout.trackMargin)),n=Editor.getStepsPerTrack();Editor.setCurrentCursorPosition(($+t)*n)},j.getStartTrack=function(){return $},j.processSelection=function(e){if(j.isVisible())switch(e){case SELECTION.RESET:return ne=!1,UI.hideContextMenu(),j.refresh(),!0;case SELECTION.CLEAR:if((i=Tracker.getCurrentPatternData())&&ne){(o=StateManager.createRangeUndo(Tracker.getCurrentPattern())).name="Clear Selection";for(var t=te.start[0];t<=te.end[0];t++)for(var n=i[t],a=te.start[1];a<=te.end[1];a++){(s=n[a])&&(StateManager.addNote(o,a,t,s),s.clear())}}StateManager.registerEdit(o),j.refresh();break;case SELECTION.COPY:case SELECTION.CUT:if(g=[],(i=Tracker.getCurrentPatternData())&&ne)for(t=te.start[0];t<=te.end[0];t++){if(n=i[t]){var r=[];for(a=te.start[1];a<=te.end[1];a++){(s=n[a]||new Note)&&r.push(s.duplicate())}g.push(r)}}if(e===SELECTION.CUT&&ne){(o=StateManager.createRangeUndo(Tracker.getCurrentPattern())).name="Cut Selection";for(t=te.start[0];t<=te.end[0];t++){if(n=i[t])for(a=te.start[1];a<=te.end[1];a++){StateManager.addNote(o,a,t,s=n[a]),s&&s.clear()}}StateManager.registerEdit(o)}j.refresh();break;case SELECTION.PASTE:var i;if((i=Tracker.getCurrentPatternData())&&ne&&g.length){var o;(o=StateManager.createRangeUndo(Tracker.getCurrentPattern())).name="Paste Selection";for(t=0;t<g.length;t++){r=g[t];if(n=i[te.start[0]+t])for(a=0;a<r.length;a++){var s,l=te.start[1]+a;!(s=n[l])&&l<Tracker.getTrackCount()&&(s=new Note,n[l]=s),s&&(StateManager.addNote(o,l,te.start[0]+t,s),s.populate(r[a]))}}StateManager.registerEdit(o)}j.refresh();break;case SELECTION.POSITION:ee.start=ee.end=[Tracker.getCurrentPatternPos(),Editor.getCurrentTrack()],c(),ne=!0,j.refresh()}},j.showSelectionUI=function(){UI.setSelection(j.processSelection),UI.showContextMenu({name:"patternActions",items:[{label:"Clear",onClick:function(){j.processSelection(SELECTION.CLEAR)}},{label:"Cut",onClick:function(){j.processSelection(SELECTION.CUT)}},{label:"Copy",onClick:function(){j.processSelection(SELECTION.COPY)}},{label:"Paste",onClick:function(){j.processSelection(SELECTION.PASTE)}}],x:ee.left+j.left+j.parent.left,y:ee.top+j.top+j.parent.top})},EventBus.on(EVENT.patternPosChange,function(e){Input.isMetaKeyDown()&&!Tracker.isPlaying()&&a(e)}),EventBus.on(EVENT.cursorPositionChange,function(e){Input.isMetaKeyDown()&&!Tracker.isPlaying()&&a({current:Tracker.getCurrentPatternPos(),prev:Tracker.getCurrentPatternPos()})}),EventBus.on(EVENT.trackCountChange,function(e){Q<e&&(Q=e),$=Math.min($,e-Q),$=Math.max($,0);for(var t=ie.length,n=e;t<n;t++){var a=UI.fxPanel(t);ie.push(a),j.addChild(a)}j.onResize(),j.refresh()}),EventBus.on(EVENT.songLoaded,function(){j.setHorizontalScroll(0)}),EventBus.on(EVENT.visibleTracksCountChange,function(){$=0,j.onResize(),j.refresh()}),EventBus.on(EVENT.trackerModeChanged,function(){j.refresh()}),EventBus.on(EVENT.fxPanelToggle,function(e){if((s=ie[e]).visible)s.hide();else{var t=j.height;Q<Tracker.getTrackCount()&&(t-=24),s.setPosition(s.left,0),s.setSize(Layout.trackWidth,t),s.setLayout(),s.show()}j.refresh()}),EventBus.on(EVENT.skipFrameChanged,function(e){se=5*(e+1)}),EventBus.on(EVENT.commandSelectAll,function(){j.isVisible()&&(UI.clearSelection(),ee.start=[0,Editor.getCurrentTrack()],ee.end=[Tracker.getCurrentPatternData().length-1,Editor.getCurrentTrack()],c(),ne=!0,ee.top=ee.left=1e5,j.showSelectionUI(),j.refresh())}),j},UI.app_songControl=function(e,t,n,a,r){var i=UI.element(e,t,n,a,r);i.type="songControl";var o=UI.radioGroup();o.setItems([{label:"song",active:!0},{label:"pattern",labels:[{width:10,label:"p"},{width:20,label:"pat"}],active:!1}]),o.onChange=function(e){Tracker.setPlayType(0==e?PLAYTYPE.song:PLAYTYPE.pattern)},i.addChild(o);var s={};s.play=UI.Assets.generate("buttonDarkGreen"),s.play.setProperties({image:Y.getImage("play_green"),hoverImage:Y.getImage("play_green_hover"),activeImage:Y.getImage("play_active_red"),activeBackground:UI.Assets.buttonDarkRedActiveScale9}),s.play.onClick=function(){s.play.toggleActive(),Tracker.isPlaying()?Tracker.stop():Tracker.getPlayType()==PLAYTYPE.song?Tracker.playSong():Tracker.playPattern()},s.play.setProperties({name:"buttonPlay"}),i.addChild(s.play),s.record=UI.Assets.generate("buttonDarkRed"),s.record.setProperties({image:Y.getImage("record"),hoverImage:Y.getImage("record_hover"),activeImage:Y.getImage("record_active")}),s.record.onClick=function(){Tracker.toggleRecord()},s.record.setProperties({name:"buttonRecord"}),i.addChild(s.record),s.song=UI.Assets.generate("buttonDark"),s.song.onClick=function(){Tracker.playSong()},s.song.setProperties({label:"Song"}),i.addChild(s.song),s.pattern=UI.Assets.generate("buttonDark"),s.pattern.onClick=function(){Tracker.playPattern()},s.pattern.setProperties({label:"Pattern"}),i.addChild(s.pattern),EventBus.on(EVENT.recordingChange,function(e){s.record.setActive(e)}),EventBus.on(EVENT.playingChange,function(e){s.play.setActive(e)}),EventBus.on(EVENT.playTypeChange,function(e){o.setSelectedIndex(e==PLAYTYPE.song?0:1,!0)});var l=["left","top","width","height","name","type","songPatternSelector"];return i.setProperties=function(t){l.forEach(function(e){void 0!==t[e]&&(i[e]=t[e])}),i.setSize(i.width,i.height),i.setPosition(i.left,i.top);var e=Math.floor(i.width/3);o.setProperties({left:0,width:e,top:0,height:i.height,align:"right"}),s.play.setProperties({left:e,width:e,top:0,height:i.height}),s.record.setProperties({left:2*e,width:e,top:0,height:i.height}),"big"==i.songPatternSelector&&(o.left=-500,e=Math.floor(i.width/4)+1,s.play.setProperties({left:0,width:e}),s.record.setProperties({left:e,width:e}),s.song.setProperties({left:2*e,width:e,top:0,height:i.height}),s.pattern.setProperties({left:3*e,width:e,top:0,height:i.height}))},i.render=function(e){if(e=!!e,i.needsRendering&&(i.clearCanvas(),"small"==i.songPatternSelector&&o.render(),s.play.render(),s.record.render(),"big"==i.songPatternSelector&&(s.song.render(),s.pattern.render())),i.needsRendering=!1,e)return i.canvas;i.parentCtx.drawImage(i.canvas,i.left,i.top,i.width,i.height)},i},UI.app_songPatternList=function(e){function i(e){return(e=""+e).length<2&&(e="0"+e),e}var t=UI.panel(),n=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);t.addChild(n);var o=UI.listbox();o.setItems([{label:"01:00",data:1}]),o.onClick=function(){var e=o.getItemAtPosition(o.eventX,o.eventY);if(e){var t=e.index;e!==o.getSelectedIndex()&&o.setSelectedIndex(t)}},t.addChild(o);var a=UI.Assets.generate("button20_20");a.setLabel("↑"),a.onDown=function(){var e=o.getSelectedIndex(),t=Tracker.getSong().patternTable[e];Tracker.updatePatternTable(e,++t),UI.ticker.onEachTick4(function(){var e=o.getSelectedIndex(),t=Tracker.getSong().patternTable[e];Tracker.updatePatternTable(e,++t)},5)},a.onTouchUp=function(){UI.ticker.onEachTick4()},t.addChild(a);var r=UI.Assets.generate("button20_20");r.setLabel("↓"),r.onDown=function(){var e=o.getSelectedIndex(),t=Tracker.getSong().patternTable[e];0<t&&t--,Tracker.updatePatternTable(e,t),UI.ticker.onEachTick4(function(){var e=o.getSelectedIndex(),t=Tracker.getSong().patternTable[e];0<t&&t--,Tracker.updatePatternTable(e,t)},5)},r.onTouchUp=function(){UI.ticker.onEachTick4()},t.addChild(r);var s=UI.Assets.generate("button20_20");s.setLabel("Ins"),s.onDown=function(){var e=o.getSelectedIndex();Editor.addToPatternTable(e)},s.setProperties({width:40,height:20}),t.addChild(s);var l=UI.Assets.generate("button20_20");return l.setLabel("Del"),l.onDown=function(){var e=o.getSelectedIndex();Editor.removeFromPatternTable(e)},l.setProperties({width:40,height:20}),t.addChild(l),t.onResize=function(){n.setSize(t.width,t.height),o.setProperties({left:0,top:0,width:t.width-42,height:t.height,centerSelection:!0,onChange:function(){Tracker.setCurrentSongPosition(o.getSelectedIndex(),!0)}}),r.setPosition(t.width-22,Math.floor(t.height/2)-10),a.setPosition(t.width-42,r.top),s.setPosition(a.left,a.top-22),l.setPosition(a.left,a.top+22)},EventBus.on(EVENT.patternTableChange,function(e){t.setPatternTable(Tracker.getSong().patternTable)}),t.setPatternTable=function(e){for(var t=[],n=0,a=Tracker.getSong().length;n<a;n++){var r=e[n];t.push({label:i(n+1)+":"+i(r),data:r,index:n})}o.setItems(t)},EventBus.on(EVENT.songLoaded,function(e){t.setPatternTable(e.patternTable)}),EventBus.on(EVENT.songPositionChange,function(e){o.setSelectedIndex(e,!0)}),t},UI.trackControl=function(e,t,n,a,r){function i(e){EventBus.trigger(EVENT.trackStateChange,{track:o.track,solo:s.solo.isActive,mute:s.mute.isActive,wasSolo:e})}var o=UI.element(e,t,n,a,r);o.type="trackControl",o.track=0;var s={};s.solo=UI.Assets.generate("buttonDark"),s.solo.setProperties({activeImage:Y.getImage("solo.png"),activeBackground:UI.Assets.buttonDarkGreenActiveScale9}),s.solo.onClick=function(){var e=s.solo.isActive;s.solo.toggleActive(),s.mute.isActive&&s.mute.toggleActive(),i(e)},s.solo.setProperties({name:"buttonSolo",label:"S"}),o.addChild(s.solo),s.mute=UI.Assets.generate("buttonDark"),s.mute.setProperties({activeImage:Y.getImage("mute"),activeBackground:UI.Assets.buttonDarkRedActiveScale9}),s.mute.onClick=function(){s.mute.toggleActive(),s.solo.isActive&&s.solo.toggleActive(),i()},s.mute.setProperties({name:"buttonMute",label:"M"}),o.addChild(s.mute),s.fx=UI.Assets.generate("buttonDark"),s.fx.onClick=function(){s.fx.toggleActive(),EventBus.trigger(EVENT.fxPanelToggle,o.track)},s.fx.setProperties({name:"buttonFX",label:"FX"}),o.addChild(s.fx);var l=["left","top","width","height","name","type","track","solo","mute","visible"];return o.setProperties=function(t){l.forEach(function(e){if(void 0!==t[e])switch(e){case"solo":s.mute.isActive&&s.mute.setActive(!1),s.solo.setActive(t[e]),i();break;case"mute":s.solo.isActive&&s.solo.setActive(!1),s.mute.setActive(t[e]),i();break;default:o[e]=t[e]}}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top);var e=Math.floor(o.width/3)+1;s.solo.setProperties({left:0,width:e,top:0,height:o.height}),s.mute.setProperties({left:e-1,width:e,top:0,height:o.height}),s.fx.setProperties({left:2*e-2,width:e,top:0,height:o.height})},o.render=function(e){if(o.isVisible()){if(e=!!e,o.needsRendering&&(o.clearCanvas(),o.ctx.fillStyle="white",o.ctx.fillText("",10,10),s.solo.render(),s.mute.render(),s.fx.render()),o.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)}},EventBus.on(EVENT.trackScopeClick,function(e){e===o.track&&s.mute.onClick()}),o},UI.visualiser=function(){function a(){m=[];var e=Tracker.getTrackCount(),t=f.height;4<Tracker.getTrackCount()&&(e=Math.ceil(Tracker.getTrackCount()/2),t=f.height/2);for(var n=f.width/e,a=0;a<Tracker.getTrackCount();a++){var r=a*n,i=0;e<=a&&(r=(a-e)*n,i=f.height-t),m[a]={left:Math.floor(r),top:Math.floor(i),width:Math.floor(n),height:Math.floor(t),lineLeft:Math.ceil(r+n/70),lineWidth:Math.floor(n-n/30)}}}var r,h,f=UI.panel(),e=["wave","spectrum","tracks"],t=2,i=e[t],g=[],p=[],m=[],v=256;f.ctx.fillStyle="black",f.ctx.lineWidth=2,f.ctx.strokeStyle="rgba(120, 255, 50, 0.5)",f.init=function(){function n(){var e=Audio.context.createAnalyser();e.smoothingTimeConstant=0,e.fftSize=v,g.push(e)}if(Audio.context){(r=Audio.context.createAnalyser()).minDecibels=-90,r.maxDecibels=-10,r.smoothingTimeConstant=.85;for(var e=0;e<Tracker.getTrackCount();e++)n();a()}h=Y.getImage("oscilloscope"),EventBus.on(EVENT.filterChainCountChange,function(e){for(var t=g.length;t<e;t++)n();a(),f.connect()}),EventBus.on(EVENT.trackStateChange,function(e){void 0!==e.track&&(p[e.track]=e.mute)}),f.needsRendering=!0},f.connect=function(e){if(Audio.context){e&&e.connect(r);for(var t=0;t<Tracker.getTrackCount();t++)Audio.filterChains[t].output().connect(g[t])}},f.nextMode=function(){e.length<=++t&&(t=0),i=e[t]};return f.render=function(){Audio.context&&f.isVisible()&&function(){f.ctx.clearRect(0,0,f.width,f.height),f.ctx.lineWidth=2,f.ctx.strokeStyle="rgba(120, 255, 50, 0.5)";for(var e,t,n=!Audio.cutOff,a=0;a<Tracker.getTrackCount();a++){var r=g[a],i=m[a],o=p[a];if(f.ctx.drawImage(h,i.left,i.top,i.width,i.height),r){var s;f.ctx.beginPath();var l=i.lineLeft,c=i.lineWidth;if(n&&!o){r.fftSize=v,e=r.fftSize,t=new Uint8Array(e),r.getByteTimeDomainData(t);for(var u=c/e,d=0;d<e;d++){s=t[d]/128*i.height/2+i.top,0===d?f.ctx.moveTo(l,s):f.ctx.lineTo(l,s),l+=u}}else f.ctx.moveTo(l,s=i.height/2+i.top),f.ctx.lineTo(l+c-1,s);f.ctx.stroke(),o&&(f.ctx.fillStyle="rgba(34, 49, 85, 0.5)",f.ctx.fillRect(i.left,i.top,i.width,i.height))}}ctx.drawImage(f.canvas,f.left,f.top)}()},f.init(),f.onResize=function(){a()},EventBus.on(EVENT.screenRender,function(){f.render()}),EventBus.on(EVENT.second,function(){Tracker.isPlaying()&&UI.getAverageFps()<32&&32<v&&(v>>=1,v=Math.max(v,32),UI.resetAverageFps())}),f.onClick=function(e){if("tracks"===i)for(var t=0;t<Tracker.getTrackCount();t++){var n=m[t],a=e.x,r=e.y;if(n.left<a&&a<n.left+n.width&&n.top<r&&r<n.top+n.height){EventBus.trigger(EVENT.trackScopeClick,t);break}}},f},UI.vumeter=function(){function t(){d.width=h.width=u,d.height=h.height=6;var e=Math.floor(u/12);f.clearRect(0,0,d.width,d.height),g.clearRect(0,0,h.width,h.height);for(var t=0;t<e;t++){var n=p,a=m;e/3<=t&&(n=v,a=b),e/1.5<=t&&(n=E,a=w),f.drawImage(n,12*t,0,10,6),g.drawImage(a,12*t,0,10,6)}c.ctx.fillStyle="#253352"}function r(e){for(var t=e.length,n=128,a=128,r=0;r<t;r++){var i=e[r];i<n?n=i:a<i&&(a=i)}return(a-n)/255}var i,o,s,l,c=UI.panel();c.left=400,c.top=9,Audio.context&&((i=Audio.context.createAnalyser()).minDecibels=-90,i.maxDecibels=-10,i.smoothingTimeConstant=.85,(o=Audio.context.createAnalyser()).minDecibels=-90,o.maxDecibels=-10,o.smoothingTimeConstant=.85,o.fftSize=i.fftSize=32,l=new Uint8Array(i.fftSize));var u=500,d=document.createElement("canvas"),h=document.createElement("canvas"),f=d.getContext("2d"),g=h.getContext("2d"),p=Y.getImage("vu_green"),m=Y.getImage("vu_green_active"),v=Y.getImage("vu_yellow"),b=Y.getImage("vu_yellow_active"),E=Y.getImage("vu_red"),w=Y.getImage("vu_red_active");return c.setSize(u,16),t(),c.needsRendering=!0,c.connect=function(e){if(Audio.context){var t=Audio.context.createChannelSplitter(2);e.connect(t),t.connect(i,0),t.connect(o,1),s=!0}},c.setProperties=function(e){u=e.width,c.left=e.left,c.setSize(u,16),t()},c.render=function(){if(s){i.getByteTimeDomainData(l);var e=r(l)*(Math.E-1);o.getByteTimeDomainData(l);var t=r(l)*(Math.E-1);c.ctx.fillRect(0,0,c.width,c.height),c.ctx.drawImage(d,0,0),c.ctx.drawImage(d,0,10);var n=Math.min(Math.floor(e*u),u),a=Math.min(Math.floor(t*u),u);n&&c.ctx.drawImage(h,0,0,n,6,0,0,n,6),a&&c.ctx.drawImage(h,0,0,a,6,0,10,a,6),ctx.drawImage(c.canvas,c.left,c.top)}},EventBus.on(EVENT.screenRender,function(){c.render()}),c},UI.app_controlPanel=function(){var c=UI.app_panelContainer(40),u=UI.app_songControl();c.addChild(u);var d=UI.checkboxbutton({label:"File",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"diskop_load":"topmain")}}),h=UI.checkboxbutton({label:"Options",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"options":"topmain")}}),f=UI.checkboxbutton({label:"Sample Edit",onDown:function(){EventBus.trigger(EVENT.showView,this.isActive?"sample":"bottommain")}});c.addChild(d),c.addChild(h),c.addChild(f);var n={background:UI.Assets.buttonKeyScale9,hoverBackground:UI.Assets.buttonKeyHoverScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},g=UI.button(),p=UI.button();g.setProperties(n),g.setLabel("mod"),g.onDown=function(){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER)},c.addChild(g),p.setProperties(n),p.setLabel("XM"),p.onDown=function(){Tracker.setTrackerMode(TRACKERMODE.FASTTRACKER)},c.addChild(p);var m=[4,8,12,16],v=[];m.forEach(function(e){v.push(UI.button())}),v.forEach(function(e,t){e.setProperties(n),e.setLabel(""+m[t]),e.index=t,e.onDown=function(){if(!this.isDisabled){var n=this.index;v.forEach(function(e,t){e.setActive(t===n)}),Layout.setVisibleTracks(m[n])}},c.addChild(e)});var b=UI.label();b.setProperties({label:"Mode",labels:[{width:20,label:""},{width:78,label:"M"},{width:84,label:"Md"},{width:100,label:"Mode"}],font:fontSmall,width:100,height:20,textAlign:"right"}),b.ignoreEvents=!0,c.addChild(b);var E=UI.label();E.setProperties({label:"Display",labels:[{width:10,label:""},{width:78,label:"t"},{width:84,label:"tr"},{width:100,label:"trck"},{width:120,label:"Display"}],font:fontSmall,width:100,height:20,textAlign:"right"}),E.ignoreEvents=!0,c.addChild(E);var w=UI.spinBox();return w.setProperties({name:"Pattern",value:Tracker.getTrackCount(),max:32,min:2,size:"big",padLength:2,trackUndo:!0,undoLabel:"Change Track count",onChange:function(e){Tracker.setTrackCount(e)}}),c.addChild(w),c.onPanelResize=function(){c.innerHeight=c.height-2*Layout.defaultMargin;var e=Layout.defaultMargin,t=Layout.defaultMargin;if("2row"===Layout.controlPanelButtonLayout){var n=Math.floor((c.innerHeight-Layout.defaultMargin)/2);t=c.height-n-Layout.defaultMargin,c.innerHeight=n}u.setProperties({left:Layout.col1X,top:e,width:Layout.songControlWidth,height:c.innerHeight,songPatternSelector:"small"});var a=Layout.col1W-60;a=Math.max(a,120);var r=Math.floor((Layout.col1W-a)/2),i=Layout.col4X+r,o="Sample Edit";"1row"!==Layout.controlPanelButtonLayout&&(a=Math.floor(Layout.controlPanelButtonsWidth/3),r=0,i=Layout.controlPanelButtonsLeft+2*a,o="Sample");var s=c.innerHeight;d.setProperties({left:Layout.controlPanelButtonsLeft+1.5*r,top:t,width:a,height:s}),h.setProperties({left:d.left+a+r,top:t,width:a,height:s}),f.setProperties({left:i,top:t,width:a,height:s,label:o}),g.setProperties({left:Layout.modeButtonsLeft+(Layout.modeButtonsWidth-101),top:e,width:51,height:16}),p.setProperties({left:g.left+g.width-1,top:g.top,width:g.width,height:g.height});var l=g.left;v.forEach(function(e,t){e.setProperties({left:l,top:g.top+g.height,width:26,height:g.height}),l+=e.width-1,e.setActive(m[t]===Layout.visibleTracks),e.setDisabled(Layout.maxVisibleTracks<m[t])}),b.setProperties({left:Layout.modeButtonsLeft,top:e+1,width:Layout.modeButtonsWidth-94,height:20}),E.setProperties({left:b.left,top:b.top+g.height,width:b.width,height:b.height}),w.setProperties({left:Layout.modeButtonsLeft,top:e,width:Layout.TrackCountSpinboxWidth,height:c.innerHeight})},c.onPanelResize(),c.renderInternal=function(){"2row"!==Layout.controlPanelButtonLayout&&(c.ctx.drawImage(Y.getImage("line_ver"),Layout.controlPanelButtonsLeft-2,0,2,c.height-1),c.ctx.drawImage(Y.getImage("line_ver"),Layout.modeButtonsLeft-2,0,2,c.height-1),"condensed"!==Layout.controlPanelButtonLayout&&(c.ctx.drawImage(Y.getImage("line_ver"),Layout.col4X-2,0,2,c.height-1),c.ctx.translate(.5,.5),c.ctx.strokeStyle="rgba(255, 255, 255, 0.3)",c.ctx.lineWidth=1,c.ctx.beginPath(),c.ctx.moveTo(Layout.col2X+10,10),c.ctx.lineTo(Layout.col2X+10,20),c.ctx.lineTo(Layout.col4X-14,20),c.ctx.lineTo(Layout.col4X-14,10),c.ctx.moveTo(Layout.col4X+10,30),c.ctx.lineTo(Layout.col4X+10,20),c.ctx.lineTo(Layout.col5X-14,20),c.ctx.lineTo(Layout.col5X-14,30),c.ctx.stroke(),c.ctx.setTransform(1,0,0,1,0,0),d.render(),h.render(),f.render()))},EventBus.on(EVENT.showView,function(e){switch(e){case"diskop_load":case"diskop_save":case"diskop_samples_load":case"diskop_modules_load":case"diskop_samples_save":case"diskop_modules_save":d.setActive(!0),h.setActive(!1);break;case"options":d.setActive(!1),h.setActive(!0);break;case"topmain":d.setActive(!1),h.setActive(!1);break;case"main":d.setActive(!1),h.setActive(!1),f.setActive(!1);break;case"bottommain":f.setActive(!1);break;case"sample":f.setActive(!0)}}),EventBus.on(EVENT.trackerModeChanged,function(e){g.setActive(e===TRACKERMODE.PROTRACKER),p.setActive(e===TRACKERMODE.FASTTRACKER),Layout.setLayout()}),EventBus.on(EVENT.trackCountChange,function(e){w.setValue(e,!0)}),EventBus.on(EVENT.songLoaded,function(e){var t=e.channels;12<t&&t<16&&(t=16),8<t&&t<12&&(t=12),4<t&&t<8&&(t=8),t=Math.min(t,Layout.maxVisibleTracks),Layout.setVisibleTracks(t),c.onPanelResize()}),c};var Layout=(uI={defaultMargin:4,showAppSideBar:!1,setLayout:function(e,t){uI.width=e||uI.width,uI.height=t||uI.height;var n=uI.width;if(uI.sidebarWidth=uI.showAppSideBar?200:0,n-=uI.sidebarWidth,uI.col1W=Math.floor((n-6*uI.defaultMargin-3)/5),uI.col2W=2*uI.col1W+uI.defaultMargin,uI.col3W=3*uI.col1W+2*uI.defaultMargin,uI.col4W=4*uI.col1W+3*uI.defaultMargin,uI.col5W=5*uI.col1W+4*uI.defaultMargin,uI.marginLeft=Math.floor((n-uI.col5W)/2),uI.marginRight=n-uI.marginLeft-uI.col5W,uI.mainLeft=uI.sidebarWidth,uI.mainWidth=n,uI.col1X=uI.marginLeft,uI.col2X=uI.col1X+uI.defaultMargin+uI.col1W,uI.col3X=uI.col2X+uI.defaultMargin+uI.col1W,uI.col4X=uI.col3X+uI.defaultMargin+uI.col1W,uI.col5X=uI.col4X+uI.defaultMargin+uI.col1W,uI.colHalfW=Math.floor(uI.col1W/2),uI.col31W=Math.floor((n-4*uI.defaultMargin-5)/3),uI.col32W=2*uI.col31W+uI.defaultMargin,uI.col31X=uI.col1X,uI.col32X=uI.col31X+uI.defaultMargin+uI.col31W,uI.col33X=uI.col32X+uI.defaultMargin+uI.col31W,uI.prefered="col5",uI.controlPanelHeight=40,uI.controlPanelLayout="full",uI.controlPanelButtonLayout="1row",uI.controlPanelButtonsLeft=uI.col2X,uI.controlPanelButtonsWidth=uI.col3W,uI.modeButtonsWidth=uI.col1W,uI.modeButtonsLeft=uI.col5X,uI.songControlWidth=uI.col1W,uI.TrackCountSpinboxWidth=60,uI.trackWidth=uI.col1W,uI.trackMargin=uI.defaultMargin,uI.visibleTracks=uI.visibleTracks||4,uI.infoPanelHeight=24,uI.trackControlHeight=32,uI.analyserHeight=66,uI.pianoHeight=200,uI.trackFont=fontMed,uI.useCondensedTrackFont=!1,uI.maxVisibleTracks=16,n<945&&(uI.maxVisibleTracks=12),n<725&&(uI.maxVisibleTracks=8),n<512&&(uI.maxVisibleTracks=4),uI.maxVisibleTracks<uI.visibleTracks)uI.setVisibleTracks(uI.maxVisibleTracks);else{n<820&&(uI.controlPanelButtonLayout="condensed",uI.modeButtonsWidth=uI.col1W+uI.colHalfW,uI.modeButtonsLeft=uI.col5X-uI.colHalfW,uI.songControlWidth=uI.modeButtonsWidth,uI.controlPanelButtonsLeft=uI.col2X+uI.colHalfW,uI.controlPanelButtonsWidth=uI.col2W),n<650&&(uI.controlPanelButtonLayout="2row",uI.controlPanelHeight=80,uI.controlPanelButtonsLeft=uI.col1X,uI.controlPanelButtonsWidth=uI.col5W,uI.controlPanelButtonsButton=Math.floor(uI.controlPanelButtonsWidth/3),uI.modeButtonsLeft=2*uI.controlPanelButtonsButton-uI.TrackCountSpinboxWidth,uI.modeButtonsWidth=uI.controlPanelButtonsButton+uI.TrackCountSpinboxWidth+uI.defaultMargin,uI.songControlWidth=uI.col2W+uI.colHalfW+uI.defaultMargin),n<620&&(uI.prefered="col3"),uI.height<800&&(uI.pianoHeight=150),uI.height<650&&(uI.pianoHeight=100);var a=uI.defaultMargin*(uI.visibleTracks-1);uI.showSideBar=uI.visibleTracks<5&&620<n;var r=uI.showSideBar?uI.col4W:uI.col5W;uI.trackWidth=Math.floor((r-a)/uI.visibleTracks),uI.firstTrackOffsetLeft=0,uI.trackWidth<125&&(uI.firstTrackOffsetLeft=18,uI.trackWidth=Math.floor((r-a-uI.firstTrackOffsetLeft)/uI.visibleTracks));var i=Tracker.inFTMode()?100:78;uI.trackWidth<i&&(uI.trackFont=fontSuperCondensed,uI.useCondensedTrackFont=!0)}},setVisibleTracks:function(e){uI.visibleTracks=e,uI.setLayout(),EventBus.trigger(EVENT.visibleTracksCountChange,e)}},uI),uI;UI.app_mainPanel=function(){function l(){g.show(),p.show(),m.show(),y.show(),I.show(),S.show(),v.show(),b.show(),k.show(),T.show(),C.show(),E.show(),w.show(),"col3"===Layout.prefered?c&&c.show():c&&c.hide()}var c,u,d=UI.app_panelContainer(160),h="",f="",g=UI.button();g.setProperties({background:UI.Assets.panelInsetScale9,activeBackground:UI.Assets.buttonDarkScale9,image:Y.getImage("logo_grey_70"),activeImage:Y.getImage("logo_colour_70")}),g.onDown=function(){g.toggleActive()},d.addChild(g);var p=UI.button();p.setProperties({background:UI.Assets.panelInsetScale9,activeBackground:UI.Assets.panelInsetScale9,image:Y.getImage("tracker"),activeImage:function(){var e=Y.getImage("steffest"),t="undefined"==typeof versionNumber?"dev":versionNumber;if(0<t.indexOf(".")){var n=t.split(".");t=n[0]+"."+n[1]}t="Version "+t;var a=e.getContext("2d");return fontSmall.write(a,t,44,4),fontSmall.write(a,"By",44,13),e}()}),p.onDown=function(){p.toggleActive()},d.addChild(p);var m=UI.inputbox({name:"modName",trackUndo:!0,onChange:function(e){Tracker.getSong().title=e,UI.setInfo(e)}});d.addChild(m);var v=UI.listbox();v.setItems([{label:"loading ...",data:1}]),d.addChild(v),v.onClick=function(e){Input.setFocusElement(v);var t=v.getItemAtPosition(v.eventX,v.eventY);t&&Tracker.setCurrentInstrumentIndex(t.data)};var b=UI.app_songPatternList();d.addChild(b);var e=window.fontFT,E=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);d.addChild(E);var w=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);d.addChild(w);var T=UI.spinBox();T.setProperties({name:"Pattern",label:"Pattern",labels:[{width:10,label:"Pat."},{width:140,label:"Pattern"}],value:0,max:100,min:0,font:e,onChange:function(e){Tracker.setCurrentPattern(e)}}),d.addChild(T);var I=UI.spinBox({name:"Instrument",label:"Instrument",labels:[{width:10,label:"Ins."},{width:123,label:"Instr"},{width:160,label:"Instrument"}],value:1,max:31,min:1,font:e,onChange:function(e){Tracker.setCurrentInstrumentIndex(e)}});d.addChild(I);var k=UI.spinBox({name:"SongLength",label:"Song length",labels:[{width:10,label:"Len."},{width:138,label:"Length"},{width:156,label:"Song len"},{width:178,label:"Song length"}],value:1,max:200,min:1,font:e,trackUndo:!0,undoLabel:"Change Song length",onChange:function(e){var t=Tracker.getSong().length;e<t?Editor.removeFromPatternTable():t<e&&Editor.addToPatternTable()}});d.addChild(k);var S=UI.spinBox({name:"SongRepeat",label:"Song repeat",labels:[{width:10,label:"Rep."},{width:138,label:"Repeat"},{width:156,label:"Song rep"},{width:178,label:"Song repeat"}],value:1,max:200,min:1,font:e,onChange:function(e){Tracker.getSong().restartPosition=e}});d.addChild(S);var C=UI.spinBox({name:"PatternLength",label:"Pattern length",labels:[{width:10,label:"Plen"},{width:138,label:"Pat len"},{width:166,label:"Pattern len"},{width:188,label:"Pattern length"}],value:64,max:128,min:1,font:e,trackUndo:!0,undoLabel:"Change Pattern length",onChange:function(e){Tracker.setPatternLength(e)}});d.addChild(C);var y=UI.spinBox({name:"BPMLength",label:"BPM",value:1,max:400,min:1,font:e,trackUndo:!0,undoLabel:"Change Song Tempo",onChange:function(e){Tracker.setBPM(e)}});d.addChild(y);var x=UI.DiskOperations();x.setProperties({name:"diskoperations",zIndex:100}),d.addChild(x),UI.diskOperations=x;var P=UI.OptionsPanel();return P.setProperties({name:"options",zIndex:100}),d.addChild(P),d.onPanelResize=function(){var e=Layout.defaultMargin,t=20+2*e,n=50+e+e,a=d.height-50-4*e,r=28,i=Layout.col1W-2;if("col3"===Layout.prefered){c||(f="patterndata",(c=UI.radioGroup()).setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0,zIndex:1}),c.setItems([{label:"About",active:!1},{label:"Song data",labels:[{width:30,label:"song"}],active:!1},{label:"Pattern data",labels:[{width:40,label:"pattern"}],active:!0},{label:"Instruments",labels:[{width:30,label:"Instr"}],active:!1}]),c.onChange=function(e){f="about",1===e&&(f="songdata"),2===e&&(f="patterndata"),3===e&&(f="instruments"),d.onPanelResize()},d.addChild(c),d.sortZIndex()),a=d.height-2*e,n=e,i=Layout.col32W-2,r=28,h?c.hide():c.show(),c.setDimensions({left:Layout.col31X,width:Layout.col31W,top:e,height:a,visible:!0}),m.setDimensions({left:Layout.col32X,width:Layout.col32W,top:e,height:20}),v.setDimensions({left:Layout.col32X,width:Layout.col32W,top:t,height:d.height-t-2*e});var o={left:Layout.col32X,width:Layout.col32W,top:n,height:a};b.setDimensions(o),E.setDimensions(o),w.setDimensions(o),g.setDimensions({left:Layout.col32X,width:Layout.col32W,top:n,height:Math.floor(a/2)}),p.setDimensions({left:Layout.col32X,width:Layout.col32W,top:Math.floor(a/2)+1,height:Math.floor(a/2)});var s=Layout.col32X;y.setDimensions({left:s,top:E.top+3,width:i,height:r}),k.setDimensions({left:s,top:E.top+3+r,width:i,height:r}),S.setDimensions({left:s,top:E.top+3+2*r,width:i,height:r}),S.hide(),T.setDimensions({left:s,top:E.top+3+2*r,width:i,height:r}),C.setDimensions({left:s,top:E.top+3+3*r,width:i,height:r}),I.setDimensions({left:s,top:E.top+3+4*r,width:i,height:r}),h||(g.toggle("about"===f),p.toggle("about"===f),m.toggle("instruments"===f),v.toggle("instruments"===f),b.toggle("songdata"===f),E.toggle("patterndata"===f),y.toggle("patterndata"===f),k.toggle("patterndata"===f),T.toggle("patterndata"===f),C.toggle("patterndata"===f),I.toggle("patterndata"===f)),w.hide()}else c&&c.hide(),h||l(),g.setDimensions({left:Layout.col1X,top:e,width:Layout.col2W,height:50}),p.setDimensions({left:Layout.col3X,top:e,width:Layout.col1W,height:50}),m.setDimensions({left:Layout.col4X,width:Layout.col2W,top:e,height:20}),v.setDimensions({left:Layout.col4X,width:Layout.col2W,top:t,height:d.height-t-2*e}),b.setDimensions({left:Layout.col1X,width:Layout.col1W,top:n,height:a}),E.setDimensions({left:Layout.col2X,width:Layout.col1W,top:n,height:a}),w.setDimensions({left:Layout.col3X,width:Layout.col1W,top:n,height:a}),y.setDimensions({left:Layout.col2X,top:E.top+3,width:i,height:r}),k.setDimensions({left:Layout.col2X,top:E.top+3+r,width:i,height:r}),S.setDimensions({left:Layout.col2X,top:E.top+3+2*r,width:i,height:r}),T.setDimensions({left:Layout.col3X,top:E.top+3,width:i,height:r}),C.setDimensions({left:Layout.col3X,top:E.top+3+r,width:i,height:r}),I.setDimensions({left:Layout.col3X,top:E.top+3+2*r,width:i,height:r});x.setSize(d.width,d.height),P.setSize(d.width,d.height),u&&u.setSize(d.width,d.height)},d.onPanelResize(),d.getCurrentView=function(){return h},EventBus.on(EVENT.songLoading,function(){m.setValue("Loading ...",!0)}),EventBus.on(EVENT.songPropertyChange,function(e){m.setValue(e.title,!0),k.setValue(e.length,!0),I.setMax(Tracker.getMaxInstruments(),!0),S.setMax(e.length,!0),e.restartPosition&&e.length<e.restartPosition&&(e.restartPosition=e.length),S.setValue(e.restartPosition||1,!0)}),EventBus.on(EVENT.songBPMChange,function(e){y.setValue(e,!0)}),EventBus.on(EVENT.instrumentChange,function(e){v.setSelectedIndex(e-1),I.setValue(e,!0)}),EventBus.on(EVENT.instrumentNameChange,function(e){var t=Tracker.getInstrument(e);if(t)for(var n=v.getItems(),a=0,r=n.length;a<r;a++)if(n[a].data==e){n[a].label=e+" "+t.name,EventBus.trigger(EVENT.instrumentListChange,n);break}}),EventBus.on(EVENT.instrumentListChange,function(e){v.setItems(e)}),EventBus.on(EVENT.patternChange,function(e){T.setValue(e,!0),C.setValue(Tracker.getPatternLength(),!0)}),EventBus.on(EVENT.trackerModeChanged,function(e){C.setDisabled(e===TRACKERMODE.PROTRACKER),I.setMax(Tracker.getMaxInstruments())}),EventBus.on(EVENT.pluginRenderHook,function(e){e.target&&"main"===e.target&&(u?u.children=[]:(u=UI.panel(0,0,d.width,d.height),d.addChild(u)),u.renderOverride=e.render,u.renderInternal=e.renderInternal,e.setRenderTarget&&e.setRenderTarget(u),x.hide(),P.hide(),g.hide(),p.hide(),m.hide(),y.hide(),I.hide(),S.hide(),v.hide(),b.hide(),k.hide(),T.hide(),C.hide(),E.hide(),w.hide(),c&&c.hide(),h="custom",u.show(),d.refresh())}),EventBus.on(EVENT.showView,function(e){switch(e){case"diskop_load":case"diskop_save":case"diskop_samples_load":case"diskop_modules_load":case"diskop_samples_save":case"diskop_modules_save":u&&u.hide(),x.setView(e),x.show(),P.hide(),h=e,d.refresh();break;case"options":u&&u.hide(),x.hide(),P.show(!0),h=e,d.refresh();break;case"topmain":case"main":u&&u.hide(),x.hide(),P.hide(),h="",l(),d.refresh()}}),d},UI.app_menu=function(e){function t(e){e.setState(!0),clearTimeout(e.timeout),e.timeout=setTimeout(function(){e.setState(!1)},100)}var a=UI.app_panelContainer(32),r=UI.scale9Panel(5,0,20,26,{img:Y.getImage("menu"),left:4,top:0,right:40,bottom:0});a.addChild(r);var n=UI.menu(5,0,a.width,26,e);n.name="MainMenu",a.addChild(n),n.setItems([{label:"File",subItems:[{label:"New",command:COMMAND.newFile},{label:"Load Module",command:COMMAND.openFile},{label:"Save Module",command:COMMAND.saveFile},{label:"Open Random MOD Song",command:COMMAND.randomSong},{label:"Open Random XM Song",command:COMMAND.randomSongXM}]},{label:"Edit",subItems:[{label:function(){return StateManager.getUndoLabel()},command:COMMAND.undo,disabled:function(){return!StateManager.canUndo()}},{label:function(){return StateManager.getRedoLabel()},command:COMMAND.redo,disabled:function(){return!StateManager.canRedo()}},{label:"Cut",command:COMMAND.cut},{label:"Copy",command:COMMAND.copy},{label:"Clear",subItems:[{label:"Clear Track",command:COMMAND.clearTrack},{label:"Clear Pattern",command:COMMAND.clearPattern},{label:"Clear Song",command:COMMAND.clearSong},{label:"Clear Instruments",command:COMMAND.clearInstruments}]},{label:"Paste",command:COMMAND.paste},{label:"Render Pattern 2 Sample",command:COMMAND.pattern2Sample}]},{label:"View",subItems:[{label:"Main",command:COMMAND.showMain},{label:"Options",command:COMMAND.showOptions},{label:"File Operations",command:COMMAND.showFileOperations},{label:"Sample Editor",command:COMMAND.showSampleEditor},{label:"Piano",command:COMMAND.togglePiano},{label:"Nibbles",command:COMMAND.nibbles},{label:"Performance stats",command:COMMAND.showStats}]},{label:"Help",subItems:[{label:"About",command:COMMAND.showAbout},{label:"Documentation",command:COMMAND.showHelp},{label:"Sourcecode on Github",command:COMMAND.showGithub}]}]);var i=UI.vumeter();i.connect(Audio.cutOffVolume),window.vumeter=i;var o=UI.label({font:fontSmall,label:"Key"});o.ignoreEvents=!0;var s=UI.checkbox(0,0,13,13);s.ignoreEvents=!0;var l=UI.label({font:fontSmall,label:"Midi"});l.ignoreEvents=!0;var c=UI.checkbox(0,0,13,13);return c.ignoreEvents=!0,a.addChild(o),a.addChild(s),a.addChild(l),a.addChild(c),a.onPanelResize=function(){var e=Math.max(Layout.col2W,250);Host.showInternalMenu||(r.hide(),e=0);var t=Layout.col5W-e;(SETTINGS.showKey||SETTINGS.showMidi)&&(t-=50);var n=Layout.marginLeft+e+Layout.defaultMargin+Layout.mainLeft;a.left=Layout.mainLeft,e&&r.setDimensions({left:Layout.marginLeft,top:0,height:26,width:e}),i.setProperties({width:t,left:n}),o.setProperties({top:4,left:a.width-56,width:40,height:20}),s.setProperties({top:4,left:a.width-20}),SETTINGS.showKey?(o.show(),s.show()):(o.hide(),s.hide()),SETTINGS.showMidi?(l.setProperties({top:14,left:o.left,width:o.width,height:o.height}),c.setProperties({top:16,left:s.left}),l.show(),c.show()):(l.hide(),c.hide())},a.renderInternal=function(){SETTINGS.showMidi&&!Midi.isEnabled()&&(a.ctx.fillStyle="rgba(34, 49, 85, 0.5)",a.ctx.fillRect(l.left,c.top,50,c.height))},a.onPanelResize(),EventBus.on(EVENT.menuLayoutChanged,function(){a.onPanelResize()}),EventBus.on(EVENT.pianoNoteOn,function(){SETTINGS.showKey&&t(s)}),EventBus.on(EVENT.midiIn,function(){SETTINGS.showMidi&&t(c)}),a},UI.app_panelContainer=function(e){var t=UI.panel(0,0,canvas.width,e,!0),n=UI.scale9Panel(0,0,t.width,t.height,UI.Assets.panelMainScale9);return n.ignoreEvents=!0,t.addChild(n),t.onResize=function(){n.setSize(t.width,t.height),t.onPanelResize&&t.onPanelResize()},t},UI.app_patternPanel=function(){function a(){var e=p.getStartTrack(),t=Math.min(e+Layout.visibleTracks,Tracker.getTrackCount()),n=!(Layout.expandSampleViewHeight&&"sample"===c);for(r=0;r<l.length;r++)l[r].setProperties(e<=r&&r<t?{track:r,left:o+(Layout.trackWidth+Layout.trackMargin)*(r-e),top:Layout.defaultMargin+Layout.infoPanelHeight+Layout.analyserHeight,width:Layout.trackWidth,height:Layout.trackControlHeight,visible:n}:{track:r,top:-100,visible:!1})}var r,i,o,s=UI.app_panelContainer(80),l=[],c="main",u=UI.editPanel();s.addChild(u);var d=UI.InfoPanel();for(s.addChild(d),r=0;r<Tracker.getTrackCount();r++)l[r]=UI.trackControl(),s.addChild(l[r]);var h=UI.visualiser();h.connect(Audio.cutOffVolume),h.name="mainAnalyser";var f=UI.element();f.render=function(){},f.onClick=function(e){h.onClick(e)},s.addChild(f);var g=UI.pattern_sidebar();s.addChild(g);var p=UI.app_patternView();p.setProperties({name:"patternViewPanel"}),s.addChild(p);var m=UI.SampleView();return m.setProperties({name:"sampleViewPanel"}),s.addChild(m),s.onPanelResize=function(){Layout.showSideBar?"main"===c&&(g.show(),u.show()):(g.hide(),u.hide());var e=Layout.infoPanelHeight+Layout.trackControlHeight+Layout.analyserHeight+2*Layout.defaultMargin,t=s.height-e-Layout.defaultMargin;Layout.expandSampleViewHeight=t<280,Layout.expandSampleViewHeight&&"sample"===c?(h.hide(),u.hide()):(h.show(),Layout.showSideBar&&u.show());var n=Layout.showSideBar?Layout.col4W:Layout.col5W;o=(i=Layout.showSideBar?Layout.col2X:Layout.col1X)+Layout.firstTrackOffsetLeft,u.setDimensions({left:Layout.col1X,top:Layout.defaultMargin,width:Layout.col1W,height:Layout.infoPanelHeight+Layout.analyserHeight}),d.setDimensions({left:Layout.showSideBar?Layout.col2X:Layout.col1X,top:0,width:Layout.showSideBar?Layout.col4W:Layout.col5W,height:Layout.infoPanelHeight}),p.setDimensions({left:i,top:e,width:n,height:t}),g.setDimensions({left:Layout.col1X,top:p.top-Layout.trackControlHeight,width:Layout.col1W,height:t+Layout.trackControlHeight}),h.setProperties({left:o+Layout.mainLeft,top:s.top+Layout.infoPanelHeight+3,width:n-Layout.firstTrackOffsetLeft,height:Layout.analyserHeight}),f.setDimensions({left:h.left-Layout.mainLeft,top:Layout.infoPanelHeight+3,width:h.width,height:h.height}),m.setProperties({left:0,top:Layout.expandSampleViewHeight?Layout.infoPanelHeight:e,width:s.width,height:Layout.expandSampleViewHeight?s.height-Layout.infoPanelHeight-Layout.defaultMargin-3:t}),a()},s.onPanelResize(),EventBus.on(EVENT.patternChange,function(){p.refresh()}),EventBus.on(EVENT.patternPosChange,function(){p.refresh()}),EventBus.on(EVENT.cursorPositionChange,function(){p.refresh()}),EventBus.on(EVENT.recordingChange,function(){p.refresh()}),EventBus.on(EVENT.trackStateChange,function(e){if(void 0!==e.track)if(e.solo)for(r=0;r<Tracker.getTrackCount();r++)r!=e.track&&l[r].setProperties({mute:!0});else if(e.wasSolo)for(r=0;r<Tracker.getTrackCount();r++)r!=e.track&&l[r].setProperties({mute:!1})}),EventBus.on(EVENT.trackCountChange,function(e){for(s.visibleTracks=Math.min(4,e),r=l.length;r<e;r++)l[r]=UI.trackControl(),l[r].setProperties({track:r,top:-200}),s.addChild(l[r]);a(),s.refresh()}),EventBus.on(EVENT.patternHorizontalScrollChange,function(){a()}),EventBus.on(EVENT.showView,function(e){switch(e){case"sample":m.show(),p.hide(),g.hide(),Layout.expandSampleViewHeight&&(h.hide(),u.hide()),c=e,s.onPanelResize(),s.refresh();break;case"bottommain":case"main":m.hide(),p.show(),h.show(),Layout.showSideBar&&(g.show(),u.show()),c="main",s.onPanelResize(),s.refresh()}}),EventBus.on(EVENT.visibleTracksCountChange,function(e){Layout.showSideBar?"main"===c&&(g.show(),u.show()):(g.hide(),u.hide()),s.onResize()}),s},UI.app_pianoView=function(){var l=UI.app_panelContainer(200);l.name="pianoViewPanel";var n,c,u=[],d=[0,2,4,5,7,9,11],h=[-1,1,0,3,0,-1,0,6,0,8,0,10,0,-1],f=Y.getImage("pianokey_white"),g=Y.getImage("pianokey_white_down"),p=Y.getImage("pianokey_black"),m=Y.getImage("pianokey_black_down"),v=0,t=3,a=1,e=UI.Assets.generate("button20_20");e.setLabel("x"),e.onClick=function(){App.doCommand(COMMAND.togglePiano)},l.addChild(e);var r=UI.spinBox();r.setProperties({name:"Octave",label:"Octave",value:1,max:t,min:a,left:4,top:2,height:28,width:150,font:window.fontMed,onChange:function(e){Input.setCurrentOctave(e)}}),l.addChild(r),l.onShow=function(){l.onPanelResize()},l.onPanelResize=function(){l.innerHeight=l.height-2*Layout.defaultMargin,e.setProperties({top:4,left:l.width-24})},l.onPanelResize(),EventBus.on(EVENT.pianoNoteOn,function(e){l.isVisible()&&(u[e]=!0,l.refresh())}),EventBus.on(EVENT.pianoNoteOff,function(e){l.isVisible()&&(u[e]=!1,l.refresh())});function i(e,t){var n=-1,a=e%420,r=Math.floor(e/420);if(0<=t)if(v+30<t){var i=Math.floor(a/60);n=d[i]+12*r}else{var o=Math.floor((a-15)/30);o<0&&(o=0),12<o&&(o=12),o%2==0?n=d[i=o/2]:(n=h[o])<0&&(i=Math.floor(a/60),n=d[i]),n+=12*r}return n+1}return l.onDown=function(e){var t=i(e.x,e.y);t&&t!==n&&(Input.handleNoteOn(t+12*c),n&&Input.handleNoteOff(n+12*c),n=t)},l.onTouchUp=function(e){var t=i(e.x,e.y);(t=t||n)&&(Input.handleNoteOff(t+12*c),n=void 0),n&&Input.handleNoteOff(n+12*c),n=void 0},l.onDrag=function(e){var t=i(e.x,e.y);t&&t!==n&&(Input.handleNoteOn(t+12*c),n&&Input.handleNoteOff(n+12*c),n=t)},l.renderInternal=function(e){if(l.isVisible()){if(e=!!e,this.needsRendering){for(var t=l.height-30,n=0,a=0;n<l.width;){var r=Math.floor(a/7),i=a%7,o=12*(c+r)+d[i]+1;l.ctx.drawImage(u[o]?g:f,n,30,64,t),a++,n+=60}v=Math.floor(t/1.7);var s=38;for(a=0;s<l.width;){if(r=Math.floor(a/7),2!==(i=a%7)&&6!==i)l.ctx.drawImage(u[o=12*(c+r)+h[2*i+1]+1]?m:p,s,30,48,v),0;a++,s+=60}}if(this.needsRendering=!1,e)return l.canvas;l.parentCtx.drawImage(l.canvas,l.left,l.top,l.width,l.height)}},EventBus.on(EVENT.octaveChanged,function(e){r.setValue(c=e,!0)}),EventBus.on(EVENT.trackerModeChanged,function(e){t=Tracker.inFTMode()?7:3,a=Tracker.inFTMode()?0:1,r.setMax(t,!0),r.setMin(a,!0)}),l},UI.Assets=function(){var a={},r={};a.preLoad=function(e){function t(e){return e=i+e,o&&(e+="?v="+App.buildNumber),e}function n(){a&&r&&(a.forEach(function(e){e.img=r,Y.sprites[e.name]=Y.sprite(e)}),e&&e())}var a,r,i=Host.getBaseUrl(),o=Host.useUrlParams;FetchService.json(t("skin/spritemap_v4.json"),function(e){a=e,n()}),Y.loadImage(t("skin/spritesheet_v4.png"),function(e){r=e,n()})},a.buttonLightScale9={left:2,top:2,right:4,bottom:4},a.buttonLightHoverScale9={left:2,top:2,right:4,bottom:4},a.buttonDarkScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkBlueScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkRedScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkRedHoverScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkGreenScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkActiveScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkActiveBlueScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkGreenHoverScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkGreenActiveScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkRedActiveScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkBlueActiveScale9={left:5,top:5,right:5,bottom:5},a.buttonDarkYellowActiveScale9={left:5,top:5,right:5,bottom:5},a.panelMainScale9={left:2,top:2,right:3,bottom:3},a.panelDarkScale9={left:3,top:3,right:3,bottom:2},a.panelDarkHoverScale9={left:3,top:3,right:3,bottom:2},a.panelDarkGreyScale9={left:3,top:3,right:3,bottom:2},a.panelDarkGreyBlueScale9={left:3,top:3,right:3,bottom:2},a.panelTransScale9={left:3,top:3,right:3,bottom:2},a.panelInsetScale9={left:2,top:2,right:2,bottom:2},a.panelDarkInsetScale9={left:2,top:2,right:2,bottom:2},a.buttonKeyScale9={left:5,top:5,right:5,bottom:5},a.buttonKeyHoverScale9={left:5,top:5,right:5,bottom:5},a.buttonKeyActiveScale9={left:5,top:5,right:5,bottom:5};var i={button20_20:{generate:function(e){var t,n=a.panelDarkScale9;if((t=UI.button(0,0,20,20)).setProperties({background:n,hoverBackground:a.panelDarkHoverScale9,textAlign:"center",font:window.fontMed,paddingTop:2}),!e)return t;r.buttonUp20_20=t}},button30_30:{generate:function(e){var t;if(t=UI.scale9Panel(0,0,30,30,a.buttonLightScale9),!e)return t;r.buttonUp30_30=t}},buttonLight:{generate:function(e){var t,n=a.buttonLightScale9;if((t=UI.button()).setProperties({background:n,hoverBackground:a.buttonLightHoverScale9,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonLight=t}},buttonDark:{generate:function(e){var t,n=a.buttonDarkScale9;if((t=UI.button(0,0,20,20)).setProperties({background:n,hoverBackground:UI.Assets.buttonDarkBlueActiveScale9,activeBackground:UI.Assets.buttonDarkActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonDark=t}},buttonDarkBlue:{generate:function(e){var t;if((t=UI.button(0,0,20,20)).setProperties({background:a.buttonDarkBlueScale9,activeBackground:UI.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonDarkBlue=t}},buttonDarkRed:{generate:function(e){var t;if((t=UI.button(0,0,20,20)).setProperties({background:a.buttonDarkRedScale9,hoverBackground:UI.Assets.buttonDarkRedHoverScale9,activeBackground:UI.Assets.buttonDarkRedActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonDarkRed=t}},buttonDarkGreen:{generate:function(e){var t;if((t=UI.button(0,0,20,20)).setProperties({background:a.buttonDarkGreenScale9,hoverBackground:UI.Assets.buttonDarkGreenHoverScale9,activeBackground:UI.Assets.buttonDarkGreenActiveScale9,isActive:!1,textAlign:"center",font:window.fontMed}),!e)return t;r.buttonDarkGreen=t}},buttonKey:{generate:function(e){var t;if((t=UI.button(0,0,20,20)).setProperties({background:a.buttonKeyScale9,hoverBackground:UI.Assets.buttonKeyHoverScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark}),!e)return t;r.buttonKey=t}}};return a.init=function(){a.buttonLightScale9.img=Y.getImage("button_light"),a.buttonLightHoverScale9.img=Y.getImage("button_light_hover"),a.buttonDarkScale9.img=Y.getImage("button_inlay"),a.buttonDarkBlueScale9.img=Y.getImage("button_inlay_blue"),a.buttonDarkRedScale9.img=Y.getImage("button_inlay_red"),a.buttonDarkRedHoverScale9.img=Y.getImage("button_inlay_red_hover"),a.buttonDarkGreenScale9.img=Y.getImage("button_inlay_green"),a.buttonDarkGreenHoverScale9.img=Y.getImage("button_hover_green"),a.buttonDarkActiveScale9.img=Y.getImage("button_inlay_active"),a.buttonDarkGreenActiveScale9.img=Y.getImage("button_inlay_green_active"),a.buttonDarkRedActiveScale9.img=Y.getImage("button_inlay_red_active"),a.buttonDarkBlueActiveScale9.img=Y.getImage("button_inlay_blue_active"),a.buttonDarkYellowActiveScale9.img=Y.getImage("button_inlay_yellow_active"),a.panelMainScale9.img=Y.getImage("background"),a.panelDarkScale9.img=Y.getImage("bar"),a.panelDarkHoverScale9.img=Y.getImage("bar_hover"),a.panelDarkGreyScale9.img=Y.getImage("panel_dark_greyish"),a.panelDarkGreyBlueScale9.img=Y.getImage("panel_dark_blueish"),a.panelTransScale9.img=Y.getImage("panel_trans"),a.panelInsetScale9.img=Y.getImage("panel_inset"),a.panelDarkInsetScale9.img=Y.getImage("panel_dark"),a.buttonKeyScale9.img=Y.getImage("keybutton"),a.buttonKeyHoverScale9.img=Y.getImage("keybutton_hover"),a.buttonKeyActiveScale9.img=Y.getImage("keybutton_highlight3")},a.get=function(e){var t=r[e];if(t)return t;var n=i[e];n&&(n.isLoading||(n.isLoading=!0,n.generate(!0)))},a.put=function(e,t){r[e]=t},a.generate=function(e){return i[e]?i[e].generate():void 0},a}(),UI.animsprite=function(e,t,n,a,r,i){var o=UI.element(e,t,n=n||14,a=a||14,!0),s=["left","top","width","height","name"];o.setProperties=function(t){s.forEach(function(e){void 0!==t[e]&&(o[e]=t[e])}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top)};var l=Y.getImage(r),c=0;return o.onShow=function(){UI.ticker.onEachTick2(function(){i<=++c&&(c=0),o.refresh()},0)},o.onHide=function(){UI.ticker.onEachTick2()},o.render=function(e){if(e=!!e,this.needsRendering&&(o.clearCanvas(),o.ctx.drawImage(l,c*n,0,n,a,0,0,n,a)),this.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)},o};var BitmapFont=function(){var I,k,S,C,y={},x=[],P=!1;return y.generate=function(e){var t=e.image,n=e.startX,a=e.startY;I=e.charWidth;var r=e.charHeight;C=e.spaceWidth||8;var i=e.margin,o=e.lineSpacing||0,s=e.charsPerLine,l=e.chars||"ABCDEFGHIJKLMNOPQRSTUVWXYZ";P=e.onlyUpperCase,y.fontArray=[],y.colors={},S=i,k=r,y.fixedWidth=!0,y.charHeight=r,"number"!=typeof I&&(y.fixedWidth=!1,"string"==typeof I&&(I=I.split("")).forEach(function(e,t){I[t]=parseInt(e)})),y.charWidth=I;for(var c,u=n,d=a,h=0,f=0,g=0,p=l.length;g<=p;g++){var m=document.createElement("canvas"),v=(c=g,(y.fixedWidth?I:I[c])||1);m.width=v,m.height=r;var b=m.getContext("2d");if(y.fixedWidth)var E=n+g%s*(v+i),w=a+Math.floor(g/s)*(r+o);else E=u,w=d,u+=v+i,s[h]<=++f&&(h++,f=0,u=n,d+=k+o);b.drawImage(t,E,w,v,r,0,0,v,r);var T=l.charCodeAt(g);y.fontArray[T]=m,x[T]=v}},y.generateColor=function(e,o){e=e||"green",o=o||"rgba(107, 161, 65,0.9)";var s=[];y.fontArray.forEach(function(e,t){var n=document.createElement("canvas"),a=document.createElement("canvas");n.width=e.width,n.height=e.height,a.width=e.width,a.height=e.height;var r=n.getContext("2d"),i=a.getContext("2d");i.fillStyle=o,i.fillRect(0,0,16,16),i.globalCompositeOperation="destination-atop",i.drawImage(e,0,0),r.drawImage(a,0,0),r.globalCompositeOperation="darken",r.drawImage(e,0,0),s[t]=n}),y.colors[e]=s},y.getTextWidth=function(e,t){P&&(e=e.toUpperCase()),t=t||S;for(var n=0,a=0,r=e.length;a<r;a++){var i=e.charCodeAt(a);n+=(x[i]||C)+t}return n},y.write=function(e,t,n,a,r,i){P&&(t=t.toUpperCase());var o=y.colors[i]||y.fontArray;r=r||S,a=a||0;for(var s=n=n||0,l=0,c=t.length;l<c;l++){var u=t.charCodeAt(l),d=o[u],h=x[u];h=h||C,d&&e.drawImage(d,s,a,h,k),s+=h+r}},y};UI.button=function(e,t,n,a,r){var s=UI.element(e,t,n,a);s.type="button";var l,c,u,d,h,f,g,p,m=r||"",v="left",b=0,E=0,w=10,i=!(s.isActive=!1),o=["left","top","width","height","name","type","image","backgroundImage","background","active","hoverBackground","hoverImage","activeBackground","activeImage","font","label","textAlign","paddingTop","paddingTopActive","paddingLeft","checkbox","radio"];return s.setProperties=function(t){o.forEach(function(e){if(void 0!==t[e])switch(e){case"label":m=t[e];break;case"font":p=t[e];break;case"textAlign":v=t[e];break;case"paddingTop":b=parseInt(t[e]);break;case"paddingTopActive":E=parseInt(t[e]);break;case"paddingLeft":w=parseInt(t[e]);break;case"image":l=t[e];break;case"backgroundImage":c=t[e];break;case"activeImage":f=t[e];break;case"hoverImage":g=t[e],i=!0;break;case"background":t[e].img&&(c=void 0,(u=UI.scale9Panel(0,0,0,0,t[e])).setParent(s));break;case"activeBackground":t[e].img&&(d=UI.scale9Panel(0,0,0,0,t[e])).setParent(s);break;case"hoverBackground":t[e].img&&(h=UI.scale9Panel(0,0,0,0,t[e])).setParent(s),i=!0;break;default:s[e]=t[e]}}),u&&u.setSize(s.width,s.height),d&&d.setSize(s.width,s.height),h&&h.setSize(s.width,s.height),s.setSize(s.width,s.height),s.setPosition(s.left,s.top),t.labels&&(s.onResize=function(){var e=m;t.labels.forEach(function(e){e.width<=s.width&&(m=e.label)}),e!==m&&s.refresh()})},s.setBackgroundImage=function(e){c=e,s.refresh()},s.setFont=function(e){p=e,s.refresh()},s.setLabel=function(e){m=e,s.refresh()},s.toggleActive=function(){s.isActive=!s.isActive,s.refresh()},s.setActive=function(e){void 0===e&&(e=!0),s.isActive=!!e,s.refresh()},s.setDisabled=function(e){void 0===e&&(e=!0),(s.isDisabled=e)&&(s.isActive=!1),s.refresh()},s.onHover=function(e){i&&(s.isActive||(s.isHover=!0,s.refresh()))},s.onHoverExit=function(){i&&s.isHover&&(s.isHover=!1,s.refresh())},s.render=function(e){if(s.isVisible()){if(s.needsRendering){e=!!e;if(c)s.ctx.drawImage(c,0,0,s.width,s.height);else if(u)if(s.isActive&&d){if(d.render(),f){var t=Math.floor((s.height-f.height)/2),n=Math.floor((s.width-f.width)/2);s.ctx.drawImage(f,n,t)}}else{var a=l;if(s.isHover&&g&&(a=g),s.isHover&&h?h.render():u.render(),a){t=Math.floor((s.height-a.height)/2),n=Math.floor((s.width-a.width)/2);s.ctx.drawImage(a,n,t)}}else s.ctx.fillStyle="grey",s.ctx.fillRect(0,0,s.width,s.height),s.ctx.fillStyle="black",s.ctx.rect(0,0,s.width,s.height),s.ctx.stroke();if(m){var r=Math.floor((s.height-10)/2)+(s.isActive?E:b),i=w;if(p){if("center"===v){var o=8*m.length;p.fixedWidth||(o=p.getTextWidth(m,0)),i=Math.floor((s.width-o)/2)}"right"===v&&(o=8*m.length,p.fixedWidth||(o=p.getTextWidth(m,0)),i=s.width-o-5),p.write(s.ctx,m,i,r,0)}else s.ctx.fillStyle="white",s.ctx.fillText(m,i,r)}s.isDisabled&&(s.ctx.fillStyle="rgba(34, 49, 85, 0.6)",s.ctx.fillRect(0,0,s.width,s.height)),s.renderInternal&&s.renderInternal()}if(s.needsRendering=!1,e)return s.canvas;s.parentCtx.drawImage(s.canvas,s.left,s.top,s.width,s.height)}},s},UI.checkbox=function(e,t,n,a){var r=UI.element(e,t,n=n||14,a=a||14,!0),i=["left","top","width","height","name","type","checked"];return r.setProperties=function(t){i.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top)},r.setState=function(e,t){r.checked=e,r.refresh(),r.onToggle&&!t&&r.onToggle(r.checked)},r.onClick=function(e){r.setState(!r.checked)},r.check=function(){r.setState(!0)},r.unCheck=function(){r.setState(!1)},r.toggle=function(){r.setState(!r.checked)},r.render=function(e){if(e=!!e,r.isVisible()){if(this.needsRendering){r.clearCanvas();var t=Y.getImage(r.checked?"checkbox_on":"checkbox_off");r.ctx.drawImage(t,0,0)}if(this.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)}},r},UI.checkboxbutton=function(e){var n=UI.button(0,0,20,20);return n.setProperties({background:(e=e||{}).background||UI.Assets.buttonDarkBlueScale9,hoverBackground:e.hoverBackground||UI.Assets.buttonDarkBlueActiveScale9,activeBackground:e.activeBackground||UI.Assets.buttonDarkBlueActiveScale9,isActive:!1,textAlign:"left",paddingLeft:30,font:e.font||window.fontFT,label:e.label||"",labels:e.labels||void 0,checkbox:e.checkbox||!1}),n.renderInternal=function(){if(n.checkbox)var e=Y.getImage(n.isActive?"checkbox_on":"checkbox_off"),t=7;else e=Y.getImage(n.isActive?"radio_active":"radio_inactive"),t=5;n.ctx.drawImage(e,8,Math.floor(n.height/2)-t)},n.onDown=function(){n.toggleActive(),e.onDown&&e.onDown.bind(n).call()},n},UI.collapsePanel=function(e){var t=UI.panel(0,0,20,20);return e=e||{},t.setProperties({background:UI.Assets.buttonDarkBlueScale9,font:window.fontFT,label:e.label||""}),t},UI.element=function(e,t,n,a){var o={};return o.left=e||0,o.top=t||0,o.width=n||20,o.height=a||20,o.visible=!0,o.needsRendering=!0,o.parentCtx=ctx,o.canvas=document.createElement("canvas"),o.canvas.width=n,o.canvas.height=a,o.ctx=o.canvas.getContext("2d"),o.children=[],o.hide=function(){o.visible=!1,o.onHide&&o.onHide()},o.show=function(e,t){o.visible=!0,e&&o.refresh(t),o.onShow&&o.onShow()},o.toggle=function(e){"boolean"==typeof e?e?o.show():o.hide():o.visible?o.hide():o.show()},o.isVisible=function(){for(var e=o.visible,t=o.parent;e&&t;)e=t.visible,t=t.parent;return e},o.containsPoint=function(e,t){return this.left<=e&&e<=this.left+this.width&&this.top<=t&&t<=this.top+this.height},o.getElementAtPoint=function(e,t){var n;e-=o.left+(o.scrollOffsetX||0),t-=o.top+(o.scrollOffsetY||0),o.scaleX&&(e/=o.scaleX),o.scaleY&&(t/=o.scaleY);for(var a=o.children.length-1;0<=a;a--){var r=o.children[a];if(r.isVisible()&&!r.ignoreEvents&&r.containsPoint(e,t)){n=r;break}}if(n){var i=n.getElementAtPoint(e,t);i?n=i:(n.eventX=e,n.eventY=t)}else(n=o).eventX=e,n.eventY=t;return n},o.setParent=function(e){(o.parent=e)&&(o.parentCtx=e.ctx)},o.addChild=function(e){e.setParent(o),e.zIndex=e.zIndex||o.children.length,o.children.push(e)},o.getChild=function(e){for(var t,n=o.children.length;n;){if((t=o.children[n])&&t.name&&t.name==e)return t;n--}},o.refresh=function(e){if(o.needsRendering=!0,e)for(var t,n=o.children.length;n;)(t=o.children[n])&&t.refresh(),n--;this.visible&&o.parent&&o.parent.refresh&&o.parent.refresh()},o.setSize=function(e,t){o.width=Math.max(e,1),o.height=Math.max(t,1),o.canvas.width=o.width,o.canvas.height=o.height,o.onResize&&o.onResize(),o.refresh()},o.setPosition=function(e,t){o.left=e,o.top=t,o.refresh()},o.setDimensions=function(e){"boolean"==typeof e.visible&&!e.visible||(o.setProperties?o.setProperties(e):(o.setPosition(e.left,e.top),o.setSize(e.width,e.height)))},o.clearCanvas=function(){o.ctx.clearRect(0,0,o.width,o.height)},o},UI.image=function(e,t,n,a,r){var i=UI.element(e,t,n=n||14,a=a||14,!0),o=["left","top","width","height","name"];i.setProperties=function(t){o.forEach(function(e){void 0!==t[e]&&(i[e]=t[e])}),i.setSize(i.width,i.height),i.setPosition(i.left,i.top)};var s=Y.getImage(r);return i.render=function(e){if(e=!!e,i.isVisible()){if(this.needsRendering&&(i.clearCanvas(),s))switch(i.scale){case"stretch":i.ctx.drawImage(s,0,0,i.width,i.height);break;default:var t=i.width-s.width>>1,n=i.height-s.height>>1;"top"===i.verticalAlign&&(n=0),"right"===i.horizintalAlign&&(t=i.width-s.width),i.ctx.drawImage(s,t,n)}if(this.needsRendering=!1,e)return i.canvas;i.parentCtx.drawImage(i.canvas,i.left,i.top,i.width,i.height)}},i},UI.inputbox=function(e){var t,n,r,i=UI.element(),a=["left","top","width","height","name","type","onChange","onSubmit","backgroundImage","trackUndo","undoLabel","undoInstrument"],o="",s="",l="panel_dark";i.setProperties=function(t){a.forEach(function(e){void 0!==t[e]&&(i[e]=t[e])}),i.setSize(i.width,i.height),i.setPosition(i.left,i.top),c&&c.setSize(i.width,i.height),t.value&&(o=t.value),t.backgroundImage&&(l=t.backgroundImage)},e&&i.setProperties(e);var c=UI.scale9Panel(0,0,i.width,i.height,{img:Y.getImage(l),left:3,top:3,right:2,bottom:2});c.ignoreEvents=!0,i.addChild(c),i.render=function(e){if(e=!!e,i.isVisible()){if(this.needsRendering){c.render();var t=0;if(o&&fontMed){t=10;fontMed.write(i.ctx,o,t,6,0)}if(n){i.ctx.fillStyle="rgba(255,255,255,0.7)";i.ctx.fillRect(t+9*r+8,4,2,i.height-8)}}if(this.needsRendering=!1,e)return i.canvas;i.parentCtx.drawImage(i.canvas,i.left,i.top,i.width,i.height)}},i.setValue=function(e,t){if(e!==o&&(s=o),o=e,i.refresh(),!t&&i.onChange){if(i.trackUndo){var n=StateManager.createValueUndo(i);n.name=i.undoLabel||"Change "+i.name,i.undoInstrument&&(n.instrument=Tracker.getCurrentInstrumentIndex(),n.id+=n.instrument),StateManager.registerEdit(n)}i.onChange(o)}},i.getValue=function(){return o},i.getPrevValue=function(){return s},i.getItemAtPosition=function(e,t){t-=startY;var n=Math.floor(t/lineHeight)+visibleIndex;return 0<=n&&n<items.length?items[n]:void 0},i.onClick=function(){t||i.activate()},i.activate=function(){t||(r=o?o.length-1:-1,t=!0,Input.setFocusElement(i),u())},i.deActivate=function(e){t&&(t=n=!1,i.refresh(),Input.clearFocusElement(),e&&i.onSubmit&&i.onSubmit(o))},i.onKeyDown=function(e,t){var n=!1;switch(e){case 8:o&&0<=r&&(i.setValue(o.substr(0,r)+o.substr(r+1)),r--),n=!0;break;case 9:case 13:case 27:i.deActivate(13===e),n=!0;break;case 37:0<=r&&r--,i.refresh(),n=!0;break;case 39:o&&(r++,r=Math.min(r,o.length-1),i.refresh()),n=!0;break;case 46:o&&r<o.length-1&&i.setValue(o.substr(0,r+1)+o.substr(r+2)),n=!0;break;case 89:case 90:if(Input.isMetaKeyDown())return void i.deActivate()}if(!n&&31<e){var a=t.key;1===a.length&&a.match(/[a-z0-9\._:\-\ #]/i)&&(i.setValue(o.substr(0,r+1)+a+o.substr(r+1)),r++),n=!0}return n};var u=function(){t&&(n=!n,i.refresh(),setTimeout(u,300))};return i},UI.knob=function(e){var l=UI.element();l.type="knob";var c="",u=50,t=u,n=["left","top","width","height","name","font","label","textAlign","paddingTop","disabled"],d=Y.getImage("knob_back"),h=Y.getImage("knob_back_inactive"),f=Y.getImage("knob_front");return l.width=d.width+32,l.height=d.height+32,l.setSize(l.width,l.height),l.setProperties=function(t){n.forEach(function(e){if(void 0!==t[e])switch(e){case"label":c=t[e];break;case"font":0;break;case"textAlign":0;break;case"paddingTop":parseInt(t[e]);break;case"disabled":l.isDisabled=!!t[e];default:l[e]=t[e]}}),l.setSize(l.width,l.height),l.setPosition(l.left,l.top)},l.setFont=function(e){l.refresh()},l.setLabel=function(e){c=e,l.refresh()},l.getLabel=function(){return c},l.setValue=function(e){l.refresh()},l.getValue=function(){return u},l.render=function(e){if(l.needsRendering){e=!!e,l.clearCanvas();var t=.8*d.width,n=.8*d.height,a=t/2,r=n/2;l.ctx.save(),l.ctx.translate(16+a,16+r),l.ctx.drawImage(l.isDisabled?h:d,-a,-r,t,n);var i=Math.abs(-230)+50,o=-230*Math.PI/180,s=(u/100*i-230)*Math.PI/180;if(l.ctx.fillStyle=l.isDisabled?"rgba(170,170,170,0.5)":"rgba(130,200,255,0.5)",l.ctx.beginPath(),l.ctx.arc(0,0,30,o,s,!1),l.ctx.arc(0,0,25,s,o,!0),l.ctx.fill(),l.ctx.rotate((u/100*320-160)*Math.PI/180),l.ctx.drawImage(f,-a,-r,t,n),l.ctx.restore(),c){fontSmall.write(l.ctx,c,16+a-3*c.length,16+n+4)}}if(l.needsRendering=!1,e)return l.canvas;l.parentCtx.drawImage(l.canvas,l.left,l.top,l.width,l.height)},l.onDragStart=function(){t=u},l.onDrag=function(e){l.isDisabled||(u=t+e.deltaY,u=Math.max(u,0),u=Math.min(u,100),l.refresh(),l.onChange&&l.onChange(u))},l.onClick=function(e){Math.abs(e.x-e.startX)<3&&Math.abs(e.y-e.startY)<3&&l.toggleDisabled()},l.toggleDisabled=function(){l.isDisabled=!l.isDisabled,l.onToggle&&l.onToggle(!l.isDisabled),l.refresh()},l},UI.label=function(e){var r,i=UI.element(),o="",s="left",l=0,n=["left","top","width","height","name","font",i.type="label","textAlign","paddingTop"];return i.setProperties=function(t){n.forEach(function(e){if(void 0!==t[e])switch(e){case"label":o=t[e];break;case"font":r=t[e];break;case"textAlign":s=t[e];break;case"paddingTop":l=parseInt(t[e]);break;default:i[e]=t[e]}}),i.setSize(i.width,i.height),i.setPosition(i.left,i.top),t.labels&&(i.onResize=function(){var e=o;t.labels.forEach(function(e){e.width<=i.width&&(o=e.label)}),e!==o&&i.refresh()})},i.setFont=function(e){r=e,i.refresh()},i.getFont=function(){return r},i.setLabel=function(e){o=e,i.refresh()},i.render=function(e){if(i.isVisible()){if(i.needsRendering&&(e=!!e,i.clearCanvas(),o)){var t,n=Math.floor((i.height-10)/2)+l,a=10;if(r)"center"==s&&(t=r.getTextWidth(o,0),a=Math.floor((i.width-t)/2)),"right"==s&&(t=r.getTextWidth(o,0),a=Math.floor(i.width-t)-10),r.write(i.ctx,o,a,n,0);else i.ctx.fillStyle="white",i.ctx.fillText(o,a,n)}if(i.needsRendering=!1,e)return i.canvas;i.parentCtx.drawImage(i.canvas,i.left,i.top,i.width,i.height)}},e&&i.setProperties(e),i},UI.listbox=function(e,t,n,a){function r(){var e=E.length;l=Math.floor(m.height/18),m.centerSelection&&(l=1);var t=18,n=m.height-4-32,a=n;c=0,l<e&&((a=Math.floor(l/e*n))<12&&(a=12),c=(n-a)/(e-l)),w&&c&&(t=Math.floor(18+c*w)),C.setProperties({left:m.width-18,top:t,width:16,height:a})}function i(){var e=E.length-1;return m.centerSelection||(e=E.length-l),e<0&&(e=0),e}var p,o,m=UI.element(e,t,n,a,!0),s=m.selectedIndex=0,v=window.fontMed,b=window.fontSmall,E=[],w=0,l=0,T=10,c=0,u=["left","top","width","height","name","type","onChange","selectedIndex","centerSelection"];m.setProperties=function(t){u.forEach(function(e){void 0!==t[e]&&(m[e]=t[e])}),void 0!==t.font&&(v=t.font),m.setSize(m.width,m.height),m.setPosition(m.left,m.top),I.setSize(m.width,m.height),r(),k.setProperties({left:m.width-18,top:2,width:16,height:16,label:"↑"}),S.setProperties({left:m.width-18,top:m.height-19,width:16,height:16,label:"↓"}),m.centerSelection&&(T=Math.ceil((m.height-18)/2))},m.setSelectedIndex=function(e,t){m.selectedIndex=e,m.centerSelection&&(w=m.selectedIndex),r(),m.refresh(),!t&&m.onChange&&s!=m.selectedIndex&&m.onChange(),s=m.selectedIndex},m.getSelectedIndex=function(){return m.selectedIndex};var I=UI.scale9Panel(0,0,m.width,m.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});I.ignoreEvents=!0,m.addChild(I);var k=UI.Assets.generate("button20_20");m.addChild(k),k.onClick=function(){m.navigateUp()};var S=UI.Assets.generate("button20_20");m.addChild(S),S.onClick=function(){m.navigateDown()};var C=UI.scale9Panel(n-28,18,16,a-3,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});return C.onDragStart=function(){C.startDragIndex=w},C.onDrag=function(e){l<E.length&&c&&(w=Math.floor(C.startDragIndex+e.deltaY/c),w=Math.min(w,i()),w=Math.max(w,0),m.centerSelection?m.setSelectedIndex(w):r())},m.addChild(C),m.navigateUp=function(){0<w&&(w--,r()),m.centerSelection?m.setSelectedIndex(w):m.refresh()},m.navigateDown=function(){w<i()&&(w++,r()),m.centerSelection?m.setSelectedIndex(w):m.refresh()},m.render=function(e){if(e=!!e,m.isVisible()){if(this.needsRendering){I.render();for(var t=Y.getImage("line_hor"),n=0,a=E.length;n<a;n++){var r=E[n],i=10,o=6,s=T+18*(n-w);if(0<s&&s<m.height){var l,c=m.ctx,u=s,d=m.height-18<=s;if(d){var h=m.height-s+1;1<h?((l=document.createElement("canvas")).width=m.width-2,l.height=h,c=l.getContext("2d"),u=4,o=6):c=void 0}if(c){p+w===n&&(c.fillStyle="rgba(110,130,220,0.07)",c.fillRect(0,u-o,m.width-2,18)),m.selectedIndex===n&&(c.fillStyle="rgba(110,130,220,0.15)",c.fillRect(0,u-o,m.width-2,18)),r.level&&(i+=10*r.level),r.icon&&(c.drawImage(r.icon,i,u-2),i+=r.icon.width+4);var f=r.label;if(v){if(r.info){var g=6*r.info.length+20;b.write(c,r.info,m.width-g,u,0),f=f.substr(0,Math.floor((m.width-g-i-26)/v.charWidth))}v.write(c,f,i,u,0)}s+=11,u+=11,t&&c.drawImage(t,0,u,m.width-2,2),d&&m.ctx.drawImage(l,0,s-11-4)}}}C.render(),k.render(),S.render()}if(this.needsRendering=!1,e)return m.canvas;m.parentCtx.drawImage(m.canvas,m.left,m.top,m.width,m.height)}},m.setItems=function(e){E=e,w=Math.min(w,i()),r(),m.refresh()},m.getItems=function(){return E},m.getItemAtPosition=function(e,t){t-=T;var n=Math.floor(t/18)+w;return 0<=n&&n<E.length?E[n]:void 0},m.insertItemAfterIndex=function(e,t,n){},m.onMouseWheel=function(e){0<e.mouseWheels[0]?m.navigateUp():m.navigateDown()},m.onDragStart=function(e){m.startDragIndex=w},m.onDrag=function(e){if(l<E.length){var t=Math.round(e.deltaY/18);w=m.startDragIndex-t,w=Math.max(w,0),w=Math.min(w,i()),m.centerSelection?m.setSelectedIndex(w):r()}},m.onHover=function(e){var t=Math.floor((m.eventY-T)/18);t!==o&&(o=p=t,m.refresh())},m.onHoverExit=function(){p&&(o=p=void 0,m.refresh())},m},UI.menu=function(e,t,n,a,s){function r(e){if(l&&l.length)for(var t=0,n=l.length;t<n;t++){var a=l[t];if(a.startX-12<=e&&e<=a.startX+a.width+12)return t}return-1}var l,c=UI.element(e,t,n,a);c.keepSelection=!0;var i,o,u,d,h=["left","top","width","height","name","type","background","layout"],f=[];return c.setProperties=function(t){h.forEach(function(e){void 0!==t[e]&&(c[e]=t[e])}),t.background&&((i=UI.scale9Panel(0,0,c.width,c.height,t.background)).ignoreEvents=!0,c.addChild(i)),c.setSize(c.width,c.height),c.setPosition(c.left,c.top)},c.onClick=function(e){if(Host.showInternalMenu){var n=r(e.x);if(l.forEach(function(e,t){t!==n&&e.subMenu&&e.subMenu.hide()}),!(n<0)){var t=l[n];if(o=void 0,Input.setFocusElement(c),t.subMenu)t.subMenu.setPosition((t.startX||0)+(e.globalX-e.x),c.height),t.subMenu.toggle(),t.subMenu.parent.refresh(),t.subMenu.isVisible()&&(o=n);t.command&&EventBus.trigger(EVENT.command,t.command)}}},c.onHover=function(e){if(Host.showInternalMenu){var t=r(c.eventX);t!==d&&(d=u=t,c.refresh()),t<0||0<=o&&o!==t&&c.activateSubmenu(t)}},c.onHoverExit=function(){u&&(d=u=void 0,c.refresh())},c.onKeyDown=function(e){var t;switch(e){case 13:if(r=c.getActiveSubItem())if(r.item.subMenu&&r.item.subMenu.isVisible()&&0<=r.item.subMenu.getSelectedIndex()){var n=r.item.subMenu.getSelectedIndex(),a=r.item.subMenu.getItems()[n];a&&r.item.subMenu.executeItem(a)}else r.menu.executeItem(r.item);t=!0;break;case 27:c.deActivate(),t=!0;break;case 37:if(0<=o)(r=c.getActiveSubItem())&&r.item.subMenu&&r.item.subMenu.isVisible()?r.menu.deActivateSubmenu():c.activateSubmenu(Math.max(o-1,0));t=!0;break;case 39:if(0<=o)(r=c.getActiveSubItem())&&r.item.subMenu&&!r.item.subMenu.isVisible()?r.menu.activateSubmenu(r.item):c.activateSubmenu(Math.min(o+1,l.length-1));t=!0;break;case 38:if(0<=o)if((r=c.getActiveSubItem())&&r.item.subMenu&&r.item.subMenu.isVisible())r.item.subMenu.setSelectedIndex(r.item.subMenu.getSelectedIndex()-1);else(i=l[o])&&i.subMenu&&i.subMenu.setSelectedIndex(i.subMenu.getSelectedIndex()-1);t=!0;break;case 40:var r,i;if(0<=o)if((r=c.getActiveSubItem())&&r.item.subMenu&&r.item.subMenu.isVisible())r.item.subMenu.setSelectedIndex(r.item.subMenu.getSelectedIndex()+1);else(i=l[o])&&i.subMenu&&i.subMenu.setSelectedIndex(i.subMenu.getSelectedIndex()+1);t=!0}return t},c.deActivate=function(e){if(0<=o){var t=l[o];t&&t.subMenu&&(e&&"submenu"===e.type&&e.mainMenu&&e.mainMenu.name===c.name||(t.subMenu.hide(),o=void 0,c.refresh(),Input.clearFocusElement()))}},c.activateSubmenu=function(e){if(e!==o){o=e,l.forEach(function(e,t){t!==o&&e.subMenu&&e.subMenu.hide()});var t=l[e];if(t&&t.subMenu)o=e,t.subMenu.setPosition((t.startX||0)+c.left,c.height),t.subMenu.toggle(),t.subMenu.parent.refresh()}},c.getActiveSubItem=function(){if(0<=o){var e=l[o];if(e&&e.subMenu){var t=e.subMenu.getSelectedIndex();if(0<=t)return{menu:e.subMenu,item:e.subMenu.getItems()[t]}}}},c.render=function(e){if(c.isVisible()){if(e=!!e,this.needsRendering){var a=10;c.clearCanvas(),i&&i.render(),f.length?f.forEach(function(e){e.render()}):l&&l.forEach(function(e,t){var n=9*e.label.length;e.startX=a,e.width=n,t===u&&(c.ctx.fillStyle="rgba(179,195,243,0.1)",c.ctx.fillRect(a-12,0,20+n,30)),fontMed.write(c.ctx,e.label,a,10),a+=24+n})}if(this.needsRendering=!1,e)return c.canvas;c.parentCtx.drawImage(c.canvas,c.left,c.top,c.width,c.height)}},c.setItems=function(e){l=e,s=s||c.parent;var r={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!(f=[]),textAlign:"center",font:window.fontDark,paddingTopActive:1},i=3,o=3;l.forEach(function(e,t){if("buttons"===c.layout){var n=UI.button(i,o,60,18);i+=60,1===t&&(i=3,o+=18),n.setProperties(r),n.setLabel(e.label),e.onClick&&(n.onClick=function(){e.onClick()}),f.push(n),c.addChild(n)}if(e.subItems){var a=UI.submenu();a.setProperties({background:UI.Assets.buttonLightScale9}),a.hide(),a.setItems(e.subItems),a.zIndex=200,s.addChild(a),a.mainMenu=c,e.subMenu=a}}),c.zIndex=9,c.refresh()},c.getItems=function(){return l},c},UI.modalDialog=function(e){var i,o=UI.element(),n="",a=["left","top","width","height","name","ok","cancel","input"];o.setProperties=function(t){a.forEach(function(e){void 0!==t[e]&&(o[e]=t[e])}),o.setSize(o.width,o.height),o.setPosition(o.left,o.top);var e=200;o.height<e&&(e=o.height-20);var n=Math.max(Math.floor(o.width/2),380);s.setSize(n,e),s.setPosition(Math.floor((o.width-n)/2),Math.floor((o.height-e)/2)),o.cancel?(l.setPosition(s.left+Math.floor(s.width/2)-110,s.top+s.height-40),c.setPosition(s.left+Math.floor(s.width/2)+10,s.top+s.height-40)):l.setPosition(s.left+Math.floor(s.width/2)-50,s.top+s.height-40),o.input&&(i||(i=UI.inputbox({name:"dialoginput",width:200,height:28,value:"",onChange:function(){o.inputValue=i.getValue()},onSubmit:function(e){o.inputValue=e,o.onKeyDown(13)}}),o.addChild(i),setTimeout(function(){i.activate()},0)),i.setProperties({left:s.left+50,top:s.top+s.height-80,width:s.width-100,height:28}))};var s=UI.scale9Panel(0,0,Math.floor(o.width/2),200,UI.Assets.panelMainScale9);s.ignoreEvents=!0,o.addChild(s);var l=UI.Assets.generate("buttonLight");l.setProperties({name:"okbutton",label:"OK",width:100,height:28}),o.addChild(l);var c=UI.Assets.generate("buttonLight");return c.setProperties({name:"cancelbutton",label:"Cancel",width:100,height:28}),o.addChild(c),o.onKeyDown=function(e){switch(e){case 13:return o.close(),!0}},o.render=function(e){if(e=!!e,this.needsRendering){if(o.clearCanvas(),o.ctx.fillStyle="rgba(0,0,0,0.6)",o.ctx.fillRect(0,0,o.width,o.height),s.render(),n){var t=n.split("/"),a=s.top+20,r=s.width-20;t.forEach(function(e){var t=10;if(fontFT){var n=fontFT.getTextWidth(e,0);t=s.left+10+Math.floor((r-n)/2),fontFT.write(o.ctx,e,t,a,0)}a+=12})}o.ok&&l.render(),o.cancel&&c.render(),i&&i.render()}if(this.needsRendering=!1,e)return o.canvas;o.parentCtx.drawImage(o.canvas,o.left,o.top,o.width,o.height)},o.setText=function(e){n=e},o.getText=function(){return n},o.close=function(){o.hide(),o.onClose&&o.onClose(),UI.removeModalElement(),delete o},o},UI.numberDisplay=function(e){function t(t){T.forEach(function(e){if(void 0!==t[e])switch(e){case"value":d=t[e];break;case"onChange":i=t[e];break;case"min":n=t[e];break;case"max":f=t[e];break;case"step":g=t[e];break;case"size":v=t[e];break;case"autoPadding":b=!!t[e];break;default:s[e]=t[e]}}),u="big"===v?window.fontLedBig:window.fontLed,w=E[v]}function o(){for(var e=""+d;e.length<s.padLength;)e=p+e;return e}function a(e){m=e;var t=o().length,n=t-(""+d).length;t<m&&(m=t),m<n&&(m=n),s.refresh()}function r(e){var t=o().split("");t.splice(m+e,1);var n=parseInt(t.join("").trim());isNaN(n)&&(n=0),s.updateValue(n)}var s=UI.element();s.type="numberDisplay",s.isActive=!1,s.isDisabled=!1;var l,c,i,u,d=0,h=0,n=0,f=100,g=1,p=" ",m=0,v="medium",b=!(s.padLength=4),E={small:{x:4,y:3,c:0},medium:{x:6,y:7,c:0},big:{x:7,y:4,c:-2}},w=E.medium,T=["left","top","width","height","name","value","onChange","min","max","step","padLength","size","autoPadding","trackUndo","undoLabel","undoInstrument"];e&&t(e),s.setProperties=function(e){t(e),s.setSize(s.width,s.height),s.setPosition(s.left,s.top),9999<f&&s.padLength<5&&(s.padLength=5)},s.setValue=function(e,t){if(e!==d&&(h=d),d=e,s.refresh(),!t&&i){if(s.trackUndo){var n=StateManager.createValueUndo(s);n.name=s.undoLabel||"Change "+s.name,s.undoInstrument&&(n.instrument=Tracker.getCurrentInstrumentIndex(),n.id+=n.instrument),StateManager.registerEdit(n)}i(d)}},s.updateValue=function(e){f<e&&(e=f),e<n&&(e=n),s.setValue(e)},s.getValue=function(){return d},s.getPrevValue=function(){return h},s.setDisabled=function(e){void 0===e&&(e=!0),(s.isDisabled=e)&&(s.isActive=!1),s.refresh()},s.setFocus=function(e){(l=!!e)?(Input.setFocusElement(s),m=o().length,I()):Input.clearFocusElement(),s.refresh()},s.togglFocus=function(){s.setFocus(!l)},s.setMax=function(e,t){f=e,!t&&f<d&&s.setValue(f)},s.setMin=function(e){d<(n=e)&&s.setValue(n)},s.onClick=function(){s.isDisabled||i&&s.togglFocus()},s.onMouseWheel=function(e){s.isDisabled||i&&s.updateValue(0<e.mouseWheels[0]?d+g:d-g)},s.onKeyDown=function(e,t){var n=t.key;switch(t.keyCode){case 8:r(-1);break;case 9:case 13:case 27:Input.clearFocusElement();break;case 37:a(m-1);break;case 38:s.updateValue(d+1);break;case 39:a(m+1);break;case 40:s.updateValue(d-1);break;case 46:r(0)}switch(n){case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":!function(e){var t=o().split("");t.splice(m,0,e);var n=parseInt(t.join("").trim());isNaN(n)&&(n=0),s.updateValue(n)}(n)}return!0},s.onResize=function(){b&&(s.padLength=Math.floor(s.width/8)-1)},s.activate=function(){l=!0,m=o().length,c=!0,I()},s.deActivate=function(){l&&(c=l=!1,s.refresh(),Input.clearFocusElement())},s.render=function(e){if(s.isVisible()){var t=l?"panel_inset_dark_active":"panel_inset_dark_inactive";if(s.needsRendering){e=!!e,s.ctx.clearRect(0,0,s.width,s.height);var n=s.paddingLeft||0,a=s.paddingTop||0,r=s.width-n-(s.paddingRight||0),i=s.height-a-(s.paddingBottom||0);if(s.ctx.drawImage(Y.getImage(t),n,a,r,i),u)if(n+=w.x,a=w.y,u.write(s.ctx,o(),n,a,0),c)s.ctx.fillStyle="rgba(255,201,65,0.7)",s.ctx.fillRect(n+m*u.charWidth+w.c,a,2,u.charHeight);s.renderInternal&&s.renderInternal(),s.isDisabled&&(s.ctx.fillStyle="rgba(34, 49, 85, 0.6)",s.ctx.fillRect(0,0,s.width,s.height))}if(s.needsRendering=!1,e)return s.canvas;s.parentCtx.drawImage(s.canvas,s.left,s.top,s.width,s.height)}};var I=function(){l?(c=!c,setTimeout(I,300)):c=!1,s.refresh()};return s},UI.panel=function(e,t,n,a){var r=UI.element(e,t,n,a);r.type="panel";var i=["left","top","width","height","name","type","zIndex","backgroundColor","borderColor"];return r.setProperties=function(t){i.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top),r.setLayout&&r.setLayout(r.left,r.top,r.width,r.height)},r.render=function(e){if(r.isVisible()){if(e=!!e,this.needsRendering&&(r.renderOverride?r.renderOverride():(r.clearCanvas(),r.backgroundColor&&(r.ctx.fillStyle=r.backgroundColor,r.ctx.fillRect(0,0,r.width,r.height)),r.borderColor&&(r.ctx.fillStyle=r.borderColor,r.ctx.rect(0,0,r.width,r.height),r.ctx.stroke()),this.children.forEach(function(e){e.render()}),r.renderInternal&&r.renderInternal())),this.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)}},r.onClick=function(){},r.sortZIndex=function(){this.children.sort(function(e,t){return e.zIndex==t.zIndex?0:t.zIndex<e.zIndex||-1})},r},UI.radioGroup=function(e,t,n,a){var r,p,m,v=UI.element(e,t,n,a,!0),b=[],E="small",w="right",T=-3,I=13,i=["left","top","width","height","name"];return v.setProperties=function(t){i.forEach(function(e){void 0!==t[e]&&(v[e]=t[e])}),v.setSize(v.width,v.height),v.setPosition(v.left,v.top),t.align&&(w=t.align),t.size&&(E=t.size),t.divider&&(p=t.divider),t.type&&0,t.highLightSelection&&(m=!0)},v.onClick=function(e){v.setSelectedIndex(Math.floor((+v.eventY+T)/I))},v.setSelectedIndex=function(e,t){e=Math.min(e,b.length-1);for(var n=0,a=b.length;n<a;n++)b[n].active=n==e;v.selectedIndex=e,v.refresh(),!t&&v.onChange&&r!=v.selectedIndex&&v.onChange(v.selectedIndex),r=v.selectedIndex},v.getSelectedIndex=function(){return v.selectedIndex},v.getSelectedItem=function(){return b[v.selectedIndex]},v.render=function(e){if(e=!!e,v.isVisible()){if(this.needsRendering){v.clearCanvas();var t=Y.getImage("radio_active"),n=Y.getImage("radio_inactive");I=Math.floor(v.height/b.length);var a=fontSmall,r=5,i=v.width-15;T=-3,"med"===E&&(t=Y.getImage("radio_big_active"),n=Y.getImage("radio_big_inactive"),T=-2,i=v.width-20,a=fontMed);var o=Math.floor((I-a.charHeight)/2);"left"===w&&(r=30,i=5);for(var s=Y.getImage("line_hor"),l=0,c=b.length;l<c;l++){var u=b[l],d=0+l*I,h=d+o;if("line"==p&&0<l&&v.ctx.drawImage(s,0,d,v.width,2),a){var f=u.label;if("right"===w&&(r=i-a.getTextWidth(u.label,0)-4)<0&&u.labels){var g=i-4;u.labels.forEach(function(e){e.width<=g&&(f=e.label)}),r=i-a.getTextWidth(f,0)-4}a.write(v.ctx,f,r,h,0)}u.active?(m&&(v.ctx.fillStyle="rgba(100,100,255,0.1",v.ctx.fillRect(0,d,v.width-2,I)),v.ctx.drawImage(t,i,h+T)):v.ctx.drawImage(n,i,h+T)}}if(this.needsRendering=!1,e)return v.canvas;v.parentCtx.drawImage(v.canvas,v.left,v.top,v.width,v.height)}},v.setItems=function(e){v.selectedIndex=void 0;for(var t=0,n=(b=e).length;t<n;t++)b[t].active&&(v.selectedIndex=t);v.refresh()},v.getItemAtPosition=function(e,t){t=+t;var n=Math.floor(t/I)+visibleIndex;return 0<=n&&n<b.length?(b[n].index=n,b[n]):void 0},v},UI.rangeSlider=function(e){var i=UI.element();i.type="rangeslider";var n=["left","top","width","height","name","onChange"],o=Y.getImage("slider_knob"),a=Y.getImage("slider_knob_vert"),t=Y.getImage("slider_back"),r=Y.getImage("slider_back_vert"),s=!1,l=0,c=UI.scale9Panel(0,0,0,0,{img:t,left:4,right:4,top:0,bottom:0,scale:"repeatX"});i.addChild(c),c.ignoreEvents=!0;var u=0,d=0,h=0,f=0,g=0,p=100,m=0;return i.setProperties=function(t){n.forEach(function(e){void 0!==t[e]&&(i[e]=t[e])}),i.setSize(i.width,i.height),i.setPosition(i.left,i.top),void 0!==t.min&&(g=t.min),void 0!==t.max&&(p=t.max),void 0!==t.value&&i.setValue(t.value,!0),void 0!==t.vertical&&(s=!!t.vertical,c.setProperties({img:r,imgLeft:0,imgRight:0,imgTop:4,imgBottom:4,scale:"repeatY"}))},i.getValue=function(){return m},i.setValue=function(e,t){p<e&&(e=p),e<g&&(e=g);var n=!t&&m!==e;(m=e,s)?d=l*(1-(e-g)/(p-g)):u=(i.width-o.width)*e/p;i.refresh(),n&&!t&&i.onChange&&i.onChange(m)},i.setMax=function(e,t){p=e,!t&&p<m&&i.setValue(p)},i.setMin=function(e,t){g=e,!t&&m<g&&i.setValue(g)},i.render=function(e){if(i.needsRendering){e=!!e,i.clearCanvas();var t=Math.floor(i.width/2)+3,n=i.height;g<0&&(n=Math.floor(n/2)),i.ctx.fillStyle="rgba(255,255,255,0.1",i.ctx.beginPath(),i.ctx.moveTo(t,n),i.ctx.lineTo(t,2),i.ctx.lineTo(t+6,2),i.ctx.fill(),g<0?(i.ctx.beginPath(),i.ctx.moveTo(t-6,n),i.ctx.lineTo(t-6,i.height),i.ctx.lineTo(t-6-6,i.height)):(i.ctx.beginPath(),i.ctx.moveTo(t-6,n),i.ctx.lineTo(t-6,2),i.ctx.lineTo(t-6-6,2)),i.ctx.fill(),c.render(),s?i.ctx.drawImage(a,-1,d,a.width,a.height):i.ctx.drawImage(o,u,-1,o.width,o.height)}if(i.needsRendering=!1,e)return i.canvas;i.parentCtx.drawImage(i.canvas,i.left,i.top,i.width,i.height)},i.onResize=function(){l=i.height-a.height+3,c.setSize(i.width,i.height),i.setValue(m,!0)},i.onDragStart=function(){h=u,f=d},i.onDrag=function(e){if(s){var t=e.deltaY;if((d=f+t)<0&&(d=0),l<d&&(d=l),o.height<l){var n=p-g,a=n-Math.round(n*d/l);m=a+g}else m=p}else{(u=h+(t=e.deltaX))<0&&(u=0);var r=i.width-o.width;r<u&&(u=r),m=o.width<r?Math.round(p*u/r):0}i.refresh(),i.onChange&&i.onChange(m)},e&&i.setProperties(e),i},UI.scale9Panel=function(e,t,n,a,u){var d=UI.element(e,t,n,a,!0);d.type="scale9",u.scale=u.scale||"stretch",d.setProperties=function(t){var e=["left","top","width","height","name","type"];if(!t){var n={};return e.forEach(function(e){n[e]=d[e]}),n}e.forEach(function(e){void 0!==t[e]&&(d[e]=t[e])}),void 0!==t.img&&(u.img=t.img),void 0!==t.scale&&(u.scale=t.scale),void 0!==t.imgTop&&(u.top=t.imgTop),void 0!==t.imgBottom&&(u.bottom=t.imgBottom),void 0!==t.imgLeft&&(u.left=t.imgLeft),void 0!==t.imgRight&&(u.right=t.imgRight),d.setSize(d.width,d.height),d.setPosition(d.left,d.top)};return d.render=function(e){if(e=!!e,d.isVisible()){if(d.needsRendering&&function(){var e=u.img;if(e){var t=e.width-u.left-u.right,n=e.height-u.top-u.bottom,a=d.width-u.left-u.right,r=d.height-u.top-u.bottom;if(d.clearCanvas(),u.top&&u.left&&d.ctx.drawImage(e,0,0,u.left,u.top,0,0,u.left,u.top),u.top&&d.ctx.drawImage(e,u.left,0,t,u.top,u.left,0,a,u.top),u.top&&u.right&&d.ctx.drawImage(e,u.left+t,0,u.right,u.top,u.left+a,0,u.right,u.top),u.left&&d.ctx.drawImage(e,0,u.top,u.left,n,0,u.top,u.left,r),"stretch"===u.scale&&d.ctx.drawImage(e,u.left,u.top,t,n,u.left,u.top,a,r),"repeatX"===u.scale)for(var i,o=u.left,s=u.left+a;o<s;)s<o+(i=t)&&(i=s-o),d.ctx.drawImage(e,u.left,u.top,i,n,o,u.top,i,n),o+=i;if("repeatY"===u.scale){var l,c=u.top;for(s=u.top+r;c<s;)s<c+(l=n)&&(l=s-c),d.ctx.drawImage(e,u.left,u.top,t,l,u.left,c,t,l),c+=l}u.right&&d.ctx.drawImage(e,u.left+t,u.top,u.right,n,u.left+a,u.top,u.right,r),u.bottom&&u.left&&d.ctx.drawImage(e,0,u.top+n,u.left,u.bottom,0,u.top+r,u.left,u.bottom),u.bottom&&d.ctx.drawImage(e,u.left,u.top+n,t,u.bottom,u.left,u.top+r,a,u.bottom),u.bottom&&u.right&&d.ctx.drawImage(e,u.left+t,u.top+n,u.right,u.bottom,u.left+a,u.top+r,u.right,u.bottom)}}(),d.needsRendering=!1,e)return d.canvas;d.parentCtx.drawImage(d.canvas,d.left,d.top)}},d},UI.submenu=function(e,t,n,a){function l(e){return"function"==typeof e.disabled?e.disabled():!!e.disabled}function c(e){return"function"==typeof e.label?e.label():e.label}var u,d=UI.element(e,t,n,a);d.type="submenu";var h,f,r,i,o=["left","top","width","height","name","type"];return d.setProperties=function(t){o.forEach(function(e){void 0!==t[e]&&(d[e]=t[e])}),t.background&&((h=UI.scale9Panel(0,0,d.width,d.height,t.background)).ignoreEvents=!0,d.addChild(h)),d.setSize(d.width,d.height),d.setPosition(d.left,d.top)},d.onHover=function(e){var t=Math.floor(d.eventY/26);t!==r&&d.setSelectedIndex(t)},d.onHoverExit=function(){f&&(r=f=void 0,d.refresh())},d.onShow=function(){r=f=0},d.onHide=function(){i&&(i.subMenu.hide(),i=void 0)},d.setSelectedIndex=function(e){(f=Math.min(e,u.length-1))<0&&(f=0);var t=u[r=f];t.subItems?d.activateSubmenu(t):i&&(i.subMenu.hide(),i=void 0),d.refresh()},d.getSelectedIndex=function(){return void 0!==f?f:-1},d.onClick=function(e){if(u&&u.length){var t=u[Math.floor(d.eventY/26)];d.executeItem(t)}},d.executeItem=function(e){l(e)||e&&(e.command?(d.hide(),d.parent.refresh(),d.mainMenu&&d.mainMenu.deActivate(),EventBus.trigger(EVENT.command,e.command)):e.subItems&&d.toggleSubmenu(e))},d.activateSubmenu=function(e){if(!e.subMenu){var t=UI.submenu();t.setProperties({background:UI.Assets.buttonLightScale9}),t.hide(),t.setItems(e.subItems),t.zIndex=300,d.parent.addChild(t),t.mainMenu=d.mainMenu,e.subMenu=t}var n=d.left+d.width-20;UI.mainPanel.width<n+e.subMenu.width&&(n=UI.mainPanel.width-e.subMenu.width),e.subMenu.setPosition(n,d.top+26*e.index),e.subMenu.show(),i=e,d.refresh()},d.deActivateSubmenu=function(){i&&(i.subMenu.hide(),i=void 0,d.refresh())},d.toggleSubmenu=function(e){e.subMenu&&e.subMenu.isVisible()?d.deActivateSubmenu():d.activateSubmenu(e)},d.render=function(e){if(d.isVisible()){if(e=!!e,this.needsRendering){d.clearCanvas(),h&&h.render();for(var t=Y.getImage("line_hor"),n=0,a=d.width-3,r=u.length-1,i=0;i<=r;i++){var o=u[i],s=l(o);i!==f||s||(d.ctx.fillStyle="rgba(255,255,255,0.2)",d.ctx.fillRect(0,n,a,26)),o.label&&fontFT.write(d.ctx,c(o),9,n+9),o.subItems&&fontMed.write(d.ctx,">",d.width-16,n+9+2),s&&(d.ctx.fillStyle="rgba(88,105,129,0.6)",d.ctx.fillRect(0,n,a,26)),n+=26,i<r&&d.ctx.drawImage(t,0,n,a,2)}}if(this.needsRendering=!1,e)return d.canvas;d.parentCtx.drawImage(d.canvas,d.left,d.top,d.width,d.height)}},d.setItems=function(e){var a=50;(u=e).forEach(function(e,t){var n=e.label?9*c(e).length:0;n+=24,a=Math.max(a,n),e.index=t}),d.setSize(a,26*u.length+4),h&&h.setSize(d.width,d.height),i=r=f=void 0,d.refresh()},d.getItems=function(){return u},d},UI.DiskOperationActions=function(){var n=UI.panel(),a=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);a.ignoreEvents=!0,n.addChild(a);var r=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);r.ignoreEvents=!0,n.addChild(r);var i=UI.label({label:"Action",font:fontSmall});n.addChild(i);var o=UI.radioGroup();return o.setProperties({align:"right",size:"med",divider:"line",type:"buttons",highLightSelection:!0}),o.setItems([{label:"load",active:!0},{label:"save",active:!1}]),o.onChange=function(e){EventBus.trigger(EVENT.diskOperationActionChange,this.getSelectedItem())},n.addChild(o),n.setLayout=function(){var e=n.width-2,t=70;n.height<100&&(t=n.height-20),UI.mainPanel&&(n.clearCanvas(),a.setProperties({left:0,top:0,height:n.height,width:n.width}),r.setProperties({left:1,top:1,height:16,width:e}),i.setProperties({left:-1,top:3,height:16,width:e}),o.setProperties({left:4,width:e-4,height:t,top:18}))},n.getAction=function(){var e="load";return 1==o.getSelectedIndex()&&(e="save"),e},n.setSelectedIndex=function(e){o.setSelectedIndex(e)},n},UI.DiskOperationSave=function(){function n(){var e=r,t=r.lastIndexOf("."),n="";0<=t&&(e=r.substr(0,t),n=r.substr(t));var a=d.getSelectedItem();a&&a.extention&&(n=a.extention),".mod"===n&&Tracker.inFTMode()&&(n=".xm"),f.setValue(e+n)}var r,t=UI.panel(),o=FILETYPE.module,s=FILETYPE.module,l=MODULETYPE.mod,c="local",a=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);a.ignoreEvents=!0,t.addChild(a);var u={};u[FILETYPE.module]=[{label:"module",active:!0,extention:".mod",fileType:FILETYPE.module},{label:"wav",active:!1,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.WAVE_PCM},{label:"mp3",active:!1,extention:".mp3",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.MP3}],u[FILETYPE.sample]=[{label:"wav 16 bit",active:!1,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RIFF_16BIT},{label:"wav 8 bit",active:!0,extention:".wav",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RIFF_8BIT},{label:"RAW 8 bit",active:!1,extention:".sample",fileType:FILETYPE.sample,fileFormat:SAMPLETYPE.RAW_8BIT}];var d=UI.radioGroup();d.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),d.setItems(u[FILETYPE.module]),d.onChange=function(e){var t=this.getSelectedItem();o=t&&t.fileType?t.fileType:FILETYPE.module,l=t&&t.fileFormat?t.fileFormat:MODULETYPE.mod,n()},t.addChild(d);var h=UI.button();h.setProperties({label:"Export",textAlign:"center",background:UI.Assets.buttonLightScale9,font:window.fontMed}),h.onClick=function(){if(s==FILETYPE.module&&(o==FILETYPE.module&&Editor.save(r,c),o==FILETYPE.sample&&BassoonProvider.renderFile(r,l===SAMPLETYPE.MP3)),s==FILETYPE.sample){var e=Tracker.getCurrentInstrument().sample;if(e){if(l===SAMPLETYPE.RAW_8BIT){var t,n=new BinaryStream(new ArrayBuffer(e.length),!0);for(n.clear(2),i=0;i<e.length-2;i++)t=e.data[i]||0,n.writeByte(Math.round(127*t))}else n=encodeRIFFsample(e.data,l===SAMPLETYPE.RIFF_16BIT?16:8);var a=new Blob([n.buffer],{type:"application/octet-stream"});"dropbox"===c?Dropbox.putFile("/"+r,a):saveAs(a,r)}}},t.addChild(h);var f=UI.inputbox({name:"fileNameInput",height:20,onChange:function(e){r=e},backgroundImage:"panel_mid"});return t.addChild(f),t.setLayout=function(){var e=t.width-2;UI.mainPanel&&(t.clearCanvas(),a.setProperties({left:0,top:0,height:t.height,width:t.width}),f.setProperties({left:4,width:e-6,top:4}),h.setProperties({left:2,width:e,height:28,top:t.height-27}),d.setProperties({left:4,width:e-4,height:t.height-h.height-30,top:30}))},EventBus.on(EVENT.songPropertyChange,function(e){r=e.filename||"",n()}),EventBus.on(EVENT.diskOperationTargetChange,function(e){(c=e).target&&(c=c.target),e&&e.fileType&&((s=e.fileType)==FILETYPE.sample&&(r=Tracker.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")),s==FILETYPE.module&&(r=Tracker.getFileName()),u[s]&&(d.setItems(u[s]),d.onChange()))}),EventBus.on(EVENT.instrumentChange,function(e){t.isVisible()&&s==FILETYPE.sample&&(r=Tracker.getCurrentInstrument().name.replace(/ /g,"-").replace(/\W/g,"")||"Sample-"+Tracker.getCurrentInstrumentIndex(),n())}),EventBus.on(EVENT.trackerModeChanged,function(e){t.isVisible()&&s==FILETYPE.module&&(r=Tracker.getSong().filename||"",n())}),t},UI.DiskOperationTargets=function(){function e(e,t){var n=e.findIndex(function(e){return e.target===t});0<=n&&e.splice(n,1)}var t=UI.panel(),n=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);n.ignoreEvents=!0,t.addChild(n);var a=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);a.ignoreEvents=!0,t.addChild(a);var r=UI.label({label:"From",font:fontSmall});t.addChild(r);var i=[{label:"Bassoon:",target:"bassoon",active:!0},{label:"Modarchive:",target:"modarchive"},{label:"Modules.pl:",target:"modulespl"},{label:"Dropbox:",target:"dropbox"},{label:"local:",target:"local"}],o=[{label:"Bassoon:",target:"bassoon",active:!0},{label:"Dropbox:",target:"dropbox"},{label:"local:",target:"local"}],s=[{label:"local:",target:"local",active:!0},{label:"Dropbox:",target:"dropbox"}];Host.useDropbox||(e(i,"dropbox"),e(o,"dropbox"),e(s,"dropbox"));var l=i,c="load",u=UI.radioGroup();return u.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),u.setItems(i),u.onChange=function(e){EventBus.trigger(EVENT.diskOperationTargetChange,this.getSelectedItem())},t.addChild(u),t.setLayout=function(){var e=t.width-3;if(UI.mainPanel){t.clearCanvas(),n.setProperties({left:0,top:0,height:t.height,width:t.width}),a.setProperties({left:2,top:1,height:16,width:e}),r.setProperties({left:-1,top:3,height:16,width:e});u.setProperties({width:e,height:t.height-18-2,left:2,top:18})}},t.getTarget=function(){return"bassoon"},EventBus.on(EVENT.diskOperationTargetChange,function(e){e&&e.fileType&&("save"===c?u.setItems(s):(e.fileType===FILETYPE.module&&(l=i),e.fileType===FILETYPE.sample&&(l=o),u.setItems(l)),u.setSelectedIndex(0))}),EventBus.on(EVENT.diskOperationActionChange,function(e){"save"===e.label?(r.setLabel("To"),c="save",u.setItems(s)):(r.setLabel("From"),c="load",u.setItems(l)),EventBus.trigger(EVENT.diskOperationTargetChange,u.getSelectedItem())}),EventBus.on(EVENT.dropboxConnectCancel,function(){u.setSelectedIndex(0)}),t},UI.DiskOperationType=function(){var n=UI.panel(),a=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkInsetScale9);a.ignoreEvents=!0,n.addChild(a);var r=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);r.ignoreEvents=!0,n.addChild(r);var i=UI.label({label:"Type",font:fontSmall});n.addChild(i);var o=UI.radioGroup();return o.setProperties({align:"right",size:"med",divider:"line",highLightSelection:!0}),o.setItems([{label:"module",active:!0,fileType:FILETYPE.module},{label:"sample",active:!1,fileType:FILETYPE.sample}]),o.onChange=function(e){EventBus.trigger(EVENT.diskOperationTargetChange,this.getSelectedItem())},n.addChild(o),n.setLayout=function(){var e=n.width-2,t=70;n.height<100&&(t=n.height-20),UI.mainPanel&&(n.clearCanvas(),a.setProperties({left:0,top:0,height:n.height,width:n.width}),r.setProperties({left:1,top:1,height:16,width:e}),i.setProperties({left:-1,top:3,height:16,width:e}),o.setProperties({left:4,width:e-4,height:t,top:18}))},n.getType=function(){var e=o.getSelectedIndex(),t="modules";return 1==e&&(t="samples"),2==e&&(t="patterns"),t},n.setType=function(e){o.setSelectedIndex(e)},n},UI.DiskOperations=function(){function a(t,e){C.setSelectedIndex(e),m=e,t.isExpanded?(t.isExpanded=!1,o.refreshList()):(t.isExpanded=!0,t.children.length?o.refreshList():(t.children=[{title:"loading ..."}],o.refreshList(),n?n.get(t.url,function(e){v(t,e)}):FetchService.json(t.url,function(e){v(t,e)})))}var o=UI.panel();o.hide();var n,s="load",l="modules",c=[],u=[],d=[],h=[],f=[],g=[],p=0,m=0,v=function(){},e=UI.scale9Panel(0,0,20,20,UI.Assets.panelMainScale9);e.ignoreEvents=!0,o.addChild(e);var r=UI.DiskOperationActions();o.addChild(r);var b=UI.DiskOperationType();o.addChild(b);var i=UI.DiskOperationTargets();o.addChild(i);var t=UI.DiskOperationSave();o.addChild(t);var E={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1,height:18,width:50},w=UI.button(),T=UI.button();T.setActive(!0),w.setProperties(E),w.setLabel("Save"),w.onDown=function(){r.setSelectedIndex(1)},o.addChild(w),T.setProperties(E),T.setLabel("Load"),T.onDown=function(){r.setSelectedIndex(0)},o.addChild(T);var I=UI.label({label:"Load module",font:fontMed});o.addChild(I);var k=UI.Assets.generate("button20_20");k.setLabel("x"),k.onClick=function(){App.doCommand(COMMAND.showTopMain)},o.addChild(k);var S=UI.Assets.generate("buttonKey");S.setLabel("browse"),S.onClick=function(){var e=document.createElement("input");e.type="file",e.onchange=function(e){Tracker.handleUpload(e.target.files)},e.click()},o.addChild(S),S.hide();var C=UI.listbox();o.addChild(C);var y=UI.button();return y.setProperties({background:UI.Assets.buttonDarkActiveScale9,image:Y.getImage("dropzone"),font:fontSmall,textAlign:"center"}),y.onClick=S.onClick,o.addChild(y),y.hide(),o.onShow=function(){o.onResize()},o.onResize=function(){if(o.isVisible()){o.clearCanvas(),e.setProperties({left:0,top:0,height:o.height,width:o.width});k.setProperties({top:3,width:20,heigth:18,left:o.width-30}),S.setProperties({top:k.top+2,width:55,height:18,left:k.left-60}),730<=o.width?(r.show(),I.show(),T.hide(),w.hide(),r.setProperties({top:5,left:Layout.col1X,width:Layout.col1W,height:o.height-10}),b.setProperties({top:5,left:Layout.col2X,width:Layout.col1W,height:o.height-10}),i.setProperties({top:5,left:Layout.col3X,width:Layout.col1W,height:o.height-10}),I.setProperties({left:Layout.col4X,top:5,height:20,width:Layout.col2W}),C.setProperties({left:Layout.col4X,width:Layout.col2W,top:24,height:o.height-24-5})):(r.hide(),I.hide(),T.show(),w.show(),T.setProperties({top:5,left:Layout.col3X}),w.setProperties({top:5,left:Layout.col3X+50}),b.setProperties({top:5,left:Layout.defaultMargin,width:Layout.col2W,height:o.height/2-5-16}),i.setProperties({top:o.height/2-16,left:Layout.defaultMargin,width:Layout.col2W,height:o.height/2+16}),C.setProperties({left:Layout.col3X,width:Layout.col3W,top:24,height:o.height-24-5})),"save"===s?(t.setProperties({left:C.left,width:C.width,top:C.top,height:C.height}),C.hide(),t.show()):(C.show(),t.hide()),y.setProperties({left:C.left,width:C.width,top:C.top,height:C.height})}},o.setView=function(e){o.refreshList("samples"===e?"samples":""),0<e.indexOf("_save")&&r.setSelectedIndex(1),0<e.indexOf("_load")&&r.setSelectedIndex(0),0<e.indexOf("_samples")&&b.setType(1),0<e.indexOf("_modules")&&b.setType(0)},o.refreshList=function(e){function t(e,t){c=[],i=0,t=t||0,function n(e,a){e.forEach(function(e){var t;e.icon&&(t=Y.getImage(e.icon)),t=t||Y.getImage("modules"===l?"module":"sample"),e.children&&(t=Y.getImage("disk")),r.push({label:e.title,data:e,level:a,index:i,icon:t,info:e.info}),c[i]=e,i++,e.children&&e.children.length&&e.isExpanded&&n(e.children,a+1)})}(e,0),C.setItems(r),C.setSelectedIndex(t)}if("save"!==s){var r=[],i=0;switch(l!==e&&C.setSelectedIndex(0,!0),"local"==(l=e||l)?(C.hide(),y.show(),S.show()):(C.show(),y.hide(),S.hide(),"bassoon"==l&&(l=b.getType())),l){case"modules":n=!1,I.setLabel("Load Module"),C.onClick=function(e){var t=C.getItemAtPosition(C.eventX,C.eventY);if(t&&t.data){var n=t.index;(t=c[n]).children?a(t,n):(C.setSelectedIndex(n),Tracker.load(t.url),App.doCommand(COMMAND.showTopMain))}},u.length?t(u,m):FetchService.json(Host.getBaseUrl()+"data/modules.json",function(e){e&&e.modules&&t(u=e.modules,m)});break;case"modarchive":n=ModArchive,I.setLabel("Browse Modarchive"),C.onClick=function(e){var t=C.getItemAtPosition(C.eventX,C.eventY);if(t&&t.data){var n=t.index;(t=c[n]).children?a(t,n):(C.setSelectedIndex(n),Tracker.load(t.url),App.doCommand(COMMAND.showTopMain))}},v=function(t,e){e&&e.length?"... load more ..."==t.title&&t.parent?(t=t.parent,e.forEach(function(e){e.parent=t}),t.children.pop(),t.children=t.children.concat(e)):(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},h.length?t(h,0):(C.setItems([{label:"loading ..."}]),FetchService.json(Host.getBaseUrl()+"data/modarchive.json",function(e){e&&e.modarchive&&t(h=e.modarchive,0)}));break;case"modulespl":n=ModulesPl,I.setLabel("Browse Modules.pl"),C.onClick=function(e){var t=C.getItemAtPosition(C.eventX,C.eventY);if(t&&t.data){var n=t.index;(t=c[n]).children?a(t,n):(C.setSelectedIndex(n),Tracker.load(t.url),App.doCommand(COMMAND.showTopMain))}},v=function(t,e){e&&e.length?"... load more ..."==t.title&&t.parent?(t=t.parent,e.forEach(function(e){e.parent=t}),t.children.pop(),t.children=t.children.concat(e)):(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},f.length?t(f,0):(C.setItems([{label:"loading ..."}]),FetchService.json(Host.getBaseUrl()+"data/modulespl.json",function(e){e&&e.modulespl&&t(f=e.modulespl,0)}));break;case"dropbox":n=Dropbox,I.setLabel("Browse Your Dropbox"),UI.setStatus("Contacting Dropbox",!0),C.setItems([{label:"loading ..."}]),C.onClick=function(e){var n=C.getItemAtPosition(C.eventX,C.eventY);if(n&&n.data){var t=n.index;(n=c[t]).children?a(n,t):(C.setSelectedIndex(t),UI.setInfo(n.title),UI.setStatus("Loading from Dropbox",!0),Dropbox.getFile(n,function(e){var t=new FileReader;t.onload=function(){Tracker.processFile(t.result,n.title,function(e){UI.setStatus("Ready")})},t.readAsArrayBuffer(e)}))}},v=function(t,e){e&&e.length?(e.forEach(function(e){e.parent=t}),t.children=e):t.children=[{title:"error loading data"}],o.refreshList()},g.length?t(g,0):Dropbox.checkConnected(function(e){e?Dropbox.list("",function(e){UI.setStatus(""),t(g=e,0)}):Dropbox.showConnectDialog()});break;case"samples":n=!1,I.setLabel("Load Sample to slot "+Tracker.getCurrentInstrumentIndex()),C.onClick=function(e){var t=C.getItemAtPosition(C.eventX,C.eventY);if(t&&t.data){var n=t.index;(t=c[n]).children?(C.setSelectedIndex(n),p=n,t.isExpanded?(t.isExpanded=!1,o.refreshList()):(t.isExpanded=!0,t.children.length?o.refreshList():FetchService.json(t.url,function(e){e&&e.samples&&(t.children=e.samples,o.refreshList())}))):(C.setSelectedIndex(n),Tracker.load(t.url))}},v=function(e,t){t&&t.samples&&(e.children=t.samples,o.refreshList())},d.length?t(d,p):FetchService.json(Host.getBaseUrl()+"data/samples.json",function(e){e&&e.samples&&t(d=e.samples,p)});break;case"local":n=!1,I.setLabel("Upload files")}}},o.playRandomSong=function(e){UI.setStatus("Fetching random song",!0),UI.setInfo(""),FetchService.json("https://www.stef.be/bassoontracker/api/random"+(e||""),function(e){e&&e.modarchive&&e.modarchive.module&&Tracker.load(e.modarchive.module.url)})},EventBus.on(EVENT.diskOperationTargetChange,function(e){var t=r.getAction();if(e&&e.target&&(e=e.target),e&&e.fileType&&(e.fileType===FILETYPE.module&&(e="modules"),e.fileType===FILETYPE.sample&&(e="samples")),void 0===e&&(e=i.getTarget()),"save"===t){s="save";var n="Export Module";"samples"===(l=b.getType())&&(n="Export Sample"),I.setLabel(n),T.isActive&&T.setActive(!1),w.isActive||w.setActive(!0),y.hide(),S.hide(),o.onResize(),"dropbox"===e&&Dropbox.checkConnected(function(e){e||Dropbox.showConnectDialog()})}else s="load",o.refreshList(e),T.isActive||T.setActive(!0),w.isActive&&w.setActive(!1)}),EventBus.on(EVENT.instrumentChange,function(e){o.isVisible()&&"samples"==l&&I.setLabel("Load Sample to slot "+Tracker.getCurrentInstrumentIndex())}),o},UI.editPanel=function(e,t,n,a,r){var i=UI.element(e,t,n,a,r);i.type="EditPanel";var o=UI.scale9Panel(0,0,0,0,UI.Assets.panelInsetScale9);i.addChild(o);function s(e){switch(e.index){case 0:Editor.clearTrack(),UI.setStatus("Track cleared");break;case 1:Editor.clearPattern(),UI.setStatus("Pattern cleared");break;case 2:Editor.copyTrack(),UI.setStatus("Track copied");break;case 3:Editor.copyPattern(),UI.setStatus("Pattern copied");break;case 4:UI.setStatus(Editor.pasteTrack()?"Track pasted":"Nothing to paste!");break;case 5:UI.setStatus(Editor.pastePattern()?"Pattern pasted":"Nothing to paste!")}}for(var l=["clear","copy","paste"],c=[],u=0;u<6;u++){var d;(d=UI.Assets.generate("buttonDark")).index=u,d.onClick=function(){s(this)},d.setProperties({label:"  "+l[Math.floor(u/2)],font:fontSmall,textAlign:"center",paddingTop:3}),i.addChild(d),c.push(d)}var h=["left","top","width","height","name","type"];return i.setProperties=function(t){h.forEach(function(e){void 0!==t[e]&&(i[e]=t[e])}),i.setSize(i.width,i.height),i.setPosition(i.left,i.top),o.setSize(i.width,i.height);for(var e=Math.floor(i.width/2)-2,n=0;n<6;n++){var a=n%2,r=Math.floor(n/2);c[n].setProperties({left:a*e+2,width:e,top:25+21*r,height:21})}},i.render=function(e){if(e=!!e,i.needsRendering){if(!i.isVisible())return;i.clearCanvas(),o.render(),window.fontMed.write(i.ctx,"↓Track",6,11,0),window.fontMed.write(i.ctx,"↓Pattern",c[1].left+6,11,0);for(var t=0;t<6;t++)c[t].render()}if(i.needsRendering=!1,e)return i.canvas;i.parentCtx.drawImage(i.canvas,i.left,i.top,i.width,i.height)},i},UI.Envelope=function(e){var f=UI.element();f.type=e;var g,o,a,s,p=UI.scale9Panel(0,0,f.width,f.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});p.ignoreEvents=!0;var l,c,u,m=-1;return f.onResize=function(){c=f.width/324,u=f.height/64},f.onHover=function(e){if(!o&&(m=-1,s=void 0,g&&g.enabled)){for(var t=Math.round(f.eventX/c),n=Math.round((f.height-f.eventY)/u),a=0,r=g.count;a<r;a++){var i=g.points[a]||[0,0];if(Math.abs(t-i[0])<6&&Math.abs(n-i[1])<6){s={p:g.points[m=a],minY:0,maxY:64},0===a?(s.minX=0,s.maxX=0):(s.minX=g.points[a-1][0],s.maxX=324,a<g.count-1&&(s.maxX=g.points[a+1][0]));break}}l!==m&&(l=m,f.refresh())}},f.onDragStart=function(e){s&&(a={startX:e.startX,startY:e.startY,pX:s.p[0],pY:s.p[1]},o=!0)},f.onDrag=function(e){if(o){a.deltaX=e.deltaX/c,a.deltaY=e.deltaY/u;var t=a.pX+a.deltaX;t=Math.min(s.maxX,t),t=Math.max(s.minX,t);var n=a.pY-a.deltaY;n=Math.min(s.maxY,n),n=Math.max(s.minY,n),s.p[0]=t,s.p[1]=n,f.refresh()}},f.onTouchUp=function(e){o=!1},f.setInstrument=function(e){g=e?e[f.type+"Envelope"]:void 0,f.refresh()},f.render=function(){function e(e){f.ctx.beginPath(),f.ctx.moveTo(e,0),f.ctx.lineTo(e,f.height),f.ctx.stroke()}if(this.needsRendering&&(p.width!==f.width&&p.setSize(f.width,f.height),f.ctx.drawImage(p.render(!0),0,0,f.width,f.height),f.ctx.lineWidth=1,"panning"===f.type&&(f.ctx.strokeStyle="#4a7c92",f.ctx.setLineDash([1,2]),o=Math.floor(f.height/2),f.ctx.beginPath(),f.ctx.moveTo(0,o),f.ctx.lineTo(f.width,o),f.ctx.stroke()),g&&g.count)){var t=f.width/324,n=f.height/64;f.ctx.strokeStyle=g.enabled?"rgba(120, 255, 50, 0.5)":"rgba(120, 120, 180, 0.5)",f.ctx.beginPath(),f.ctx.setLineDash([]);for(var a=0;a<g.count;a++){var r=g.points[a];if(r){var i=r[0]*t,o=f.height-r[1]*n,s=4,l=g.enabled?"#D2861B":"#546888";a===m&&(s=6,l="#FFFFFF"),f.ctx.fillStyle=l,0===a?f.ctx.moveTo(i,o):f.ctx.lineTo(i,o);var c=s/2;f.ctx.fillRect(i-c,o-c,s,s)}}if(f.ctx.stroke(),g.enabled){if(g.sustain){var u=g.points[g.sustainPoint||0];u&&(f.ctx.strokeStyle="#67b6d2",f.ctx.setLineDash([1,2]),e(u[0]*t))}if(g.loop){f.ctx.strokeStyle="#d2b637",f.ctx.setLineDash([1,2]);var d=g.points[g.loopStartPoint||0],h=g.points[g.loopEndPoint||0];d&&e(d[0]*t),h&&e(h[0]*t)}}}this.needsRendering=!1,f.parentCtx.drawImage(f.canvas,f.left,f.top,f.width,f.height)},f},UI.EnvelopePanel=function(t){var a,n=UI.panel();n.type=t;var r=!1,i=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);i.ignoreEvents=!0,n.addChild(i);var o=UI.label({label:t+" Envelope",font:fontSmall});o.onClick=function(){s.toggle()},n.addChild(o);var s=UI.checkbox();s.onToggle=function(e){a&&(a.enabled=e,u.refresh())},n.addChild(s);var l=UI.Assets.generate("button20_20");l.onDown=function(){if(a.enabled){if(a.count<a.points.length){var e=a.points[a.count-1]||[0,0],t=a.points[a.count];e[0]+10<320&&(t[0]<=e[0]&&(t[0]=e[0]+10),a.count++)}else{var n=a.points[a.points.length-1];if(n[0]+10<320)a.points.push([n[0]+10,32]),a.count=a.points.length}u.refresh()}},l.setProperties({label:"+",width:18,height:18}),n.addChild(l);var c=UI.Assets.generate("button20_20");c.onDown=function(){a.enabled&&(2<a.count&&(a.count--,n.checkMax()),u.refresh())},c.setProperties({label:"-",width:18,height:18}),n.addChild(c);var u=UI.Envelope(t);n.addChild(u);var d=UI.panel(0,0,20,20),h=UI.checkbox(),f=UI.checkbox(),g=UI.spinBox(),p=UI.spinBox(),m=UI.spinBox();h.onToggle=function(e){g.setDisabled(!e),a.sustain=e,u.refresh()},f.onToggle=function(e){p.setDisabled(!e),m.setDisabled(!e),a.loop=e,u.refresh()},g.setProperties({label:" ",name:n.type+" envelope sustain",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontFT,trackUndo:!0,undoInstrument:!0,onChange:function(e){a.sustainPoint=e,n.checkMax(),u.refresh()}}),p.setProperties({label:"From",name:n.type+" envelope loop from",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,trackUndo:!0,undoInstrument:!0,onChange:function(e){a.loopStartPoint=e,n.checkMax(),u.refresh()}}),m.setProperties({label:"To",name:n.type+" envelope loop to",value:0,max:100,min:0,padLength:2,disabled:!0,font:window.fontSmall,trackUndo:!0,undoInstrument:!0,onChange:function(e){a.loopEndPoint=e,n.checkMax(),u.refresh()}});var v=UI.scale9Panel(0,0,d.width,d.height,UI.Assets.panelMainScale9);v.ignoreEvents=!0,d.addChild(v),d.addChild(g),d.addChild(p),d.addChild(m);var b=UI.label({label:"Sustain",font:fontSmall,width:60});d.addChild(b);var E=UI.label({label:"Loop",font:fontSmall,width:60});return d.addChild(E),d.addChild(h),d.addChild(f),n.addChild(d),n.setInstrument=function(e){e&&(a=e[t+"Envelope"],u.setInstrument(e),s.setState(a&&a.enabled),h.setState(a&&a.sustain),f.setState(a&&a.loop),g.setValue(a.sustainPoint||0,!0),p.setValue(a.loopStartPoint||0,!0),m.setValue(a.loopEndPoint||0,!0))},n.setDisabled=function(e){n.ignoreEvents=r=e,n.refresh()},n.onResize=function(){d.setSize(120,n.height);var e=d.width;i.setSize(n.width-e-36,18),o.setSize(n.width-e,20),s.setPosition(2,2),o.setPosition(12,2),u.setPosition(0,20),u.setSize(n.width-e+1,n.height-22),v.setSize(d.width,d.height),d.setPosition(n.width-d.width,0),h.setPosition(4,4),b.setPosition(14,4),g.setProperties({left:10,top:20,width:100,height:28}),f.setPosition(5,50),E.setPosition(14,50),p.setProperties({left:10,top:70,width:100,height:28}),m.setProperties({left:10,top:98,width:100,height:28}),l.setPosition(i.width,i.top),c.setPosition(i.width+18,i.top)},n.renderInternal=function(){r&&(n.ctx.fillStyle="rgba(34, 49, 85, 0.4)",n.ctx.fillRect(0,0,n.width,n.height))},n.checkMax=function(){a.count&&(a.count<=a.sustainPoint&&g.setValue(a.count-1),a.count<=a.loopStartPoint&&p.setValue(a.count-1),a.count<=a.loopEndPoint&&m.setValue(a.count-1))},n},UI.fxPanel=function(e){function t(e,t){if(a&&!e.isDisabled)switch(e.getLabel()){case"volume":a.volumeValue(t);break;case"panning":a.panningValue((t-50)/50);break;case"high":a.highValue(t/100);break;case"mid":a.midValue(t/100);break;case"low":a.lowValue(t/100);break;case"lowPass":a.lowPassFrequencyValue(t/100);break;case"reverb":a.reverbValue(t);break;case"distortion":a.distortionValue(t);break;case"delay":a.delayValue(t);break;case"compression":a.compressionValue(t)}}function n(e,t){if(a){var n=e.getLabel();a.setState(n,t)}}var s=UI.panel();s.hide(),e=e||0;var l=UI.scale9Panel(0,0,20,20,UI.Assets.buttonDarkScale9);l.ignoreEvents=!0,s.addChild(l);for(var a,r=["volume","panning","high","mid","low","lowPass","distortion","compression","delay","reverb"],i=0,o=10,c=[],u=0,d=r.length;u<d;u++){var h=UI.knob();h.setProperties({top:i,left:o,label:r[u],disabled:1<u}),h.onChange=function(e){t(this,e)},h.onToggle=function(e){n(this,e),t(this,this.getValue())},s.addChild(h),c.push(h),u%2==0?o+=70:(o=10,i+=70)}return Audio.filterChains&&(a=Audio.filterChains[e]),s.setLayout=function(){if(UI.mainPanel){l.setSize(s.width,s.height);var a=Math.max(1,Math.floor(s.width/70)),r=Math.floor((s.width-70*a)/2),i=Math.floor((s.width-2*r)/a),o=0;c.forEach(function(e,t){var n=t%a;e.setPosition(n*i+r,o),n==a-1&&(o+=70)})}},s},UI.InfoPanel=function(){var a,r=UI.element(),i="",o="",s=UI.Assets.generate("buttonDark");s.setLabel("More info "),s.onClick=function(){a&&window.open(a)},r.addChild(s);var l=UI.animsprite(5,7,20,18,"boing",11);r.addChild(l),l.hide(),EventBus.on(EVENT.statusChange,function(e){e&&(void 0!==e.status&&(o=e.status),void 0!==e.info&&(i=e.info,a=e.url),void 0!==e.showSpinner&&l.toggle(!!e.showSpinner)),r.refresh()});var e=["left","top","width","height","name","type","zIndex"];return r.setProperties=function(t){e.forEach(function(e){void 0!==t[e]&&(r[e]=t[e])}),r.setSize(r.width,r.height),r.setPosition(r.left,r.top),r.setLayout&&r.setLayout(r.left,r.top,r.width,r.height)},r.setLayout=function(){var e=Layout.col1W,t="More Info";e<100&&(t="info"),e<45&&(t="i"),s.setProperties({width:Layout.col1W,height:24,top:2,left:Layout.col5X-2-r.left,label:t,font:fontFT})},r.render=function(e){if(r.isVisible()){if(e=!!e,this.needsRendering){r.clearCanvas(),a&&s.render();var t=i;o&&(t=o+": "+t);var n=6;l.isVisible()&&(l.render(),n+=20),window.fontFT.write(r.ctx,t,n,11,0)}if(this.needsRendering=!1,e)return r.canvas;r.parentCtx.drawImage(r.canvas,r.left,r.top,r.width,r.height)}},r};var Input=function(){function m(){if(v.length){var e=v.shift();if(e.source)try{e.source.stop()}catch(e){}}}var u,l,d={},c={};c.touches=[];var h,i=0,o=!(c.mouseWheels=[]),v=[],b={},f=!1,g=2,t=3,n=1,E=13;d.init=function(){function e(s){function e(e,t,n){c.isTouchDown=!0;var a=canvas.getBoundingClientRect();t-=a.left+window.pageXOffset,n-=a.top+window.pageYOffset,(l=UI.getModalElement())?(l.eventX=t,l.eventY=n):l=UI.getEventElement(t,n),l&&u&&u.deActivate&&u.name!==l.name&&u.deActivate(l);var r=l?l.eventX:t,i=l?l.eventY:n,o={id:e,x:r,y:i,startX:r,startY:i,globalX:t,globalY:n,globalStartX:t,globalStartY:n,UIobject:l,isMeta:s.shiftKey||s.metaKey||s.ctrlKey||s.altKey};c.touches.push(o),o.UIobject&&(o.UIobject.onDragStart&&o.UIobject.onDragStart(o),o.UIobject.onDown&&o.UIobject.onDown(o))}if(s.preventDefault(),window.focus(),o||void 0!==Audio&&Audio.playSilence&&Audio.context&&"suspended"!==Audio.context.state&&(Audio.playSilence(),o=!0),s.touches&&0<s.touches.length)for(var t=s.changedTouches,n=0;n<t.length;n++){var a=t[n];e(a.identifier,a.pageX,a.pageY)}else{var r=p("notouch");0<=r&&c.touches.splice(r,1),e("notouch",s.pageX,s.pageY)}}function t(e){function t(e,t,n){if(0<=e){var a=c.touches[e];a.globalX=t-window.pageXOffset,a.globalY=n-window.pageYOffset,a.deltaX=a.globalX-a.globalStartX,a.deltaY=a.globalY-a.globalStartY,a.x=a.startX+a.deltaX,a.y=a.startY+a.deltaY,c.touches.splice(e,1,a),c.isTouchDown&&a.UIobject&&a.UIobject.onDrag&&(a.dragX=t,a.dragY=n,a.UIobject.onDrag(a))}}e.preventDefault();var n=canvas.getBoundingClientRect();if(e.touches&&0<e.touches.length)for(var a=e.changedTouches,r=0;r<a.length;r++){var i=a[r];t(p(i.identifier),i.pageX-n.left,i.pageY-n.top)}else{var o=e.pageX-n.left,s=e.pageY-n.top;if(t(p("notouch"),o,s),c.currentMouseX=o,c.currentMouseY=s,c.mouseMoved=(new Date).getTime(),SETTINGS.useHover){var l=UI.getEventElement(o,s);l&&l.onHover&&l.onHover(c),h&&h!=l&&h.onHoverExit&&h.onHoverExit(c,l),h=l}}}function n(e){function t(e){if(0<=e){var t=c.touches[e],n=t.startX-t.x,a=t.startY-t.y,r=Math.sqrt(n*n+a*a),i=!0;if(t.UIobject){var o=t.UIobject;o.keepSelection&&(i=!1),r<8&&o.onClick&&o.onClick(t),o.onTouchUp&&o.onTouchUp(t)}i&&r<8&&UI.clearSelection(),c.touches.splice(e,1)}}if(o||Audio&&Audio.checkState&&Audio.checkState(),c.isTouchDown=!1,e&&e.touches)for(var n=e.changedTouches,a=0;a<n.length;a++){t(p(n[a].identifier))}else t(p("notouch"))}function a(e){if(e.preventDefault(),c.currentMouseX){var t=UI.getEventElement(c.currentMouseX,c.currentMouseY);if(t&&t.onMouseWheel){c.mouseWheels.unshift(e.wheelDeltaY||e.wheelDelta||-e.detail),10<c.mouseWheels.length&&c.mouseWheels.pop(),t.onMouseWheel(c)}}}function r(){App.isPlugin||(clearTimeout(i),i=setTimeout(function(){UI.setSize(window.innerWidth,window.innerHeight)},100))}canvas.addEventListener("mousedown",e,!1),canvas.addEventListener("mousemove",t,!1),canvas.addEventListener("mouseup",n,!1),canvas.addEventListener("mouseout",function(e){c.isTouchDown&&n(e)},!1),canvas.addEventListener("touchstart",e,!1),canvas.addEventListener("touchmove",t,!1),canvas.addEventListener("touchend",n,!1),window.navigator.msPointerEnabled&&(canvas.addEventListener("MSPointerDown",e,!1),canvas.addEventListener("MSPointerMove",t,!1),canvas.addEventListener("MSPointerEnd",n,!1)),canvas.addEventListener("mousewheel",a,!1),canvas.addEventListener("DOMMouseScroll",a,!1),window.addEventListener("keydown",function(e){e.preventDefault();var t=KEYBOARDTABLE[SETTINGS.keyboardTable]||KEYBOARDTABLE.azerty,n=e.keyCode,a=e.key,r={shift:e.shiftKey,control:e.ctrlKey,alt:e.altKey,command:e.metaKey};if(f=r.command||r.control||r.alt||r.shift,!a&&e.keyIdentifier){var i=e.keyIdentifier;i=i.replace("U+",""),a=String.fromCharCode(parseInt(i,16)).toLowerCase()}if(u&&u.onKeyDown&&u.onKeyDown(n,e))return;switch(n){case 8:return Tracker.isRecording()?void(f?(Editor.removeNote(),Tracker.moveCurrentPatternPos(-1)):(0===(s=Editor.getCurrentTrackPosition())?Editor.putNote(0,0):!Tracker.inFTMode()||3!==s&&4!==s?Editor.putNoteParam(s,0):Editor.putNoteParam(s,-1),Tracker.moveCurrentPatternPos(1))):(Tracker.playPatternStep(Editor.getCurrentTrackPosition()),void Tracker.moveCurrentPatternPos(-1));case 9:return e.stopPropagation(),e.preventDefault(),void Editor.moveCursorPosition(f?-Editor.getStepsPerTrack():Editor.getStepsPerTrack());case 13:return void(Tracker.isRecording()&&f?(Editor.insertNote(),Tracker.moveCurrentPatternPos(1)):Tracker.togglePlay());case 16:break;case 27:UI.clearSelection();break;case 32:return void Tracker.toggleRecord();case 33:var o=Math.floor(Tracker.getPatternLength()/4);0===o&&(o=1);var s=Math.floor(Tracker.getCurrentPatternPos()/o)*o;return Tracker.getCurrentPatternPos()===s&&(s-=o),s<0&&(s=0),void Tracker.setCurrentPatternPos(s);case 34:return 0===(o=Math.floor(Tracker.getPatternLength()/4))&&(o=1),s=Math.ceil(Tracker.getCurrentPatternPos()/o)*o,Tracker.getCurrentPatternPos()===s&&(s+=o),s>=Tracker.getPatternLength()-1&&(s=Tracker.getPatternLength()-1),void Tracker.setCurrentPatternPos(s);case 35:return void Tracker.setCurrentPatternPos(Tracker.getPatternLength()-1);case 36:return void Tracker.setCurrentPatternPos(0);case 37:return void Editor.moveCursorPosition(-1);case 38:return void Tracker.moveCurrentPatternPos(-1);case 39:return void Editor.moveCursorPosition(1);case 40:return void Tracker.moveCurrentPatternPos(1);case 46:return void(Tracker.isRecording()&&(0===(s=Editor.getCurrentTrackPosition())?Editor.putNote(0,0):Editor.putNoteParam(s,0),Tracker.moveCurrentPatternPos(1)));case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:if(Tracker.isRecording())break;return(l=n-96)<1&&(l+=10),void Tracker.setCurrentInstrumentIndex(l);case 107:return void Tracker.setCurrentInstrumentIndex(Tracker.getCurrentInstrumentIndex()+1);case 109:return void(1<(l=Tracker.getCurrentInstrumentIndex())&&Tracker.setCurrentInstrumentIndex(l-1));case 112:case 113:case 114:case 115:case 116:case 117:case 118:return void d.setCurrentOctave(n-111);case 119:case 120:case 121:case 122:case 123:return;case 187:return void Tracker.setCurrentInstrumentIndex(Tracker.getCurrentInstrumentIndex()+1);case 189:return void(1<(l=Tracker.getCurrentInstrumentIndex())&&Tracker.setCurrentInstrumentIndex(l-1));case 221:return}if(a&&40<n&&n<230){if(f&&65<=n&&n<=90){switch(e.stopPropagation(),e.preventDefault(),n){case 65:return void EventBus.trigger(EVENT.commandSelectAll);case 67:return void UI.copySelection(!0);case 86:return void UI.pasteSelection(!0);case 88:return void UI.cutSelection(!0);case 89:return void EventBus.trigger(EVENT.commandRedo);case 90:return void EventBus.trigger(EVENT.commandUndo)}return}var l=-1,c=t[a];"number"==typeof c&&(l=12*g+c,0===c&&(l=0)),d.handleNoteOn(l,a)}},!1),window.addEventListener("keyup",function(e){var t=e.key;if(!t&&e.keyIdentifier){var n=e.keyIdentifier;n=n.replace("U+",""),t=String.fromCharCode(parseInt(n,16)).toLowerCase()}var a,r=e.keyCode;if(16!==(a=r)&&17!==a&&18!==a&&91!==a&&93!==a||(f=!1),t&&40<r&&r<200){var i=(KEYBOARDTABLE[SETTINGS.keyboardTable]||KEYBOARDTABLE.azerty)[t];if("number"==typeof i)return d.handleNoteOff(12*g+i)}},!1),canvas.addEventListener("dragenter",function(e){e.stopPropagation(),e.preventDefault()},!1),canvas.addEventListener("dragover",function(e){e.stopPropagation(),e.preventDefault()},!1),canvas.addEventListener("drop",function(e){e.stopPropagation(),e.preventDefault(),Tracker.handleUpload(e.dataTransfer.files)},!1),window.addEventListener("paste",function(e){UI.pasteSelection(!0)},!1),window.addEventListener("copy",function(e){UI.copySelection(!0)},!1),window.addEventListener("cut",function(e){UI.cutSelection(!0)},!1),window.addEventListener("undo",function(e){},!1),window.addEventListener("delete",function(e){},!1),App.isPlugin||window.addEventListener("resize",r,!1),r()};var p=function(e){for(var t=0;t<c.touches.length;t++)if(c.touches[t].id===e)return t;return-1};return d.setFocusElement=function(e){var t=e.name||e.type;if(u){if((u.name||u.type)===t)return;u.deActivate&&u.deActivate()}u=e},d.clearFocusElement=function(e){if(e){e.deActivate&&e.deActivate(),u&&u.name===e.name&&(u=void 0)}else u&&u.deActivate&&u.deActivate(),u=void 0},d.getFocusElement=function(){return u},d.clearInputNotes=function(){for(;v.length;)m()},d.getCurrentOctave=function(){return g},d.setCurrentOctave=function(e){e<=t&&n<=e&&EventBus.trigger(EVENT.octaveChanged,g=e)},d.handleNoteOn=function(e,t,n,a){var r,i,o,s=!0;if(0<=e&&(E=e,UI.clearSelection(),i=Math.floor((e-1)/12)+1,o=OCTAVENOTES[(e-1)%12+1]))if(Tracker.inFTMode())if("OFF"===o.name)s=!(r={period:1,index:0});else{var l=FTNotes[e];l&&(r={period:l.period,index:e})}else r=NOTEPERIOD[o.name+(i-1)];if(Tracker.isRecording())if(0<Editor.getCurrentTrackPosition()){s=!1;var c=/[0-9A-Fa-f]/g,u=-1;if(c.test(t=t||"")?u=parseInt(t,16):Tracker.inFTMode()&&5===Editor.getCurrentTrackPosition()&&(c=/[0-9A-Za-z]/g).test(t)&&(u=parseInt(t,36)),Tracker.inFTMode()&&3===Editor.getCurrentTrackPosition())switch(u=-1,t){case"0":u=0;break;case"1":u=1;break;case"2":u=2;break;case"3":u=3;break;case"4":u=4;break;case"-":u=5;break;case"+":u=6;break;case"d":case"D":u=7;break;case"u":case"U":u=8;break;case"s":case"S":u=9;break;case"v":case"V":u=10;break;case"p":case"P":u=11;break;case"<":u=12;break;case">":u=13;break;case"M":u=14}255<u&&(u=-1),0<=u&&(Editor.putNoteParam(Editor.getCurrentTrackPosition(),u),Tracker.moveCurrentPatternPos(1))}else{if(b[e])return;r&&(Editor.putNote(Tracker.getCurrentInstrumentIndex(),r.period,r.index,a),Tracker.isPlaying()||Tracker.moveCurrentPatternPos(1))}if(s&&r){if(b[e])return;var d=Tracker.getCurrentInstrument();if(d){if(r.index&&(d.setSampleForNoteIndex(r.index),d.sample.relativeNote)){r.index+=d.sample.relativeNote;var h=FTNotes[r.index];h&&(r.period=h.period)}Audio.checkState();var f=void 0;n&&(f={offset:{value:n}}),"number"==typeof a&&(a=100*a/64),b[e]=d.play(r.index,r.period,a,void 0,f),b[e].instrument=d,b[e].isKey=!0,v.push(b[e]);var g=b[e];if(g.scheduled&&g.scheduled.vibrato){var p=d.scheduleAutoVibrato(g,2);g.scheduled.vibrato+=p}64<v.length&&m(),EventBus.trigger(EVENT.pianoNoteOn,e)}}},d.handleNoteOff=function(e,t){if(!SETTINGS.sustainKeyboardNotes&&b[e]&&b[e].source&&Audio.context){EventBus.trigger(EVENT.pianoNoteOff,e);try{b[e].instrument?b[e].instrument.noteOff(Audio.context.currentTime,b[e]):b[e].source.stop()}catch(e){}}b[e]=!1,t&&Tracker.inFTMode()&&Tracker.isRecording()&&Tracker.isPlaying()&&(Editor.putNoteParam(5,20),Editor.putNoteParam(7,1))},d.isMetaKeyDown=function(){return f},d.getPrevIndex=function(){return E},EventBus.on(EVENT.second,function(){if(Audio.context){var n=Audio.context.currentTime;v.forEach(function(e){if(e&&e.time&&e.scheduled){if(e.scheduled.volume&&e.scheduled.volume<=n+2&&e.instrument){var t=e.instrument.scheduleEnvelopeLoop(e.volumeEnvelope,e.scheduled.volume,2);e.scheduled.volume+=t}e.scheduled.panning&&e.scheduled.panning<=n+2&&e.instrument&&(t=e.instrument.scheduleEnvelopeLoop(e.panningEnvelope,e.scheduled.panning,2),e.scheduled.panning+=t),e.scheduled.vibrato&&e.scheduled.vibrato<=n+2&&e.instrument&&(t=e.instrument.scheduleAutoVibrato(e,2),e.scheduled.vibrato+=t)}})}}),EventBus.on(EVENT.trackerModeChanged,function(e){Tracker.inFTMode()?(t=7,n=0,d.setCurrentOctave(g+2)):(t=3,n=1,d.setCurrentOctave(Math.min(Math.max(g-2,n),t)))}),d}();UI.MainPanel=function(){var a=UI.panel(0,0,canvas.width,canvas.height,!0);a.setProperties({backgroundColor:"#071028"}),a.name="mainPanel";var n={},r=UI.app_menu(a);a.addChild(r);var i=UI.app_mainPanel();a.addChild(i);var o=UI.app_controlPanel();a.addChild(o);var s=UI.app_patternPanel();a.addChild(s);var l=UI.app_sidebar();Layout.showAppSideBar&&(a.addChild(l),l.init());var c=UI.app_pianoView();return c.hide(),a.addChild(c),a.createContextMenu=function(e){var t=n[e.name];return t||((t=UI.menu(100,100,128,42,a)).zIndex=100,t.setProperties({background:UI.Assets.panelMainScale9,layout:"buttons"}),t.setItems(e.items),t.hide(),a.addChild(t),n[e.name]=t),t},a.onResize=function(){Layout.setLayout(a.width,a.height),r.setSize(Layout.mainWidth,r.height);var e=r.height;i.setSize(Layout.mainWidth,i.height),i.setPosition(Layout.mainLeft,e),e+=i.height,o.setSize(Layout.mainWidth,Layout.controlPanelHeight),o.setPosition(Layout.mainLeft,e);var t=a.height-(e+=o.height);c.isVisible()&&(c.setSize(Layout.mainWidth,Layout.pianoHeight),c.setPosition(Layout.mainLeft,a.height-c.height),t-=c.height),s.setPosition(Layout.mainLeft,e),s.setSize(Layout.mainWidth,t),l.setPosition(0,0),l.setSize(Layout.sidebarWidth,a.height)},a.sortZIndex(),a.onResize(),EventBus.on(EVENT.toggleView,function(e){if("piano"===e){c.toggle();var t=a.height-s.top;c.isVisible()&&(c.setSize(Layout.mainWidth,Layout.pianoHeight),c.setPosition(Layout.mainLeft,a.height-c.height),t-=c.height),s.setSize(Layout.mainWidth,t)}"sidebar"===e&&(Layout.showAppSideBar=!Layout.showAppSideBar,Layout.setLayout(),a.onResize())}),EventBus.on(EVENT.showContextMenu,function(e){var t=a.createContextMenu(e),n=e.x;Layout.mainWidth<n+t.width&&(n=Layout.mainWidth-t.width),t.setPosition(n,e.y-t.height-2),t.show(),a.refresh()}),EventBus.on(EVENT.hideContextMenu,function(){for(var e in n)n[e].hide();a.refresh()}),a},UI.OptionsPanel=function(){var p=UI.panel();p.hide();var t=UI.scale9Panel(0,0,20,20,UI.Assets.panelMainScale9);t.ignoreEvents=!0,p.addChild(t);var e=UI.label({label:"Options:",font:fontMed,left:5,height:18,top:9,width:200});p.addChild(e);var n=UI.Assets.generate("button20_20");n.setLabel("x"),n.onClick=function(){App.doCommand(COMMAND.showTopMain)},p.addChild(n);var a=[{label:"VU bars",values:["NONE","COLOURS: AMIGA","TRANSPARENT"],valueLabels:{"COLOURS: AMIGA":[{width:56,label:"AMIGA"},{width:110,label:"COLOURS: AMIGA"}]},setValue:function(e){SETTINGS.vubars=0===e?"none":2===e?"trans":"colour",Settings.saveSettings()},getValue:function(){var e=1;return"none"===SETTINGS.vubars&&(e=0),"trans"===SETTINGS.vubars&&(e=2),e}},{label:"Stereo",values:["Hard: Amiga","Balanced","None: mono"],setValue:function(e){Audio.setStereoSeparation(0===e?STEREOSEPARATION.FULL:2===e?STEREOSEPARATION.NONE:STEREOSEPARATION.BALANCED),Settings.saveSettings()},getValue:function(){var e=1;return SETTINGS.stereoSeparation===STEREOSEPARATION.NONE&&(e=2),SETTINGS.stereoSeparation===STEREOSEPARATION.FULL&&(e=0),e}},{label:"Keyboard Layout",labels:[{width:56,label:"Keyboard"},{width:110,label:"Keyboard Layout"}],values:["QWERTY","AZERTY","QWERTZ","Dvorak"],setValue:function(e){SETTINGS.keyboardTable=0===e?"qwerty":1===e?"azerty":2===e?"qwertz":"dvorak",Settings.saveSettings()},getValue:function(){var e=0;return"azerty"===SETTINGS.keyboardTable&&(e=1),"qwertz"===SETTINGS.keyboardTable&&(e=2),"dvorak"===SETTINGS.keyboardTable&&(e=3),e},checkBoxes:[{label:"Show Key Input",labels:[{width:60,label:"Show"},{width:100,label:"Show Key"},{width:150,label:"Show Key Input"}],getValue:function(){return SETTINGS.showKey},handler:function(e){SETTINGS.showKey=e,Settings.saveSettings(),EventBus.trigger(EVENT.menuLayoutChanged)}}]},{label:"Screen refresh",labels:[{width:56,label:"Screen"},{width:100,label:"Screen refresh"}],values:["Smooth","Normal","Economical","Low CPU"],setValue:function(e){UI.skipFrame(e),Settings.saveSettings()},getValue:function(){return UI.getSkipFrame()},checkBoxes:[{label:"Optimize High DPI",labels:[{width:60,label:"H-DPI"},{width:100,label:"High DPI"},{width:155,label:"Optimize High DPI"}],getValue:function(){return SETTINGS.highDPI},handler:function(e){SETTINGS.highDPI=e,Settings.saveSettings(),UI.scaleToDevicePixelRatio(e)}}]},{label:"Frequency table",labels:[{width:56,label:"Frequency"},{width:110,label:"Frequency table"}],values:["Linear","Amiga periods"],valueLabels:{"Amiga periods":[{width:56,label:"AMIGA"},{width:110,label:"Amiga periods"}]},setValue:function(e){Tracker.useLinearFrequency=0===e},getValue:function(){return Tracker.useLinearFrequency?0:1}},{label:"Dropbox: existing file",labels:[{width:20,label:"Dropbox"},{width:80,label:"Dropbox save"},{width:160,label:"Dropbox existing file"}],values:["Rename","Overwrite"],setValue:function(e){SETTINGS.dropboxMode=0===e?"rename":"overwrite",Settings.saveSettings()},getValue:function(){var e=0;return"overwrite"===SETTINGS.dropboxMode&&(e=1),e}},{label:"Midi-in",labels:[{width:20,label:"Midi"},{width:80,label:"Midi-in"}],values:["Disabled","Enabled Note","Enabled Note-Volume"],valueLabels:{"Enabled Note":[{width:80,label:"Note"},{width:150,label:"Enabled Note"}],"Enabled Note-Volume":[{width:80,label:"Note-Volume"},{width:150,label:"Enabled Note-Volume"}]},setValue:function(e){0===e?(SETTINGS.midi="disabled",Midi.disable()):(SETTINGS.midi=1===e?"enabled-note":"enabled",Midi.enable()),Settings.saveSettings()},getValue:function(){var e=0;return"enabled-note"===SETTINGS.midi&&(e=1),"enabled"===SETTINGS.midi&&(e=2),e},checkBoxes:[{label:"Show Midi Input",labels:[{width:60,label:"Show"},{width:100,label:"Show Midi"},{width:150,label:"Show Midi Input"}],getValue:function(){return SETTINGS.showMidi},handler:function(e){SETTINGS.showMidi=e,Settings.saveSettings(),EventBus.trigger(EVENT.menuLayoutChanged)}}]}];return a.forEach(function(e){var t=UI.scale9Panel(0,0,20,20,UI.Assets.panelDarkGreyScale9);t.ignoreEvents=!0,p.addChild(t);var n=UI.label();n.setProperties({label:e.label,labels:e.labels,font:fontSmall,textAlign:"center"}),p.addChild(n),e.labelBox=t,e.label=n;for(var a=[],r=(e.getValue(),0);r<e.values.length;r++){var i,o=e.values[r];if(o)(i=UI.Assets.generate("buttonKey")).setProperties(e.valueLabels&&e.valueLabels[o]?{label:o,labels:e.valueLabels[o]}:{label:o}),i.index=r,i.option=e,i.onClick=function(){this.isDisabled||activateOption(this)};p.addChild(i),a.push(i)}if(e.buttons=a,e.checkBoxes){var s=e.checkBoxes[0],l=UI.checkboxbutton({background:UI.Assets.panelDarkInsetScale9,hoverBackground:UI.Assets.panelInsetScale9,activeBackground:UI.Assets.panelDarkInsetScale9,label:s.label,labels:s.labels,checkbox:!0});l.getValue=s.getValue,p.addChild(l),l.onClick=function(){s.handler(l.isActive)},e.checkBox=l}}),activateOption=function(e){var t=e.option;t.buttons.forEach(function(e){e.setActive(!1)}),e.setActive(!0),t.setValue(e.index)},p.onShow=function(){p.onResize()},p.onResize=function(){if(p.isVisible()){p.clearCanvas(),t.setProperties({left:0,top:0,height:p.height,width:p.width});n.setProperties({top:5,left:p.width-30});var s=[27,103],l=20,c=20,u=0,d=0,h=!1,f=a.length,e=a.length;p.width<600&&(h=!0,s=[27,103],c=l=18,e=4);var g=Math.floor((p.width-Layout.defaultMargin*(e+1))/e);a.forEach(function(e,t){var n=Layout.defaultMargin+u*(g+Layout.defaultMargin),a=s[d];f<=t&&(n=p.width+100),e.labelBox.setProperties({top:a,width:g,height:l,left:n}),e.label.setProperties({top:a+3,_width:Layout.col31W,width:g,height:l,left:n+2});for(var r=e.getValue(),i=0;i<e.buttons.length;i++){var o=e.buttons[i];o.setProperties({top:a+i*c+l,height:c,width:g,left:n}),o.setActive(i===r)}e.checkBox&&(e.checkBox.setProperties({top:p.height-c-7,height:c+4,width:g,left:n}),e.checkBox.setActive(e.checkBox.getValue())),u++,h&&4<=u&&(u=0,d++)})}},EventBus.on(EVENT.songPropertyChange,function(){p.isVisible()&&p.onResize()}),EventBus.on(EVENT.trackerModeChanged,function(){var e=a[4];e.buttons&&e.buttons.length&&e.buttons.forEach(function(e){e.setDisabled(!Tracker.inFTMode())});var t=a[1];t.buttons&&t.buttons.length&&t.buttons.forEach(function(e){e.setDisabled(Tracker.inFTMode())}),p.isVisible()&&p.onResize()}),p},UI.SampleView=function(){function e(e){var t=Tracker.getCurrentInstrument();if(t)if(16===e)g.setActive(!(t.sample.bits=16)),p.setActive(!0);else{for(var n=0,a=t.sample.data.length;n<a;n++)t.sample.data[n]=Math.round(127*t.sample.data[n])/127;t.sample.bits=8,g.setActive(!0),p.setActive(!1)}}function n(e){"loop"===e?(x.show(),C.show(),S.show(),P.hide(),A.hide(),U.hide(),B.setActive(),V.setActive(!1),M.forEach(function(e){e.hide()})):(x.hide(),C.hide(),S.hide(),P.show(),A.show(),U.show(),B.setActive(!1),V.setActive(),M.forEach(function(e){e.show()})),d.onResize()}function a(n){M.forEach(function(e,t){e.setActive(n===t)});var e=Tracker.getCurrentInstrument();e&&(e.vibrato.type=n)}var r,d=UI.panel();d.name="SampleView",d.hide();var t=window;t=window.fontCondensed;var h=UI.inputbox({name:"instrumentName",height:20,trackUndo:!0,undoInstrument:!0,onChange:function(e){if(r){var t=Tracker.getInstrument(r);t&&(t.name=e),EventBus.trigger(EVENT.instrumentNameChange,r)}}});d.addChild(h);var f=UI.Assets.generate("button20_20");f.setLabel("x"),f.onClick=function(){App.doCommand(COMMAND.showBottomMain)},d.addChild(f);var i={background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,isActive:!1,textAlign:"center",font:window.fontDark,paddingTopActive:1},g=UI.button(),p=UI.button();g.setProperties(i),g.setLabel("8"),g.setActive(!0),g.onDown=function(){e(8)},d.addChild(g),p.setProperties(i),p.setLabel("16"),p.onDown=function(){e(16)},d.addChild(p);var m=UI.WaveForm();d.addChild(m),m.onMouseWheel=function(e){m.zoom(0<e.mouseWheels[0]?1.01:.99)};var v=UI.EnvelopePanel("volume");d.addChild(v);var b=UI.EnvelopePanel("panning");d.addChild(b);var E=new UI.panel;E.setProperties({name:"instrumentSideButtonPanel"});var w=UI.spinBox({name:"Instrument",label:"",value:1,max:64,padLength:2,min:1,font:t,onChange:function(e){Tracker.setCurrentInstrumentIndex(e)}});d.addChild(w);var T=UI.sliderBox({name:"Volume",label:"Volume",font:t,height:200,width:40,value:64,max:64,min:0,step:1,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.sample.volume=e)}});E.addChild(T);var I=UI.sliderBox({name:"Finetune",label:"Finetune",font:t,value:0,max:7,min:-8,step:1,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&t.setFineTune(e)}});E.addChild(I);var k=UI.sliderBox({name:"Panning",label:"Panning",font:t,value:0,max:127,min:-127,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.panning=e,t.sample.panning=e)}});E.addChild(k);var S=UI.spinBox({name:"Repeat",label:"Start",value:0,max:65535,min:0,step:2,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.sample.length<t.sample.loop.length+e&&S.setValue(e=t.sample.length-t.sample.loop.length,!0),t.sample.loop.start=e),m.refresh()}});E.addChild(S);var C=UI.spinBox({name:"Repeat Length",label:"Length",value:0,max:65535,min:0,step:2,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.sample.length<t.sample.loop.start+e&&C.setValue(e=t.sample.length-t.sample.loop.start,!0),t.sample.loop.length=e),EventBus.trigger(EVENT.samplePropertyChange,{interal_loopLength:e}),m.refresh()}});E.addChild(C);var y=UI.sliderBox({name:"Fadeout",label:"Fadeout",value:0,max:4095,min:0,step:1,font:t,vertical:!0,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.fadeout=e)}});E.addChild(y);var x=UI.spinBox({name:"relativeNote",label:"RelativeNote",value:0,max:128,min:-127,step:1,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.sample.relativeNote=e)}});E.addChild(x);var P=UI.spinBox({name:"vibratoSpeed",label:"Vib Speed",value:0,max:63,min:0,step:1,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.vibrato.rate=e)}});E.addChild(P),P.hide();var A=UI.spinBox({name:"vibratoDepth",label:"Vib Depth",value:0,max:15,min:0,step:1,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.vibrato.depth=e)}});E.addChild(A),A.hide();var U=UI.spinBox({name:"vibratoSweep",label:"Vib Sweep",value:0,max:255,min:0,step:1,font:t,trackUndo:!0,undoInstrument:!0,onChange:function(e){var t=Tracker.getCurrentInstrument();t&&(t.vibrato.sweep=e)}});E.addChild(U),U.hide();var M=[];["sin","square","saw","saw_inverse"].forEach(function(e,t){var n=UI.button();n.setProperties({background:UI.Assets.buttonKeyScale9,activeBackground:UI.Assets.buttonKeyActiveScale9,image:Y.getImage("wave_"+e),activeImage:Y.getImage("wave_"+e),isActive:!1}),n.onDown=function(){a(t)},n.hide(),E.addChild(n),M.push(n)}),a(0),d.addChild(E);var _=[],o=[{label:"Zoom In",width:62,onClick:function(){m.zoom(2)}},{label:"Out",width:38,onClick:function(){m.zoom(.5)}},{label:"All",width:50,onClick:function(){m.zoom(1)}},{value:0,width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.sampleLength&&e.setValue(t.sampleLength)}},{label:"Loop",width:50,onClick:function(){m.zoom("loop")}},{value:0,width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.loopLength&&e.setValue(t.loopLength),void 0!==t.interal_loopLength&&e.setValue(t.interal_loopLength)}},{label:"Range",width:50,onClick:function(){m.zoom("range")}},{value:"0",width:50,type:"number",onSamplePropertyChange:function(e,t){void 0!==t.rangeLength&&e.setValue(t.rangeLength)}}],s=[{label:"Reverse",onClick:function(){m.reverse()}},{label:"Invert",onClick:function(){m.invert()}},{label:"Upsample",onClick:function(){m.resample("up")}},{label:"DownSample",onClick:function(){m.resample("down")}}],l=[{label:"Maximize",onClick:function(){m.adjustVolume("max")}},{label:"Fade In",width:62,onClick:function(){m.adjustVolume("fadein")}},{label:"Out",width:38,onClick:function(){m.adjustVolume("fadeout")}},{label:"-5%",width:50,onClick:function(){m.adjustVolume(-5)}},{label:"+5%",width:50,onClick:function(){m.adjustVolume(5)}},{label:"-10%",width:50,onClick:function(){m.adjustVolume(-10)}},{label:"+10%",width:50,onClick:function(){m.adjustVolume(10)}}],c=[{label:"[",width:15,onClick:function(){m.select("start")}},{label:"All",width:70,onClick:function(){m.select("all")}},{label:"]",width:15,onClick:function(){m.select("end")}},{label:"None",width:50,onClick:function(){m.select("none")}},{label:"Loop",width:50,onClick:function(){m.select("loop")}},{label:"Cut",width:50,onClick:function(){UI.cutSelection()}},{label:"Copy",width:50,onClick:function(){UI.copySelection()}},{label:"Paste",onClick:function(){UI.pasteSelection()}}];[{label:"Load",onClick:function(){EventBus.trigger(EVENT.showView,"diskop_samples_load")}},{label:"Play",onDown:function(){Input.handleNoteOn(Input.getPrevIndex())},onUp:function(){Input.handleNoteOff(Input.getPrevIndex()),Input.clearInputNotes(),m.stop()}},{label:"Range",onDown:function(){m.playSection("range")},onUp:function(){Input.handleNoteOff(Input.getPrevIndex()),Input.clearInputNotes(),m.stop()}},{label:"Loop",onDown:function(){m.playSection("loop")},onUp:function(){Input.handleNoteOff(Input.getPrevIndex()),Input.clearInputNotes(),m.stop()}},{label:"Stop",onClick:function(){Input.clearInputNotes(),m.stop()}},{label:"More",onClick:function(){L.toggle(),D.toggle(),O.toggle(),N.toggle(),v.toggle(),b.toggle(),d.refresh()}}].forEach(function(e){var t=UI.Assets.generate("buttonLight");t.setLabel(e.label),t.onClick=e.onClick,t.onDown=e.onDown,t.onTouchUp=e.onUp,d.addChild(t),_.push(t)});var L=UI.buttonGroup("Display",o),D=UI.buttonGroup("Select",c),O=UI.buttonGroup("Edit",s),N=UI.buttonGroup("Volume",l);d.addChild(L),d.addChild(D),d.addChild(O),d.addChild(N);var B=UI.button();B.setProperties({background:UI.Assets.panelDarkGreyScale9,activeBackground:UI.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Loop",font:fontSmall,paddingTop:2,paddingTopActive:2,paddingLeft:20}),B.onDown=function(){n("loop")},d.addChild(B);var R=UI.checkbox();R.onToggle=function(e){var t=Tracker.getInstrument(r);t&&(t.sample.loop.enabled=e),S.setDisabled(!e),C.setDisabled(!e),m.refresh()},d.addChild(R);var V=UI.button();return V.setProperties({background:UI.Assets.panelDarkGreyScale9,activeBackground:UI.Assets.panelDarkGreyBlueScale9,isActive:!1,label:"Vibrato",font:fontSmall,paddingTop:2,paddingTopActive:2}),V.onDown=function(){n("vibrato")},d.addChild(V),d.onShow=function(){Input.setFocusElement(d),d.onResize()},d.onKeyDown=function(e,t){if(d.visible)switch(e){case 37:return m.scroll(-1),!0;case 39:return m.scroll(1),!0;case 46:return UI.deleteSelection(),!0}},d.onResize=function(){if(d.isVisible()){d.clearCanvas();var e=130,t=E.height-e-10,n=Math.ceil(E.width/4),a=0,r=2*n;E.width<170&&(n=Math.ceil(E.width/2),a=t=Math.floor(t/2),r=0),m.setPosition(Layout.col2X,20+Layout.defaultMargin+8),m.setSize(Layout.col4W,d.height-m.top-e-28-8),v.setPosition(Layout.col2X,m.top+m.height+Layout.defaultMargin+30),v.setSize(Layout.col2W,e),b.setPosition(Layout.col4X,v.top),b.setSize(Layout.col2W,e),O.setSize(Layout.col1W,e),L.setSize(Layout.col1W,e),D.setSize(Layout.col1W,e),N.setSize(Layout.col1W,e),L.setPosition(Layout.col2X,m.top+m.height+Layout.defaultMargin+30),D.setPosition(Layout.col3X,L.top),O.setPosition(Layout.col4X,L.top),N.setPosition(Layout.col5X,L.top);var i=0,o=100;Tracker.inFTMode()&&(i=40,o=0),h.setProperties({top:Layout.defaultMargin,left:Layout.col2X+71,width:Layout.col4W-71-25-Layout.defaultMargin-i}),f.setProperties({top:Layout.defaultMargin,left:h.left+h.width+Layout.defaultMargin+i}),g.setProperties({top:Layout.defaultMargin,width:20,height:20,left:h.left+h.width+Layout.defaultMargin-2+o}),p.setProperties({top:Layout.defaultMargin,width:20,height:20,left:h.left+h.width+Layout.defaultMargin+18+o}),E.setProperties({left:0,top:0,width:Layout.col1W,height:d.height}),w.setProperties({left:Layout.col2X,top:1,width:68,height:28}),T.setProperties({left:0,top:0,width:n,height:t}),I.setProperties({left:n,top:0,width:n,height:t}),y.setProperties({left:r,top:a,width:n,height:t}),k.setProperties({left:r+n,top:a,width:n,height:t});var s=m.top+m.height+Layout.defaultMargin,l=Layout.col4W/_.length;_.forEach(function(e,t){e.setProperties({width:l,height:28,left:Layout.col2X+l*t,top:s})}),B.setProperties({width:Layout.col1W/2,height:18,left:2,top:v.top}),R.setPosition(B.left+2,B.top+2),V.setProperties({width:B.width,height:B.height,left:B.left+B.width,top:B.top});S.setProperties({left:0,top:B.top+24,width:Layout.col1W,height:34}),C.setProperties({left:0,top:B.top+24+34,width:Layout.col1W,height:34}),x.setProperties({left:0,top:B.top+24+68,width:Layout.col1W,height:34}),P.setProperties({left:0,top:V.top+22,width:Layout.col1W,height:30}),A.setProperties({left:0,top:V.top+22+30,width:Layout.col1W,height:30}),U.setProperties({left:0,top:V.top+22+60,width:Layout.col1W,height:30});var c=Math.floor((Layout.col1W-4)/4),u=Layout.col1W-4*c;M.forEach(function(e,t){e.setProperties({left:u+t*c,top:V.top+22+90,width:c,height:17})})}},EventBus.on(EVENT.instrumentChange,function(e){w.setValue(r=e,!0);var t=Tracker.getInstrument(e);t?(h.setValue(t.name,!0),I.setValue(t.getFineTune(),!0),y.setValue(t.fadeout||0,!0),P.setValue(t.vibrato.rate||0,!0),A.setValue(t.vibrato.depth||0,!0),U.setValue(t.vibrato.sweep||0,!0),a(t.vibrato.type||0),t.sample&&(S.setMax(t.sample.length,!0),C.setMax(t.sample.length,!0),T.setValue(t.sample.volume,!0),k.setValue(t.sample.panning||0,!0),S.setValue(t.sample.loop.start,!0),C.setValue(t.sample.loop.length,!0),x.setValue(t.sample.relativeNote,!0),R.setState(t.sample.loop.enabled,!0),8===t.sample.bits?(g.setActive(!0),p.setActive(!1)):(g.setActive(!1),p.setActive(!0))),m.setInstrument(t),v.setInstrument(t),b.setInstrument(t)):(m.setInstrument(),v.setInstrument(),b.setInstrument(),h.setValue("",!0),T.setValue(0,!0),k.setValue(0,!0),I.setValue(0,!0),S.setValue(0,!0),C.setValue(0,!0),x.setValue(0,!0),y.setValue(0,!0))}),EventBus.on(EVENT.samplePlay,function(e){d.visible&&e&&e.instrumentIndex===r&&m.play(e.startPeriod,e.effects&&e.effects.offset?e.effects.offset.value:0)}),EventBus.on(EVENT.songPropertyChange,function(e){w.setMax(e.instruments.length-1)}),EventBus.on(EVENT.trackerModeChanged,function(e){I.setMax(e===TRACKERMODE.PROTRACKER?7:127,!0),I.setMin(e===TRACKERMODE.PROTRACKER?-8:-128,!0);var t=Tracker.getInstrument(r);t&&I.setValue(t.getFineTune(),!0),v.setDisabled(!Tracker.inFTMode()),b.setDisabled(!Tracker.inFTMode()),x.setDisabled(!Tracker.inFTMode()),P.setDisabled(!Tracker.inFTMode()),A.setDisabled(!Tracker.inFTMode()),U.setDisabled(!Tracker.inFTMode()),y.setDisabled(!Tracker.inFTMode()),k.setDisabled(!Tracker.inFTMode()),w.setMax(Tracker.getMaxInstruments()),e===TRACKERMODE.PROTRACKER?(S.setProperties({step:2}),C.setProperties({step:2}),t&&(t.sample.loop.start=2*Math.floor(t.sample.loop.start/2),t.sample.loop.length=2*Math.floor(t.sample.loop.length/2),S.setValue(t.sample.loop.start,!0),C.setValue(t.sample.loop.length,!0)),n("loop")):(S.setProperties({step:1}),C.setProperties({step:1})),d.onResize()}),EventBus.on(EVENT.samplePropertyChange,function(e){Tracker.getInstrument(r)&&(void 0!==e.loopStart&&S.setValue(e.loopStart,e.internal),void 0!==e.loopLength&&C.setValue(e.loopLength,e.internal))}),EventBus.on(EVENT.sampleIndexChange,function(e){if(d.visible&&e===r){Tracker.getInstrument(r);EventBus.trigger(EVENT.instrumentChange,r)}}),d},UI.sliderBox=function(e){function t(t){w.forEach(function(e){if(void 0!==t[e])switch(e){case"label":o=t[e];break;case"value":l=s=t[e];break;case"min":c=t[e];break;case"max":u=t[e];break;case"step":0;break;case"onChange":a=t[e];break;case"font":n=t[e];break;case"vertical":r=!!t[e],T&&T.setProperties({vertical:r});break;default:i[e]=t[e]}})}var n,a,r,i=UI.element(),o="",s=0,l=0,c=0,u=100,d=4,h=0,f=0,g=0,p=0,m=10,v=10,b=!(i.type="sliderBox"),E=Y.getImage("line_ver"),w=["left","top","width","height","name","label","value","onChange","min","max","step","vertical","font","trackUndo","undoLabel","undoInstrument"];e&&t(e),9999<u&&(d=5);var T=UI.rangeSlider({min:c,max:u,height:20,width:20,vertical:!!r,onChange:function(e){e!==s&&i.setValue(e)}});i.addChild(T);var I=UI.numberDisplay({min:c,max:u,padLength:4,size:"small",onChange:function(e){e!==s&&i.setValue(e)}});return I.paddingBottom=-1,i.addChild(I),i.setProperties=function(e){t(e),i.setSize(i.width,i.height),i.setPosition(i.left,i.top)},i.setValue=function(e,t){if(e!==s&&(l=s),T.setValue(s=e,t),I.setValue(s,t),i.refresh(),!t&&a){if(i.trackUndo){var n=StateManager.createValueUndo(i);n.name=i.undoLabel||"Change "+i.name,i.undoInstrument&&(n.instrument=Tracker.getCurrentInstrumentIndex(),n.id+=n.instrument),StateManager.registerEdit(n)}a(s)}},i.getValue=function(){return s},i.getPrevValue=function(){return l},i.setMax=function(e,t){u=e,!t&&u<s&&i.setValue(u),T.setMax(u,t),I.setMax(u,t)},i.setMin=function(e,t){c=e,!t&&s<c&&i.setValue(c),T.setMin(c,t),I.setMin(c,t)},i.setDisabled=function(e){b=e,i.refresh(),i.ignoreEvents=b},i.render=function(e){if(e=!!e,i.needsRendering&&(i.clearCanvas(),T.render(),I.render(),n?n.write(i.ctx,o,h,f,0):(i.ctx.fillStyle="white",i.ctx.fillText(o,h,f)),r&&i.ctx.drawImage(E,i.width-2,0,2,i.height),b&&(i.ctx.fillStyle="rgba(34, 49, 85, 0.6)",i.ctx.fillRect(1,0,i.width-1,i.height))),i.needsRendering=!1,e)return i.canvas;i.parentCtx.drawImage(i.canvas,i.left,i.top,i.width,i.height)},i.onMouseWheel=function(e){0<e.mouseWheels[0]?u<++s&&(s=u):--s<c&&(s=c),i.setValue(s)},T.onMouseWheel=i.onMouseWheel,i.onResize=function(){m=40,v=20,5==d&&(m=48,g-=8),r?(T.setSize(20,i.height-36),T.setPosition(Math.floor((i.width-20)/2),0),g=Math.floor((i.width-40)/2),p=i.height-32,h=Math.floor((i.width-n.getTextWidth(o,0))/2),f=i.height-10):(T.setSize(i.width,20),T.setPosition(0,i.height-20),g=i.width-40,p=2),I.setSize(m,v),I.setPosition(g,p)},i},UI.spinBox=function(e){function t(e){void 0!==e.size&&(i=e.size),void 0!==e.label&&(o=e.label),void 0!==e.labels&&(a=e.labels),void 0!==e.font&&(r=e.font),void 0!==e.step&&(s=e.step)}var n=UI.numberDisplay(e);n.type="spinBox";var a,r,i="medium",o="",s=1;e&&t(e);var l=UI.Assets.generate("button20_20");l.onDown=function(){n.isDisabled||(n.updateValue(n.getValue()-s),UI.ticker.onEachTick4(function(){n.updateValue(n.getValue()-s)},10))},l.onTouchUp=function(){UI.ticker.onEachTick4()},l.setProperties({name:"buttonDown",label:"↓"}),n.addChild(l);var c=UI.Assets.generate("button20_20");c.onDown=function(){n.isDisabled||(n.updateValue(n.getValue()+s),UI.ticker.onEachTick4(function(){n.updateValue(n.getValue()+s)},10))},c.onTouchUp=function(){UI.ticker.onEachTick4()},c.setProperties({name:"buttonUp",label:"↑"}),n.addChild(c);var u=n.setProperties;return n.setProperties=function(e){t(e),u&&u(e)},n.renderInternal=function(){o&&(r?r.write(n.ctx,o,6,11,0):(n.ctx.fillStyle="white",n.ctx.fillText(o,10,10))),c.render(),l.render()},n.onResize=function(){a&&a.forEach(function(e){e.width<=n.width&&(o=e.label)}),"big"===i?(c.setProperties({left:n.width-l.width,height:Math.floor(n.height/2),top:0}),l.setProperties({left:c.left,height:c.height,top:n.height-c.height}),n.paddingLeft=2,n.paddingRight=c.width,n.paddingBottom=-1,n.paddingTop=-1):(l.setProperties({left:n.width-l.width,top:3}),c.setProperties({left:n.width-c.width-l.width,top:3}),n.paddingLeft=c.left-8*n.padLength-10-4,n.paddingRight=c.width+l.width+1,n.paddingBottom=n.height-c.height-8)},n};var StateManager=(p9={},r9={undo:[],redo:[]},p9.registerEdit=function(e){var t=!0;if(!s9){if(r9.undo.length)switch(e.type){case EDITACTION.VALUE:var n=r9.undo[r9.undo.length-1];n&&n.type===e.type&&n.id===e.id&&(t=!1,n.to=e.to)}t&&(r9.undo.push(e),100<r9.undo.length&&r9.undo.shift(),r9.redo=[])}},p9.undo=function(){if(r9.undo.length){var e=r9.undo.pop();switch(s9=!0,e.instrument&&e.instrument!==Tracker.getCurrentInstrumentIndex()&&Tracker.setCurrentInstrumentIndex(e.instrument),e.type){case EDITACTION.NOTE:case EDITACTION.RANGE:case EDITACTION.TRACK:case EDITACTION.PATTERN:var t=Tracker.getSong().patterns[e.id];e.id!==Tracker.getCurrentPattern()&&Tracker.setCurrentPattern(e.id),e.data.forEach(function(e){t&&(t[e.position.row][e.position.track]||new Note).populate(e.from)}),EventBus.trigger(EVENT.patternChange,e.id);break;case EDITACTION.VALUE:e.target.setValue(e.from);break;case EDITACTION.DATA:e.target===EDITACTION.SAMPLE&&(e.undo=!0,e.redo=!1,EventBus.trigger(EVENT.showView,"sample"),EventBus.trigger(EVENT.commandProcessSample,e))}r9.redo.push(e),s9=!1,e.name&&UI.setStatus("Undo "+e.name)}},p9.redo=function(){if(r9.redo.length){var e=r9.redo.pop();switch(s9=!0,e.instrument&&e.instrument!==Tracker.getCurrentInstrumentIndex()&&Tracker.setCurrentInstrumentIndex(e.instrument),e.type){case EDITACTION.NOTE:case EDITACTION.RANGE:case EDITACTION.TRACK:case EDITACTION.PATTERN:var n=Tracker.getSong().patterns[e.id];e.id!==Tracker.getCurrentPattern()&&Tracker.setCurrentPattern(e.id),e.data.forEach(function(e){if(n){var t=n[e.position.row][e.position.track]||new Note;e.to?t.populate(e.to):t.clear()}}),EventBus.trigger(EVENT.patternChange,e.id);break;case EDITACTION.VALUE:e.target.setValue(e.to);break;case EDITACTION.DATA:e.target===EDITACTION.SAMPLE&&(e.undo=!1,e.redo=!0,EventBus.trigger(EVENT.showView,"sample"),EventBus.trigger(EVENT.commandProcessSample,e))}r9.undo.push(e),s9=!1,e.name&&UI.setStatus("Redo "+e.name)}},p9.createNoteUndo=function(e,t,n,a){return{target:EDITACTION.PATTERN,type:EDITACTION.NOTE,id:e,data:[{position:{track:t,row:n},from:a.duplicate()}]}},p9.createTrackUndo=function(e){return{target:EDITACTION.PATTERN,type:EDITACTION.TRACK,id:e,data:[]}},p9.createPatternUndo=function(e){return{target:EDITACTION.PATTERN,type:EDITACTION.PATTERN,id:e,data:[]}},p9.createRangeUndo=function(e){return{target:EDITACTION.PATTERN,type:EDITACTION.RANGE,id:e,data:[]}},p9.createValueUndo=function(e){return{target:e,type:EDITACTION.VALUE,id:e.name,from:e.getPrevValue(),to:e.getValue()}},p9.createSampleUndo=function(e,t,n){return{target:EDITACTION.SAMPLE,type:EDITACTION.DATA,id:"sample"+Tracker.getCurrentInstrumentIndex(),instrument:Tracker.getCurrentInstrumentIndex(),from:t||0,to:n||0,action:e}},p9.addNote=function(e,t,n,a){var r={position:{track:t,row:n},from:a?a.duplicate():{}};return e.data.push(r),r},p9.getHistory=function(){return r9},p9.clear=function(){r9={undo:[],redo:[]}},p9.lock=function(){s9=!0},p9.unLock=function(){s9=!1},p9.canUndo=function(){return 0<r9.undo.length},p9.canRedo=function(){return 0<r9.redo.length},p9.getUndoLabel=function(){var e="";return r9.undo.length&&(e=r9.undo[r9.undo.length-1].name||""),"Undo "+e},p9.getRedoLabel=function(){var e="";return r9.redo.length&&(e=r9.redo[r9.redo.length-1].name||""),"Redo "+e},EventBus.on(EVENT.commandUndo,p9.undo),EventBus.on(EVENT.commandRedo,p9.redo),p9),s9,p9,r9,X9,Y9,Z9,$9,_9,aaa,W9,baa,caa,daa;UI.ticker=(W9={},baa=0,caa=0,daa=!1,W9.onEachTick2=function(e,t){_9=0,Z9=t||0,daa=(X9=e)||Y9},W9.onEachTick4=function(e,t){aaa=0,$9=t||0,Y9=e,daa=X9||Y9},EventBus.on(EVENT.screenRefresh,function(){daa&&(baa=1-baa)&&(caa=1-caa,X9&&Z9<++_9&&X9(),caa&&Y9&&$9<++aaa&&Y9())}),W9),UI.WaveForm=function(){function h(e){var t,n=p.sample.loop.start||0;if(e===L)return n<P||A<n?-10:(U=A-P,t=Math.floor((n-P)/U*T.width),Math.max(5<P?0:5,t));var a=n+p.sample.loop.length;return a<P||A<a?-10:(t=Math.floor((a-P)/U*T.width),Math.min(t,T.width-(E-6<A?6:0)))}function f(e){var t;if(e===O)return I<P||A<I?-10:(U=A-P,t=Math.floor((I-P)/U*T.width),Math.max(5<P?0:5,t));var n=I+S;return n<P||A<n?-10:(t=Math.floor((n-P)/U*T.width),Math.min(t,T.width-(E-6<A?6:0)))}function c(e){var t={};return S?(t.tail=g.slice(I+S),t.range=g.slice(I,I+S),t.head=g.slice(0,I)):e?(t.range=[],t.tail=g.slice(I),t.head=g.slice(0,I)):(t.tail=[],t.range=g.slice(0,g.length),t.head=[]),t}function u(e){g=e.head.concat(e.range).concat(e.tail),p.sample.data=g,p.sample.length=g.length,s=!0,EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),s=!1,B.refresh(),T.refresh()}function a(){var e=p.sample.loop.start,t=p.sample.loop.length,n=p.sample.length;e<0&&(e=0),t<0&&(t=0),n<e+t&&(n<e&&(e=n),t=n-e),e===p.sample.loop.start&&t===p.sample.loop.length||(p.sample.loop.start=e,p.sample.loop.length=t,s=!0,EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),s=!1,B.refresh(),T.refresh())}function n(e){(e.loopStart||e.loopLength)&&(p.sample.loop.start=e.loopStart||0,p.sample.loop.length=e.loopLength||0,s=!0,EventBus.trigger(EVENT.instrumentChange,Tracker.getCurrentInstrumentIndex()),s=!1)}var g,p,m,r,v,b,E,i,o,w,s,T=UI.element(),I=-1,k=-1,S=0,l=0,C=0,d=0,y=!(T.name="Waveform"),x=1,P=0,A=0,U=0,M=[],_=0,L=1,D=2,O=3,N=4,B=UI.element(),R=UI.scale9Panel(0,0,T.width,T.height,{img:Y.getImage("panel_dark"),left:3,top:3,right:2,bottom:2});R.ignoreEvents=!0;var V=UI.scale9Panel(1,0,100,18,{img:Y.getImage("bar"),left:2,top:2,right:3,bottom:3});return V.onDragStart=function(){V.startDragIndex=P,V.startLeft=V.left},V.onDrag=function(e){var t=V.startLeft+e.deltaX,n=T.width-V.width-1;t=Math.max(t,1),t=Math.min(t,n),V.setPosition(t,V.top),U=A-P,P=Math.floor((E-U)*(t/(n-1))),A=P+U,B.refresh()},T.addChild(V),EventBus.on(EVENT.screenRefresh,function(){(m||r)&&T.isVisible()&&T.refresh()}),T.scroll=function(e){var t=V.left+e,n=T.width-V.width-1;t=Math.max(t,1),t=Math.min(t,n),V.setPosition(t,V.top),U=A-P,P=Math.floor((E-U)*(t/(n-1))),A=P+U,B.refresh()},T.onDragStart=function(e){var t=e.startX;if(p.sample.loop.enabled){var n=h(D);if(Math.abs(t-n)<5)return l=D,void(d=p.sample.loop.length);if(n=h(L),Math.abs(t-n)<5)return l=L,void(d=p.sample.loop.start)}return S&&(n=f(N),Math.abs(t-n)<5)?(l=N,void(d=S)):0<=I&&(n=f(O),Math.abs(t-n)<5)?(l=O,void(d=I)):(r=!0,i=o=e.startX,I=k=Math.round(P+i*(p.sample.length/T.width/x)),void EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:S=0}))},T.onDrag=function(e){var t=p.sample.length/T.width/x;if(l&&(l===L||l===D)){C=l;var n=e.deltaX,a=d+Math.round(t*n);Tracker.inFTMode()||(a-=a%2);var r={};return l===L?(a=Math.min(a,E-2),a=Math.max(a,0),r.loopStart=a,E<r.loopStart+p.sample.loop.length&&(r.loopLength=E-r.loopStart)):(a=Math.max(a,2),a=Math.min(a,E-p.sample.loop.start),r.loopLength=a),EventBus.trigger(EVENT.samplePropertyChange,r),void T.refresh()}if(l&&(l===O||l===N))return C=l,n=e.deltaX,a=d+Math.round(t*n),l===O?(a=Math.min(a,E-2),a=Math.max(a,0),E<(I=a)+S&&(S=E-I)):(a=Math.max(a,2),a=Math.min(a,E-I),S=a),EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:S}),void T.refresh();o=e.x,k=Math.round(P+o*t),k=Math.max(k,0),S=k-I,EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:Math.abs(S)})},T.onTouchUp=function(e){r&&k<I&&(S=I-k,k=(I=k)+S,T.refresh()),l=0,y=r=!1,S&&UI.setSelection(T.processSelection)},T.onDown=function(e){y=!0},T.onHover=function(e){if(!r&&!l&&!y){var t=C;y||(C=0);var n=T.eventX;if(0<=I&&(a=f(O),Math.abs(n-a)<5))return void(t!==(C=O)&&T.refresh());if(0<=k){var a=f(N);if(Math.abs(n-a)<5)return void(t!==(C=N)&&T.refresh())}if(p.sample.loop.enabled){if(a=h(D),Math.abs(n-a)<5)return void(t!==(C=D)&&T.refresh());if(a=h(L),Math.abs(n-a)<5)return void(t!==(C=L)&&T.refresh())}t!==C&&T.refresh()}},T.onResize=function(){B.setPosition(0,0),B.setSize(T.width,T.height),V.setPosition(V.left,T.height-18),1<x&&V.setSize(Math.floor(T.width/x),18)},T.setInstrument=function(e){E=(p=e)?(g=p.sample.data).length:(g=void 0,0),EventBus.trigger(EVENT.samplePropertyChange,{sampleLength:E,loopLength:e?e.sample.loop.length:0,internal:!0}),s||(m=!1,T.zoom(1),k=I=-1,S=0,T.refresh())},T.play=function(e,t){1<x||(_=t=t||0,m=!0,v=(new Date).getTime(),b=Audio.getSampleRateForPeriod(e),T.refresh())},T.playSection=function(e){"range"===e&&Input.handleNoteOn(Input.getPrevIndex(),void 0,I),"loop"===e&&Input.handleNoteOn(Input.getPrevIndex(),void 0,p.sample.loop.start)},T.stop=function(){m=!1,T.refresh()},T.zoom=function(e){var t=!1;if("range"===e)if(S){A=(P=I)+(U=S);var n=T.width/(x=E/U),a=T.width-n-2;V.setPosition(Math.floor(P/(E-U)*a),V.top),t=!0}else e=1;"loop"===e&&(p.sample.loop.enabled&&(A=(P=p.sample.loop.start)+(U=p.sample.loop.length),a=T.width-(n=T.width/(x=E/U))-2,V.setPosition(Math.floor(P/(E-U)*a),V.top)),t=!0),1!==e&&1!==x||(x=1,P=0),t||(x*=e,x=Math.max(x,1),U=Math.floor(E/x),A=P+U),V.setSize(Math.floor(T.width/x),18),(w=1<x)&&E<A&&(P=E-U,A=E,V.setPosition(T.width-V.width-1,V.top)),B.refresh(),T.refresh()},T.select=function(e,t,n){switch(e){case"all":I=0,S=k=g.length,T.refresh();break;case"none":k=I=-1,S=0,T.refresh();break;case"loop":2<p.sample.loop.length&&(k=(I=p.sample.loop.start)+(S=p.sample.loop.length),T.refresh());break;case"start":S=k-(I=0),T.refresh();break;case"end":S=(k=g.length)-I,T.refresh();break;case"range":k=(I=t)+(S=n),T.refresh()}EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:S}),UI.setSelection(T.processSelection)},T.render=function(){if(this.needsRendering){if(B.needsRendering){if(B.clearCanvas(),B.ctx.fillStyle="rgb(13, 19, 27)",B.ctx.fillRect(0,0,T.width,T.height),B.ctx.strokeStyle="rgba(120, 255, 50, 0.5)",R.width!==T.width&&R.setSize(T.width,T.height),B.ctx.drawImage(R.render(!0),0,0,T.width,T.height),g&&g.length&&T.width){1===x&&(P=0,A=E);var e=(U=A-P)/T.width,t=T.height/2;B.ctx.beginPath();for(var n=T.height/2-2,a=0;a<T.width;a++){var r=Math.floor(a*e),i=g[P+r]*-n;0===a?B.ctx.moveTo(a,t+i):B.ctx.lineTo(a,t+i)}B.ctx.stroke()}B.needsRendering=!1}if(T.ctx.drawImage(B.canvas,0,0),m&&E){var o=(new Date).getTime();r=_+b*(o-v)/1e3;if(p.sample.loop.enabled&&p.sample.loop.start<r){var s=(r=p.sample.loop.start+(r-p.sample.loop.start)%p.sample.loop.length)/E*T.width;T.ctx.fillStyle="rgb(241, 162, 71)",T.ctx.fillRect(s,0,1,T.height)}else if(E<r)m=!1;else{s=r/E*T.width;T.ctx.fillStyle="rgb(241, 162, 71)",T.ctx.fillRect(s,0,1,T.height)}}if(2<p.sample.loop.length||p.sample.loop.enabled){var l=p.sample.loop.enabled?"rgb(241, 220, 71)":"rgba(150, 150, 150,0.7)";T.ctx.fillStyle=l,C===L&&(T.ctx.fillStyle="white");var c=h(L);T.ctx.fillRect(c,0,1,T.height-1),T.ctx.fillRect(c-4,0,4,10),T.ctx.fillStyle=l,C===D&&(T.ctx.fillStyle="white"),c=h(D),T.ctx.fillRect(c,0,1,T.height-1),T.ctx.fillRect(c+1,0,4,10)}var u=-1,d=-1;0<=k&&(T.ctx.fillStyle=l="rgb(241, 131, 71)",C===N&&(T.ctx.fillStyle="white"),d=f(N),T.ctx.fillRect(d,0,1,T.height-1),T.ctx.fillRect(d+1,11,4,10)),0<=I&&(I<P?u=0:(T.ctx.fillStyle=l="rgb(241, 131, 71)",C===O&&(T.ctx.fillStyle="white"),u=f(O),T.ctx.fillRect(u,0,1,T.height-1),T.ctx.fillRect(u-4,11,4,10)),I+S<P&&(u=d=-1)),u!==d&&(0<=u&&(d=Math.min(d,T.width))<=0&&(d=T.width),T.ctx.fillStyle="rgba(241, 162, 71,0.1)",T.ctx.fillRect(u,0,d-u,T.height)),w&&V.render()}this.needsRendering=!1,T.parentCtx.drawImage(T.canvas,T.left,T.top,T.width,T.height)},T.adjustVolume=function(e){var t,n,a,r=c(),i=!1,o=StateManager.createSampleUndo(SELECTION.REPLACE,I,S);if(o.data=r.range.slice(0),o.name="Adjust Volume","max"===e){var s=0,l=0;for(n=0,a=r.range.length;n<a;n++)s=Math.min(s,r.range[n]),l=Math.max(l,r.range[n]);if(1<(t=1/Math.max(l,-s))){for(n=0,a=r.range.length;n<a;n++)r.range[n]=r.range[n]*t;i=!0}}if("fadein"===e){for(n=0,a=r.range.length-1;n<=a;n++)r.range[n]=r.range[n]*(t=n/a);i=!0}if("fadeout"===e){for(n=0,a=r.range.length-1;n<=a;n++)r.range[n]=r.range[n]*(t=1-n/a);i=!0}if(!i){if("number"==typeof e)for(t=1+1/e,n=0,a=r.range.length-1;n<=a;n++)r.range[n]=Math.min(Math.max(r.range[n]*t,-1),1);i=!0}i&&(o.dataTo=r.range.slice(0),StateManager.registerEdit(o),u(r))},T.reverse=function(){var e=c(),t=StateManager.createSampleUndo(SELECTION.REPLACE,I,S);t.data=e.range.slice(0),t.name="Reverse Sample",e.range=e.range.reverse(),t.dataTo=e.range.slice(0),StateManager.registerEdit(t),u(e)},T.invert=function(){var e=c(),t=StateManager.createSampleUndo(SELECTION.REPLACE,I,S);t.data=e.range.slice(0),t.name="Reverse Sample";for(var n=0,a=e.range.length-1;n<=a;n++)e.range[n]=-e.range[n];t.dataTo=e.range.slice(0),StateManager.registerEdit(t),u(e)},T.resample=function(e){var t=c(),n=[],a=StateManager.createSampleUndo(SELECTION.REPLACE,I,S);if(a.data=t.range.slice(0),a.name="Resample Sample",a.loopStart=p.sample.loop.start,a.loopLength=p.sample.loop.length,"up"===e){for(var r=0,i=t.range.length;r<i;r++)n.push(t.range[r]),n.push(t.range[r]);p.sample.loop.start=Math.floor(2*p.sample.loop.start),p.sample.loop.length=Math.floor(2*p.sample.loop.length),k=(I*=2)+(S*=2)}else{for(r=0,i=t.range.length;r<i;r+=2)n.push(t.range[r]);p.sample.loop.start=Math.floor(p.sample.loop.start/2),p.sample.loop.length=Math.floor(p.sample.loop.length/2),I=Math.floor(I/2),S=Math.floor(S/2),k=I+S}Tracker.inFTMode()||(p.sample.loop.start=p.sample.loop.start-p.sample.loop.start%2,p.sample.loop.length=p.sample.loop.length-p.sample.loop.length%2),a.dataTo=(t.range=n).slice(0),StateManager.registerEdit(a),u(t)},T.processSelection=function(e){if(T.isVisible())switch(e){case SELECTION.RESET:return!1;case SELECTION.CLEAR:T.adjustVolume(0);break;case SELECTION.COPY:case SELECTION.CUT:if(0<S){var t=c();if(M=t.range.slice(0),e===SELECTION.CUT)(n=StateManager.createSampleUndo(SELECTION.CUT,I,S)).data=t.range.slice(0),n.name="cut sample",n.loopStart=p.sample.loop.start,n.loopLength=p.sample.loop.length,StateManager.registerEdit(n),t.range=[],u(t),a(),k=I+(S=0),EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:S}),T.refresh()}break;case SELECTION.DELETE:if(0<S)(t=c()).range=[],u(t),k=I+(S=0),EventBus.trigger(EVENT.samplePropertyChange,{rangeLength:S}),T.refresh();break;case SELECTION.PASTE:var n;t=c(!0),I<0&&(I=g.length),(n=StateManager.createSampleUndo(SELECTION.PASTE,I,M.length)).name="paste sample",n.data=t.range.slice(0),n.dataTo=M.slice(0),n.loopStart=p.sample.loop.start,n.loopLength=p.sample.loop.length,StateManager.registerEdit(n),0<=I?t.range=M:t.tail=t.tail.concat(M),u(t),a(),setTimeout(function(){T.select("range",I,M.length)},10)}},EventBus.on(EVENT.commandSelectAll,function(){T.isVisible()&&T.select("all")}),EventBus.on(EVENT.commandProcessSample,function(e){if(T.isVisible()){if(e.undo)switch(e.action){case SELECTION.CUT:T.select("range",e.from,0),(t=c(!0)).range=e.data,u(t),n(e),T.select("range",e.from,e.data.length);break;case SELECTION.PASTE:T.select("range",e.from,e.to),(t=c(!0)).range=e.data,u(t),n(e),T.select("range",e.from,e.data.length);break;case SELECTION.REPLACE:T.select("range",e.from,e.to),(t=c()).range=e.data,u(t),e.to&&T.select("range",e.from,e.data.length)}if(e.redo)switch(e.action){case SELECTION.CUT:T.select("range",e.from,e.data.length),(t=c()).range=[],u(t),T.select("range",e.from,0);break;case SELECTION.PASTE:T.select("range",e.from,e.data.length||0),(t=c(!0)).range=e.dataTo,u(t),a(),T.select("range",e.from,e.dataTo.length);break;case SELECTION.REPLACE:var t;T.select("range",e.from,e.to),(t=c()).range=e.dataTo,u(t),e.to&&T.select("range",e.from,e.data.length)}}}),T},Yascal.sprite=function(e){var t={};if(t.canvas=document.createElement("canvas"),t.ctx=t.canvas.getContext("2d"),e&&(e.width&&(t.canvas.width=e.width,t.canvas.height=e.height||e.width),e.img)){var n=t.canvas.width,a=t.canvas.height;t.ctx.drawImage(e.img,e.x||0,e.y||0,n,a,0,0,n,a)}return t},FilterChain=function(e){function n(){var e,t,n,a,r,i,o,s,l,c,u,d;f=h,x&&(v=v||((e=Y.createBiquadFilter()).type="highshelf",e.frequency.value=3200,e.gain.value=B,e),f.connect(v),f=v),P&&(b=b||((t=Y.createBiquadFilter()).type="peaking",t.frequency.value=1e3,t.Q.value=.5,t.gain.value=N,t),f.connect(b),f=b),A&&(E=E||((n=Y.createBiquadFilter()).type="lowshelf",n.frequency.value=320,n.gain.value=O,n),f.connect(E),f=E),U&&(w=w||((a=Y.createBiquadFilter()).type="lowpass",a.frequency.value=5e3,a),f.connect(w),f=w),_&&(k=k||Y.createWaveShaper(),V=V||Y.createGain(),k.curve=function(e){for(var t,n="number"==typeof e?e:50,a=new Float32Array(44100),r=Math.PI/180,i=0;i<44100;++i)a[i]=(3+n)*(t=2*i/44100-1)*20*r/(Math.PI+n*Math.abs(t));return a}(V),k.oversample="4x",f.connect(V),V.connect(k),f=k),D&&((S=S||Y.createDynamicsCompressor()).threshold.setValueAtTime(-25,Y.currentTime),S.attack.setValueAtTime(0,Y.currentTime),S.release.setValueAtTime(12,Y.currentTime),f.connect(S),f=S),L&&(I=I||(r=.12,i=.4,o=Y.createChannelMerger(2),s=Y.createDelay(),l=Y.createDelay(),c=Y.createGain(),u=Y.createGain(),(d=Y.createChannelSplitter(2)).connect(s,0),d.connect(l,1),l.delayTime.value=s.delayTime.value=r,u.gain.value=c.gain.value=i,s.connect(c),c.connect(l),l.connect(u),u.connect(s),c.connect(o,0,0),u.connect(o,0,1),{splitter:d,merger:o}),(F=F||Y.createGain()).gain.value=0,f.connect(F),F.connect(I.splitter),p=I.merger),M&&(T=T||Y.createConvolver(),(R=R||Y.createGain()).gain.value=0,f.connect(R),R.connect(T),g=T),y&&(C=C||Audio.context.createStereoPanner(),f.connect(C),f=C),m=m||Y.createGain(),f.connect(m),g&&g.connect(m),p&&p.connect(m),f=m}var t={};e=e||{volume:!0,panning:!0,high:!1,mid:!1,low:!1,lowPass:!1,reverb:!1,distortion:!1,delay:!1,compression:!1};var h,f,g,p,m,v,b,E,w,T,I,k,S,C,a=(e={volume:!0,panning:!0,high:!1,mid:!1,low:!1,lowPass:!1,reverb:!1,distortion:!1,delay:!1,compression:!1}).volume,y=e.panning&&Audio.context.createStereoPanner,x=e.high,P=e.mid,A=e.low,U=e.lowPass,M=e.reverb,_=e.distortion,L=e.delay,D=e.compression,O=0,N=0,B=0,r=70,i=0,R=0,V=0,F=0,Y=Audio.context;return(h=Y.createGain()).gain.value=1,f=h,t.lowValue=function(e){if(A){if(void 0!==e){E.gain.value=20*(O=e)}return O}},t.midValue=function(e){if(P){if(void 0!==e){b.gain.value=20*(N=e)}return N}},t.highValue=function(e){if(x){if(void 0!==e){v.gain.value=20*(B=e)}return B}},t.lowPassFrequencyValue=function(e){if(U){var t=Audio.context.sampleRate/2,n=Math.log(t/40)/Math.LN2,a=Math.pow(2,n*(e-1));w.frequency.value=t*a}},t.lowPassQualityValue=function(e){U&&(w.Q.value=30*e)},t.compressionValue=function(e){S.ratio.setValueAtTime(4*e/100+1,Y.currentTime)},t.reverbValue=function(e){if(M){if(!T.buffer){var t=cachedAssets.audio["data/reverb/sportcentre.m4a"];if(t)T.buffer=t;else PreLoader().load(["data/reverb/sportcentre.m4a"],PRELOADTYPE.audio,function(){T.buffer=cachedAssets.audio["data/reverb/sportcentre.m4a"]})}var n=parseInt(e)/100;R.gain.value=n*n}},t.distortionValue=function(e){if(_){var t=parseInt(e)/100;V.gain.value=10*t}},t.delayValue=function(e){if(L){var t=parseInt(e)/100;F.gain.value=t*t}},t.delayValue=function(e){if(L){var t=parseInt(e)/100;F.gain.value=t*t}},t.volumeValue=function(e){if(a){if(void 0!==e){var t=(r=e)/100;m.gain.value=t*t}return r}},t.panningValue=function(e,t){if(y)return void 0!==e&&C.pan.setValueAtTime(i=e,t||Audio.context.currentTime),i},t.setState=function(e,t){h.disconnect(),v&&v.disconnect(),b&&b.disconnect(),E&&E.disconnect(),w&&w.disconnect(),R&&R.disconnect(),C&&C.disconnect(),k&&k.disconnect(),F&&F.disconnect(),S&&S.disconnect(),p=g=void 0,"high"===e&&(x=!!t),"mid"===e&&(P=!!t),"low"===e&&(A=!!t),"lowPass"===e&&(U=!!t),"reverb"===e&&(M=!!t),"panning"===e&&(y=!!t&&Audio.context.createStereoPanner),"distortion"===e&&(_=!!t),"delay"===e&&(L=!!t),"compression"===e&&(D=!!t),n()},t.input=function(){return h},t.output=function(){return f},n(),t.volumeValue(r),t};var Midi=(vfa={},vfa.init=function(){if(!navigator.requestMIDIAccess)return!1;navigator.requestMIDIAccess().then(function(e){yfa=!0;var t=Array.from(e.inputs.values());t.forEach(function(e){e.onmidimessage=zfa}),t.length&&EventBus.trigger(EVENT.midiIn)},function(){})},vfa.enable=function(){Midi.init()},vfa.disable=function(){yfa=!1,EventBus.trigger(EVENT.midiIn)},vfa.isEnabled=function(){return!!yfa},vfa),yfa,vfa;function zfa(e){if(yfa){var t=e.data;switch(t[0]){case 128:case 129:Bfa(t[1]);break;case 144:case 145:case 146:case 147:case 148:case 149:case 150:case 151:case 152:case 153:case 154:case 155:case 156:case 157:case 158:case 159:(t[2]?function(e,t){var n,a=e-47,r=Input.getCurrentOctave();"enabled"===SETTINGS.midi&&(n=t+1>>1);Input.handleNoteOn(a+12*r,void 0,void 0,n)}:Bfa)(t[1],t[2]);break;case 176:break;case 192:Tracker.setCurrentInstrumentIndex(t[1]+1)}EventBus.trigger(EVENT.midiIn)}}function Bfa(e){var t=e-47,n=Input.getCurrentOctave();Input.handleNoteOff(t+12*n,"enabled"===SETTINGS.midi)}var FileDetector=(hga={},iga={unknown:{name:"UNKNOWN"},unsupported:{name:"UNSUPPORTED"},mod_ProTracker:{name:"PROTRACKER",isMod:!0,loader:function(){return ProTracker()}},mod_SoundTracker:{name:"SOUNDTRACKER",isMod:!0,loader:function(){return SoundTracker()}},mod_FastTracker:{name:"FASTTRACKER",isMod:!0,loader:function(){return FastTracker()}},sample:{name:"SAMPLE",isSample:!0},zip:{name:"ZIP"}},hga.detect=function(r,e){function i(e){return e<128}var o=r.length,t="";if("Extended Module: "==(t=r.readString(17,0)))return iga.mod_FastTracker;if(1100<o&&(t=r.readString(4,1080)),"M.K."==t)return iga.mod_ProTracker;if("M!K!"==t)return iga.mod_ProTracker;if("M&K!"==t)return iga.mod_ProTracker;if("FLT4"==t)return iga.mod_ProTracker;if("2CHN"==t)return iga.mod_ProTracker;if("3CHN"==t)return iga.mod_ProTracker;if("5CHN"==t)return iga.mod_ProTracker;if("6CHN"==t)return iga.mod_ProTracker;if("7CHN"==t)return iga.mod_ProTracker;if("8CHN"==t)return iga.mod_ProTracker;if("9CHN"==t)return iga.mod_ProTracker;if("10CH"==t)return iga.mod_ProTracker;if("11CH"==t)return iga.mod_ProTracker;if("12CH"==t)return iga.mod_ProTracker;if("13CH"==t)return iga.mod_ProTracker;if("14CH"==t)return iga.mod_ProTracker;if("15CH"==t)return iga.mod_ProTracker;if("16CH"==t)return iga.mod_ProTracker;if("18CH"==t)return iga.mod_ProTracker;if("20CH"==t)return iga.mod_ProTracker;if("22CH"==t)return iga.mod_ProTracker;if("24CH"==t)return iga.mod_ProTracker;if("26CH"==t)return iga.mod_ProTracker;if("28CH"==t)return iga.mod_ProTracker;if("30CH"==t)return iga.mod_ProTracker;if("32CH"==t)return iga.mod_ProTracker;var n="";return e&&4<e.length&&(n=e.substr(e.length-4)),".wav"==(n=n.toLowerCase())||".mp3"==n||".iff"==n||"flac"==n||".ogg"==n||"opus"==n?iga.sample:".zip"==n||"PK"==r.readString(2,0)?iga.zip:e&&0<=e.indexOf(".")&&1624<o&&function(){r.goto(0);for(var e=0;e<20;e++)if(!i(r.readByte()))return;for(var t=0,n=0,a=0;a<15;a++){for(e=0;e<22;e++)if(!i(r.readByte()))return;if(r.jump(-22),"st-"==r.readString(22).toLowerCase().substr(0,3)&&(n+=10),20<n)return 1;t+=r.readWord(),r.jump(6)}return!(o<2*t+1624)}()?iga.mod_SoundTracker:iga.sample},hga),hga,iga,FastTracker=function(){var y={load:function(e,t){function n(e){for(e.points=[],b=0;b<12;b++)e.points.push(e.raw.slice(2*b,2*b+2));return 1&e.type&&(e.enabled=!0),2&e.type&&(e.sustain=!0),4&e.type&&(e.loop=!0),e}Tracker.setTrackerMode(TRACKERMODE.FASTTRACKER,!0),Tracker.clearInstruments(1);var a={},r={patterns:[],instruments:[]};e.litteEndian=!0,e.goto(17),r.title=e.readString(20),e.jump(1),a.trackerName=e.readString(20),a.trackerVersion=e.readByte(),a.trackerVersion=e.readByte()+"."+a.trackerVersion,a.headerSize=e.readDWord(),a.songlength=e.readWord(),a.restartPosition=e.readWord(),a.numberOfChannels=e.readWord(),a.numberOfPatterns=e.readWord(),a.numberOfInstruments=e.readWord(),a.flags=e.readWord(),Tracker.useLinearFrequency=a.flags%2==1,a.defaultTempo=e.readWord(),a.defaultBPM=e.readWord();for(var i=[],o=0,s=0;s<a.songlength;++s)i[s]=e.readUbyte(),o<i[s]&&(o=i[s]);r.patternTable=i,r.length=a.songlength,r.channels=a.numberOfChannels,r.restartPosition=a.restartPosition+1;var l=60+a.headerSize;for(e.goto(l),s=0;s<a.numberOfPatterns;s++){var c=[],u={};u.headerSize=e.readDWord(),u.packingType=e.readUbyte(),u.patternLength=e.readWord(),u.patternSize=e.readWord(),e.goto(l+=u.headerSize);for(var d=0;d<u.patternLength;d++){var h,f=[];for(h=0;h<a.numberOfChannels;h++){var g=Note(),p=e.readUbyte();128&p?(1&p&&g.setIndex(e.readUbyte()),2&p&&(g.instrument=e.readUbyte()),4&p&&(g.volumeEffect=e.readUbyte()),8&p&&(g.effect=e.readUbyte()),16&p&&(g.param=e.readUbyte())):(g.setIndex(p),g.instrument=e.readUbyte(),g.volumeEffect=e.readUbyte(),g.effect=e.readUbyte(),g.param=e.readUbyte()),f.push(g)}c.push(f)}e.goto(l+=u.patternSize),r.patterns.push(c)}var m=[];for(s=1;s<=a.numberOfInstruments;++s){var v=Instrument();try{if(v.filePosition=e.index,v.headerSize=e.readDWord(),v.name=e.readString(22),v.type=e.readUbyte(),v.numberOfSamples=e.readWord(),v.samples=[],(v.sampleHeaderSize=0)<v.numberOfSamples){v.sampleHeaderSize=e.readDWord(),v.sampleHeaderSize=Math.max(v.sampleHeaderSize,40),200<v.sampleHeaderSize&&(v.sampleHeaderSize=40);for(var b=0;b<96;b++)v.sampleNumberForNotes.push(e.readUbyte());for(b=0;b<24;b++)v.volumeEnvelope.raw.push(e.readWord());for(b=0;b<24;b++)v.panningEnvelope.raw.push(e.readWord());v.volumeEnvelope.count=e.readUbyte(),v.panningEnvelope.count=e.readUbyte(),v.volumeEnvelope.sustainPoint=e.readUbyte(),v.volumeEnvelope.loopStartPoint=e.readUbyte(),v.volumeEnvelope.loopEndPoint=e.readUbyte(),v.panningEnvelope.sustainPoint=e.readUbyte(),v.panningEnvelope.loopStartPoint=e.readUbyte(),v.panningEnvelope.loopEndPoint=e.readUbyte(),v.volumeEnvelope.type=e.readUbyte(),v.panningEnvelope.type=e.readUbyte(),v.vibrato.type=e.readUbyte(),v.vibrato.sweep=e.readUbyte(),v.vibrato.depth=Math.min(e.readUbyte(),15),v.vibrato.rate=e.readUbyte(),v.fadeout=e.readWord(),v.reserved=e.readWord(),v.volumeEnvelope=n(v.volumeEnvelope),v.panningEnvelope=n(v.panningEnvelope)}}catch(e){}if(e.goto(l+=v.headerSize),0===v.numberOfSamples){var E=Sample();v.samples.push(E)}else{if(e.isEOF(1))break;for(var w=0;w<v.numberOfSamples;w++)(E=Sample()).length=e.readDWord(),E.loop.start=e.readDWord(),E.loop.length=e.readDWord(),E.volume=e.readUbyte(),E.finetuneX=e.readByte(),E.type=e.readUbyte(),E.panning=e.readUbyte()-128,E.relativeNote=e.readByte(),E.reserved=e.readByte(),E.name=e.readString(22),E.bits=8,v.samples.push(E),e.goto(l+=v.sampleHeaderSize);for(w=0;w<v.numberOfSamples;w++)if((E=v.samples[w]).length){l+=E.length,16&E.type&&(E.bits=16,E.type^=16,E.length>>=1,E.loop.start>>=1,E.loop.length>>=1),E.loop.type=E.type||0,E.loop.enabled=!!E.loop.type;var T=E.length,I=0;if(16===E.bits)for(var k=0;k<T;k++){var S=e.readShort()+I;S<-32768?S+=65536:32767<S&&(S-=65536),E.data.push((I=S)/32768)}else for(k=0;k<T;k++)(S=e.readByte()+I)<-128?S+=256:127<S&&(S-=256),E.data.push((I=S)/127);if(E.loop.type===LOOPTYPE.PINGPONG){var C=E.data.slice(E.loop.start,E.loop.start+E.loop.length);E.data=E.data.slice(0,E.loop.start+E.loop.length),E.data=E.data.concat(C.reverse()),E.loop.length=2*E.loop.length,E.length=E.loop.start+E.loop.length}e.goto(l)}}v.setSampleIndex(0),Tracker.setInstrument(s,v),m.push({label:s+" "+v.name,data:s})}return EventBus.trigger(EVENT.instrumentListChange,m),r.instruments=Tracker.getInstruments(),Tracker.setBPM(a.defaultBPM),Tracker.setAmigaSpeed(a.defaultTempo),y.validate(r),r},write:function(e){var t=Tracker.getSong(),n=Tracker.getInstruments(),a=Tracker.getTrackCount(),r="undefined"==typeof versionNumber?"dev":versionNumber,i=0;for(o=0;o<128;o++){i=Math.max(i,t.patternTable[o]||0)}var o,s=336;for(o=0;o<=i;o++)t.patterns[o]&&(s+=9+t.patterns[o].length*a*5);for(o=1;o<n.length;o++){var l=n[o];l&&l.hasSamples()?l.samples.forEach(function(e){var t=e.length;16===e.bits&&(t*=2),s+=283+t}):s+=29}var c=new BinaryStream(new ArrayBuffer(s),!1);for(c.writeStringSection("Extended Module: ",17),c.writeStringSection(t.title,20),c.writeByte(26),c.writeStringSection("BassoonTracker "+r,20),c.writeByte(4),c.writeByte(1),c.writeDWord(276),c.writeWord(t.length),c.writeWord(0),c.writeWord(Tracker.getTrackCount()),c.writeWord(i+1),c.writeWord(n.length-1),c.writeWord(Tracker.useLinearFrequency?1:0),c.writeWord(Tracker.getAmigaSpeed()),c.writeWord(Tracker.getBPM()),o=0;o<256;o++)c.writeUByte(t.patternTable[o]||0);for(o=0;o<=i;o++){var u=t.patterns[o],d=0,h=0;if(u&&(h=(d=u.length)*a*5),c.writeDWord(9),c.writeUByte(0),c.writeWord(d),c.writeWord(h),u)for(var f=0,g=u.length;f<g;f++)for(var p=u[f],m=0;m<a;m++){var v=p[m]||{};c.writeUByte(v.index||0),c.writeUByte(v.instrument||0),c.writeUByte(v.volumeEffect||0),c.writeUByte(v.effect||0),c.writeUByte(v.param||0)}}for(o=1;o<n.length;o++)if((l=n[o])&&l.hasSamples()){l.numberOfSamples=l.samples.length,c.writeDWord(243),c.writeStringSection(l.name,22),c.writeUByte(0),c.writeWord(l.numberOfSamples);var b=(l.volumeEnvelope.enabled?1:0)+(l.volumeEnvelope.sustain?2:0)+(l.volumeEnvelope.loop?4:0),E=(l.panningEnvelope.enabled?1:0)+(l.panningEnvelope.sustain?2:0)+(l.panningEnvelope.loop?4:0);c.writeDWord(40);for(var w=0;w<96;w++)c.writeUByte(l.sampleNumberForNotes[w]||0);for(w=0;w<12;w++){var T=l.volumeEnvelope.points[w]||[0,0];c.writeWord(T[0]),c.writeWord(T[1])}for(w=0;w<12;w++)c.writeWord((T=l.panningEnvelope.points[w]||[0,0])[0]),c.writeWord(T[1]);c.writeUByte(l.volumeEnvelope.count||0),c.writeUByte(l.panningEnvelope.count||0),c.writeUByte(l.volumeEnvelope.sustainPoint||0),c.writeUByte(l.volumeEnvelope.loopStartPoint||0),c.writeUByte(l.volumeEnvelope.loopEndPoint||0),c.writeUByte(l.panningEnvelope.sustainPoint||0),c.writeUByte(l.panningEnvelope.loopStartPoint||0),c.writeUByte(l.panningEnvelope.loopEndPoint||0),c.writeUByte(b),c.writeUByte(E),c.writeUByte(l.vibrato.type||0),c.writeUByte(l.vibrato.sweep||0),c.writeUByte(l.vibrato.depth||0),c.writeUByte(l.vibrato.rate||0),c.writeWord(l.fadeout||0),c.writeWord(0);for(var I=0;I<l.numberOfSamples;I++){var k=l.samples[I],S=0;2<k.loop.length&&k.loop.enabled&&(S=1);var C=k.length,y=k.loop.start,x=k.loop.length;16===k.bits&&(S+=16,C*=2,y*=2,x*=2),c.writeDWord(C),c.writeDWord(y),c.writeDWord(x),c.writeUByte(k.volume),c.writeByte(k.finetuneX),c.writeUByte(S),c.writeUByte((k.panning||0)+128),c.writeUByte(k.relativeNote||0),c.writeUByte(0),c.writeStringSection(k.name||"",22)}for(I=0;I<l.numberOfSamples;I++){var P,A=0,U=0;if(16===(k=l.samples[I]).bits)for(w=0,g=k.length;w<g;w++)A=(P=Math.round(32768*k.data[w]))-U,U=P,A<-32768?A+=65536:32767<A&&(A-=65536),c.writeWord(A);else for(w=0,g=k.length;w<g;w++)A=(P=Math.round(127*k.data[w]))-U,U=P,A<-128?A+=256:127<A&&(A-=256),c.writeByte(A)}}else c.writeDWord(29),c.writeStringSection(l?l.name:"",22),c.writeUByte(0),c.writeWord(0);e&&e(c)},validate:function(e){function r(e,t){var n=!0;if(e.points&&e.points[0])if(0===e.points[0][0])for(var a=0,r=1;r<e.count;r++){var i=e.points[r];i&&a<i[0]?a=i[0]:n=!1}else n=!1;else n=!1;return n?e:"volume"===t?{raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6}:{raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5}}e.instruments.forEach(function(e){e.volumeEnvelope=r(e.volumeEnvelope,"volume"),e.panningEnvelope=r(e.panningEnvelope,"panning");for(var t=e.samples.length-1,n=0,a=e.sampleNumberForNotes.length;n<a;n++)e.sampleNumberForNotes[n]=Math.min(e.sampleNumberForNotes[n],t)})}};return y},ProTracker=function(){var e={load:function(e,t){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER,!0),Tracker.useLinearFrequency=!1,Tracker.clearInstruments(31);var n={patterns:[],restartPosition:1},a=4;n.typeId=e.readString(4,1080),n.title=e.readString(20,0),"2CHN"===n.typeId&&(a=2),"3CHN"===n.typeId&&(a=3),"5CHN"===n.typeId&&(a=5),"6CHN"===n.typeId&&(a=6),"7CHN"===n.typeId&&(a=7),"8CHN"===n.typeId&&(a=8),"9CHN"===n.typeId&&(a=9),"10CH"===n.typeId&&(a=10),"11CH"===n.typeId&&(a=11),"12CH"===n.typeId&&(a=12),"13CH"===n.typeId&&(a=13),"14CH"===n.typeId&&(a=14),"15CH"===n.typeId&&(a=15),"16CH"===n.typeId&&(a=16),"18CH"===n.typeId&&(a=18),"20CH"===n.typeId&&(a=20),"22CH"===n.typeId&&(a=22),"24CH"===n.typeId&&(a=24),"26CH"===n.typeId&&(a=26),"28CH"===n.typeId&&(a=28),"30CH"===n.typeId&&(a=30),"32CH"===n.typeId&&(a=32),n.channels=a;var r=0;for(d=1;d<=31;++d){var i=e.readString(22),o=e.readWord(),s=Instrument();s.name=i,s.sample.length=s.sample.realLen=o<<1;var l=e.readUbyte();16<l&&(l%=16),7<l&&(l-=16),s.setFineTune(l),s.sample.volume=e.readUbyte(),s.sample.loop.start=e.readWord()<<1,s.sample.loop.length=e.readWord()<<1,s.sample.loop.enabled=2<s.sample.loop.length,s.sample.loop.type=LOOPTYPE.FORWARD,s.pointer=r,r+=s.sample.length,s.setSampleIndex(0),Tracker.setInstrument(d,s)}n.instruments=Tracker.getInstruments(),e.goto(950),n.length=e.readUbyte(),e.jump(1);for(var c=[],u=0,d=0;d<128;++d)c[d]=e.readUbyte(),u<c[d]&&(u=c[d]);for(n.patternTable=c,e.goto(1084),d=0;d<=u;++d){for(var h=[],f=0;f<64;f++){var g,p=[];for(g=0;g<a;g++){var m=Note(),v=e.readUint();m.setPeriod(v>>16&4095),m.effect=v>>8&15,m.instrument=v>>24&240|v>>12&15,m.param=255&v,p.push(m)}for(g=a;g<Tracker.getTrackCount();g++)p.push(Note());h.push(p)}n.patterns.push(h)}var b=[];for(d=1;d<=31;d++)if(s=Tracker.getInstrument(d)){var E=s.sample.length;for(2<s.sample.loop.length&&SETTINGS.unrollShortLoops&&s.sample.loop.length<1e3&&(E=Math.min(E,s.sample.loop.start+s.sample.loop.length),s.sample.length=E),j=0;j<E;j++){var w=e.readByte();j<2&&(w=0),s.sample.data.push(w/127)}if((SETTINGS.unrollShortLoops||SETTINGS.unrollLoops)&&2<s.sample.loop.length){var T=Math.ceil(4e4/s.sample.loop.length)+1;SETTINGS.unrollLoops||(T=0);var I=!1,k=0;SETTINGS.unrollShortLoops&&s.sample.loop.length<1600&&(T=Math.floor(1e3/s.sample.loop.length),I=!0);for(var S=0;S<T;S++){var C=s.sample.loop.start,y=C+s.sample.loop.length;for(j=C;j<y;j++)s.sample.data.push(s.sample.data[j]);k+=s.sample.loop.length}I&&k&&(s.sample.loop.length+=k,s.sample.length+=k)}b.push({label:d+" "+s.name,data:d})}return EventBus.trigger(EVENT.instrumentListChange,b),n},write:function(e){var t=Tracker.getSong(),n=Tracker.getInstruments(),a=Tracker.getTrackCount(),r=Tracker.getPatternLength(),i=1084,o=0;for(l=0;l<128;l++){var s=t.patternTable[l]||0;o=Math.max(o,s)}i+=(o+1)*(256*a),32<Tracker.getInstruments().length&&UI.showDialog("WARNING !!!//This file has more than 31 instruments.//Only the first 31 instruments will be included.");var l;for(l=1;l<=31;l++){(v=n[l])&&(v.setSampleIndex(0),i+=v.sample.length)}var c=new BinaryStream(new ArrayBuffer(i),!0);for(c.writeStringSection(t.title,20),l=1;l<=31;l++){(v=n[l])?(v.sample.length=Math.min(v.sample.length,131070),c.writeStringSection(v.name,22),c.writeWord(v.sample.length>>1),c.writeUByte(v.sample.finetune),c.writeUByte(v.sample.volume),c.writeWord(v.sample.loop.start>>1),c.writeWord(v.sample.loop.length>>1)):c.clear(30)}for(c.writeUByte(t.length),c.writeUByte(127),l=0;l<128;l++){c.writeUByte(s=t.patternTable[l]||0)}for(c.writeString(8==a?"8CHN":"M.K."),l=0;l<=o;l++)for(var u=t.patterns[l],d=0;d<r;d++)for(var h=u[d],f=0;f<a;f++)if(h){var g=h[f],p=0,m=g.instrument;15<m&&(m=g.instrument-(p=16)),c.writeUint((p<<24)+(g.period<<16)+(m<<12)+(g.effect<<8)+g.param)}else c.writeUint(0);for(l=1;l<=31;l++){var v;if((v=n[l])&&v.sample.data&&v.sample.length)for(var b=0;b<v.sample.length;b++)c.writeByte(Math.round(127*(v.sample.data[b]||0)))}e&&e(c)}};return e},SoundTracker=function(){var e={load:function(e,t){Tracker.setTrackerMode(TRACKERMODE.PROTRACKER,!0),Tracker.useLinearFrequency=!1,Tracker.clearInstruments(15);var n={patterns:[],restartPosition:1};n.typeId="ST",n.channels=4,n.title=e.readString(20,0);var a=0;for(c=1;c<=15;++c){var r=e.readString(22),i=e.readWord(),o=Instrument();o.name=r,o.sample.length=o.realLen=i<<1,o.sample.volume=e.readWord(),o.setFineTune(0),o.sample.loop.start=e.readWord(),o.sample.loop.length=e.readWord()<<1,o.sample.loop.enabled=2<o.sample.loop.length,o.sample.loop.type=LOOPTYPE.FORWARD,o.pointer=a,a+=o.sample.length,o.setSampleIndex(0),Tracker.setInstrument(c,o)}n.instruments=Tracker.getInstruments(),e.goto(470),n.length=e.readUbyte(),n.speed=e.readUbyte();for(var s=[],l=0,c=0;c<128;++c)s[c]=e.readUbyte(),l<s[c]&&(l=s[c]);for(n.patternTable=s,e.goto(600),c=0;c<=l;++c){for(var u=[],d=0;d<64;d++){var h,f=[];for(h=0;h<4;h++){var g={},p=e.readUint();g.period=p>>16&4095,g.effect=p>>8&15,g.instrument=p>>24&240|p>>12&15,g.param=255&p,f.push(g)}for(h=4;h<Tracker.getTrackCount();h++)f.push({note:0,effect:0,instrument:0,param:0});u.push(f)}n.patterns.push(u)}var m=[];for(c=1;c<=15;c++)if(o=Tracker.getInstrument(c)){var v=o.sample.length;for(j=0;j<v;j++){var b=e.readByte();j<2&&(b=0),o.sample.data.push(b/127)}m.push({label:c+" "+o.name,data:c})}return EventBus.trigger(EVENT.instrumentListChange,m),n}};return e};!function(e){"use strict";function de(){function l(e,t){for(var n=0;n|=1&e,e>>>=1,n<<=1,0<--t;);return n>>>1}var f=this;f.build_tree=function(e){var t,n,a,r=f.dyn_tree,i=f.stat_desc.static_tree,o=f.stat_desc.elems,s=-1;for(e.heap_len=0,e.heap_max=p,t=0;t<o;t++)0!==r[2*t]?(e.heap[++e.heap_len]=s=t,e.depth[t]=0):r[2*t+1]=0;for(;e.heap_len<2;)r[2*(a=e.heap[++e.heap_len]=s<2?++s:0)]=1,e.depth[a]=0,e.opt_len--,i&&(e.static_len-=i[2*a+1]);for(f.max_code=s,t=Math.floor(e.heap_len/2);1<=t;t--)e.pqdownheap(r,t);for(a=o;t=e.heap[1],e.heap[1]=e.heap[e.heap_len--],e.pqdownheap(r,1),n=e.heap[1],e.heap[--e.heap_max]=t,e.heap[--e.heap_max]=n,r[2*a]=r[2*t]+r[2*n],e.depth[a]=Math.max(e.depth[t],e.depth[n])+1,r[2*t+1]=r[2*n+1]=a,e.heap[1]=a++,e.pqdownheap(r,1),2<=e.heap_len;);e.heap[--e.heap_max]=e.heap[1],function(e){var t,n,a,r,i,o,s=f.dyn_tree,l=f.stat_desc.static_tree,c=f.stat_desc.extra_bits,u=f.stat_desc.extra_base,d=f.stat_desc.max_length,h=0;for(r=0;r<=g;r++)e.bl_count[r]=0;for(s[2*e.heap[e.heap_max]+1]=0,t=e.heap_max+1;t<p;t++)d<(r=s[2*s[2*(n=e.heap[t])+1]+1]+1)&&(r=d,h++),s[2*n+1]=r,f.max_code<n||(e.bl_count[r]++,i=0,u<=n&&(i=c[n-u]),e.opt_len+=(o=s[2*n])*(r+i),l&&(e.static_len+=o*(l[2*n+1]+i)));if(0!==h){do{for(r=d-1;0===e.bl_count[r];)r--;e.bl_count[r]--,e.bl_count[r+1]+=2,e.bl_count[d]--,h-=2}while(0<h);for(r=d;0!==r;r--)for(n=e.bl_count[r];0!==n;)a=e.heap[--t],f.max_code<a||(s[2*a+1]!=r&&(e.opt_len+=(r-s[2*a+1])*s[2*a],s[2*a+1]=r),n--)}}(e),function(e,t,n){var a,r,i,o=[],s=0;for(a=1;a<=g;a++)o[a]=s=s+n[a-1]<<1;for(r=0;r<=t;r++)0!==(i=e[2*r+1])&&(e[2*r]=l(o[i]++,i))}(r,f.max_code,e.bl_count)}}function he(e,t,n,a,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=a,this.max_length=r}function t(e,t,n,a,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=a,this.func=r}function fe(e,t,n,a){var r=e[2*t],i=e[2*n];return r<i||r==i&&a[t]<=a[n]}function n(){function o(){var e;for(e=0;e<286;e++)Z[2*e]=0;for(e=0;e<30;e++)J[2*e]=0;for(e=0;e<19;e++)$[2*e]=0;Z[512]=1,se.opt_len=se.static_len=0,ne=i=0}function s(e,t){var n,a,r=-1,i=e[1],o=0,s=7,l=4;for(0===i&&(s=138,l=3),e[2*(t+1)+1]=65535,n=0;n<=t;n++)a=i,i=e[2*(n+1)+1],++o<s&&a==i||(o<l?$[2*a]+=o:0!==a?(a!=r&&$[2*a]++,$[32]++):o<=10?$[34]++:$[36]++,r=a,l=(o=0)===i?(s=138,3):a==i?(s=6,3):(s=7,4))}function l(e){se.pending_buf[se.pending++]=e}function c(e){l(255&e),l(e>>>8&255)}function u(e,t){var n,a=t;16-a<oe?(c(ie|=(n=e)<<oe&65535),ie=n>>>16-oe,oe+=a-16):(ie|=e<<oe&65535,oe+=a)}function d(e,t){var n=2*e;u(65535&t[n],65535&t[1+n])}function h(e,t){var n,a,r=-1,i=e[1],o=0,s=7,l=4;for(0===i&&(s=138,l=3),n=0;n<=t;n++)if(a=i,i=e[2*(n+1)+1],!(++o<s&&a==i)){if(o<l)for(;d(a,$),0!=--o;);else 0!==a?(a!=r&&(d(a,$),o--),d(16,$),u(o-3,2)):o<=10?(d(17,$),u(o-3,3)):(d(18,$),u(o-11,7));r=a,l=(o=0)===i?(s=138,3):a==i?(s=6,3):(s=7,4)}}function f(){16==oe?(c(ie),oe=ie=0):8<=oe&&(l(255&ie),ie>>>=8,oe-=8)}function g(e,t){var n,a,r;if(se.pending_buf[ae+2*ne]=e>>>8&255,se.pending_buf[ae+2*ne+1]=255&e,se.pending_buf[ee+ne]=255&t,ne++,0===e?Z[2*t]++:(i++,e--,Z[2*(de._length_code[t]+256+1)]++,J[2*de.d_code(e)]++),0==(8191&ne)&&2<X){for(n=8*ne,a=Y-B,r=0;r<30;r++)n+=J[2*r]*(5+de.extra_dbits[r]);if(n>>>=3,i<Math.floor(ne/2)&&n<Math.floor(a/2))return!0}return ne==te-1}function p(e,t){var n,a,r,i,o=0;if(0!==ne)for(;n=se.pending_buf[ae+2*o]<<8&65280|255&se.pending_buf[ae+2*o+1],a=255&se.pending_buf[ee+o],o++,0===n?d(a,e):(d((r=de._length_code[a])+256+1,e),0!==(i=de.extra_lbits[r])&&u(a-=de.base_length[r],i),d(r=de.d_code(--n),t),0!==(i=de.extra_dbits[r])&&u(n-=de.base_dist[r],i)),o<ne;);d(256,e),re=e[513]}function m(){8<oe?c(ie):0<oe&&l(255&ie),oe=ie=0}function v(e,t,n){var a,r,i;u(0+(n?1:0),3),a=e,r=t,i=!0,m(),re=8,i&&(c(r),c(~r)),se.pending_buf.set(A.subarray(a,a+r),se.pending),se.pending+=r}function t(e,t,n){var a,r,i=0;0<X?(le.build_tree(se),ce.build_tree(se),i=function(){var e;for(s(Z,le.max_code),s(J,ce.max_code),ue.build_tree(se),e=18;3<=e&&0===$[2*de.bl_order[e]+1];e--);return se.opt_len+=3*(e+1)+5+5+4,e}(),(r=se.static_len+3+7>>>3)<=(a=se.opt_len+3+7>>>3)&&(a=r)):a=r=t+5,t+4<=a&&-1!=e?v(e,t,n):r==a?(u(2+(n?1:0),3),p(he.static_ltree,he.static_dtree)):(u(4+(n?1:0),3),function(e,t,n){var a;for(u(e-257,5),u(t-1,5),u(n-4,4),a=0;a<n;a++)u($[2*de.bl_order[a]+1],3);h(Z,e-1),h(J,t-1)}(le.max_code+1,ce.max_code+1,i+1),p(Z,J)),o(),n&&m()}function b(e){t(0<=B?B:-1,Y-B,e),B=Y,I.flush_pending()}function E(){var e,t,n,a;do{if(0===(a=r-K-Y)&&0===Y&&0===K)a=y;else if(-1==a)a--;else if(y+y-262<=Y){for(A.set(A.subarray(y,y+y),0),W-=y,Y-=y,B-=y,n=e=L;t=65535&M[--n],M[n]=y<=t?t-y:0,0!=--e;);for(n=e=y;t=65535&U[--n],U[n]=y<=t?t-y:0,0!=--e;);a+=y}if(0===I.avail_in)return;e=I.read_buf(A,Y+K,a),3<=(K+=e)&&(_=((_=255&A[Y])<<N^255&A[Y+1])&O)}while(K<262&&0!==I.avail_in)}function w(e){var t,n,a=G,r=Y,i=z,o=y-262<Y?Y-(y-262):0,s=Q,l=P,c=Y+258,u=A[r+i-1],d=A[r+i];q<=z&&(a>>=2),K<s&&(s=K);do{if(A[(t=e)+i]==d&&A[t+i-1]==u&&A[t]==A[r]&&A[++t]==A[r+1]){r+=2,t++;do{}while(A[++r]==A[++t]&&A[++r]==A[++t]&&A[++r]==A[++t]&&A[++r]==A[++t]&&A[++r]==A[++t]&&A[++r]==A[++t]&&A[++r]==A[++t]&&A[++r]==A[++t]&&r<c);if(n=258-(c-r),r=c-258,i<n){if(W=e,s<=(i=n))break;u=A[r+i-1],d=A[r+i]}}}while((e=65535&U[e&l])>o&&0!=--a);return i<=K?i:K}function T(e){return e.total_in=e.total_out=0,e.msg=null,se.pending=0,k=113,C=se.pending_out=0,le.dyn_tree=Z,le.stat_desc=he.static_l_desc,ce.dyn_tree=J,ce.stat_desc=he.static_d_desc,ue.dyn_tree=$,ue.stat_desc=he.static_bl_desc,oe=ie=0,re=8,o(),function(){var e;for(r=2*y,e=M[L-1]=0;e<L-1;e++)M[e]=0;H=ge[X].max_lazy,q=ge[X].good_length,Q=ge[X].nice_length,G=ge[X].max_chain,R=z=2,_=F=K=B=Y=0}(),0}var I,k,S,C,y,x,P,A,r,U,M,_,L,D,O,N,B,R,V,F,Y,W,K,z,G,H,X,j,q,Q,Z,J,$,ee,te,ne,ae,i,re,ie,oe,se=this,le=new de,ce=new de,ue=new de;se.depth=[],se.bl_count=[],se.heap=[],Z=[],J=[],$=[],se.pqdownheap=function(e,t){for(var n=se.heap,a=n[t],r=t<<1;r<=se.heap_len&&(r<se.heap_len&&fe(e,n[r+1],n[r],se.depth)&&r++,!fe(e,a,n[r],se.depth));)n[t]=n[r],t=r,r<<=1;n[t]=a},se.deflateInit=function(e,t,n,a,r,i){return a=a||8,r=r||8,i=i||0,e.msg=null,-1==t&&(t=6),r<1||9<r||8!=a||n<9||15<n||t<0||9<t||i<0||2<i?-2:(e.dstate=se,P=(y=1<<(x=n))-1,O=(L=1<<(D=r+7))-1,N=Math.floor((D+3-1)/3),A=new Uint8Array(2*y),U=[],M=[],te=1<<r+6,se.pending_buf=new Uint8Array(4*te),S=4*te,ae=Math.floor(te/2),ee=3*te,X=t,j=i,T(e))},se.deflateEnd=function(){return 42!=k&&113!=k&&666!=k?-2:(se.pending_buf=null,se.dstate=A=U=M=null,113==k?-3:0)},se.deflateParams=function(e,t,n){var a=0;return-1==t&&(t=6),t<0||9<t||n<0||2<n?-2:(ge[X].func!=ge[t].func&&0!==e.total_in&&(a=e.deflate(1)),X!=t&&(H=ge[X=t].max_lazy,q=ge[X].good_length,Q=ge[X].nice_length,G=ge[X].max_chain),j=n,a)},se.deflateSetDictionary=function(e,t,n){var a,r=n,i=0;if(!t||42!=k)return-2;if(r<3)return 0;for(y-262<r&&(i=n-(r=y-262)),A.set(t.subarray(i,i+r),0),B=Y=r,_=((_=255&A[0])<<N^255&A[1])&O,a=0;a<=r-3;a++)U[a&P]=M[_=(_<<N^255&A[a+2])&O],M[_]=a;return 0},se.deflate=function(e,t){var n,a,r,i,o,s;if(4<t||t<0)return-2;if(!e.next_out||!e.next_in&&0!==e.avail_in||666==k&&4!=t)return e.msg=pe[4],-2;if(0===e.avail_out)return e.msg=pe[7],-5;if(I=e,i=C,C=t,42==k&&(a=8+(x-8<<4)<<8,3<(r=(X-1&255)>>1)&&(r=3),a|=r<<6,0!==Y&&(a|=32),k=113,l((s=a+=31-a%31)>>8&255),l(255&s)),0!==se.pending){if(I.flush_pending(),0===I.avail_out)return C=-1,0}else if(0===I.avail_in&&t<=i&&4!=t)return I.msg=pe[7],-5;if(666==k&&0!==I.avail_in)return e.msg=pe[7],-5;if(0!==I.avail_in||0!==K||0!=t&&666!=k){switch(o=-1,ge[X].func){case 0:o=function(e){var t,n=65535;for(S-5<n&&(n=S-5);;){if(K<=1){if(E(),0===K&&0==e)return 0;if(0===K)break}if(Y+=K,t=B+n,((K=0)===Y||t<=Y)&&(K=Y-t,Y=t,b(!1),0===I.avail_out))return 0;if(y-262<=Y-B&&(b(!1),0===I.avail_out))return 0}return b(4==e),0===I.avail_out?4==e?2:0:4==e?3:1}(t);break;case 1:o=function(e){for(var t,n=0;;){if(K<262){if(E(),K<262&&0==e)return 0;if(0===K)break}if(3<=K&&(n=65535&M[_=(_<<N^255&A[Y+2])&O],U[Y&P]=M[_],M[_]=Y),0!==n&&(Y-n&65535)<=y-262&&2!=j&&(R=w(n)),3<=R)if(t=g(Y-W,R-3),K-=R,R<=H&&3<=K){for(R--;n=65535&M[_=(_<<N^255&A[++Y+2])&O],U[Y&P]=M[_],M[_]=Y,0!=--R;);Y++}else Y+=R,R=0,_=((_=255&A[Y])<<N^255&A[Y+1])&O;else t=g(0,255&A[Y]),K--,Y++;if(t&&(b(!1),0===I.avail_out))return 0}return b(4==e),0===I.avail_out?4==e?2:0:4==e?3:1}(t);break;case 2:o=function(e){for(var t,n,a=0;;){if(K<262){if(E(),K<262&&0==e)return 0;if(0===K)break}if(3<=K&&(a=65535&M[_=(_<<N^255&A[Y+2])&O],U[Y&P]=M[_],M[_]=Y),z=R,V=W,R=2,0!==a&&z<H&&(Y-a&65535)<=y-262&&(2!=j&&(R=w(a)),R<=5&&(1==j||3==R&&4096<Y-W)&&(R=2)),3<=z&&R<=z){for(n=Y+K-3,t=g(Y-1-V,z-3),K-=z-1,z-=2;++Y<=n&&(a=65535&M[_=(_<<N^255&A[Y+2])&O],U[Y&P]=M[_],M[_]=Y),0!=--z;);if(F=0,R=2,Y++,t&&(b(!1),0===I.avail_out))return 0}else if(0!==F){if((t=g(0,255&A[Y-1]))&&b(!1),Y++,K--,0===I.avail_out)return 0}else F=1,Y++,K--}return 0!==F&&(t=g(0,255&A[Y-1]),F=0),b(4==e),0===I.avail_out?4==e?2:0:4==e?3:1}(t)}if(2!=o&&3!=o||(k=666),0==o||2==o)return 0===I.avail_out&&(C=-1),0;if(1==o){if(1==t)u(2,3),d(256,he.static_ltree),f(),1+re+10-oe<9&&(u(2,3),d(256,he.static_ltree),f()),re=7;else if(v(0,0,!1),3==t)for(n=0;n<L;n++)M[n]=0;if(I.flush_pending(),0===I.avail_out)return C=-1,0}}return 4!=t?0:1}}function a(){this.next_in_index=0,this.next_out_index=0,this.avail_in=0,this.total_in=0,this.avail_out=0,this.total_out=0}var g=15,p=573,r=[0,1,2,3,4,4,5,5,6,6,6,6,7,7,7,7,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,15,0,0,16,17,18,18,19,19,20,20,20,20,21,21,21,21,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29];de._length_code=[0,1,2,3,4,5,6,7,8,8,9,9,10,10,11,11,12,12,12,12,13,13,13,13,14,14,14,14,15,15,15,15,16,16,16,16,16,16,16,16,17,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,25,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,27,28],de.base_length=[0,1,2,3,4,5,6,7,8,10,12,14,16,20,24,28,32,40,48,56,64,80,96,112,128,160,192,224,0],de.base_dist=[0,1,2,3,4,6,8,12,16,24,32,48,64,96,128,192,256,384,512,768,1024,1536,2048,3072,4096,6144,8192,12288,16384,24576],de.d_code=function(e){return e<256?r[e]:r[256+(e>>>7)]},de.extra_lbits=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],de.extra_dbits=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],de.extra_blbits=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],de.bl_order=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],he.static_ltree=[12,8,140,8,76,8,204,8,44,8,172,8,108,8,236,8,28,8,156,8,92,8,220,8,60,8,188,8,124,8,252,8,2,8,130,8,66,8,194,8,34,8,162,8,98,8,226,8,18,8,146,8,82,8,210,8,50,8,178,8,114,8,242,8,10,8,138,8,74,8,202,8,42,8,170,8,106,8,234,8,26,8,154,8,90,8,218,8,58,8,186,8,122,8,250,8,6,8,134,8,70,8,198,8,38,8,166,8,102,8,230,8,22,8,150,8,86,8,214,8,54,8,182,8,118,8,246,8,14,8,142,8,78,8,206,8,46,8,174,8,110,8,238,8,30,8,158,8,94,8,222,8,62,8,190,8,126,8,254,8,1,8,129,8,65,8,193,8,33,8,161,8,97,8,225,8,17,8,145,8,81,8,209,8,49,8,177,8,113,8,241,8,9,8,137,8,73,8,201,8,41,8,169,8,105,8,233,8,25,8,153,8,89,8,217,8,57,8,185,8,121,8,249,8,5,8,133,8,69,8,197,8,37,8,165,8,101,8,229,8,21,8,149,8,85,8,213,8,53,8,181,8,117,8,245,8,13,8,141,8,77,8,205,8,45,8,173,8,109,8,237,8,29,8,157,8,93,8,221,8,61,8,189,8,125,8,253,8,19,9,275,9,147,9,403,9,83,9,339,9,211,9,467,9,51,9,307,9,179,9,435,9,115,9,371,9,243,9,499,9,11,9,267,9,139,9,395,9,75,9,331,9,203,9,459,9,43,9,299,9,171,9,427,9,107,9,363,9,235,9,491,9,27,9,283,9,155,9,411,9,91,9,347,9,219,9,475,9,59,9,315,9,187,9,443,9,123,9,379,9,251,9,507,9,7,9,263,9,135,9,391,9,71,9,327,9,199,9,455,9,39,9,295,9,167,9,423,9,103,9,359,9,231,9,487,9,23,9,279,9,151,9,407,9,87,9,343,9,215,9,471,9,55,9,311,9,183,9,439,9,119,9,375,9,247,9,503,9,15,9,271,9,143,9,399,9,79,9,335,9,207,9,463,9,47,9,303,9,175,9,431,9,111,9,367,9,239,9,495,9,31,9,287,9,159,9,415,9,95,9,351,9,223,9,479,9,63,9,319,9,191,9,447,9,127,9,383,9,255,9,511,9,0,7,64,7,32,7,96,7,16,7,80,7,48,7,112,7,8,7,72,7,40,7,104,7,24,7,88,7,56,7,120,7,4,7,68,7,36,7,100,7,20,7,84,7,52,7,116,7,3,8,131,8,67,8,195,8,35,8,163,8,99,8,227,8],he.static_dtree=[0,5,16,5,8,5,24,5,4,5,20,5,12,5,28,5,2,5,18,5,10,5,26,5,6,5,22,5,14,5,30,5,1,5,17,5,9,5,25,5,5,5,21,5,13,5,29,5,3,5,19,5,11,5,27,5,7,5,23,5],he.static_l_desc=new he(he.static_ltree,de.extra_lbits,257,286,g),he.static_d_desc=new he(he.static_dtree,de.extra_dbits,0,30,g),he.static_bl_desc=new he(null,de.extra_blbits,0,19,7);var ge=[new t(0,0,0,0,0),new t(4,4,8,4,1),new t(4,5,16,8,1),new t(4,6,32,32,1),new t(4,4,16,16,2),new t(8,16,32,32,2),new t(8,16,128,128,2),new t(8,32,128,256,2),new t(32,128,258,1024,2),new t(32,258,258,4096,2)],pe=["need dictionary","stream end","","","stream error","data error","","buffer error","",""];a.prototype={deflateInit:function(e,t){return this.dstate=new n,this.dstate.deflateInit(this,e,t=t||g)},deflate:function(e){return this.dstate?this.dstate.deflate(this,e):-2},deflateEnd:function(){if(!this.dstate)return-2;var e=this.dstate.deflateEnd();return this.dstate=null,e},deflateParams:function(e,t){return this.dstate?this.dstate.deflateParams(this,e,t):-2},deflateSetDictionary:function(e,t){return this.dstate?this.dstate.deflateSetDictionary(this,e,t):-2},read_buf:function(e,t,n){var a=this.avail_in;return n<a&&(a=n),0===a?0:(this.avail_in-=a,e.set(this.next_in.subarray(this.next_in_index,this.next_in_index+a),t),this.next_in_index+=a,this.total_in+=a,a)},flush_pending:function(){var e=this,t=e.dstate.pending;e.avail_out<t&&(t=e.avail_out),0!==t&&(e.next_out.set(e.dstate.pending_buf.subarray(e.dstate.pending_out,e.dstate.pending_out+t),e.next_out_index),e.next_out_index+=t,e.dstate.pending_out+=t,e.total_out+=t,e.avail_out-=t,e.dstate.pending-=t,0===e.dstate.pending&&(e.dstate.pending_out=0))}};var i=e.zip||e;i.Deflater=i._jzlib_Deflater=function(e){var s=new a,l=new Uint8Array(512),t=e?e.level:-1;void 0===t&&(t=-1),s.deflateInit(t),s.next_out=l,this.append=function(e,t){var n,a=[],r=0,i=0,o=0;if(e.length){s.next_in_index=0,s.next_in=e,s.avail_in=e.length;do{if(s.next_out_index=0,s.avail_out=512,0!=s.deflate(0))throw new Error("deflating: "+s.msg);s.next_out_index&&a.push(512==s.next_out_index?new Uint8Array(l):new Uint8Array(l.subarray(0,s.next_out_index))),o+=s.next_out_index,t&&0<s.next_in_index&&s.next_in_index!=r&&(t(s.next_in_index),r=s.next_in_index)}while(0<s.avail_in||0===s.avail_out);return n=new Uint8Array(o),a.forEach(function(e){n.set(e,i),i+=e.length}),n}},this.flush=function(){var e,t,n=[],a=0,r=0;do{if(s.next_out_index=0,s.avail_out=512,1!=(e=s.deflate(4))&&0!=e)throw new Error("deflating: "+s.msg);0<512-s.avail_out&&n.push(new Uint8Array(l.subarray(0,s.next_out_index))),r+=s.next_out_index}while(0<s.avail_in||0===s.avail_out);return s.deflateEnd(),t=new Uint8Array(r),n.forEach(function(e){t.set(e,a),a+=e.length}),t}}}(this),function(e){"use strict";function _(){function u(e,t,n,a,r,i,o,s,l,c,u){var d,h,f,g,p,m,v,b,E,w,T,I,k,S,C;for(w=0,p=n;y[e[t+w]]++,w++,0!==--p;);if(y[0]==n)return o[0]=-1,s[0]=0,L;for(b=s[0],m=1;m<=U&&0===y[m];m++);for(b<(v=m)&&(b=m),p=U;0!==p&&0===y[p];p--);for((f=p)<b&&(b=p),s[0]=b,S=1<<m;m<p;m++,S<<=1)if((S-=y[m])<0)return N;if((S-=y[p])<0)return N;for(y[p]+=S,A[1]=m=0,w=1,k=2;0!=--p;)A[k]=m+=y[w],k++,w++;for(w=p=0;0!==(m=e[t+w])&&(u[A[m]++]=p),w++,++p<n;);for(n=A[f],A[0]=p=0,g=-1,I=-b,C=T=P[w=0]=0;v<=f;v++)for(d=y[v];0!=d--;){for(;I+b<v;){if(g++,C=b<(C=f-(I+=b))?b:C,(h=1<<(m=v-I))>d+1&&(h-=d+1,k=v,m<C))for(;++m<C&&!((h<<=1)<=y[++k]);)h-=y[k];if(V<c[0]+(C=1<<m))return N;P[g]=T=c[0],c[0]+=C,0!==g?(A[g]=p,x[0]=m,x[1]=b,x[2]=T-P[g-1]-(m=p>>>I-b),l.set(x,3*(P[g-1]+m))):o[0]=T}for(x[1]=v-I,n<=w?x[0]=192:u[w]<a?(x[0]=u[w]<256?0:96,x[2]=u[w++]):(x[0]=i[u[w]-a]+16+64,x[2]=r[u[w++]-a]),h=1<<v-I,m=p>>>I;m<C;m+=h)l.set(x,3*(T+m));for(m=1<<v-1;0!=(p&m);m>>>=1)p^=m;for(p^=m,E=(1<<I)-1;(p&E)!=A[g];)g--,E=(1<<(I-=b))-1}return 0!==S&&1!=f?B:L}function d(e){var t;for(h||(h=[],f=[],y=new Int32Array(U+1),x=[],P=new Int32Array(U),A=new Int32Array(U+1)),f.length<e&&(f=[]),t=0;t<e;t++)f[t]=0;for(t=0;t<U+1;t++)y[t]=0;for(t=0;t<3;t++)x[t]=0;P.set(y.subarray(0,U),0),A.set(y.subarray(0,U+1),0)}var h,f,y,x,P,A;this.inflate_trees_bits=function(e,t,n,a,r){var i;return d(19),(i=u(e,h[0]=0,19,19,null,null,n,t,a,h,f))==N?r.msg="oversubscribed dynamic bit lengths tree":i!=B&&0!==t[0]||(r.msg="incomplete dynamic bit lengths tree",i=N),i},this.inflate_trees_dynamic=function(e,t,n,a,r,i,o,s,l){var c;return d(288),(c=u(n,h[0]=0,e,257,p,m,i,a,s,h,f))!=L||0===a[0]?(c==N?l.msg="oversubscribed literal/length tree":c!=g&&(l.msg="incomplete literal/length tree",c=N),c):(d(288),(c=u(n,e,t,0,v,b,o,r,s,h,f))!=L||0===r[0]&&257<e?(c==N?l.msg="oversubscribed distance tree":c==B?(l.msg="incomplete distance tree",c=N):c!=g&&(l.msg="empty distance tree with lengths",c=N),c):L)}}function n(){function f(e,t,n,a,r,i,o,s){var l,c,u,d,h,f,g,p,m,v,b,E,w,T,I,k;g=s.next_in_index,p=s.avail_in,h=o.bitb,f=o.bitk,v=(m=o.write)<o.read?o.read-m-1:o.end-m,b=R[e],E=R[t];do{for(;f<20;)p--,h|=(255&s.read_byte(g++))<<f,f+=8;if(0!==(d=(c=n)[k=3*((u=a)+(l=h&b))]))for(;;){if(h>>=c[k+1],f-=c[k+1],0!=(16&d)){for(w=c[k+2]+(h&R[d&=15]),h>>=d,f-=d;f<15;)p--,h|=(255&s.read_byte(g++))<<f,f+=8;for(d=(c=r)[k=3*((u=i)+(l=h&E))];;){if(h>>=c[k+1],f-=c[k+1],0!=(16&d)){for(d&=15;f<d;)p--,h|=(255&s.read_byte(g++))<<f,f+=8;if(T=c[k+2]+(h&R[d]),h>>=d,f-=d,v-=w,T<=m)0<m-(I=m-T)&&m-I<2?(o.window[m++]=o.window[I++],o.window[m++]=o.window[I++]):(o.window.set(o.window.subarray(I,I+2),m),m+=2,I+=2),w-=2;else{for(I=m-T;(I+=o.end)<0;);if((d=o.end-I)<w){if(w-=d,0<m-I&&m-I<d)for(;o.window[m++]=o.window[I++],0!=--d;);else o.window.set(o.window.subarray(I,I+d),m),m+=d,I+=d,d=0;I=0}}if(0<m-I&&m-I<w)for(;o.window[m++]=o.window[I++],0!=--w;);else o.window.set(o.window.subarray(I,I+w),m),m+=w,I+=w,w=0;break}if(0!=(64&d))return s.msg="invalid distance code",p+=w=f>>3<(w=s.avail_in-p)?f>>3:w,g-=w,f-=w<<3,o.bitb=h,o.bitk=f,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,N;l+=c[k+2],d=c[k=3*(u+(l+=h&R[d]))]}break}if(0!=(64&d))return 0!=(32&d)?(p+=w=f>>3<(w=s.avail_in-p)?f>>3:w,g-=w,f-=w<<3,o.bitb=h,o.bitk=f,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,D):(s.msg="invalid literal/length code",p+=w=f>>3<(w=s.avail_in-p)?f>>3:w,g-=w,f-=w<<3,o.bitb=h,o.bitk=f,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,N);if(l+=c[k+2],0===(d=c[k=3*(u+(l+=h&R[d]))])){h>>=c[k+1],f-=c[k+1],o.window[m++]=c[k+2],v--;break}}else h>>=c[k+1],f-=c[k+1],o.window[m++]=c[k+2],v--}while(258<=v&&10<=p);return p+=w=f>>3<(w=s.avail_in-p)?f>>3:w,g-=w,f-=w<<3,o.bitb=h,o.bitk=f,s.avail_in=p,s.total_in+=g-s.next_in_index,s.next_in_index=g,o.write=m,L}var g,p,m,v,b=0,E=0,w=0,T=0,I=0,k=0,S=0,C=0,y=0,x=0;this.init=function(e,t,n,a,r,i){g=P,S=e,C=t,m=n,y=a,v=r,x=i,p=null},this.proc=function(e,t,n){var a,r,i,o,s,l,c,u=0,d=0,h=0;for(h=t.next_in_index,o=t.avail_in,u=e.bitb,d=e.bitk,l=(s=e.write)<e.read?e.read-s-1:e.end-s;;)switch(g){case P:if(258<=l&&10<=o&&(e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,n=f(S,C,m,y,v,x,e,t),h=t.next_in_index,o=t.avail_in,u=e.bitb,d=e.bitk,l=(s=e.write)<e.read?e.read-s-1:e.end-s,n!=L)){g=n==D?z:H;break}w=S,p=m,E=y,g=A;case A:for(a=w;d<a;){if(0===o)return e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=L,o--,u|=(255&t.read_byte(h++))<<d,d+=8}if(u>>>=p[(r=3*(E+(u&R[a])))+1],d-=p[r+1],0===(i=p[r])){T=p[r+2],g=K;break}if(0!=(16&i)){I=15&i,b=p[r+2],g=M;break}if(0==(64&i)){w=i,E=r/3+p[r+2];break}if(0==(32&i))return g=H,t.msg="invalid literal/length code",n=N,e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);g=z;break;case M:for(a=I;d<a;){if(0===o)return e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=L,o--,u|=(255&t.read_byte(h++))<<d,d+=8}b+=u&R[a],u>>=a,d-=a,w=C,p=v,E=x,g=F;case F:for(a=w;d<a;){if(0===o)return e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=L,o--,u|=(255&t.read_byte(h++))<<d,d+=8}if(u>>=p[(r=3*(E+(u&R[a])))+1],d-=p[r+1],0!=(16&(i=p[r]))){I=15&i,k=p[r+2],g=Y;break}if(0!=(64&i))return g=H,t.msg="invalid distance code",n=N,e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);w=i,E=r/3+p[r+2];break;case Y:for(a=I;d<a;){if(0===o)return e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=L,o--,u|=(255&t.read_byte(h++))<<d,d+=8}k+=u&R[a],u>>=a,d-=a,g=W;case W:for(c=s-k;c<0;)c+=e.end;for(;0!==b;){if(0===l&&(s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l&&(e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l)))return e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);e.window[s++]=e.window[c++],l--,c==e.end&&(c=0),b--}g=P;break;case K:if(0===l&&(s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l&&(e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,s==e.end&&0!==e.read&&(l=(s=0)<e.read?e.read-s-1:e.end-s),0===l)))return e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);n=L,e.window[s++]=T,l--,g=P;break;case z:if(7<d&&(d-=8,o++,h--),e.write=s,n=e.inflate_flush(t,n),l=(s=e.write)<e.read?e.read-s-1:e.end-s,e.read!=e.write)return e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);g=G;case G:return n=D,e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);case H:return n=N,e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n);default:return n=O,e.bitb=u,e.bitk=d,t.avail_in=o,t.total_in+=h-t.next_in_index,t.next_in_index=h,e.write=s,e.inflate_flush(t,n)}},this.free=function(){}}function a(e,t){var w,T=this,I=j,k=0,S=0,C=0,y=[0],x=[0],P=new n,A=0,U=new Int32Array(3*V),M=new _;T.bitk=0,T.bitb=0,T.window=new Uint8Array(t),T.end=t,T.read=0,T.write=0,T.reset=function(e,t){t&&(t[0]=0),I==ee&&P.free(e),I=j,T.bitk=0,T.bitb=0,T.read=T.write=0},T.reset(e,null),T.inflate_flush=function(e,t){var n,a,r;return a=e.next_out_index,e.avail_out<(n=((r=T.read)<=T.write?T.write:T.end)-r)&&(n=e.avail_out),0!==n&&t==B&&(t=L),e.avail_out-=n,e.total_out+=n,e.next_out.set(T.window.subarray(r,r+n),a),a+=n,(r+=n)==T.end&&(r=0,T.write==T.end&&(T.write=0),e.avail_out<(n=T.write-r)&&(n=e.avail_out),0!==n&&t==B&&(t=L),e.avail_out-=n,e.total_out+=n,e.next_out.set(T.window.subarray(r,r+n),a),a+=n,r+=n),e.next_out_index=a,T.read=r,t},T.proc=function(e,t){var n,a,r,i,o,s,l,c;for(i=e.next_in_index,o=e.avail_in,a=T.bitb,r=T.bitk,l=(s=T.write)<T.read?T.read-s-1:T.end-s;;)switch(I){case j:for(;r<3;){if(0===o)return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);t=L,o--,a|=(255&e.read_byte(i++))<<r,r+=8}switch(A=1&(n=7&a),n>>>1){case 0:a>>>=3,a>>>=n=7&(r-=3),r-=n,I=q;break;case 1:var u=[],d=[],h=[[]],f=[[]];_.inflate_trees_fixed(u,d,h,f),P.init(u[0],d[0],h[0],0,f[0],0),a>>>=3,r-=3,I=ee;break;case 2:a>>>=3,r-=3,I=Z;break;case 3:return a>>>=3,r-=3,I=ae,e.msg="invalid block type",t=N,T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t)}break;case q:for(;r<32;){if(0===o)return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);t=L,o--,a|=(255&e.read_byte(i++))<<r,r+=8}if((~a>>>16&65535)!=(65535&a))return I=ae,e.msg="invalid stored block lengths",t=N,T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);k=65535&a,a=r=0,I=0!==k?Q:0!==A?te:j;break;case Q:if(0===o)return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);if(0===l&&(s==T.end&&0!==T.read&&(l=(s=0)<T.read?T.read-s-1:T.end-s),0===l&&(T.write=s,t=T.inflate_flush(e,t),l=(s=T.write)<T.read?T.read-s-1:T.end-s,s==T.end&&0!==T.read&&(l=(s=0)<T.read?T.read-s-1:T.end-s),0===l)))return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);if(t=L,o<(n=k)&&(n=o),l<n&&(n=l),T.window.set(e.read_buf(i,n),s),i+=n,o-=n,s+=n,l-=n,0!=(k-=n))break;I=0!==A?te:j;break;case Z:for(;r<14;){if(0===o)return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);t=L,o--,a|=(255&e.read_byte(i++))<<r,r+=8}if(S=n=16383&a,29<(31&n)||29<(n>>5&31))return I=ae,e.msg="too many length or distance symbols",t=N,T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);if(n=258+(31&n)+(n>>5&31),!w||w.length<n)w=[];else for(c=0;c<n;c++)w[c]=0;a>>>=14,r-=14,C=0,I=J;case J:for(;C<4+(S>>>10);){for(;r<3;){if(0===o)return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);t=L,o--,a|=(255&e.read_byte(i++))<<r,r+=8}w[X[C++]]=7&a,a>>>=3,r-=3}for(;C<19;)w[X[C++]]=0;if(y[0]=7,(n=M.inflate_trees_bits(w,y,x,U,e))!=L)return(t=n)==N&&(w=null,I=ae),T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);C=0,I=$;case $:for(;!(258+(31&(n=S))+(n>>5&31)<=C);){var g,p;for(n=y[0];r<n;){if(0===o)return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);t=L,o--,a|=(255&e.read_byte(i++))<<r,r+=8}if((p=U[3*(x[0]+(a&R[n=U[3*(x[0]+(a&R[n]))+1]]))+2])<16)a>>>=n,r-=n,w[C++]=p;else{for(c=18==p?7:p-14,g=18==p?11:3;r<n+c;){if(0===o)return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);t=L,o--,a|=(255&e.read_byte(i++))<<r,r+=8}if(r-=n,g+=(a>>>=n)&R[c],a>>>=c,r-=c,258+(31&(n=S))+(n>>5&31)<(c=C)+g||16==p&&c<1)return w=null,I=ae,e.msg="invalid bit length repeat",t=N,T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);for(p=16==p?w[c-1]:0;w[c++]=p,0!=--g;);C=c}}x[0]=-1;var m=[],v=[],b=[],E=[];if(m[0]=9,v[0]=6,(n=M.inflate_trees_dynamic(257+(31&(n=S)),1+(n>>5&31),w,m,v,b,E,U,e))!=L)return n==N&&(w=null,I=ae),t=n,T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);P.init(m[0],v[0],U,b[0],U,E[0]),I=ee;case ee:if(T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,(t=P.proc(T,e,t))!=D)return T.inflate_flush(e,t);if(t=L,P.free(e),i=e.next_in_index,o=e.avail_in,a=T.bitb,r=T.bitk,l=(s=T.write)<T.read?T.read-s-1:T.end-s,0===A){I=j;break}I=te;case te:if(T.write=s,t=T.inflate_flush(e,t),l=(s=T.write)<T.read?T.read-s-1:T.end-s,T.read!=T.write)return T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);I=ne;case ne:return t=D,T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);case ae:return t=N,T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t);default:return t=O,T.bitb=a,T.bitk=r,e.avail_in=o,e.total_in+=i-e.next_in_index,e.next_in_index=i,T.write=s,T.inflate_flush(e,t)}},T.free=function(e){T.reset(e,null),U=T.window=null},T.set_dictionary=function(e,t,n){T.window.set(e.subarray(t,t+n),0),T.read=T.write=n},T.sync_point=function(){return I==q?1:0}}function t(){function o(e){return e&&e.istate?(e.total_in=e.total_out=0,e.msg=null,e.istate.mode=7,e.istate.blocks.reset(e,null),L):O}var n=this;n.mode=0,n.method=0,n.was=[0],n.need=0,n.marker=0,n.wbits=0,n.inflateEnd=function(e){return n.blocks&&n.blocks.free(e),n.blocks=null,L},n.inflateInit=function(e,t){return n.blocks=e.msg=null,t<8||15<t?(n.inflateEnd(e),O):(e.istate.blocks=new a(e,1<<(n.wbits=t)),o(e),L)},n.inflate=function(e,t){var n,a;if(!e||!e.istate||!e.next_in)return O;for(t=4==t?B:L,n=B;;)switch(e.istate.mode){case 0:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,8!=(15&(e.istate.method=e.read_byte(e.next_in_index++)))){e.istate.mode=13,e.msg="unknown compression method",e.istate.marker=5;break}if(e.istate.wbits<8+(e.istate.method>>4)){e.istate.mode=13,e.msg="invalid window size",e.istate.marker=5;break}e.istate.mode=1;case 1:if(0===e.avail_in)return n;if(n=t,e.avail_in--,e.total_in++,a=255&e.read_byte(e.next_in_index++),((e.istate.method<<8)+a)%31!=0){e.istate.mode=13,e.msg="incorrect header check",e.istate.marker=5;break}if(0==(32&a)){e.istate.mode=7;break}e.istate.mode=2;case 2:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need=(255&e.read_byte(e.next_in_index++))<<24&4278190080,e.istate.mode=3;case 3:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<16&16711680,e.istate.mode=4;case 4:if(0===e.avail_in)return n;n=t,e.avail_in--,e.total_in++,e.istate.need+=(255&e.read_byte(e.next_in_index++))<<8&65280,e.istate.mode=5;case 5:return 0===e.avail_in?n:(n=t,e.avail_in--,e.total_in++,e.istate.need+=255&e.read_byte(e.next_in_index++),e.istate.mode=6,2);case 6:return e.istate.mode=13,e.msg="need dictionary",e.istate.marker=0,O;case 7:if((n=e.istate.blocks.proc(e,n))==N){e.istate.mode=13,e.istate.marker=0;break}if(n==L&&(n=t),n!=D)return n;n=t,e.istate.blocks.reset(e,e.istate.was),e.istate.mode=12;case 12:return D;case 13:return N;default:return O}},n.inflateSetDictionary=function(e,t,n){var a=0,r=n;return e&&e.istate&&6==e.istate.mode?(1<<e.istate.wbits<=r&&(a=n-(r=(1<<e.istate.wbits)-1)),e.istate.blocks.set_dictionary(t,a,r),e.istate.mode=7,L):O},n.inflateSync=function(e){var t,n,a,r,i;if(!e||!e.istate)return O;if(13!=e.istate.mode&&(e.istate.mode=13,e.istate.marker=0),0===(t=e.avail_in))return B;for(n=e.next_in_index,a=e.istate.marker;0!==t&&a<4;)e.read_byte(n)==s[a]?a++:a=0!==e.read_byte(n)?0:4-a,n++,t--;return e.total_in+=n-e.next_in_index,e.next_in_index=n,e.avail_in=t,4!=(e.istate.marker=a)?N:(r=e.total_in,i=e.total_out,o(e),e.total_in=r,e.total_out=i,e.istate.mode=7,L)},n.inflateSyncPoint=function(e){return e&&e.istate&&e.istate.blocks?e.istate.blocks.sync_point():O}}function r(){}var L=0,D=1,O=-2,N=-3,g=-4,B=-5,R=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],V=1440,i=[96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,192,80,7,10,0,8,96,0,8,32,0,9,160,0,8,0,0,8,128,0,8,64,0,9,224,80,7,6,0,8,88,0,8,24,0,9,144,83,7,59,0,8,120,0,8,56,0,9,208,81,7,17,0,8,104,0,8,40,0,9,176,0,8,8,0,8,136,0,8,72,0,9,240,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,200,81,7,13,0,8,100,0,8,36,0,9,168,0,8,4,0,8,132,0,8,68,0,9,232,80,7,8,0,8,92,0,8,28,0,9,152,84,7,83,0,8,124,0,8,60,0,9,216,82,7,23,0,8,108,0,8,44,0,9,184,0,8,12,0,8,140,0,8,76,0,9,248,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,196,81,7,11,0,8,98,0,8,34,0,9,164,0,8,2,0,8,130,0,8,66,0,9,228,80,7,7,0,8,90,0,8,26,0,9,148,84,7,67,0,8,122,0,8,58,0,9,212,82,7,19,0,8,106,0,8,42,0,9,180,0,8,10,0,8,138,0,8,74,0,9,244,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,204,81,7,15,0,8,102,0,8,38,0,9,172,0,8,6,0,8,134,0,8,70,0,9,236,80,7,9,0,8,94,0,8,30,0,9,156,84,7,99,0,8,126,0,8,62,0,9,220,82,7,27,0,8,110,0,8,46,0,9,188,0,8,14,0,8,142,0,8,78,0,9,252,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,194,80,7,10,0,8,97,0,8,33,0,9,162,0,8,1,0,8,129,0,8,65,0,9,226,80,7,6,0,8,89,0,8,25,0,9,146,83,7,59,0,8,121,0,8,57,0,9,210,81,7,17,0,8,105,0,8,41,0,9,178,0,8,9,0,8,137,0,8,73,0,9,242,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,202,81,7,13,0,8,101,0,8,37,0,9,170,0,8,5,0,8,133,0,8,69,0,9,234,80,7,8,0,8,93,0,8,29,0,9,154,84,7,83,0,8,125,0,8,61,0,9,218,82,7,23,0,8,109,0,8,45,0,9,186,0,8,13,0,8,141,0,8,77,0,9,250,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,198,81,7,11,0,8,99,0,8,35,0,9,166,0,8,3,0,8,131,0,8,67,0,9,230,80,7,7,0,8,91,0,8,27,0,9,150,84,7,67,0,8,123,0,8,59,0,9,214,82,7,19,0,8,107,0,8,43,0,9,182,0,8,11,0,8,139,0,8,75,0,9,246,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,206,81,7,15,0,8,103,0,8,39,0,9,174,0,8,7,0,8,135,0,8,71,0,9,238,80,7,9,0,8,95,0,8,31,0,9,158,84,7,99,0,8,127,0,8,63,0,9,222,82,7,27,0,8,111,0,8,47,0,9,190,0,8,15,0,8,143,0,8,79,0,9,254,96,7,256,0,8,80,0,8,16,84,8,115,82,7,31,0,8,112,0,8,48,0,9,193,80,7,10,0,8,96,0,8,32,0,9,161,0,8,0,0,8,128,0,8,64,0,9,225,80,7,6,0,8,88,0,8,24,0,9,145,83,7,59,0,8,120,0,8,56,0,9,209,81,7,17,0,8,104,0,8,40,0,9,177,0,8,8,0,8,136,0,8,72,0,9,241,80,7,4,0,8,84,0,8,20,85,8,227,83,7,43,0,8,116,0,8,52,0,9,201,81,7,13,0,8,100,0,8,36,0,9,169,0,8,4,0,8,132,0,8,68,0,9,233,80,7,8,0,8,92,0,8,28,0,9,153,84,7,83,0,8,124,0,8,60,0,9,217,82,7,23,0,8,108,0,8,44,0,9,185,0,8,12,0,8,140,0,8,76,0,9,249,80,7,3,0,8,82,0,8,18,85,8,163,83,7,35,0,8,114,0,8,50,0,9,197,81,7,11,0,8,98,0,8,34,0,9,165,0,8,2,0,8,130,0,8,66,0,9,229,80,7,7,0,8,90,0,8,26,0,9,149,84,7,67,0,8,122,0,8,58,0,9,213,82,7,19,0,8,106,0,8,42,0,9,181,0,8,10,0,8,138,0,8,74,0,9,245,80,7,5,0,8,86,0,8,22,192,8,0,83,7,51,0,8,118,0,8,54,0,9,205,81,7,15,0,8,102,0,8,38,0,9,173,0,8,6,0,8,134,0,8,70,0,9,237,80,7,9,0,8,94,0,8,30,0,9,157,84,7,99,0,8,126,0,8,62,0,9,221,82,7,27,0,8,110,0,8,46,0,9,189,0,8,14,0,8,142,0,8,78,0,9,253,96,7,256,0,8,81,0,8,17,85,8,131,82,7,31,0,8,113,0,8,49,0,9,195,80,7,10,0,8,97,0,8,33,0,9,163,0,8,1,0,8,129,0,8,65,0,9,227,80,7,6,0,8,89,0,8,25,0,9,147,83,7,59,0,8,121,0,8,57,0,9,211,81,7,17,0,8,105,0,8,41,0,9,179,0,8,9,0,8,137,0,8,73,0,9,243,80,7,4,0,8,85,0,8,21,80,8,258,83,7,43,0,8,117,0,8,53,0,9,203,81,7,13,0,8,101,0,8,37,0,9,171,0,8,5,0,8,133,0,8,69,0,9,235,80,7,8,0,8,93,0,8,29,0,9,155,84,7,83,0,8,125,0,8,61,0,9,219,82,7,23,0,8,109,0,8,45,0,9,187,0,8,13,0,8,141,0,8,77,0,9,251,80,7,3,0,8,83,0,8,19,85,8,195,83,7,35,0,8,115,0,8,51,0,9,199,81,7,11,0,8,99,0,8,35,0,9,167,0,8,3,0,8,131,0,8,67,0,9,231,80,7,7,0,8,91,0,8,27,0,9,151,84,7,67,0,8,123,0,8,59,0,9,215,82,7,19,0,8,107,0,8,43,0,9,183,0,8,11,0,8,139,0,8,75,0,9,247,80,7,5,0,8,87,0,8,23,192,8,0,83,7,51,0,8,119,0,8,55,0,9,207,81,7,15,0,8,103,0,8,39,0,9,175,0,8,7,0,8,135,0,8,71,0,9,239,80,7,9,0,8,95,0,8,31,0,9,159,84,7,99,0,8,127,0,8,63,0,9,223,82,7,27,0,8,111,0,8,47,0,9,191,0,8,15,0,8,143,0,8,79,0,9,255],o=[80,5,1,87,5,257,83,5,17,91,5,4097,81,5,5,89,5,1025,85,5,65,93,5,16385,80,5,3,88,5,513,84,5,33,92,5,8193,82,5,9,90,5,2049,86,5,129,192,5,24577,80,5,2,87,5,385,83,5,25,91,5,6145,81,5,7,89,5,1537,85,5,97,93,5,24577,80,5,4,88,5,769,84,5,49,92,5,12289,82,5,13,90,5,3073,86,5,193,192,5,24577],p=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],m=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,112,112],v=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577],b=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],U=15;_.inflate_trees_fixed=function(e,t,n,a){return e[0]=9,t[0]=5,n[0]=i,a[0]=o,L};var P=0,A=1,M=2,F=3,Y=4,W=5,K=6,z=7,G=8,H=9,X=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],j=0,q=1,Q=2,Z=3,J=4,$=5,ee=6,te=7,ne=8,ae=9,s=[0,0,255,255];r.prototype={inflateInit:function(e){return this.istate=new t,this.istate.inflateInit(this,e=e||15)},inflate:function(e){return this.istate?this.istate.inflate(this,e):O},inflateEnd:function(){if(!this.istate)return O;var e=this.istate.inflateEnd(this);return this.istate=null,e},inflateSync:function(){return this.istate?this.istate.inflateSync(this):O},inflateSetDictionary:function(e,t){return this.istate?this.istate.inflateSetDictionary(this,e,t):O},read_byte:function(e){return this.next_in.subarray(e,e+1)[0]},read_buf:function(e,t){return this.next_in.subarray(e,e+t)}};var l=e.zip||e;l.Inflater=l._jzlib_Inflater=function(){var l=new r,c=new Uint8Array(512),u=!1;l.inflateInit(),l.next_out=c,this.append=function(e,t){var n,a,r=[],i=0,o=0,s=0;if(0!==e.length){l.next_in_index=0,l.next_in=e,l.avail_in=e.length;do{if(l.next_out_index=0,l.avail_out=512,0!==l.avail_in||u||(u=!(l.next_in_index=0)),n=l.inflate(0),u&&n===B){if(0!==l.avail_in)throw new Error("inflating: bad input")}else if(n!==L&&n!==D)throw new Error("inflating: "+l.msg);if((u||n===D)&&l.avail_in===e.length)throw new Error("inflating: bad input");l.next_out_index&&r.push(512===l.next_out_index?new Uint8Array(c):new Uint8Array(c.subarray(0,l.next_out_index))),s+=l.next_out_index,t&&0<l.next_in_index&&l.next_in_index!=i&&(t(l.next_in_index),i=l.next_in_index)}while(0<l.avail_in||0===l.avail_out);return a=new Uint8Array(s),r.forEach(function(e){a.set(e,o),o+=e.length}),a}},this.flush=function(){l.inflateEnd()}}}(this),function(a){"use strict";function h(e){var t=a[e.codecClass],n=e.sn;if(f[n])throw Error("duplicated sn");f[n]={codec:new t(e.options),crcInput:"input"===e.crcType,crcOutput:"output"===e.crcType,crc:new r},postMessage({type:"newTask",sn:n})}function e(e){var t=e.sn,n=e.type,a=e.data,r=f[t];!r&&e.codecClass&&(h(e),r=f[t]);var i,o="append"===n,s=g();if(o)try{i=r.codec.append(a,function(e){postMessage({type:"progress",sn:t,loaded:e})})}catch(e){throw delete f[t],e}else delete f[t],i=r.codec.flush();var l=g()-s;s=g(),a&&r.crcInput&&r.crc.append(a),i&&r.crcOutput&&r.crc.append(i);var c=g()-s,u={type:n,sn:t,codecTime:l,crcTime:c},d=[];i&&d.push((u.data=i).buffer),o||!r.crcInput&&!r.crcOutput||(u.crc=r.crc.get());try{postMessage(u,d)}catch(e){postMessage(u)}}function r(){this.crc=-1}function t(){}a.zWorkerInitialized&&(a.zWorkerInitialized=!0),addEventListener("message",function(e){var t=e.data,n=t.type,a=t.sn,r=i[n];if(r)try{r(t)}catch(e){!function(e,t,n){var a,r={type:e,sn:t,error:{message:(a=n).message,stack:a.stack}};postMessage(r)}(n,a,e)}});var i={importScripts:function(e){e.scripts&&0<e.scripts.length&&importScripts.apply(void 0,e.scripts),postMessage({type:"importScripts"})},newTask:h,append:e,flush:e},f={},g=a.performance?a.performance.now.bind(a.performance):Date.now;r.prototype.append=function(e){for(var t=0|this.crc,n=this.table,a=0,r=0|e.length;a<r;a++)t=t>>>8^n[255&(t^e[a])];this.crc=t},r.prototype.get=function(){return~this.crc},r.prototype.table=function(){var e,t,n,a=[];for(e=0;e<256;e++){for(n=e,t=0;t<8;t++)1&n?n=n>>>1^3988292384:n>>>=1;a[e]=n}return a}(),(a.NOOP=t).prototype.append=function(e){return e},t.prototype.flush=function(){}}(this);var Instrument=function(){function o(e,t,n){var a=Tracker.getProperties().tickTime,r=e.sustain?e.sustainPoint+1:e.count;e.loopStartPoint=Math.min(e.loopStartPoint,e.count-1),e.loopEndPoint=Math.min(e.loopEndPoint,e.count-1);var i=e.loop&&e.loopStartPoint<e.loopEndPoint;e.sustain&&e.sustainPoint<=e.loopStartPoint&&(i=!1),i&&(r=e.loopEndPoint+1);var o=0;if(t.gain)var s=t.gain,l=0,c=64;else s=t.pan,c=l=32;s.setValueAtTime((e.points[0][1]-l)/c,n);for(var u=1;u<r;u++){var d=e.points[u];s.linearRampToValueAtTime((d[1]-l)/c,n+(o=d[0]*a))}return!!i&&f.scheduleEnvelopeLoop(t,n,2,o)}var f={type:"sample",name:"",instrumentIndex:0,sampleIndex:-1,fadeout:128,data:[]};return f.samples=[Sample()],f.sample=f.samples[0],f.volumeEnvelope={raw:[],enabled:!1,points:[[0,48],[10,64],[20,40],[30,18],[40,28],[50,18]],count:6},f.panningEnvelope={raw:[],enabled:!1,points:[[0,32],[20,40],[40,24],[60,32],[80,32]],count:5},f.vibrato={},f.sampleNumberForNotes=[],f.play=function(e,t,n,a,r,i){return Tracker.inFTMode()&&(t=f.getPeriodForNote(e)),Audio.playSample(f.instrumentIndex,t,n,a,r,i,e)},f.noteOn=function(e){var t,n,a={};if(f.volumeEnvelope.enabled){t=Audio.context.createGain();var r=f.volumeEnvelope,i=o(r,t,e);i&&(a.volume=e+i)}return f.panningEnvelope.enabled&&Audio.usePanning&&(n=Audio.context.createStereoPanner(),(i=o(r=f.panningEnvelope,n,e))&&(a.panning=e+i)),f.vibrato.rate&&f.vibrato.depth&&(a.ticks=0,a.vibrato=e,a.vibratoFunction=f.getAutoVibratoFunction()),{volume:t,panning:n,scheduled:a}},f.noteOff=function(e,t){function n(){t.volume.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeEnvelope&&t.volumeEnvelope.gain.cancelScheduledValues(e),t.panningEnvelope&&t.panningEnvelope.pan.cancelScheduledValues(e),t.scheduled=void 0}if(t&&t.volume){if(Tracker.inFTMode()){var a=Tracker.getProperties().tickTime;if(f.volumeEnvelope.enabled){if(f.volumeEnvelope.sustain&&t.volumeEnvelope){n();var r=0,i=f.volumeEnvelope.points[f.volumeEnvelope.sustainPoint];i&&(r=i[0]*a);for(var o=f.volumeEnvelope.sustainPoint;o<f.volumeEnvelope.count;o++){var s=f.volumeEnvelope.points[o];s&&t.volumeEnvelope.gain.linearRampToValueAtTime(s[1]/64,e+s[0]*a-r)}}if(f.fadeout)t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+65536/f.fadeout*a/2)}else n(),t.volumeFadeOut.gain.linearRampToValueAtTime(0,e+.1);if(f.panningEnvelope.enabled&&Audio.usePanning&&t.panningEnvelope)for(r=0,(i=f.panningEnvelope.points[f.panningEnvelope.sustainPoint])&&(r=i[0]*a),o=f.panningEnvelope.sustainPoint;o<f.panningEnvelope.count;o++)(s=f.panningEnvelope.points[o])&&t.panningEnvelope.pan.linearRampToValueAtTime((s[1]-32)/32,e+s[0]*a-r);return 100}if(n(),!t.isKey||!t.volume)return 0;t.volume.gain.linearRampToValueAtTime(0,e+.5)}},f.scheduleEnvelopeLoop=function(e,t,n,a){a=a||0;var r=Tracker.getProperties().tickTime;if(e.gain)var i=f.volumeEnvelope,o=e.gain,s=0,l=64;else i=f.panningEnvelope,o=e.pan,l=s=32;var c=i.points[i.loopStartPoint],u=c[0];if(i.loop&&i.loopStartPoint<i.loopEndPoint)for(;a<n;)for(var d=a,h=i.loopStartPoint;h<=i.loopEndPoint;h++)o.linearRampToValueAtTime(((c=i.points[h])[1]-s)/l,t+(a=d+(c[0]-u)*r));return a},f.scheduleAutoVibrato=function(e,t){var n=0;e.scheduled.ticks=e.scheduled.ticks||0;var a,r,i,o,s=Tracker.getProperties().tickTime,l=-f.vibrato.rate/40,c=f.vibrato.depth/8;for(Tracker.useLinearFrequency&&(c*=4),e.source&&(a=e.startPeriod,r=e.scheduled.vibratoFunction||Audio.waveFormFunction.sine,i=e.scheduled.vibrato||Audio.context.currentTime,o=0);n<t;){if(n+=s,a){var u=1;f.vibrato.sweep&&e.scheduled.ticks<f.vibrato.sweep&&(u=1-(f.vibrato.sweep-e.scheduled.ticks)/f.vibrato.sweep);var d=r(a,e.scheduled.ticks,l,c*u);Tracker.setPeriodAtTime(e,d,i+o*s),o++}e.scheduled.ticks++}return n},f.getAutoVibratoFunction=function(){switch(f.vibrato.type){case 1:return Audio.waveFormFunction.square;case 2:return Audio.waveFormFunction.saw;case 3:return Audio.waveFormFunction.sawInverse}return Audio.waveFormFunction.sine},f.resetVolume=function(e,t){if(t.volumeFadeOut&&(t.volumeFadeOut.gain.cancelScheduledValues(e),t.volumeFadeOut.gain.setValueAtTime(1,e)),t.volumeEnvelope){t.volumeEnvelope.gain.cancelScheduledValues(e);var n=Tracker.getProperties().tickTime,a=f.volumeEnvelope.sustain?f.volumeEnvelope.sustainPoint+1:f.volumeEnvelope.count;t.volumeEnvelope.gain.setValueAtTime(f.volumeEnvelope.points[0][1]/64,e);for(var r=1;r<a;r++){var i=f.volumeEnvelope.points[r];t.volumeEnvelope.gain.linearRampToValueAtTime(i[1]/64,e+i[0]*n)}}},f.getFineTune=function(){return Tracker.inFTMode()?f.sample.finetuneX:f.sample.finetune},f.setFineTune=function(e){Tracker.inFTMode()?(f.sample.finetuneX=e,f.sample.finetune=e>>4):(7<e&&(e-=16),f.sample.finetune=e,f.sample.finetuneX=e<<4)},f.getPeriodForNote=function(e,t){var n=0;return Tracker.useLinearFrequency?(n=7680-64*(e-1),t&&(n-=f.getFineTune()/2)):(n=FTNotes[e].period,t&&f.getFineTune()&&(n=Audio.getFineTuneForNote(e,f.getFineTune()))),n},f.setSampleForNoteIndex=function(e){var t=f.sampleNumberForNotes[e-1];t!==f.sampleIndex&&"number"==typeof t&&f.setSampleIndex(t)},f.setSampleIndex=function(e){f.sampleIndex!==e&&(f.sample=f.samples[e],f.sampleIndex=e,EventBus.trigger(EVENT.sampleIndexChange,f.instrumentIndex))},f.hasSamples=function(){for(var e=0,t=f.samples.length;e<t;e++)if(f.samples[e].length)return!0},f.hasVibrato=function(){return f.vibrato.rate&&f.vibrato.depth},f},Note=function(){var n={period:0,index:0,effect:0,instrument:0,param:0,volumeEffect:0,setPeriod:function(e){n.period=e,n.index=FTPeriods[e]||0},setIndex:function(e){var t=FTNotes[n.index=e];t?(n.period=t.modPeriod||t.period,1===n.period&&(n.period=0)):n.period=0},clear:function(){n.instrument=0,n.period=0,n.effect=0,n.param=0,n.index=0,n.volumeEffect=0},duplicate:function(){return{instrument:n.instrument,period:n.period,effect:n.effect,param:n.param,volumeEffect:n.volumeEffect,note:n.index}},populate:function(e){n.instrument=e.instrument||0,n.period=e.period||0,n.effect=e.effect||0,n.param=e.param||0,n.volumeEffect=e.volumeEffect||0,n.index=e.note||e.index||0}};return n},Sample=function(){var r={data:[],length:0,name:"",bits:8,volume:64,finetune:0,finetuneX:0,panning:0,relativeNote:0,loop:{enabled:!1,start:0,length:0,type:0},check:function(){for(var e=0,t=0,n=0,a=r.data.length;n<a;n++)e=Math.min(e,r.data[n]),t=Math.max(t,r.data[n]);return{min:e,max:t}}};return r},BassoonProvider=(zxa={},Axa="https://www.stef.be/bassoontracker/api/",Bxa=!1,zxa.putFile=function(){Editor.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(e){Tracker.getFileName(),FetchService.sendBinary("https://www.stef.be/bassoontracker/api/storage/put/",e.buffer,function(e){})})},zxa.renderFile=function(a,r){if(!Bxa){Bxa=!0;var i=Axa+"storage/render/"+(Tracker.inFTMode()?"xm":"mod");a=a||Tracker.getFileName(),UI.setStatus("saving file ...",!0),Logger.info("Rendering "+a),Editor.buildBinary(Tracker.inFTMode()?MODULETYPE.xm:MODULETYPE.mod,function(n){FetchService.sendBinary(i,n.buffer,function(e){if("error"===e)UI.setStatus("error saving file"),Bxa=!1;else{var t=e;UI.setStatus("rendering file ...",!0),FetchService.sendBinary(i=Axa+"storage/convert/"+t,n.buffer,function(e){"error"===e?(UI.setStatus("Error rendering file ..."),Bxa=!1):(t=e,r?(UI.setStatus("Converting file to mp3...",!0),FetchService.sendBinary(i=Axa+"storage/wavtomp3/"+t,n.buffer,function(e){"error"===e?(UI.setStatus("Error converting file to mp3..."),Bxa=!1):Cxa(e,a,"mp3")})):Cxa(t,a,"wav"))})}})})}},zxa.proxyUrl=function(e){return Axa+"proxy?"+encodeURIComponent(e)},zxa),zxa,Axa,Bxa;function Cxa(e,t,n){if(n){var a=!1,r=t.lastIndexOf(".");0<=r&&(a=t.substr(r+1).toLowerCase()===n.toLowerCase()),a||(t+="."+n)}UI.setStatus("Downloading ..."),Bxa=!1,setTimeout(function(){UI.setStatus("")},3e3),document.location.href=Axa+"storage/"+e+"?dl=1&name="+t}var Dropbox=(Vxa={},Vxa.isConnected=!1,Vxa.checkConnected=function(t){Vxa.isConnected&&t&&t(!0),dropboxService.getAccessToken()?dropboxService("users/get_current_account",void 0,{onComplete:function(e){e&&e.account_id&&(Vxa.isConnected=!0,t&&t(!0))},onError:function(){t&&t(!1)}}):t&&t(!1)},Vxa.showConnectDialog=function(){var n=UI.modalDialog();n.setProperties({width:UI.mainPanel.width,height:UI.mainPanel.height,top:0,left:0,ok:!0,cancel:!0}),n.onClick=function(e){var t=n.getElementAtPoint(e.x,e.y);t&&t.name&&(UI.setStatus(""),"okbutton"===t.name?Dropbox.authenticate():(n.close(),EventBus.trigger(EVENT.dropboxConnectCancel)))},n.setText("DROPBOX ://BassoonTracker is not yet connected to DropBox//Do you want to do that now?//(BassoonTracker will only have access/to its own BassoonTracker folder)"),UI.setModalElement(n)},Vxa.authenticate=function(){dropboxService.clearAccessToken(),dropboxService.authenticate({client_id:"ukk9z4f0nd1xa13",redirect_uri:"https://www.stef.be/bassoontracker/auth/dropbox.html"},{onComplete:function(e){},onError:function(e){}})},Vxa.list=function(e,t){dropboxService("files/list_folder",{path:e},function(e){var n=[];e.entries.forEach(function(e){if(e[".tag"]&&"folder"===e[".tag"])n.push({title:e.name,url:e.path_lower,children:[]});else{var t=Math.floor(e.size/1e3)+"kb";n.push({title:e.name+" ("+t+")"||"---",url:e.id,path:e.path_display})}}),t(n)})},Vxa.get=function(e,t){Vxa.list(e,t)},Vxa.getFile=function(e,a){dropboxService("files/download",{path:e.url},function(e,t,n){a(t)})},Vxa.putFile=function(e,t,a){var n={path:e};"overwrite"===SETTINGS.dropboxMode?n.mode="overwrite":(n.mode="add",n.autorename=!0),dropboxService("files/upload",n,t,{onComplete:function(e,t,n){a&&a(e)},onError:function(e,t,n){a&&a(!1)}})},Vxa),Vxa,ModArchive=function(){function l(e,t){FetchService.json(n+e,function(e){t(e)})}function c(e,t){FetchService.json("https://www.stef.be/bassoontracker/api/"+e,function(e){e&&e.modarchive&&(e=e.modarchive),t(e)})}function u(e){var t=[];return e&&e.forEach(function(e){t.push({title:e.title||"---",url:"https://api.modarchive.org/downloads.php?moduleid="+e.id,icon:e.format,info:formatFileSize(e.size)})}),t}function d(e,t){var n=[];if(e){if(e.module){var a=e.module;a.forEach?a.forEach(function(e){n.push({title:e.songtitle||"---",url:e.url,icon:"mod"})}):n.push({title:a.songtitle||"---",url:a.url,icon:"mod"})}if(e.totalpages){var r=parseInt(e.totalpages);if(1<r){var i=t[0]+"/",o=parseInt(t[1]||1);isNaN(o)&&(o=1),"artist/"!=i&&"genre/"!=i||(i+=t[1]+"/",o=parseInt(t[2]||1),isNaN(o)&&(o=1)),o<r&&n.push({title:"... load more ...",children:[],url:i+=o+1})}}}return n}var e={},n="http://localhost:3000/";n="https://www.stef.be/bassoontracker/api/ma/";var h=[],f=[];return e.get=function(e,t){var n,r,a=e.split("/"),i=a[1]||"",o=a[2]||"";switch(e=a[0]){case"genres":r=t,h.length?r&&r(h):l("genres",function(e){if(e){var a={};e.forEach(function(e){if(e.parent){var t={title:e.name,count:e.count,info:e.count+" >",children:[],url:"genre/"+e.id};a[e.parent]||(a[e.parent]=[]),a[e.parent].push(t)}}),e.forEach(function(e){if(!e.parent){var t={title:e.name,children:a[e.id]||[]},n=0;t.children.forEach(function(e){n+=e.count}),t.info=n+" >",h.push(t)}})}r&&r(h)});break;case"artists":n=t,f.length?n&&n(f):l("artists",function(e){e&&e.forEach(function(e){f.push({title:e.handle,children:[],info:e.count+" >",url:"artist/"+e.id})}),n&&n(f)});break;case"genre":l("genre/"+i,function(e){t(u(e))});break;case"toprating":c("toprating/"+(o=i||1),function(e){t(d(e,a))});break;case"topreview":c("topreview/"+(o=i||1),function(e){t(d(e,a))});break;case"artist":var s="artist/"+i;o&&(s+="/"+o),l(s,function(e){t(u(e))});break;default:t([])}},e}(),ModulesPl=(wza={},xza="https://www.stef.be/bassoontracker/api/mpl/",yza="https://www.stef.be/bassoontracker/api/modules.pl/",zza=[],Aza=[],wza.get=function(e,t){var n,a,r,i,o,s=e.split("/"),l=s[1]||"",c=s[2]||"";switch(e=s[0]){case"genres":o=t,zza.length?o&&o(zza):Eza("genres",function(e){e&&e.forEach(function(e){zza.push({title:e.name,url:"genre/"+e.name,children:[],info:e.count+" >"})}),o&&o(zza)});break;case"genre":r=t,i="genre/"+l,(a=c)&&(i+="/"+(a=parseInt(a))),Eza(i,function(e){r(Fza(e))});break;case"toprating":Eza("toprating/"+(c=l||1),function(e){t(Fza(e,"rate"))});break;case"topscore":Eza("topscore/"+(c=l||1),function(e){t(Fza(e,"score"))});break;case"artists":n=t,Aza.length?n&&n(Aza):Eza("artists",function(e){e&&e.forEach(function(e){Aza.push({title:e.handle,info:e.count+" >",url:"artist/"+e.id,children:[]})}),n&&n(Aza)});break;case"artist":var u="artist/"+l;c&&(u+="/"+c),Eza(u,function(e){t(Fza(e))});break;default:t([])}},wza),wza,xza,yza,zza,Aza;function Eza(e,t){FetchService.json(xza+e,function(e){t(e)})}function Fza(e,a){var r=[];return e&&e.forEach(function(e){var t=formatFileSize(e.size),n=e.title||"---";a&&(n=e[a]+": "+n),r.push({title:n,url:yza+e.id,info:t,icon:e.format})}),r}var Plugin=(jAa={},kAa={Nibbles:["script/plugins/games/nibbles/nibbles.js","script/plugins/games/nibbles/logo.png","script/plugins/games/nibbles/levels.png","script/plugins/games/nibbles/player1.png"],Generator:["script/plugins/apps/generator/generator.js","script/plugins/apps/generator/sin.png","script/plugins/apps/generator/logo.png"]},lAa={},jAa.register=function(e){lAa[e.name]=e},jAa.load=function(r,t){function i(e){n<=++a&&(r.loaded=!0,r.onLoad&&r.onLoad(),t&&t())}var e=r.name||r;if("object"==typeof window[e])t&&t();else{"string"==typeof r&&(r={name:r,src:kAa[r]});var n,a,o=lAa[r.name];if(o)o.loading||t&&t();else r.src?(r.loading=!0,n=r.src.length,a=0,r.src.forEach(function(e){var n,t,a;switch(e.split(".").pop().toLowerCase()){case"js":t=e,(a=document.createElement("script")).type="application/javascript",a.src=Host.getRemoteUrl()+t,a.addEventListener("error",i,!1),a.addEventListener("load",i,!1),document.getElementsByTagName("head")[0].appendChild(a);break;case"png":n=e,Y.loadImage(Host.getRemoteUrl()+n,function(e){var t=n.split("/").pop().split(".")[0];Y.sprites[r.name+"."+t]=Y.sprite({img:e,width:e.width,height:e.height}),i()});break;default:i()}})):t&&t()}},jAa),jAa,kAa,lAa;return{init:Tracker.init,load:Tracker.load,playSong:Tracker.playSong,stop:Tracker.stop,togglePlay:Tracker.togglePlay,isPlaying:Tracker.isPlaying,getTrackCount:Tracker.getTrackCount,getSong:Tracker.getSong,getInstruments:Tracker.getInstruments,getStateAtTime:Tracker.getStateAtTime,getTimeStates:Tracker.getTimeStates,setCurrentSongPosition:Tracker.setCurrentSongPosition,setBPM:Tracker.setBPM,getBPM:Tracker.getBPM,setAmigaSpeed:Tracker.setAmigaSpeed,getAmigaSpeed:Tracker.getAmigaSpeed,setMaster:Tracker.setMaster,isMaster:Tracker.isMaster,audio:Audio}};"undefined"!=typeof HostBridge&&HostBridge.customConfig||(BassoonTracker=BassoonTracker());